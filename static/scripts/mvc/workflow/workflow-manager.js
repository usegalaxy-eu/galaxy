define(["exports","jquery","mvc/workflow/workflow-connector","libs/toastr"],function(t,e,n,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var f=i(e),r=i(n),o=function(t){{if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n)){var a=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(t,n):{};a.get||a.set?Object.defineProperty(e,n,a):e[n]=t[n]}return e.default=t,e}}(a);function i(t){return t&&t.__esModule?t:{default:t}}function s(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}var u=function(){function n(t,e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,n),this.app=t,this.canvas_container=e,this.id_counter=0,this.nodes={},this.name=null,this.has_changes=!1,this.active_form_has_changes=!1,this.workflowOutputLabels={},this.workflow_version=0}var t,e,a;return t=n,(e=[{key:"canLabelOutputWith",value:function(t){return!t||!(t in this.workflowOutputLabels)}},{key:"registerOutputLabel",value:function(t){t&&(this.workflowOutputLabels[t]=!0)}},{key:"unregisterOutputLabel",value:function(t){t&&delete this.workflowOutputLabels[t]}},{key:"updateOutputLabel",value:function(t,e){t&&this.unregisterOutputLabel(t),this.canLabelOutputWith(e)||o.warning("Workflow contains duplicate workflow output labels ".concat(e,". This must be fixed before it can be saved.")),e&&this.registerOutputLabel(e)}},{key:"attemptUpdateOutputLabel",value:function(t,e,n){return!!this.canLabelOutputWith(n)&&(t.labelWorkflowOutput(e,n),t.nodeView.redrawWorkflowOutputs(),!0)}},{key:"create_node",value:function(t,e,n){var a=this.app.prebuildNode(t,e,n);return this.add_node(a),this.fit_canvas_to_nodes(),this.app.canvas_manager.draw_overview(),this.activate_node(a),a}},{key:"add_node",value:function(t){t.id=this.id_counter,t.element.attr("id","wf-node-step-".concat(t.id)),t.element.attr("node-label",t.label),this.id_counter++,this.nodes[t.id]=t,this.has_changes=!0,t.workflow=this}},{key:"remove_node",value:function(t){this.active_node==t&&this.clear_active_node(),delete this.nodes[t.id],this.has_changes=!0}},{key:"remove_all",value:function(){var n=this;f.default.each(this.nodes,function(t,e){e.destroy(),n.remove_node(e)})}},{key:"rectify_workflow_outputs",value:function(){var e=this,i=!1,n=!1;f.default.each(this.nodes,function(t,e){"tool"===e.type&&e.workflow_outputs&&0<e.workflow_outputs.length&&(i=!0),f.default.each(e.post_job_actions,function(t,e){"HideDatasetAction"===e.action_type&&(n=!0)})}),!1===i&&!1===n||f.default.each(this.nodes,function(t,a){var o=!1;null===a.post_job_actions&&(a.post_job_actions={},o=!0);var n=[];f.default.each(a.post_job_actions,function(t,e){"HideDatasetAction"==e.action_type&&n.push(t)}),0<n.length&&f.default.each(n,function(t,e){o=!0,delete a.post_job_actions[e]}),i&&f.default.each(a.output_terminals,function(t,e){if(!0===!a.isWorkflowOutput(e.name)){o=!0;var n={action_type:"HideDatasetAction",output_name:e.name,action_arguments:{}};a.post_job_actions["HideDatasetAction".concat(e.name)]=null,a.post_job_actions["HideDatasetAction".concat(e.name)]=n}}),e.active_node==a&&!0===o&&e.reload_active_node()})}},{key:"to_simple",value:function(){var o={};return f.default.each(this.nodes,function(t,e){var s={};f.default.each(e.input_terminals,function(t,o){s[o.name]=null;var i=[];f.default.each(o.connectors,function(t,e){if(e.handle1){var n={id:e.handle1.node.id,output_name:e.handle1.name},a=o.attributes.input.input_subworkflow_step_id;void 0!==a&&(n.input_subworkflow_step_id=a),i[t]=n,s[o.name]=i}})});var a={};e.post_job_actions&&f.default.each(e.post_job_actions,function(t,e){var n={action_type:e.action_type,output_name:e.output_name,action_arguments:e.action_arguments};a[e.action_type+e.output_name]=null,a[e.action_type+e.output_name]=n}),e.workflow_outputs||(e.workflow_outputs=[]);var n={id:e.id,type:e.type,content_id:e.content_id,tool_version:e.config_form?e.config_form.version:null,tool_state:e.tool_state,errors:e.errors,input_connections:s,position:(0,f.default)(e.element).position(),annotation:e.annotation,post_job_actions:e.post_job_actions,uuid:e.uuid,label:e.label,workflow_outputs:e.workflow_outputs};o[e.id]=n}),{steps:o}}},{key:"from_simple",value:function(t,e){var a=void 0===e||e,s=this,u=0;a?s.name=t.name:u=Object.keys(s.nodes).length;var o=u,c=!1;s.workflow_version=t.version,f.default.each(t.steps,function(t,e){var n=s.app.prebuildNode(e.type,e.name,e.content_id);a||(e.uuid=null,f.default.each(e.workflow_outputs,function(t,e){e.uuid=null})),n.init_field_data(e),e.position&&n.element.css({top:e.position.top,left:e.position.left}),n.id=parseInt(e.id)+u,n.element.attr("id","wf-node-step-".concat(n.id)),n.element.attr("node-label",e.label),s.nodes[n.id]=n,o=Math.max(o,parseInt(t)+u),c||(0<n.workflow_outputs.length?c=!0:f.default.each(n.post_job_actions||[],function(t,e){"HideDatasetAction"===e.action_type&&(c=!0)}))}),s.id_counter=o+1,f.default.each(t.steps,function(t,e){var i=s.nodes[parseInt(t)+u];f.default.each(e.input_connections,function(o,t){t&&(f.default.isArray(t)||(t=[t]),f.default.each(t,function(t,e){var n=s.nodes[parseInt(e.id)+u],a=new r.default;a.connect(n.output_terminals[e.output_name],i.input_terminals[o]),a.redraw()}))}),c&&f.default.each(i.output_terminals,function(t,e){void 0===i.post_job_actions["HideDatasetAction".concat(e.name)]&&(i.addWorkflowOutput(e.name),(0,f.default)(i.element).find(".callout-terminal.".concat(e.name.replace(/(?=[()])/g,"\\"))).find("icon").addClass("mark-terminal-active"),s.has_changes=!0)})})}},{key:"check_changes_in_active_form",value:function(){this.active_form_has_changes&&(this.has_changes=!0,(0,f.default)("#right-content").find("form").submit(),this.active_form_has_changes=!1)}},{key:"reload_active_node",value:function(){if(this.active_node){var t=this.active_node;this.clear_active_node(),this.activate_node(t)}}},{key:"clear_active_node",value:function(){this.active_node&&(this.active_node.make_inactive(),this.active_node=null),document.activeElement.blur(),this.app.showAttributes()}},{key:"activate_node",value:function(t){this.active_node!=t&&(this.check_changes_in_active_form(),this.clear_active_node(),this.app.showForm(t.config_form,t),t.make_active(),this.active_node=t)}},{key:"node_changed",value:function(t,e){this.has_changes=!0,this.active_node==t&&e&&(this.check_changes_in_active_form(),this.app.showForm(t.config_form,t)),this.app.showWorkflowParameters()}},{key:"layout",value:function(){this.check_changes_in_active_form(),this.has_changes=!0;var o={},i={};f.default.each(this.nodes,function(t,e){void 0===o[t]&&(o[t]=0),void 0===i[t]&&(i[t]=[])}),f.default.each(this.nodes,function(t,a){f.default.each(a.input_terminals,function(t,e){f.default.each(e.connectors,function(t,e){var n=e.handle1.node;o[a.id]+=1,i[n.id].push(a.id)})})});for(var t=[];;){var e=[];for(var n in o)0===o[n]&&e.push(n);if(0===e.length)break;for(var a in t.push(e),e){var s=e[a];for(var u in delete o[s],i[s])o[i[s][u]]-=1}}if(!o.length){var c=this.nodes,r=80;f.default.each(t,function(t,e){e.sort(function(t,e){return(0,f.default)(c[t].element).position().top-(0,f.default)(c[e].element).position().top});var o=0,i=30;f.default.each(e,function(t,e){var n=c[e],a=(0,f.default)(n.element);(0,f.default)(a).css({top:i,left:r}),o=Math.max(o,(0,f.default)(a).width()),i+=(0,f.default)(a).height()+30}),r+=o+80}),f.default.each(c,function(t,e){e.redraw()})}}},{key:"bounds_for_all_nodes",value:function(){var a,o=1/0,i=-1/0,s=1/0,u=-1/0;return f.default.each(this.nodes,function(t,e){var n=(0,f.default)(e.element);a=n.position(),o=Math.min(o,a.left),i=Math.max(i,a.left+n.width()),s=Math.min(s,a.top),u=Math.max(u,a.top+n.width())}),{xmin:o,xmax:i,ymin:s,ymax:u}}},{key:"fit_canvas_to_nodes",value:function(){function t(t,e){return Math.ceil(t/e)*e}function e(t,e){return t<e||3*e<t?-(t-(Math.ceil(t%e/e)+1)*e):0}var n=this.app.canvas_manager.canvasZoom,a=this.bounds_for_all_nodes(),o=this.canvas_container.position(),i=this.canvas_container.parent(),s=e(a.xmin,100),u=e(a.ymin,100);s=Math.max(s,o.left),u=Math.max(u,o.top);var c=o.left-s,r=o.top-u,l=t(a.xmax+100,100)+s,d=t(a.ymax+100,100)+u;l=Math.max(l,-c+i.width()),d=Math.max(d,-r+i.height()),this.canvas_container.css({left:c/n,top:r/n,width:l,height:d}),this.canvas_container.children().each(function(){var t=(0,f.default)(this).position();(0,f.default)(this).css("left",(t.left+s)/n),(0,f.default)(this).css("top",(t.top+u)/n)})}}])&&s(t.prototype,e),a&&s(t,a),n}();t.default=u});