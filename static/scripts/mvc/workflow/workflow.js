define(["exports","underscore","jquery","backbone","onload/loadConfig","app","libs/toastr","mvc/tag","mvc/workflow/workflow-model","utils/query-string-parsing","utils/localization","ui/loading-indicator"],function(o,e,t,n,r,l,a,i,s,c,d,f){"use strict";Object.defineProperty(o,"__esModule",{value:!0});var u=_(e),w=_(t),h=_(n),p=function(o){{if(o&&o.__esModule)return o;var e={};if(null!=o)for(var t in o)if(Object.prototype.hasOwnProperty.call(o,t)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(o,t):{};n.get||n.set?Object.defineProperty(e,t,n):e[t]=o[t]}return e.default=o,e}}(a),m=_(i),g=_(s),k=_(c),v=_(d),y=_(f);function _(o){return o&&o.__esModule?o:{default:o}}var b=h.default.View.extend({tagName:"tr",initialize:function(){u.default.bindAll(this,"render","_rowTemplate","renderTagEditor","_templateActions","removeWorkflow","copyWorkflow"),p.options.timeOut=1500},events:{"click #show-in-tool-panel":"showInToolPanel","click #delete-workflow":"removeWorkflow","click #rename-workflow":"renameWorkflow","click #copy-workflow":"copyWorkflow"},render:function(){return(0,w.default)(this.el).html(this._rowTemplate()),this},showInToolPanel:function(){this.model.save({show_in_tool_panel:!this.model.get("show_in_tool_panel")},{success:function(){window.location="".concat((0,r.getAppRoot)(),"workflows/list")}})},removeWorkflow:function(){var o=this.model.get("name");window.confirm("Are you sure you want to delete workflow '".concat(o,"'?"))&&(this.model.destroy({success:function(){p.success("Successfully deleted workflow '".concat(o,"'"))}}),this.remove())},renameWorkflow:function(){var o=this.model.get("name"),e=window.prompt("Enter a new Name for workflow '".concat(o,"'"),o);e&&(this.model.save({name:e},{success:function(){p.success("Successfully renamed workflow '".concat(o,"' to '").concat(e,"'"))}}),this.render())},copyWorkflow:function(){var n=this,r=(0,l.getGalaxyInstance)(),a=this.model.get("name");w.default.getJSON("".concat(this.model.urlRoot,"/").concat(this.model.id,"/download"),function(o){var e="Copy of ".concat(a),t=n.model.get("owner");t!=r.user.attributes.username&&(e+=" shared by user ".concat(t)),o.name=e,n.collection.create(o,{at:0,wait:!0,success:function(){p.success("Successfully copied workflow '".concat(a,"' to '").concat(e,"'"))},error:function(o,e,t){p.error(t.errorThrown)}})}).error(function(o,e,t){p.error(o.responseJSON.err_msg)})},_rowTemplate:function(){var o=(0,l.getGalaxyInstance)(),e=this.model.get("show_in_tool_panel"),t=this.model.id,n='<input id="show-in-tool-panel" type="checkbox" class="show-in-tool-panel" '.concat(e?'checked="'.concat(e,'"'):"",' value="').concat(t,'">');return'\n            <td>\n                <div class="btn-group">\n                    <a href="'.concat((0,r.getAppRoot)(),"workflow/editor?id=").concat(this.model.id,'" class="btn btn-secondary">\n                        ').concat(u.default.escape(this.model.get("name")),'\n                    </a>\n                    <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n                      <span class="sr-only">Toggle Dropdown</span>\n                    </button>\n                    ').concat(this._templateActions(),'\n                </div>\n            </td>\n            <td>\n                <div class="').concat(t,' tags-display">\n                </div>\n            </td>\n            <td>\n                ').concat(this.model.get("owner")===o.user.attributes.username?"You":this.model.get("owner"),"\n            </td>\n            <td>").concat(this.model.get("number_of_steps"),"</td>\n            <td>").concat(this.model.get("published")?"Yes":"No","</td>\n            <td>").concat(n,"</td>")},renderTagEditor:function(){var o=new m.default.TagsEditor({model:this.model,el:w.default.find(".".concat(this.model.id,".tags-display")),workflow_mode:!0});o.toggle(!0),o.render()},_templateActions:function(){var o=(0,l.getGalaxyInstance)();return this.model.get("owner")===o.user.attributes.username?'<div class="dropdown-menu">\n                        <a class="dropdown-item" href="'.concat((0,r.getAppRoot)(),"workflow/editor?id=").concat(this.model.id,'">Edit</a>\n                        <a class="dropdown-item" href="').concat((0,r.getAppRoot)(),"workflows/run?id=").concat(this.model.id,'">Run</a>\n                        <a class="dropdown-item" href="').concat((0,r.getAppRoot)(),"workflow/sharing?id=").concat(this.model.id,'">Share</a>\n                        <a class="dropdown-item" href="').concat((0,r.getAppRoot)(),"api/workflows/").concat(this.model.id,'/download?format=json-download">Download</a>\n                        <a class="dropdown-item" id="copy-workflow" style="cursor: pointer;">Copy</a>\n                        <a class="dropdown-item" id="rename-workflow" style="cursor: pointer;">Rename</a>\n                        <a class="dropdown-item" href="').concat((0,r.getAppRoot)(),"workflow/display_by_id?id=").concat(this.model.id,'">View</a>\n                        <a class="dropdown-item" id="delete-workflow" style="cursor: pointer;">Delete</a>\n                    </div>'):'<ul class="dropdown-menu">\n                        <li><a href="'.concat((0,r.getAppRoot)(),"workflow/display_by_username_and_slug?username=").concat(this.model.get("owner"),"&slug=").concat(this.model.get("slug"),'">View</a></li>\n                        <li><a href="').concat((0,r.getAppRoot)(),"workflows/run?id=").concat(this.model.id,'">Run</a></li>\n                        <li><a id="copy-workflow" style="cursor: pointer;">Copy</a></li>\n                        <li><a class="link-confirm-shared-').concat(this.model.id,'" href="').concat((0,r.getAppRoot)(),"workflow/sharing?unshare_me=True&id=").concat(this.model.id,'">Remove</a></li>\n                    </ul>')}}),A=h.default.View.extend({title:(0,v.default)("Workflows"),active_tab:"workflow",initialize:function(){y.default.markViewAsLoading(this),u.default.bindAll(this,"adjustActiondropdown"),this.collection=new g.default.WorkflowCollection,this.collection.fetch().done(this.render()),this.collection.bind("add",this.appendItem),this.collection.on("sync",this.render,this)},events:{dragover:"highlightDropZone",dragleave:"unhighlightDropZone"},highlightDropZone:function(o){(0,w.default)(".hidden_description_layer").addClass("dragover"),(0,w.default)(".menubutton").addClass("background-none"),o.preventDefault()},unhighlightDropZone:function(){(0,w.default)(".hidden_description_layer").removeClass("dragover"),(0,w.default)(".menubutton").removeClass("background-none")},drop:function(o){this.unhighlightDropZone(),o.preventDefault();for(var e,t=o.dataTransfer.files,n=0;e=t[n];n++)this.readWorkflowFiles(e)},readWorkflowFiles:function(t){var n=this,r=new FileReader;r.onload=function(o){var e;try{e=JSON.parse(r.result)}catch(o){p.error("Could not read file '".concat(t.name,"'. Verify it is a valid Galaxy workflow")),e=null}e&&n.collection.create(e,{at:0,wait:!0,success:function(){p.success("Successfully imported workflow '".concat(e.name,"'"))},error:function(o,e,t){p.error(t.errorThrown)}})},r.readAsText(t,"utf-8")},_showArgErrors:u.default.once(function(){var o=k.default.get("message");"error"===k.default.get("status")?p.error(u.default.escape(o||"Unknown Error, please report this to an administrator.")):o&&p.info(u.default.escape(o))}),render:function(){var e=this,o=this._templateHeader(),t=this._templateActionButtons(),n=this._templateWorkflowTable();this.$el.html(o+t+n),u.default.each(this.collection.models,function(o){e.appendItem(o),e.confirmDelete(o)});return this.searchWorkflow(this.$(".search-wf"),this.$(".workflow-search tr"),3),this.adjustActiondropdown(),this._showArgErrors(),this.$(".hidden_description_layer").get(0).addEventListener("drop",u.default.bind(this.drop,this)),this},appendItem:function(o){var e=new b({model:o,collection:this.collection});(0,w.default)(".workflow-search").append(e.render().el),e.renderTagEditor()},confirmDelete:function(o){this.$(".link-confirm-shared-".concat(o.id)).click(function(){return window.confirm("Are you sure you want to remove the shared workflow '".concat(o.attributes.name,"'?"))})},searchWorkflow:function(o,t,n){o.on("keyup",function(){var o=(0,w.default)(this).val();if(o.length>=n){var e=new RegExp(o,"i");t.hide(),t.filter(function(){return e.test((0,w.default)(this).text())}).show()}else t.show()})},adjustActiondropdown:function(){(0,w.default)(this.el).on("show.bs.dropdown",function(){(0,w.default)(this.el).css("overflow","inherit")}),(0,w.default)(this.el).on("hide.bs.dropdown",function(){(0,w.default)(this.el).css("overflow","auto")})},_templateNoWorkflow:function(){return'<div class="wf-nodata"> You have no workflows. </div>'},_templateActionButtons:function(){return'<ul class="manage-table-actions"><li><input class="search-wf form-control" type="text" autocomplete="off" placeholder="search for workflow..."></li><li><a class="action-button fa fa-plus wf-action" id="new-workflow" title="Create new workflow" href="'.concat((0,r.getAppRoot)(),'workflows/create"></a></li><li><a class="action-button fa fa-upload wf-action" id="import-workflow" title="Upload or import workflow" href="').concat((0,r.getAppRoot)(),'workflows/import"></a></li></ul>')},_templateWorkflowTable:function(){return"".concat('<table class="table colored"><thead><tr class="header"><th>Name</th><th>Tags</th><th>Owner</th><th># of Steps</th><th>Published</th><th>Show in tools panel</th></tr></thead>','<tbody class="workflow-search "><div class="hidden_description_layer"><p>Drop workflow files here to import</p></tbody></table></div>')},_templateHeader:function(){return'<div class="page-container"><div class="user-workflows wf"><div class="response-message"></div><h2>'+(0,v.default)("Your workflows")+"</h2></div></div>"}});o.default={View:A}});