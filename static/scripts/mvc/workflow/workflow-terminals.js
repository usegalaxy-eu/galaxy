define(["exports"],function(t){"use strict";function o(t){this.collectionType=t,this.isCollection=!0,this.rank=t.split(":").length}Object.defineProperty(t,"__esModule",{value:!0}),window.workflow_globals=window.workflow_globals||{};var a={isCollection:!1,canMatch:function(){return!1},canMapOver:function(){return!1},toString:function(){return"NullCollectionType[]"},append:function(t){return t},equal:function(t){return t===this}},c={isCollection:!0,canMatch:function(t){return a!==t},canMapOver:function(){return!1},toString:function(){return"AnyCollectionType[]"},append:function(){return c},equal:function(t){return t===this}};$.extend(o.prototype,{append:function(t){return t===a?this:t===c?t:new o("".concat(this.collectionType,":").concat(t.collectionType))},canMatch:function(t){return t!==a&&(t===c||t.collectionType==this.collectionType)},canMapOver:function(t){if(t===a)return!1;if(t===c)return!1;if(this.rank<=t.rank)return!1;var e=t.collectionType;return this._endsWith(this.collectionType,e)},effectiveMapOver:function(t){var e=t.collectionType;return new o(this.collectionType.substring(0,this.collectionType.length-e.length-1))},equal:function(t){return t.collectionType==this.collectionType},toString:function(){return"CollectionType[".concat(this.collectionType,"]")},_endsWith:function(t,e){return-1!==t.indexOf(e,t.length-e.length)}});var e=Backbone.Model.extend({initialize:function(t){this.mapOver=t.mapOver||a,this.terminal=t.terminal,this.terminal.terminalMapping=this},disableMapOver:function(){this.setMapOver(a)},setMapOver:function(t){this.mapOver=t,this.trigger("change")}}),n=Backbone.Model.extend({initialize:function(t){this.element=t.element,this.connectors=[]},connect:function(t){this.connectors.push(t),this.node&&this.node.markChanged()},disconnect:function(t){this.connectors.splice($.inArray(t,this.connectors),1),this.node&&(this.node.markChanged(),this.resetMappingIfNeeded(),t.dragging||t.handle2.resetCollectionTypeSource())},redraw:function(){$.each(this.connectors,function(t,e){e.redraw()})},destroy:function(){$.each(this.connectors.slice(),function(t,e){e.destroy()})},destroyInvalidConnections:function(){_.each(this.connectors,function(t){t&&t.destroyIfInvalid()})},setMapOver:function(e){this.multiple||this.mapOver().equal(e)||(this.terminalMapping.setMapOver(e),_.each(this.node.output_terminals,function(t){t.setMapOver(e)}))},mapOver:function(){return this.terminalMapping?this.terminalMapping.mapOver:a},isMappedOver:function(){return this.terminalMapping&&this.terminalMapping.mapOver.isCollection},resetMapping:function(){this.terminalMapping.disableMapOver()},resetCollectionTypeSource:function(){var t=this.node;_.each(t.output_terminals,function(t){t.attributes.collection_type_source&&t.attributes.collection_type&&(t.attributes.collection_type=null,t.update(t.attributes))})},resetMappingIfNeeded:function(){}}),i=n.extend({initialize:function(t){n.prototype.initialize.call(this,t),this.datatypes=t.datatypes},resetMappingIfNeeded:function(){this.node.hasConnectedOutputTerminals()||this.node.hasConnectedMappedInputTerminals()||_.each(this.node.mappedInputTerminals(),function(t){t.resetMappingIfNeeded()}),!this.node.hasMappedOverInputTerminals()&&this.resetMapping()},resetMapping:function(){this.terminalMapping.disableMapOver(),_.each(this.connectors,function(t){var e=t.handle2;e&&(e.resetMappingIfNeeded(),t.destroyIfInvalid())})}}),r=n.extend({initialize:function(t){n.prototype.initialize.call(this,t),this.update(t.input)},canAccept:function(t){return!this._inputFilled()&&this.attachable(t)},resetMappingIfNeeded:function(){this.mapOver().isCollection&&((this.node.hasConnectedMappedInputTerminals()||!this.node.hasConnectedOutputTerminals())&&this.resetMapping())},resetMapping:function(){this.terminalMapping.disableMapOver(),this.node.hasMappedOverInputTerminals()||_.each(this.node.output_terminals,function(t){t.resetMapping()})},connected:function(){return 0!==this.connectors.length},_inputFilled:function(){return!!this.connected()&&(!this.multiple||!!this._collectionAttached())},_collectionAttached:function(){if(this.connected()){var t=this.connectors[0].handle1;return!!t&&!!(t.isCollection||t.isMappedOver()||0<t.datatypes.indexOf("input_collection"))}return!1},_mappingConstraints:function(){if(!this.node)return[];var t=this.mapOver();if(t.isCollection)return[t];var e=[];return this.node.hasConnectedOutputTerminals()?e.push(_.first(_.values(this.node.output_terminals)).mapOver()):_.each(this.node.connectedMappedInputTerminals(),function(t){e.push(t.mapOver())}),e},_producesAcceptableDatatype:function(t){for(var e in this.datatypes){var n=this.datatypes[e];if("input"==n)return!0;var i=[];if(i=i.concat(t.datatypes),t.node.post_job_actions)for(var o in t.node.post_job_actions){var c=t.node.post_job_actions[o];"ChangeDatatypeAction"!=c.action_type||""!==c.output_name&&c.output_name!=t.name||!c.action_arguments||i.push(c.action_arguments.newtype)}for(var a in i){var r=i[a];if("input"==r||"_sniff_"==r||"input_collection"==r||window.workflow_globals.app.isSubType(i[a],n))return!0}}return!1},_otherCollectionType:function(t){var e=a;t.isCollection&&(e=t.collectionType);var n=t.mapOver();return n.isCollection&&(e=n.append(e)),e}}),l=r.extend({update:function(t){this.datatypes=t.extensions,this.multiple=t.multiple,this.collection=!1},connect:function(t){r.prototype.connect.call(this,t);var e=t.handle1;if(e){var n=this._otherCollectionType(e);n.isCollection&&this.setMapOver(n)}},attachable:function(t){var e=this._otherCollectionType(t),n=this.mapOver();{if(e.isCollection)return this.multiple?!(this.connected()&&!this._collectionAttached())&&(1==e.rank&&this._producesAcceptableDatatype(t)):n.isCollection&&n.canMatch(e)?this._producesAcceptableDatatype(t):!!this._mappingConstraints().every(_.bind(e.canMatch,e))&&this._producesAcceptableDatatype(t);if(n.isCollection)return!1}return this._producesAcceptableDatatype(t)}}),s=r.extend({update:function(t){this.type=t.type},connect:function(t){r.prototype.connect.call(this,t)},attachable:function(t){return this.type==t.attributes.type}}),p=r.extend({update:function(t){this.multiple=!1,this.collection=!0,this.datatypes=t.extensions;var e=[];t.collection_types?_.each(t.collection_types,function(t){e.push(new o(t))}):e.push(c),this.collectionTypes=e},connect:function(e){r.prototype.connect.call(this,e);var n=e.handle1;if(n){var t=this.node;_.each(t.output_terminals,function(t){t.attributes.collection_type_source&&!e.dragging&&(n.isMappedOver()?n.isCollection?t.attributes.collection_type=n.terminalMapping.mapOver.append(n.collectionType).collectionType:t.attributes.collection_type=n.terminalMapping.mapOver.collectionType:t.attributes.collection_type=n.attributes.collection_type,t.update(t.attributes))});var i=this._effectiveMapOver(n);this.setMapOver(i)}},_effectiveMapOver:function(t){var e=this.collectionTypes,n=this._otherCollectionType(t);if(!_.some(e,function(t){return t.canMatch(n)}))for(var i in e){var o=e[i];if(n.canMapOver(o)){var c=n.effectiveMapOver(o);if(c!=a)return c}}return a},_effectiveCollectionTypes:function(){var e=this.mapOver();return _.map(this.collectionTypes,function(t){return e.append(t)})},attachable:function(t){var e=this._otherCollectionType(t);if(e.isCollection){var n=this._effectiveCollectionTypes(),i=this.mapOver();if(_.some(n,function(t){return t.canMatch(e)}))return this._producesAcceptableDatatype(t);if(i.isCollection)return!1;if(_.some(this.collectionTypes,function(t){return e.canMapOver(t)})){var o=this._effectiveMapOver(t);if(!o.isCollection)return!1;if(this._mappingConstraints().every(o.canMatch))return this._producesAcceptableDatatype(t)}}return!1}}),u=n.extend({initialize:function(t){(n.prototype.initialize.call(this,t),this.datatypes=t.datatypes,t.collection_type)?this.collectionType=new o(t.collection_type):(t.collection_type_source||console.log("Warning: No collection type or collection type source defined."),this.collectionType=c);this.isCollection=!0},update:function(t){var e;t.collection_type?e=new o(t.collection_type):(t.collection_type_source||console.log("Warning: No collection type or collection type source defined."),e=c);var n=this.collectionType;this.collectionType=e;var i=this.connectors.slice(0);e.collectionType!=n.collectionType&&_.each(i,function(t){t.destroyIfInvalid(!0)})}}),h=n.extend({});t.default={InputTerminal:l,InputParameterTerminal:s,OutputTerminal:i,OutputParameterTerminal:h,InputCollectionTerminal:p,OutputCollectionTerminal:u,TerminalMapping:e,CollectionTypeDescription:o,NULL_COLLECTION_TYPE_DESCRIPTION:a,ANY_COLLECTION_TYPE_DESCRIPTION:c}});