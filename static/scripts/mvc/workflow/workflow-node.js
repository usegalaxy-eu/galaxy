define(["exports","underscore","jquery","backbone","onload/loadConfig","utils/utils","mvc/workflow/workflow-view-node"],function(t,e,o,n,a,i,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var l=d(e),f=d(o),s=d(n),r=d(i),p=d(u);function d(t){return t&&t.__esModule?t:{default:t}}var c=s.default.Model.extend({initialize:function(t,e){this.app=t,this.element=e.element,this.input_terminals={},this.output_terminals={},this.errors={},this.workflow_outputs=[]},getWorkflowOutput:function(t){return l.default.findWhere(this.workflow_outputs,{output_name:t})},isWorkflowOutput:function(t){return void 0!==this.getWorkflowOutput(t)},removeWorkflowOutput:function(t){for(;this.isWorkflowOutput(t);){var e=this.getWorkflowOutput(t);this.workflow_outputs.splice(l.default.indexOf(this.workflow_outputs,e),1)}},addWorkflowOutput:function(t,e){if(this.isWorkflowOutput(t))return!1;var o={output_name:t};return e&&(o.label=e),this.workflow_outputs.push(o),!0},labelWorkflowOutput:function(t,e){var o=!1,n=null;if(this.isWorkflowOutput(t)){var i=this.getWorkflowOutput(t);o=(n=i.label)!=(i.label=e)}else o=this.addWorkflowOutput(t,e);return o&&(this.app.workflow.updateOutputLabel(n,e),this.markChanged(),this.nodeView.redrawWorkflowOutputs()),o},connectedOutputTerminals:function(){return this._connectedTerminals(this.output_terminals)},_connectedTerminals:function(t){var o=[];return f.default.each(t,function(t,e){0<e.connectors.length&&o.push(e)}),o},hasConnectedOutputTerminals:function(){var t=this.output_terminals;for(var e in t)if(0<t[e].connectors.length)return!0;return!1},connectedMappedInputTerminals:function(){return this._connectedMappedTerminals(this.input_terminals)},hasConnectedMappedInputTerminals:function(){var t=this.input_terminals;for(var e in t){var o=t[e];if(0<o.connectors.length&&o.isMappedOver())return!0}return!1},_connectedMappedTerminals:function(t){var o=[];return f.default.each(t,function(t,e){e.mapOver().isCollection&&0<e.connectors.length&&o.push(e)}),o},mappedInputTerminals:function(){return this._mappedTerminals(this.input_terminals)},_mappedTerminals:function(t){var o=[];return f.default.each(t,function(t,e){e.mapOver().isCollection&&o.push(e)}),o},hasMappedOverInputTerminals:function(){var e=!1;return l.default.each(this.input_terminals,function(t){t.mapOver().isCollection&&(e=!0)}),e},redraw:function(){f.default.each(this.input_terminals,function(t,e){e.redraw()}),f.default.each(this.output_terminals,function(t,e){e.redraw()})},clone:function(){var o=this,n={name:this.name,label:this.label,annotation:this.annotation,post_job_actions:this.post_job_actions},i=this.app.workflow.create_node(this.type,this.name,this.content_id);r.default.request({type:"POST",url:"".concat((0,a.getAppRoot)(),"api/workflows/build_module"),data:{type:this.type,tool_id:this.content_id,tool_state:this.tool_state},success:function(t){var e=Object.assign({},t,n);i.init_field_data(e),i.update_field_data(e),o.app.workflow.activate_node(i)}})},destroy:function(){f.default.each(this.input_terminals,function(t,e){e.destroy()}),f.default.each(this.output_terminals,function(t,e){e.destroy()}),this.app.workflow.remove_node(this),(0,f.default)(this.element).remove()},make_active:function(){(0,f.default)(this.element).addClass("toolForm-active")},make_inactive:function(){var t,e=this.element.get(0);(t=e.parentNode).removeChild(e),t.appendChild(e),(0,f.default)(e).removeClass("toolForm-active")},set_tool_version:function(){"tool"===this.type&&this.config_form&&(this.tool_version=this.config_form.version,this.content_id=this.config_form.id)},init_field_data:function(t){t.type&&(this.type=t.type),this.name=t.name,this.config_form=t.config_form,this.set_tool_version(),this.tool_state=t.tool_state,this.errors=t.errors,this.tooltip=t.tooltip?t.tooltip:"",this.annotation=t.annotation,this.post_job_actions=t.post_job_actions?t.post_job_actions:{},this.label=t.label,this.uuid=t.uuid,this.workflow_outputs=t.workflow_outputs?t.workflow_outputs:[];var o=new p.default({el:this.element[0],node:this});this.nodeView=o,f.default.each(t.inputs,function(t,e){o.addDataInput(e)}),0<t.inputs.length&&0<t.outputs.length&&o.addRule(),f.default.each(t.outputs,function(t,e){o.addDataOutput(e)}),o.render(),this.app.workflow.node_changed(this,!0)},update_field_data:function(a){var o=this,n=o.nodeView,u=[];if(f.default.each(n.outputViews,function(t,e){var o=e.output.name,n=a.outputs,i=!1;l.default.each(n,function(t){t.name==o&&(i=!0)}),!1===i&&u.push(o)}),l.default.each(u,function(t){l.default.each(n.outputViews[t].terminalElement.terminal.connectors,function(t){t&&t.destroy()}),n.outputViews[t].remove(),delete n.outputViews[t],delete o.output_terminals[t]}),f.default.each(o.workflow_outputs,function(t,e){e&&!o.output_terminals[e.output_name]&&o.workflow_outputs.splice(t,1)}),f.default.each(a.outputs,function(t,e){n.outputViews[e.name]?(o.output_terminals[e.name].datatypes=e.extensions,o.output_terminals[e.name].destroyInvalidConnections()):n.addDataOutput(e)}),this.tool_state=a.tool_state,this.config_form=a.config_form,this.set_tool_version(),this.errors=a.errors,this.annotation=a.annotation,this.label=a.label,"post_job_actions"in a){var t=a.post_job_actions;this.post_job_actions=t||{}}o.nodeView.renderToolErrors();var e=n.$("div.inputs"),i=n.newInputsDiv(),s={};l.default.each(a.inputs,function(t){var e=o.nodeView.addDataInput(t,i);s[t.name]=e}),l.default.each(l.default.difference(l.default.values(n.terminalViews),l.default.values(s)),function(t){t.el.terminal.destroy()}),n.terminalViews=s,o.nodeView.render();var r=a.outputs;1==r.length&&"collection_type"in r[0]&&n.updateDataOutput(r[0]),e.replaceWith(i),"workflow_outputs"in a&&(this.workflow_outputs=a.workflow_outputs?a.workflow_outputs:[]),this.markChanged(),this.redraw()},error:function(t){var e=(0,f.default)(this.element).find(".toolFormBody");e.find("div").remove();var o="<div style='color: red; text-style: italic;'>".concat(t,"</div>");this.config_form=o,e.html(o),this.app.workflow.node_changed(this)},markChanged:function(){this.app.workflow.node_changed(this)}});t.default=c});