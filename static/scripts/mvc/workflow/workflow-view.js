define(["exports","underscore","jquery","backbone","onload/loadConfig","app","utils/localization","utils/utils","mvc/workflow/workflow-manager","mvc/workflow/workflow-canvas","mvc/workflow/workflow-node","mvc/workflow/workflow-icons","mvc/workflow/workflow-forms","mvc/ui/ui-misc","utils/async-save-text","ui/editable-text"],function(o,t,e,a,u,r,n,i,l,s,d,f,c,w,h){"use strict";Object.defineProperty(o,"__esModule",{value:!0});var p=A(t),_=A(e),v=A(a),m=A(n),k=A(i),g=A(l),y=A(s),b=A(d),x=A(f),S=A(c),T=A(w),C=A(h);function A(o){return o&&o.__esModule?o:{default:o}}function j(o){var t=(0,_.default)("#galaxy_tools").contents();0===t.length&&(t=(0,_.default)(document),(0,_.default)(this).removeClass("search_active"),t.find(".toolTitle").removeClass("search_match"),t.find(".toolSectionBody").hide(),t.find(".toolTitle").show(),t.find(".toolPanelLabel").show(),t.find(".toolSectionWrapper").each(function(){"recently_used_wrapper"!==(0,_.default)(this).attr("id")?(0,_.default)(this).show():(0,_.default)(this).hasClass("user_pref_visible")&&(0,_.default)(this).show()}),t.find("#search-no-results").hide(),t.find("#search-spinner").hide(),o&&t.find("#tool-search-query").val("search tools"))}window.workflow_globals=window.workflow_globals||{},o.default=v.default.View.extend({initialize:function(o){var l=window.workflow_globals.app=this;this.options=o,this.urls=o&&o.urls||{};var e=l.urls.workflow_index,t=function(o,a){if(show_message("Saving workflow","progress"),l.workflow.check_changes_in_active_form(),!l.workflow.has_changes)return hide_modal(),void(a&&a());l.workflow.rectify_workflow_outputs(),k.default.request({url:"".concat((0,u.getAppRoot)(),"api/workflows/").concat(l.options.id),type:"PUT",data:{workflow:l.workflow.to_simple()},success:function(o){var t=(0,_.default)("<div/>").text(o.message);if(o.errors){t.addClass("warningmark");var e=(0,_.default)("<ul/>");_.default.each(o.errors,function(o,t){(0,_.default)("<li/>").text(t).appendTo(e)}),t.append(e)}else t.addClass("donemark");l.workflow.name=o.name,l.workflow.has_changes=!1,l.workflow.stored=!0,l.workflow.workflow_version=o.version,l.showWorkflowParameters(),l.build_version_select(),o.errors?window.show_modal("Saving workflow",t,{Ok:hide_modal}):(a&&a(),hide_modal())},error:function(o){window.show_modal("Saving workflow failed.",o.err_msg,{Ok:hide_modal})}})};(0,_.default)("#search-clear-btn").click(function(){(0,_.default)("#tool-search-query").val(""),j(!1)}),(0,_.default)("#tool-search-query").click(function(){(0,_.default)(this).focus(),(0,_.default)(this).select()}).keyup(function(o){if(27==o.keyCode&&(this.value=""),(0,_.default)(this).css("font-style","normal"),this.value.length<3)j(!1);else if(this.value!=this.lastValue){(0,_.default)(this).addClass("search_active");var t=this.value;this.timer&&window.clearTimeout(this.timer),(0,_.default)("#search-spinner").show(),this.timer=window.setTimeout(function(){_.default.get(l.urls.tool_search,{q:t},function(o){if((0,_.default)("#search-no-results").hide(),(0,_.default)(".toolSectionWrapper").hide(),(0,_.default)(".toolSectionWrapper").find(".toolTitle").hide(),0!==o.length){var t=_.default.map(o,function(o,t){return"link-".concat(o)});(0,_.default)(t).each(function(o,t){(0,_.default)("[id='".concat(t,"']")).parent().addClass("search_match"),(0,_.default)("[id='".concat(t,"']")).parent().show().parent().parent().show().parent().show()}),(0,_.default)(".toolPanelLabel").each(function(){for(var o=(0,_.default)(this),t=o.next(),e=!0;0!==t.length&&t.hasClass("toolTitle");){if(t.is(":visible")){e=!1;break}t=t.next()}e&&o.hide()})}else(0,_.default)("#search-no-results").show();(0,_.default)("#search-spinner").hide()},"json")},400)}this.lastValue=this.value}),this.canvas_manager=window.workflow_globals.canvas_manager=new y.default(this,(0,_.default)("#canvas-viewport"),(0,_.default)("#overview")),this.reset(),this.datatypes=JSON.parse(_.default.ajax({url:"".concat((0,u.getAppRoot)(),"api/datatypes"),async:!1}).responseText),this.datatypes_mapping=JSON.parse(_.default.ajax({url:"".concat((0,u.getAppRoot)(),"api/datatypes/mapping"),async:!1}).responseText),this.ext_to_type=this.datatypes_mapping.ext_to_class_name,this.type_to_type=this.datatypes_mapping.class_to_classes,this.get_workflow_versions=function(){for(var o={},t=JSON.parse(_.default.ajax({url:"".concat((0,u.getAppRoot)(),"api/workflows/").concat(l.options.id,"/versions"),async:!1}).responseText),e=0;e<t.length;e++){var a=t[e],n="Version ".concat(a.version,", ").concat(a.steps," steps"),i=!1;e==l.workflow.workflow_version&&(n="".concat(n," (active)"),i=!0),o[n]={version:e,selected:i}}return o},this.build_version_select=function(){var o=this.get_workflow_versions();(0,_.default)("#workflow-version-switch").empty(),_.default.each(o,function(o,t){(0,_.default)("#workflow-version-switch").append((0,_.default)("<option></option>").html(o).val(t.version).selected(t.selected))}),(0,_.default)("#workflow-version-switch").on("change",function(){if((0,_.default)("#workflow-version-switch").unbind("change"),this.value!=l.workflow.workflow_version){if(l.workflow&&l.workflow.has_changes)if(0==confirm("There are unsaved changes to your workflow which will be lost. Continue ?"))return void l.build_version_select();l.load_workflow(l.options.id,this.value)}})},this.load_workflow=function(o,t){this._workflowLoadAjax(o,t,{success:function(a){l.reset(),l.workflow.from_simple(a,!0),l.workflow.has_changes=!1,l.workflow.fit_canvas_to_nodes(),l.scroll_to_nodes(),l.canvas_manager.draw_overview(),l.build_version_select();var n="";p.default.each(a.steps,function(o,t){var e="";o.errors&&(e+="<li>".concat(o.errors,"</li>")),p.default.each(a.upgrade_messages[t],function(o){e+="<li>".concat(o,"</li>")}),e&&(n+="<li>Step ".concat(parseInt(t,10)+1,": ").concat(l.workflow.nodes[t].name,"<ul>").concat(e,"</ul></li>"))}),n?window.show_modal("Issues loading this workflow","Please review the following issues, possibly resulting from tool upgrades or changes.<p><ul>".concat(n,"</ul></p>"),{Continue:hide_modal}):hide_modal(),l.showWorkflowParameters()},error:function(o){window.show_modal("Loading workflow failed.",o.err_msg,{Ok:function(o){window.onbeforeunload=void 0,window.document.location=e}})},beforeSubmit:function(o){show_message("Loading workflow","progress")}})},this.load_workflow(l.options.id,l.options.version),window.make_popupmenu&&make_popupmenu((0,_.default)("#workflow-options-button"),{Save:t,"Save As":function(){var o=(0,_.default)('<form><label style="display:inline-block; width: 100%;">Save as name: </label><input type="text" id="workflow_rename" style="width: 80%;" autofocus/><br><label style="display:inline-block; width: 100%;">Annotation: </label><input type="text" id="wf_annotation" style="width: 80%;" /></form>');window.show_modal("Save As a New Workflow",o,{OK:function(){var o=0<(0,_.default)("#workflow_rename").val().length?(0,_.default)("#workflow_rename").val():"SavedAs_".concat(l.workflow.name),t=0<(0,_.default)("#wf_annotation").val().length?(0,_.default)("#wf_annotation").val():"";_.default.ajax({url:l.urls.workflow_save_as,type:"POST",data:{workflow_name:o,workflow_annotation:t,workflow_data:function(){return JSON.stringify(l.workflow.to_simple())}}}).done(function(o){window.onbeforeunload=void 0,window.location="".concat((0,u.getAppRoot)(),"workflow/editor?id=").concat(o),hide_modal()}).fail(function(){hide_modal(),alert("Saving this workflow failed. Please contact this site's administrator.")})},Cancel:hide_modal})},Run:function(){window.location="".concat((0,u.getAppRoot)(),"workflows/run?id=").concat(l.options.id)},"Edit Attributes":function(){l.workflow.clear_active_node()},"Auto Re-layout":function(){l.workflow.layout(),l.workflow.fit_canvas_to_nodes(),l.scroll_to_nodes(),l.canvas_manager.draw_overview()},Download:{url:"".concat((0,u.getAppRoot)(),"api/workflows/").concat(l.options.id,"/download?format=json-download"),action:function(){}},Close:function(){if(l.workflow.check_changes_in_active_form(),l.workflow&&l.workflow.has_changes){var o=function(){window.onbeforeunload=void 0,window.document.location=l.urls.workflow_index};window.show_modal("Close workflow editor","There are unsaved changes to your workflow which will be lost.",{Cancel:hide_modal,"Save Changes":function(){t(null,o)}},{"Don't Save":o})}else window.document.location=l.urls.workflow_index}});var a=localStorage.getItem("overview-size");void 0!==a&&(0,_.default)(".workflow-overview").css({width:a,height:a}),(0,_.default)(".workflow-overview").bind("dragend",function(o,t){var e=(0,_.default)(this).offsetParent(),a=e.offset(),n=Math.max(e.width()-(t.offsetX-a.left),e.height()-(t.offsetY-a.top));localStorage.setItem("overview-size","".concat(n,"px"))}),window.onbeforeunload=function(){if(l.workflow&&l.workflow.has_changes)return"There are unsaved changes to your workflow which will be lost."},0<this.options.workflows.length&&(0,_.default)("#left").find(".toolMenu").append(this._buildToolPanelWorkflows()),(0,_.default)("div.toolSectionBody").hide(),(0,_.default)("div.toolSectionTitle > span").wrap("<a href='#'></a>");var n=null;(0,_.default)("div.toolSectionTitle").each(function(){var o=(0,_.default)(this).next("div.toolSectionBody");(0,_.default)(this).click(function(){o.is(":hidden")?(n&&n.slideUp("fast"),(n=o).slideDown("fast")):(o.slideUp("fast"),n=null)})}),(0,C.default)("workflow-name","workflow-name",l.urls.rename_async,"new_name"),(0,_.default)("#workflow-tag").click(function(){return(0,_.default)(".tag-area").click(),!1}),(0,C.default)("workflow-annotation","workflow-annotation",l.urls.annotate_async,"new_annotation",25,!0,4)},_buildToolPanelWorkflows:function(){var a=this,n=(0,_.default)('<div class="toolSectionWrapper"><div class="toolSectionTitle"><a href="#"><span>Workflows</span></a></div><div class="toolSectionBody"><div class="toolSectionBg"/></div></div>');return p.default.each(this.options.workflows,function(t){if(t.id!==a.options.id){var o=new T.default.Button({icon:"fa fa-copy",cls:"ui-button-icon-plain",tooltip:(0,m.default)("Copy and insert individual steps"),onclick:function(){var o=(0,r.getGalaxyInstance)();t.step_count<2?a.copy_into_workflow(t.id,t.name):o.modal.show({title:(0,m.default)("Warning"),body:"This will copy ".concat(t.step_count," new steps into your workflow."),buttons:{Cancel:function(){o.modal.hide()},Copy:function(){o.modal.hide(),a.copy_into_workflow(t.id,t.name)}}})}}),e=(0,_.default)("<a/>").attr("href","#").html(t.name).on("click",function(){a.add_node_for_subworkflow(t.latest_id,t.name)});n.find(".toolSectionBg").append((0,_.default)("<div/>").addClass("toolTitle").append(e).append(o.$el))}}),n},copy_into_workflow:function(o){var a=this;this._workflowLoadAjax(o,None,{success:function(o){a.workflow.from_simple(o,!1);var e="";_.default.each(o.upgrade_messages,function(o,t){e+="<li>Step ".concat(parseInt(o,10)+1,": ").concat(a.workflow.nodes[o].name,"<ul>"),_.default.each(t,function(o,t){e+="<li>".concat(t,"</li>")}),e+="</ul></li>"}),e?window.show_modal("Subworkflow embedded with changes","Problems were encountered loading this workflow (possibly a result of tool upgrades). Please review the following parameters and then save.<ul>".concat(e,"</ul>"),{Continue:hide_modal}):hide_modal()},beforeSubmit:function(o){show_message("Importing workflow","progress")}})},reset:function(){this.workflow&&this.workflow.remove_all(),this.workflow=window.workflow_globals.workflow=new g.default(this,(0,_.default)("#canvas-container"))},scroll_to_nodes:function(){var o,t,e=(0,_.default)("#canvas-viewport"),a=(0,_.default)("#canvas-container");t=a.width()<e.width()?(e.width()-a.width())/2:0,o=a.height()<e.height()?(e.height()-a.height())/2:0,a.css({left:t,top:o})},_workflowLoadAjax:function(o,t,e){_.default.ajax(k.default.merge(e,{url:this.urls.load_workflow,data:{id:o,_:"true",version:t},dataType:"json",cache:!1}))},_moduleInitAjax:function(a,o){var t=this;k.default.request({type:"POST",url:"".concat((0,u.getAppRoot)(),"api/workflows/build_module"),data:o,success:function(o){var e=(0,r.getGalaxyInstance)();a.init_field_data(o),a.update_field_data(o),_.default.each(a.output_terminals,function(o,t){a.addWorkflowOutput(t.name),(0,_.default)(a.element).find(".callout.".concat(t.name.replace(/(?=[()])/g,"\\"))).find("img").attr("src","".concat(e.root,"static/images/fugue/asterisk-small.png"))}),t.workflow.activate_node(a)}})},add_node_for_tool:function(o,t){var e=this.workflow.create_node("tool",t,o);this._moduleInitAjax(e,{type:"tool",tool_id:o,_:"true"})},add_node_for_subworkflow:function(o,t){var e=this.workflow.create_node("subworkflow",t,o);this._moduleInitAjax(e,{type:"subworkflow",content_id:o,_:"true"})},add_node_for_module:function(o,t){var e=this.workflow.create_node(o,t);this._moduleInitAjax(e,{type:o,_:"true"})},display_file_list:function(o){var t="<select id='node_data_list' name='node_data_list'>";for(var e in o.output_terminals)t+="<option value='".concat(e,"'>").concat(e,"</option>");return t+="</select>"},showWorkflowParameters:function(){var a=/\$\{.+?\}/g,e=[],o=(0,_.default)("#workflow-parameters-container"),t=(0,_.default)("#workflow-parameters-box"),n="",i=[];_.default.each(this.workflow.nodes,function(o,t){t.config_form&&t.config_form.inputs&&k.default.deepeach(t.config_form.inputs,function(o){if("string"==typeof o.value){var t=o.value.match(a);t&&(i=i.concat(t))}}),t.post_job_actions&&_.default.each(t.post_job_actions,function(o,t){t.action_arguments&&_.default.each(t.action_arguments,function(o,t){if("string"==typeof t){var e=t.match(a);e&&(i=i.concat(e))}})}),i&&_.default.each(i,function(o,t){-1===_.default.inArray(t,e)&&e.push(t)})}),e&&0!==e.length?(_.default.each(e,function(o,t){n+="<div>".concat(t.substring(2,t.length-1),"</div>")}),o.html(n),t.show()):(o.html(n),t.hide())},showAttributes:function(){(0,_.default)(".right-content").hide(),(0,_.default)("#edit-attributes").show()},showForm:function(o,t){var e="right-content",a="".concat(e,"-").concat(t.id),n=(0,_.default)("#".concat(e)),i=(0,r.getGalaxyInstance)();if(o&&0===n.find("#".concat(a)).length){var l=(0,_.default)('<div id="'.concat(a,'" class="').concat(e,'"/>'));if(o.node=t,o.workflow=this.workflow,o.datatypes=this.datatypes,o.icon=x.default[t.type],o.cls="ui-portlet-section",t){var s="tool"==t.type?"Tool":"Default";l.append(new S.default[s](o).form.$el),n.append(l)}else i.emit.debug("workflow-view::initialize()","Node not found in workflow.")}(0,_.default)(".".concat(e)).hide(),n.find("#".concat(a)).show(),n.show(),n.scrollTop()},isSubType:function(o,t){return o=this.ext_to_type[o],t=this.ext_to_type[t],this.type_to_type[o]&&t in this.type_to_type[o]},prebuildNode:function(o,t,e){var i=this,a=(0,_.default)("<div class='toolForm toolFormInCanvas'/>"),n=(0,_.default)("<div class='toolFormTitle unselectable'><span class='nodeTitle'>".concat(t,"</div></div>"));!function(o,t){var e=x.default[t];if(e){var a=(0,_.default)('<i class="icon fa">&nbsp;</i>').addClass(e);o.before(a)}}(n.find(".nodeTitle"),o),a.append(n),a.css("left",(0,_.default)(window).scrollLeft()+20),a.css("top",(0,_.default)(window).scrollTop()+20),a.append((0,_.default)("<div class='toolFormBody'></div>"));var l=new b.default(this,{element:a});l.type=o,l.content_id=e;var s="<div><img height='16' align='middle' src='".concat((0,u.getAppRoot)(),"static/images/loading_small_white_bg.gif'/> loading tool info...</div>");a.find(".toolFormBody").append(s);var r=(0,_.default)("<div class='buttons' style='float: right;'></div>");"subworkflow"!==o&&r.append((0,_.default)("<div/>").addClass("fa-icon-button fa fa-files-o node-clone").click(function(o){l.clone()})),r.append((0,_.default)("<div/>").addClass("fa-icon-button fa fa-times node-destroy").click(function(o){l.destroy()})),a.appendTo("#canvas-container");var d=(0,_.default)("#canvas-container").position(),f=(0,_.default)("#canvas-container").parent(),c=a.width(),w=a.height();return a.css({left:-d.left+f.width()/2-c/2,top:-d.top+f.height()/2-w/2}),r.prependTo(a.find(".toolFormTitle")),c+=r.width()+10,a.css("width",c),a.bind("dragstart",function(){i.workflow.activate_node(l)}).bind("dragend",function(){i.workflow.node_changed(this),i.workflow.fit_canvas_to_nodes(),i.canvas_manager.draw_overview()}).bind("dragclickonly",function(){i.workflow.activate_node(l)}).bind("drag",function(o,t){var e=(0,_.default)(this).offsetParent().offset(),a=(t.offsetX-e.left)/i.canvas_manager.canvasZoom,n=(t.offsetY-e.top)/i.canvas_manager.canvasZoom;(0,_.default)(this).css({left:a,top:n}),(0,_.default)(this).find(".terminal").each(function(){this.terminal.redraw()})}),l}})});