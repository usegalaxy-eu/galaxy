define(["exports"],function(t){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var o=0;o<e.length;o++){var i=e[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function o(t,e,o){return e&&i(t.prototype,e),o&&i(t,o),t}Object.defineProperty(t,"__esModule",{value:!0});var e=function(){function e(t){n(this,e),this.panel=t}return o(e,[{key:"test",value:function(t,e){var o=this;window.clearTimeout(this.timeout);var i=t.pageX,n=t.pageY,a=$(this.panel),c=a.position(),s=a.width(),h=a.height(),r=a.parent(),v=r.width(),f=r.height(),l=r.offset(),d=l.left,p=l.top,w=d+r.width(),u=p+r.height(),m=-(s-v/2),g=-(h-f/2),k=v/2,_=f/2,b=!1,y=0;i-5<d?c.left<k&&(y=Math.min(23,k-c.left),a.css("left",c.left+y),b=!0):w<i+5?c.left>m&&(y=Math.min(23,c.left-m),a.css("left",c.left-y),b=!0):n-5<p?c.top<_&&(y=Math.min(23,_-c.top),a.css("top",c.top+y),b=!0):u<n+5&&c.top>g&&(y=Math.min(23,c.top-m),a.css("top","".concat(c.top-y,"px")),b=!0),b&&(e(),this.timeout=window.setTimeout(function(){o.test(t,e)},50))}},{key:"stop",value:function(){window.clearTimeout(this.timeout)}}]),e}(),a=[.25,.33,.5,.67,.75,.8,.9,1,1.1,1.25,1.5,1.75,2,2.5,3,4],c=function(){function i(t,e,o){n(this,i),this.app=t,this.cv=e,this.cc=this.cv.find("#canvas-container"),this.overview=o,this.oc=o.find("#overview-canvas"),this.ov=o.find("#overview-viewport"),this.zoomLevel=7,this.canvasZoom=a[7],this.initZoomControls(),this.init_drag(),this.init_copy_paste()}return o(i,[{key:"setZoom",value:function(t){this.zoomLevel=Math.min(Math.max(0,t),a.length),this.canvasZoom=a[this.zoomLevel],this.cv.css("transform-origin","top left"),this.cv.css("transform","scale("+this.canvasZoom+")"),this.cv.css("width","".concat(100/this.canvasZoom,"%")),this.cv.css("height","".concat(100/this.canvasZoom,"%")),this.app.workflow.fit_canvas_to_nodes()}},{key:"initZoomControls",value:function(){var t=this,e=$('<div class="btn-group-vertical"/>').css({position:"absolute",left:"1rem",bottom:"1rem"});e.append($('<div class="btn btn-secondary fa fa-plus"/>').click(function(){return t.setZoom(t.zoomLevel+1)})),e.append($('<div class="btn btn-secondary fa fa-minus"/>').click(function(){return t.setZoom(t.zoomLevel-1)})),this.cv.closest("#workflow-canvas-body").append(e)}},{key:"init_drag",value:function(){var o,i,n=this,h=this,r=function(t,e){t=Math.min(t,h.cv.width()/2),t=Math.max(t,-h.cc.width()+h.cv.width()/2),e=Math.min(e,h.cv.height()/2),e=Math.max(e,-h.cc.height()+h.cv.height()/2),h.cc.css({left:t,top:e}),h.cv.css({"background-position-x":t,"background-position-y":e}),h.update_viewport_overlay()};this.cc.each(function(){this.scroll_panel=new e(this)}),this.cv.bind("click",function(){document.activeElement.blur()}).bind("dragstart",function(){var t=$(this).offset(),e=h.cc.position();i=e.top-t.top,o=e.left-t.left}).bind("drag",function(t,e){r((e.offsetX+o)/n.canvasZoom,(e.offsetY+i)/n.canvasZoom)}).bind("dragend",function(){h.app.workflow.fit_canvas_to_nodes(),h.draw_overview()}),this.overview.click(function(t){if(h.overview.hasClass("blockaclick"))h.overview.removeClass("blockaclick");else{var e=h.cc.width(),o=h.cc.height(),i=h.oc.width(),n=h.oc.height(),a=t.pageX-h.oc.offset().left-h.ov.width()/2,c=t.pageY-h.oc.offset().top-h.ov.height()/2;r(-a/i*e,-c/n*o),h.app.workflow.fit_canvas_to_nodes(),h.draw_overview()}}),this.ov.bind("drag",function(t,e){var o=h.cc.width(),i=h.cc.height(),n=h.oc.width(),a=h.oc.height(),c=e.offsetX-h.overview.offset().left,s=e.offsetY-h.overview.offset().top;r(-c/n*o,-s/a*i)}).bind("dragend",function(){h.overview.addClass("blockaclick"),h.app.workflow.fit_canvas_to_nodes(),h.draw_overview()}),$(".workflow-overview").bind("drag",function(t,e){var o=$(this).offsetParent(),i=o.offset(),n=Math.max(o.width()-(e.offsetX-i.left),o.height()-(e.offsetY-i.top));$(this).css({width:n,height:n}),h.draw_overview()}),$(".workflow-overview div").bind("drag",function(){})}},{key:"init_copy_paste",value:function(){var o=this;document.addEventListener("copy",function(t){""===window.getSelection().toString()&&(o.app.workflow.active_node&&"subworkflow"!==o.app.workflow.active_node.type&&t.clipboardData.setData("application/json",JSON.stringify({nodeId:o.app.workflow.active_node.id})),t.preventDefault())}),document.addEventListener("paste",function(t){if(document.activeElement&&"textarea"!==document.activeElement.type&&"text"!==document.activeElement.type){var e;try{e=JSON.parse(t.clipboardData.getData("application/json")).nodeId}catch(t){console.debug(t)}e&&o.app.workflow.nodes.hasOwnProperty(e)&&o.app.workflow.nodes[e].clone(),t.preventDefault()}})}},{key:"update_viewport_overlay",value:function(){var t=this.cc,e=this.cv,o=this.oc,i=this.ov,n=t.width(),a=t.height(),c=o.width(),s=o.height(),h=t.position();i.css({left:-h.left/n*c,top:-h.top/a*s,width:e.width()/n*c-2,height:e.height()/a*s-2})}},{key:"draw_overview",value:function(){var h,t,r,e,o=$("#overview-canvas"),i=o.parent().parent().width(),v=o.get(0).getContext("2d"),f=$("#canvas-container").width(),l=$("#canvas-container").height(),n=this.cv.width(),a=this.cv.height();f<n&&l<a?(e=(i-(r=f/n*i))/2,t=(i-(h=l/a*i))/2):f<l?(t=0,e=((h=i)-(r=Math.ceil(h*f/l)))/2):(e=0,t=((r=i)-(h=Math.ceil(r*l/f)))/2),o.parent().css({left:e,top:t,width:r,height:h}),o.attr("width",r),o.attr("height",h),$.each(this.app.workflow.nodes,function(t,e){v.fillStyle="gray";var o=$(e.element),i=o.position(),n=i.left/f*r,a=i.top/l*h,c=o.width()/f*r,s=o.height()/l*h;e.errors&&(v.fillStyle="#e31a1e"),v.fillRect(n,a,c,s)}),this.update_viewport_overlay()}}]),i}();t.default=c});