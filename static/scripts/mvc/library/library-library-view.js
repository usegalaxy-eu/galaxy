define(["exports","underscore","jquery","backbone","onload/loadConfig","app","libs/toastr","mvc/library/library-model","mvc/ui/ui-select"],function(e,t,s,i,o,r,a,n,c){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var l=m(t),d=m(s),p=m(i),u=m(a),h=m(n),f=m(c);function m(e){return e&&e.__esModule?e:{default:e}}var _=p.default.View.extend({el:"#center",model:null,options:{},events:{"click .toolbtn_save_permissions":"savePermissions"},initialize:function(e){this.options=l.default.extend(this.options,e),this.options.id&&this.fetchLibrary()},fetchLibrary:function(e){this.options=l.default.extend(this.options,e),this.model=new h.default.Library({id:this.options.id});var t=this;this.model.fetch({success:function(){t.options.show_permissions&&t.showPermissions()},error:function(e,t){var s=(0,r.getGalaxyInstance)();void 0!==t.responseJSON?u.default.error("".concat(t.responseJSON.err_msg," Click this to go back."),"",{onclick:function(){s.libraries.library_router.back()}}):u.default.error("An error occurred. Click this to go back.","",{onclick:function(){s.libraries.library_router.back()}})}})},showPermissions:function(e){this.options=l.default.extend(this.options,e),(0,d.default)(".tooltip").remove(),void 0!==this.options.fetched_permissions&&(0===this.options.fetched_permissions.access_library_role_list.length?this.model.set({is_unrestricted:!0}):this.model.set({is_unrestricted:!1}));var t=!1,s=(0,r.getGalaxyInstance)();s.user&&(t=s.user.isAdmin());var i=this.templateLibraryPermissions();this.$el.html(i({library:this.model,is_admin:t}));var a=this;d.default.get("".concat((0,o.getAppRoot)(),"api/libraries/").concat(a.id,"/permissions?scope=current")).done(function(e){a.prepareSelectBoxes({fetched_permissions:e})}).fail(function(){u.default.error("An error occurred while attempting to fetch library permissions.")}),(0,d.default)('#center [data-toggle="tooltip"]').tooltip({trigger:"hover"}),(0,d.default)("#center").css("overflow","auto")},_serializeRoles:function(e){for(var t=[],s=0;s<e.length;s++)t.push("".concat(e[s][1],":").concat(e[s][0]));return t},prepareSelectBoxes:function(e){this.options=l.default.extend(this.options,e);var t=this.options.fetched_permissions,s=this,i=this._serializeRoles(t.access_library_role_list),a=this._serializeRoles(t.add_library_item_role_list),r=this._serializeRoles(t.manage_library_role_list),o=this._serializeRoles(t.modify_library_role_list);s.accessSelectObject=new f.default.View(this._createSelectOptions(this,"access_perm",i,!0)),s.addSelectObject=new f.default.View(this._createSelectOptions(this,"add_perm",a,!1)),s.manageSelectObject=new f.default.View(this._createSelectOptions(this,"manage_perm",r,!1)),s.modifySelectObject=new f.default.View(this._createSelectOptions(this,"modify_perm",o,!1))},_createSelectOptions:function(e,t,s,i){return i=!0===i&&i,{minimumInputLength:0,css:t,multiple:!0,placeholder:"Click to select a role",container:e.$el.find("#".concat(t)),ajax:{url:"".concat((0,o.getAppRoot)(),"api/libraries/").concat(e.id,"/permissions?scope=available&is_library_access=").concat(i),dataType:"json",quietMillis:100,data:function(e,t){return{q:e,page_limit:10,page:t}},results:function(e,t){var s=10*t<e.total;return{results:e.roles,more:s}}},formatResult:function(e){return"".concat(e.name," type: ").concat(e.type)},formatSelection:function(e){return e.name},initSelection:function(e,t){var s=[];(0,d.default)(e.val().split(",")).each(function(){var e=this.split(":");s.push({id:e[0],name:e[1]})}),t(s)},initialData:s,dropdownCssClass:"bigdrop"}},makeDatasetPrivate:function(){var t=this;d.default.post("".concat((0,o.getAppRoot)(),"api/libraries/datasets/").concat(t.id,"/permissions?action=make_private")).done(function(e){t.model.set({is_unrestricted:!1}),t.showPermissions({fetched_permissions:e}),u.default.success("The dataset is now private to you.")}).fail(function(){u.default.error("An error occurred while attempting to make dataset private.")})},removeDatasetRestrictions:function(){var t=this;d.default.post("".concat((0,o.getAppRoot)(),"api/libraries/datasets/").concat(t.id,"/permissions?action=remove_restrictions")).done(function(e){t.model.set({is_unrestricted:!0}),t.showPermissions({fetched_permissions:e}),u.default.success("Access to this dataset is now unrestricted.")}).fail(function(){u.default.error("An error occurred while attempting to make dataset unrestricted.")})},_extractIds:function(e){for(var t=[],s=e.length-1;0<=s;s--)t.push(e[s].id);return t},savePermissions:function(e){var t=this,s=this._extractIds(this.accessSelectObject.$el.select2("data")),i=this._extractIds(this.addSelectObject.$el.select2("data")),a=this._extractIds(this.manageSelectObject.$el.select2("data")),r=this._extractIds(this.modifySelectObject.$el.select2("data"));d.default.post("".concat((0,o.getAppRoot)(),"api/libraries/").concat(t.id,"/permissions?action=set_permissions"),{"access_ids[]":s,"add_ids[]":i,"manage_ids[]":a,"modify_ids[]":r}).done(function(e){t.showPermissions({fetched_permissions:e}),u.default.success("Permissions saved.")}).fail(function(){u.default.error("An error occurred while attempting to set library permissions.")})},templateLibraryPermissions:function(){return l.default.template(['<div class="library_style_container">',"<div>",'<a href="#">','<button data-toggle="tooltip" data-placement="top" title="Go back to the list of Libraries" class="btn btn-secondary primary-button" type="button">','<span class="fa fa-list"/>',"&nbsp;Libraries","</button>","</a>","</div>","<h1>",'Library: <%= _.escape(library.get("name")) %>',"</h1>",'<div class="alert alert-warning">',"<% if (is_admin) { %>","You are logged in as an <strong>administrator</strong> therefore you can manage any library on this Galaxy instance. Please make sure you understand the consequences.","<% } else { %>","You can assign any number of roles to any of the following permission types. However please read carefully the implications of such actions.","<% }%>","</div>",'<div class="dataset_table">',"<h2>Library permissions</h2>","<h4>Roles that can access the library</h4>",'<div id="access_perm" class="access_perm roles-selection"/>','<div class="alert alert-info roles-selection">',"User with <strong>any</strong> of these roles can access this library. If there are no access roles set on the library it is considered <strong>unrestricted</strong>.","</div>","<h4>Roles that can manage permissions on this library</h4>",'<div id="manage_perm" class="manage_perm roles-selection"/>','<div class="alert alert-info roles-selection">',"User with <strong>any</strong> of these roles can manage permissions on this library (includes giving access).","</div>","<h4>Roles that can add items to this library</h4>",'<div id="add_perm" class="add_perm roles-selection"/>','<div class="alert alert-info roles-selection">',"User with <strong>any</strong> of these roles can add items to this library (folders and datasets).","</div>","<h4>Roles that can modify this library</h4>",'<div id="modify_perm" class="modify_perm roles-selection"/>','<div class="alert alert-info roles-selection">',"User with <strong>any</strong> of these roles can modify this library (name, synopsis, etc.).","</div>",'<button data-toggle="tooltip" data-placement="top" title="Save modifications made on this page" class="btn btn-secondary toolbtn_save_permissions primary-button" type="button">','<span class="fa fa-floppy-o"/>',"&nbsp;Save","</button>","</div>","</div>"].join(""))}});e.default={LibraryView:_}});