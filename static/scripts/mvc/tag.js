define(["exports","underscore","backbone","onload/loadConfig","app","mvc/base-mvc","utils/localization"],function(t,e,i,a,s,n,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var d=h(e),r=h(i),l=h(n),u=h(o);function h(t){return t&&t.__esModule?t:{default:t}}var c=r.default.View.extend(l.default.LoggableMixin).extend(l.default.HiddenUntilActivatedViewMixin).extend({tagName:"div",className:"tags-display",select_width:"100%",events:{},initialize:function(t){(this.show_editor=!1)===t.usePrompt?this.label="":this.label='<label class="prompt">'.concat((0,u.default)("Tags"),"</label>"),this.workflow_mode=t.workflow_mode||!1,this.workflow_mode&&(this.events.click="showEditor",this.events.keydown="keydownHandler"),this.hiddenUntilActivated(t.$activator,t)},render:function(){var t=this;return this.workflow_mode?this.$el.html(this._workflowTemplate()):this.$el.html(this._defaultTemplate()),this.$input().select2({placeholder:"Add tags",width:this.workflow_mode?this.width:this.select_width,tags:function(){return t._getTagsUsed()}}),this._setUpBehaviors(),this},_hashToName:function(t){return t.startsWith("#")?"name:".concat(t.slice(1)):t},_nameToHash:function(t){return t.startsWith("name:")&&(t="#".concat(t.slice(5))),t},_defaultTemplate:function(){return[this.label,this._renderEditor()].join("")},_workflowTemplate:function(){return[this.show_editor?this._renderEditor():this._renderTags()].join(" ")},keydownHandler:function(t){switch(t.which){case 27:this.hideEditor()}},showEditor:function(){this.show_editor=!0,this.render()},hideEditor:function(){this.show_editor=!1,this.render()},_renderEditor:function(){return'<input class="tags-input" value="'.concat(this.tagsToCSV(),'"/>')},_renderTags:function(){var t=this.model.get("tags"),e="".concat((0,a.getAppRoot)(),"static/images/fugue/tag--plus.png"),i=[];return d.default.each(t,function(t){t=0==t.indexOf("name:")?t.slice(5):t;var e='<span class="badge badge-primary badge-tags">'.concat(t,"</span>");i.push(e)}),0===i.length&&i.push("<img src=".concat(e,' class="add-tag-button" title="Add tags"/>')),i.join(" ")},tagsToCSV:function(){var e=this,t=this.model.get("tags");return!d.default.isArray(t)||d.default.isEmpty(t)?"":t.map(function(t){return d.default.escape(e._nameToHash(t))}).sort().join(",")},$input:function(){return this.$el.find("input.tags-input")},_getTagsUsed:function(){var t=(0,s.getGalaxyInstance)();return d.default.map(t.user.get("tags_used"),this._nameToHash)},_setUpBehaviors:function(){var e=this;this.$input().on("change",function(t){t.val=d.default.map(t.val,e._hashToName),e.model.save({tags:t.val}),t.added&&e._addNewTagToTagsUsed("".concat(t.added.text))})},_addNewTagToTagsUsed:function(t){var e=(0,s.getGalaxyInstance)(),i=e.user.get("tags_used");d.default.contains(i,t)||(i.push(t),i.sort(),e.user.set("tags_used",i))},remove:function(){this.$input.off(),this.stopListening(this.model),r.default.View.prototype.remove.call(this)},toString:function(){return["TagsEditor(","".concat(this.model),")"].join("")}});t.default={TagsEditor:c}});