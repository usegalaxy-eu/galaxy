define(["exports","underscore","jquery","backbone","onload/loadConfig","app","utils/localization","utils/utils","utils/deferred","mvc/ui/ui-misc","mvc/form/form-view","mvc/form/form-data","mvc/tool/tool-form-base","mvc/ui/ui-modal","mvc/webhooks","mvc/workflow/workflow-icons"],function(e,t,s,a,h,_,i,o,n,r,l,u,d,c,p,f){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var m=C(t),w=C(s),v=C(a),b=C(i),g=C(o),y=C(n),k=C(r),x=C(l),S=C(u),$=C(d),j=C(c),P=C(p),T=C(f);function C(e){return e&&e.__esModule?e:{default:e}}var H=v.default.View.extend({initialize:function(e){var t=(0,_.getGalaxyInstance)();this.modal=t.modal||new j.default.View,this.model=e&&e.model||new v.default.Model(e),this.deferred=new y.default,e&&e.active_tab&&(this.active_tab=e.active_tab),this.setElement((0,w.default)("<div/>").addClass("ui-form-composite").append(this.$message=(0,w.default)("<div/>").addClass("mb-4")).append(this.$header=(0,w.default)("<div/>")).append(this.$steps=(0,w.default)("<div/>"))),(0,w.default)("body").append(this.$el),this._configure(),this.render()},_configure:function(){var l=this,i=(0,_.getGalaxyInstance)();this.forms=[],this.steps=[],this.links=[],this.parms=[],m.default.each(this.model.get("steps"),function(e,t){i.emit.debug("tool-form-composite::initialize()","".concat(t," : Preparing workflow step."));var s=T.default[e.step_type],a="".concat(parseInt(t+1),": ").concat(e.step_label||e.step_name);e.annotation&&(a+=" - ".concat(e.annotation)),e.step_version&&(a+=" (Galaxy Version ".concat(e.step_version,")")),e=g.default.merge({index:t,fixed_title:m.default.escape(a),icon:s||"",help:null,citations:null,collapsible:!0,collapsed:0<t&&!l._isDataStep(e),sustain_version:!0,sustain_repeats:!0,sustain_conditionals:!0,narrow:!0,text_enable:"Edit",text_disable:"Undo",cls_enable:"fa fa-edit",cls_disable:"fa fa-undo",errors:e.messages,initial_errors:!0,cls:"ui-portlet-section",hide_operations:!0,needs_refresh:!1,always_refresh:"tool"!=e.step_type},e),l.steps[t]=e,l.links[t]=[],l.parms[t]={}}),m.default.each(this.steps,function(e,s){S.default.visitInputs(e.inputs,function(e,t){l.parms[s][t]=e})}),m.default.each(this.steps,function(e,a){m.default.each(e.output_connections,function(s){m.default.each(l.steps,function(e,t){e.step_index===s.input_step_index&&l.links[a].push(e)})})}),m.default.each(this.steps,function(i,o){m.default.each(l.steps,function(t,e){var a={};m.default.each(i.output_connections,function(e){t.step_index===e.input_step_index&&(a[e.input_name]=e)}),m.default.each(l.parms[e],function(e,t){var s=a[t];s&&(e.type="hidden",e.help=e.step_linked?"".concat(e.help,", "):"",e.help+="Output dataset '".concat(s.output_name,"' from step ").concat(parseInt(o)+1),e.step_linked=e.step_linked||[],e.step_linked.push({index:i.index,step_type:i.step_type}))})})});var t=0;function o(e){return l.wp_inputs[e]=l.wp_inputs[e]||{label:e,name:e,type:"text",color:"hsl( ".concat(100*++t,", 70%, 30% )"),style:"ui-form-wp-source",links:[]}}this.wp_inputs={},m.default.each(this.steps,function(s,e){m.default.each(l.parms[e],function(t,e){!function(e,t){for(var s,a=/\$\{(.+?)\}/g;s=a.exec(String(e));)t(o(s[1]))}(t.value,function(e){e.links.push(s),t.wp_linked=!0,t.type="text",t.backdrop=!0,t.style="ui-form-wp-target"})}),m.default.each(s.replacement_parameters,function(e){o(e)})}),m.default.each(this.steps,function(n,e){if("tool"==n.step_type){var r=!0;S.default.visitInputs(n.inputs,function(e,t,s){var a=e.value&&"RuntimeValue"==e.value.__class__,i=-1!=["data","data_collection"].indexOf(e.type),o=s[e.data_ref];e.step_linked&&!l._isDataStep(e.step_linked)&&(r=!1),e.options&&(0==e.options.length&&!r||e.wp_linked)&&(e.is_workflow=!0),o&&(e.is_workflow=o.step_linked&&!l._isDataStep(o.step_linked)||e.wp_linked),(i||e.value&&"RuntimeValue"==e.value.__class__&&!e.step_linked)&&(n.collapsed=!1),a&&(e.value=null),e.flavor="workflow",a||i||"hidden"===e.type||e.wp_linked||(e.optional||!g.default.isEmpty(e.value)&&""!==e.value)&&(e.collapsible_value=e.value,e.collapsible_preview=!0)})}})},render:function(){var t=this;this.deferred.reset(),this._renderHeader(),this._renderMessage(),this._renderParameters(),this._renderHistory(),this._renderUseCachedJob(),this._renderResourceParameters(),m.default.each(this.steps,function(e){t._renderStep(e)})},_renderHeader:function(){var e=this;this.execute_btn=new k.default.Button({icon:"fa-check",title:(0,b.default)("Run workflow"),cls:"btn btn-primary",onclick:function(){e._execute()}}),this.$header.addClass("h4").empty().append("<b>Workflow: ".concat(this.model.get("name"),"<b>")).append(this.execute_btn.$el.addClass("float-right mt-3"))},_renderMessage:function(){this.$message.empty(),this.model.get("has_upgrade_messages")&&this.$message.append(new k.default.Message({message:"Some tools in this workflow may have changed since it was last saved or some errors were found. The workflow may still run, but any new options will have default values. Please review the messages below to make a decision about whether the changes will affect your analysis.",status:"warning",persistent:!0,fade:!1}).$el);var e=this.model.get("step_version_changes");e&&0<e.length&&this.$message.append(new k.default.Message({message:"Some tools are being executed with different versions compared to those available when this workflow was last saved because the other versions are not or no longer available on this Galaxy instance. To upgrade your workflow and dismiss this message simply edit the workflow and re-save it.",status:"warning",persistent:!0,fade:!1}).$el)},_renderParameters:function(){var s=this;this.wp_form=null,m.default.isEmpty(this.wp_inputs)||(this.wp_form=new x.default({title:"<b>Workflow Parameters</b>",inputs:this.wp_inputs,cls:"ui-portlet-section",onchange:function(){m.default.each(s.wp_form.input_list,function(e,t){m.default.each(e.links,function(e){s._refreshStep(e)})})}}),this._append(this.$steps.empty(),this.wp_form.$el))},_renderHistory:function(){this.history_form=new x.default({cls:"ui-portlet-section",title:"<b>History Options</b>",inputs:[{type:"conditional",name:"new_history",test_param:{name:"check",label:"Send results to a new history",type:"boolean",value:"false",help:""},cases:[{value:"true",inputs:[{name:"name",label:"History name",type:"text",value:this.model.get("name")}]}]}]}),this._append(this.$steps,this.history_form.$el)},_renderResourceParameters:function(){this.workflow_resource_parameters_form=null,m.default.isEmpty(this.model.get("workflow_resource_parameters"))||(this.workflow_resource_parameters_form=new x.default({cls:"ui-portlet-section",title:"<b>Workflow Resource Options</b>",inputs:this.model.get("workflow_resource_parameters")}),this._append(this.$steps,this.workflow_resource_parameters_form.$el))},_renderUseCachedJob:function(){var e=(0,_.getGalaxyInstance)(),t={};e.user.attributes.preferences&&"extra_user_preferences"in e.user.attributes.preferences&&(t=JSON.parse(e.user.attributes.preferences.extra_user_preferences));var s="use_cached_job|use_cached_job_checkbox"in t&&t["use_cached_job|use_cached_job_checkbox"];this.display_use_cached_job_checkbox="true"===s,this.display_use_cached_job_checkbox&&(this.job_options_form=new x.default({cls:"ui-portlet-section",title:"<b>Job re-use Options</b>",inputs:[{type:"conditional",name:"use_cached_job",test_param:{name:"check",label:"BETA: Attempt to reuse jobs with identical parameters?",type:"boolean",value:"false",help:"This may skip executing jobs that you have already run."}}]}),this._append(this.$steps,this.job_options_form.$el))},_renderStep:function(a){var i=(0,_.getGalaxyInstance)(),s=this,o=null;this.deferred.execute(function(e){if(s.$steps.addClass("ui-steps"),"tool"==a.step_type)a.postchange=function(t,s){var e={tool_id:a.id,tool_version:a.version,inputs:w.default.extend(!0,{},s.data.create())};s.wait(!0),i.emit.debug("tool-form-composite::postchange()","Sending current state.",e),g.default.request({type:"POST",url:"".concat((0,h.getAppRoot)(),"api/tools/").concat(a.id,"/build"),data:e,success:function(e){s.update(e),s.wait(!1),i.emit.debug("tool-form-composite::postchange()","Received new model.",e),t.resolve()},error:function(e){i.emit.debug("tool-form-composite::postchange()","Refresh request failed.",e),t.reject()}})},o=new $.default(a),a.post_job_actions&&a.post_job_actions.length&&o.portlet.append((0,w.default)("<div/>").addClass("ui-form-element-disabled").append((0,w.default)("<div/>").addClass("ui-form-title").html("<b>Job Post Actions</b>")).append((0,w.default)("<div/>").addClass("ui-form-preview").html(m.default.reduce(a.post_job_actions,function(e,t){return"".concat(e," ").concat(t.short_str)},""))));else{var t=-1!=["data_input","data_collection_input"].indexOf(a.step_type);m.default.each(a.inputs,function(e){e.flavor="module",e.hide_label=t}),o=new x.default(g.default.merge({title:a.fixed_title,onchange:function(){m.default.each(s.links[a.index],function(e){s._refreshStep(e)})},inputs:a.inputs&&0<a.inputs.length?a.inputs:[{type:"hidden",name:"No options available.",ignore:null}]},a)),a.step_label&&o.$el.attr("step-label",a.step_label)}s.forms[a.index]=o,s._append(s.$steps,o.$el),a.needs_refresh&&s._refreshStep(a),o.portlet[s.show_progress?"disable":"enable"](),s.show_progress&&s.execute_btn.model.set({wait:!0,wait_text:"Preparing...",percentage:100*(a.index+1)/s.steps.length}),i.emit.debug("tool-form-composite::initialize()","".concat(a.index," : Workflow step state ready."),a),window.setTimeout(function(){e.resolve()},0)})},_refreshStep:function(e){var l=this,u=this.forms[e.index];u?(m.default.each(l.parms[e.index],function(e,t){if(e.step_linked||e.wp_linked){var s=u.field_list[u.data.match(t)];if(s){var a;if(e.step_linked)a={values:[]},m.default.each(e.step_linked,function(e){if(l._isDataStep(e)){var t=l.forms[e.index].data.create().input;t&&m.default.each(t.values,function(e){a.values.push(e)})}}),!e.multiple&&0<a.values.length&&(a={values:[a.values[0]]});else if(e.wp_linked){a=e.value;for(var i,o=/\$\{(.+?)\}/g;i=o.exec(e.value);){var n=l.wp_form.field_list[l.wp_form.data.match(i[1])],r=n&&n.value();r&&(a=a.split(i[0]).join(r))}}void 0!==a&&s.value(a)}}}),u.trigger("change")):e.needs_refresh=!0},_refreshHistory:function(){var e=(0,_.getGalaxyInstance)(),t=this,s=e&&e.currHistoryPanel&&e.currHistoryPanel.model;this._refresh_history&&window.clearTimeout(this._refresh_history),s&&s.refresh().success(function(){0===s.numOfUnfinishedShownContents()&&(t._refresh_history=window.setTimeout(function(){t._refreshHistory()},s.UPDATE_DELAY))})},_execute:function(){var t=this;this.show_progress=!0,this._enabled(!1),this.deferred.execute(function(e){window.setTimeout(function(){e.resolve(),t._submit()},0)})},_submit:function(){var r=(0,_.getGalaxyInstance)(),l=this,e=this.history_form.data.create(),u={new_history_name:e["new_history|name"]?e["new_history|name"]:null,history_id:e["new_history|name"]?null:this.model.get("history_id"),resource_params:this.workflow_resource_parameters_form?this.workflow_resource_parameters_form.data.create():{},replacement_params:this.wp_form?this.wp_form.data.create():{},parameters:{},parameters_normalized:!0,batch:!0};this.display_use_cached_job_checkbox&&(u.use_cached_job="true"===this.job_options_form.data.create()["use_cached_job|check"]);var t=!0;for(var s in this.forms){var a=this.forms[s],i=a.data.create(),o=l.steps[s],n=o.step_index;for(var d in a.trigger("reset"),i){var c=i[d],p=a.data.match(d),f=a.input_list[p];if(!f.step_linked){if(!(t=this._isDataStep(o)?c&&c.values&&0<c.values.length:f.optional||f.is_workflow&&""!==c||!f.is_workflow&&null!==c)){a.highlight(p);break}u.parameters[n]=u.parameters[n]||{},u.parameters[n][d]=i[d]}}if(!t)break}t?(r.emit.debug("tool-form-composite::submit()","Validation complete.",u),g.default.request({type:"POST",url:"".concat((0,h.getAppRoot)(),"api/workflows/").concat(this.model.id,"/invocations"),data:u,success:function(e){r.emit.debug("tool-form-composite::submit","Submission successful.",e),l.$el.children().hide(),l.$el.append(l._templateSuccess(e)),w.default.isArray(e)&&0<e.length&&(l.$el.append((0,w.default)("<div/>",{id:"webhook-view"})),new P.default.WebhookView({type:"workflow",toolId:u.tool_id,toolVersion:u.tool_version})),l._refreshHistory()},error:function(e){r.emit.debug("tool-form-composite::submit","Submission failed.",e);var t=!1;if(e&&e.err_data)for(var s in l.forms){var a=l.forms[s],i=e.err_data[a.model.get("step_index")];if(i){var o=a.data.matchResponse(i);for(var n in o){a.highlight(n,o[n]),t=!0;break}}}t||l.modal.show({title:(0,b.default)("Workflow submission failed"),body:l._templateError(u,e&&e.err_msg),buttons:{Close:function(){l.modal.hide()}}})},complete:function(){l._enabled(!0)}})):(l._enabled(!0),r.emit.debug("tool-form-composite::submit()","Validation failed.",u))},_append:function(e,t){e.append("<p/>").append(t)},_enabled:function(t){this.execute_btn.model.set({wait:!t,wait_text:"Sending...",percentage:-1}),this.wp_form&&this.wp_form.portlet[t?"enable":"disable"](),this.history_form&&this.history_form.portlet[t?"enable":"disable"](),m.default.each(this.forms,function(e){e&&e.portlet[t?"enable":"disable"]()})},_isDataStep:function(e){for(var t=w.default.isArray(e)?e:[e],s=0;s<t.length;s++){var a=t[s];if(!a||!a.step_type||!a.step_type.startsWith("data"))return!1}return!0},_templateSuccess:function(e){var t=(0,_.getGalaxyInstance)();if(w.default.isArray(e)&&0<e.length){var s="",a="You can check the status of queued jobs and view the resulting data by refreshing the History pane, if this has not already happened automatically.",i=e[0].history_id&&t.currHistoryPanel&&t.currHistoryPanel.model.id!=e[0].history_id||!1;return 1<e.length?(s="<em> - ".concat(e.length," times</em>"),i&&(a='This workflow will generate results in multiple histories.  You can observe progress in the <a href="'.concat((0,h.getAppRoot)(),'history/view_multiple">history multi-view</a>.'))):i&&(a='This workflow will generate results in a new history. <a href="'.concat((0,h.getAppRoot)(),"history/switch_to_history?hist_id=").concat(e[0].history_id,'">Switch to that history now</a>.')),(0,w.default)('\n                <div class="donemessagelarge">\n                    <p>\n                        Successfully invoked workflow <b>'.concat(g.default.sanitize(this.model.get("name")),"</b>").concat(s,".\n                    </p>\n                    <p>\n                        ").concat(a,"\n                    </p>\n                </div>"))}return this._templateError(e,"Invalid success response. No invocations found.")},_templateError:function(e,t){return(0,w.default)("<div/>").addClass("errormessagelarge").append((0,w.default)("<p/>").text("The server could not complete the request. Please contact the Galaxy Team if this error persists. ".concat(JSON.stringify(t)||""))).append((0,w.default)("<pre/>").text(JSON.stringify(e,null,4)))}});e.default={View:H}});