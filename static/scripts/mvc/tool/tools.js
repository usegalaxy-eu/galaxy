define(["exports","underscore","jquery","d3","backbone","onload/loadConfig","app","viz/trackster/util","mvc/dataset/data"],function(e,t,n,i,s,l,a,o,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var u=p(t),d=p(n),c=p(i),h=p(s),f=p(o);function p(e){return e&&e.__esModule?e:{default:e}}var m={hidden:!1,show:function(){this.set("hidden",!1)},hide:function(){this.set("hidden",!0)},toggle:function(){this.set("hidden",!this.get("hidden"))},is_visible:function(){return!this.attributes.hidden}},_=h.default.Model.extend({defaults:{name:null,label:null,type:null,value:null,html:null,num_samples:5},initialize:function(e){this.attributes.html=unescape(this.attributes.html)},copy:function(){return new _(this.toJSON())},set_value:function(e){this.set("value",e||"")}}),v=h.default.Collection.extend({model:_}),g=_.extend({}),y=_.extend({set_value:function(e){this.set("value",parseInt(e,10))},get_samples:function(){return c.default.scale.linear().domain([this.get("min"),this.get("max")]).ticks(this.get("num_samples"))}}),b=y.extend({set_value:function(e){this.set("value",parseFloat(e))}}),w=_.extend({get_samples:function(){return u.default.map(this.get("options"),function(e){return e[0]})}});_.subModelTypes={integer:y,float:b,data:g,select:w};var x=h.default.Model.extend({defaults:{id:null,name:null,description:null,target:null,inputs:[],outputs:[]},urlRoot:"".concat((0,l.getAppRoot)(),"api/tools"),initialize:function(e){this.set("inputs",new v(u.default.map(e.inputs,function(e){return new(_.subModelTypes[e.type]||_)(e)})))},toJSON:function(){var e=h.default.Model.prototype.toJSON.call(this);return e.inputs=this.get("inputs").map(function(e){return e.toJSON()}),e},remove_inputs:function(t){var e=this.get("inputs").filter(function(e){return-1!==t.indexOf(e.get("type"))});this.get("inputs").remove(e)},copy:function(e){var t=new x(this.toJSON());if(e){var n=new h.default.Collection;t.get("inputs").each(function(e){e.get_samples()&&n.push(e)}),t.set("inputs",n)}return t},apply_search_results:function(e){return-1!==u.default.indexOf(e,this.attributes.id)?this.show():this.hide(),this.is_visible()},set_input_value:function(t,e){this.get("inputs").find(function(e){return e.get("name")===t}).set("value",e)},set_input_values:function(t){var n=this;u.default.each(u.default.keys(t),function(e){n.set_input_value(e,t[e])})},run:function(){return this._run()},rerun:function(e,t){return this._run({action:"rerun",target_dataset_id:e.id,regions:t})},get_inputs_dict:function(){var t={};return this.get("inputs").each(function(e){t[e.get("name")]=e.get("value")}),t},_run:function(e){var t=u.default.extend({tool_id:this.id,inputs:this.get_inputs_dict()},e),n=d.default.Deferred(),i=new f.default.ServerStateDeferred({ajax_settings:{url:this.urlRoot,data:JSON.stringify(t),dataType:"json",contentType:"application/json",type:"POST"},interval:2e3,success_fn:function(e){return"pending"!==e}});return d.default.when(i.go()).then(function(e){n.resolve(new r.DatasetCollection(e))}),n}});u.default.extend(x.prototype,m);var $=h.default.Collection.extend({model:x}),S=h.default.Model.extend(m),T=h.default.Model.extend({defaults:{elems:[],open:!1},clear_search_results:function(){u.default.each(this.attributes.elems,function(e){e.show()}),this.show(),this.set("open",!1)},apply_search_results:function(t){var n,i=!0;u.default.each(this.attributes.elems,function(e){e instanceof S?(n=e).hide():e instanceof x&&e.apply_search_results(t)&&(i=!1,n&&n.show())}),i?this.hide():(this.show(),this.set("open",!0))}});u.default.extend(T.prototype,m);var N=h.default.Model.extend({defaults:{search_hint_string:"search tools",min_chars_for_search:3,clear_btn_url:"",visible:!0,query:"",results:null,clear_key:27},urlRoot:"".concat((0,l.getAppRoot)(),"api/tools"),initialize:function(){this.on("change:query",this.do_search)},do_search:function(){var e=this.attributes.query;if(e.length<this.attributes.min_chars_for_search)this.set("results",null);else{var t=e;this.timer&&clearTimeout(this.timer),(0,d.default)("#search-clear-btn").hide(),(0,d.default)("#search-spinner").show();var n=this;this.timer=setTimeout(function(){"undefined"!=typeof ga&&ga("send","pageview","".concat((0,l.getAppRoot)(),"?q=").concat(t)),d.default.get(n.urlRoot,{q:t},function(e){n.set("results",e),(0,d.default)("#search-spinner").hide(),(0,d.default)("#search-clear-btn").show()},"json")},400)}},clear_search:function(){this.set("query",""),this.set("results",null)}});u.default.extend(N.prototype,m);var k=h.default.Model.extend({initialize:function(e){this.attributes.tool_search=e.tool_search,this.attributes.tool_search.on("change:results",this.apply_search_results,this),this.attributes.tools=e.tools,this.attributes.layout=new h.default.Collection(this.parse(e.layout))},parse:function(e){var s=this;return u.default.map(e,function e(t){var n=t.model_class;if(n.indexOf("Tool")===n.length-4)return s.attributes.tools.get(t.id);if("ToolSection"!==n)return"ToolSectionLabel"===n?new S(t):void 0;var i=u.default.map(t.elems,e);return t.elems=i,new T(t)})},clear_search_results:function(){this.get("layout").each(function(e){e instanceof T?e.clear_search_results():e.show()})},apply_search_results:function(){var t=this.get("tool_search").get("results");if(null!==t){var n=null;this.get("layout").each(function(e){e instanceof S?(n=e).hide():e instanceof x?e.apply_search_results(t)&&n&&n.show():(n=null,e.apply_search_results(t))})}else this.clear_search_results()}}),O=h.default.View.extend({initialize:function(){this.model.on("change:hidden",this.update_visible,this),this.update_visible()},update_visible:function(){this.model.attributes.hidden?this.$el.hide():this.$el.show()}}),q=O.extend({tagName:"div",render:function(){var e=(0,d.default)("<div/>");e.append(B.tool_link(this.model.toJSON()));var t=this.model.get("form_style",null);if("upload1"===this.model.id)e.find("a").on("click",function(e){e.preventDefault(),(0,a.getGalaxyInstance)().upload.show()});else if("regular"===t){var n=this;e.find("a").on("click",function(e){e.preventDefault(),(0,a.getGalaxyInstance)().router.push("/",{tool_id:n.model.id,version:n.model.get("version")})})}return this.$el.append(e),this}}),M=O.extend({tagName:"div",className:"toolPanelLabel",render:function(){return this.$el.append((0,d.default)("<span/>").text(this.model.attributes.text)),this}}),j=O.extend({tagName:"div",className:"toolSectionWrapper",initialize:function(){O.prototype.initialize.call(this),this.model.on("change:open",this.update_open,this)},render:function(){this.$el.append(B.panel_section(this.model.toJSON()));var i=this.$el.find(".toolSectionBody");return u.default.each(this.model.attributes.elems,function(e){if(e instanceof x){var t=new q({model:e,className:"toolTitle"});t.render(),i.append(t.$el)}else if(e instanceof S){var n=new M({model:e});n.render(),i.append(n.$el)}}),this},events:{"click .toolSectionTitle > a":"toggle"},toggle:function(){this.model.set("open",!this.model.attributes.open)},update_open:function(){this.model.attributes.open?this.$el.children(".toolSectionBody").slideDown("fast"):this.$el.children(".toolSectionBody").slideUp("fast")}}),z=h.default.View.extend({tagName:"div",id:"tool-search",className:"bar",events:{click:"focus_and_select","keyup :input":"query_changed","change :input":"query_changed","click #search-clear-btn":"clear"},render:function(){return this.$el.append(B.tool_search(this.model.toJSON())),this.model.is_visible()||this.$el.hide(),this.$el.find("[title]").tooltip(),this},focus_and_select:function(){this.$el.find(":input").focus().select()},clear:function(){return this.model.clear_search(),this.$el.find(":input").val(""),this.focus_and_select(),!1},query_changed:function(e){if(this.model.attributes.clear_key&&this.model.attributes.clear_key===e.which)return this.clear(),!1;this.model.set("query",this.$el.find(":input").val())}}),J=h.default.View.extend({tagName:"div",className:"toolMenu",initialize:function(){this.model.get("tool_search").on("change:results",this.handle_search_results,this)},render:function(){var s=this,e=new z({model:this.model.get("tool_search")});return e.render(),s.$el.closest(".unified-panel").find(".unified-panel-controls").append(e.$el),this.model.get("layout").each(function(e){if(e instanceof T){var t=new j({model:e});t.render(),s.$el.append(t.$el)}else if(e instanceof x){var n=new q({model:e,className:"toolTitleNoSection"});n.render(),s.$el.append(n.$el)}else if(e instanceof S){var i=new M({model:e});i.render(),s.$el.append(i.$el)}}),s.$el.find("a.tool-link").click(function(e){var t=(0,d.default)(this).attr("class").split(/\s+/)[0],n=s.model.get("tools").get(t);s.trigger("tool_link_click",e,n)}),this},handle_search_results:function(){var e=this.model.get("tool_search").get("results");e&&0===e.length?(0,d.default)("#search-no-results").show():(0,d.default)("#search-no-results").hide()}}),P=h.default.View.extend({className:"toolForm",render:function(){this.$el.children().remove(),this.$el.append(B.tool_form(this.model.toJSON()))}}),B={tool_search:u.default.template('<input id="tool-search-query" class="search-query parent-width" name="query"\n                placeholder="<%- search_hint_string %>" autocomplete="off" type="text" />\n         <a id="search-clear-btn" title="clear search (esc)"> </a>\n         <span id="search-spinner" class="search-spinner fa fa-spinner fa-spin"></span>\n    '),panel_section:u.default.template(['<div class="toolSectionTitle" id="title_<%- id %>">','<a href="javascript:void(0)"><span><%- name %></span></a>',"</div>",'<div id="<%- id %>" class="toolSectionBody" style="display: none;">','<div class="toolSectionBg"></div>',"<div>"].join("")),tool_link:u.default.template(['<a class="<%- id %> tool-link" href="<%= link %>" target="<%- target %>" minsizehint="<%- min_width %>">','<span class="labels">',"<% _.each( labels, function( label ){ %>",'<span class="badge badge-primary badge-<%- label %>">',"<%- label %>","</span>","<% }); %>","</span>",'<span class="tool-old-link">',"<%- name %>","</span>"," <%- description %>","</a>"].join("")),tool_form:u.default.template(['<div class="toolFormTitle"><%- tool.name %> (version <%- tool.version %>)</div>','<div class="toolFormBody">',"<% _.each( tool.inputs, function( input ){ %>",'<div class="form-row">','<label for="<%- input.name %>"><%- input.label %>:</label>','<div class="form-row-input">',"<%= input.html %>","</div>",'<div class="toolParamHelp" style="clear: both;">',"<%- input.help %>","</div>",'<div style="clear: both;"></div>',"</div>","<% }); %>","</div>",'<div class="form-row form-actions">','<input type="submit" class="btn btn-primary" name="runtool_btn" value="Execute" />',"</div>",'<div class="toolHelp">','<div class="toolHelpBody"><% tool.help %></div>',"</div>"].join(""),{variable:"tool"})};e.default={ToolParameter:_,IntegerToolParameter:y,SelectToolParameter:w,Tool:x,ToolCollection:$,ToolSearch:N,ToolPanel:k,ToolPanelView:J,ToolFormView:P}});