define(["exports","underscore","jquery","onload/loadConfig","app","utils/localization","utils/deferred","mvc/ui/ui-misc","mvc/form/form-view","mvc/webhooks","components/Citations.vue","vue"],function(e,t,n,s,l,o,i,a,r,c,d,u){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var f=y(t),p=y(n),h=y(o),m=y(i),v=y(a),g=y(r),_=y(c),w=y(d),b=y(u);function y(e){return e&&e.__esModule?e:{default:e}}e.default=g.default.extend({initialize:function(e){var t=(0,l.getGalaxyInstance)(),n=this;this.deferred=new m.default,g.default.prototype.initialize.call(this,e),this._update(this.model.get("initialmodel")),this.model.get("listen_to_history")&&t&&t.currHistoryPanel&&this.listenTo(t.currHistoryPanel.collection,"change",function(){n.model.get("onchange")()}),this.$el.on("remove",function(){n._destroy()})},_update:function(t){var n=this;(t=t||this.model.get("buildmodel"))?(this.deferred.reset(),this.deferred.execute(function(e){t(e,n),e.then(function(){n._render()})})):this._render()},_destroy:function(){var e=this;this.$el.off().hide(),this.deferred.execute(function(){g.default.prototype.remove.call(e),(0,l.getGalaxyInstance)().emit.debug("tool-form-base::_destroy()","Destroy view.")})},_render:function(){var n=this,e=this.model.attributes;this.model.set({title:e.fixed_title||"<b>".concat(e.name,"</b> ").concat(e.description," (Galaxy Version ").concat(e.version,")"),operations:!e.hide_operations&&this._operations(),onchange:function(){var t=(0,l.getGalaxyInstance)();n.deferred.reset(),n.deferred.execute(function(e){n.model.get("postchange")(e,n),n.model.get("listen_to_history")&&e.then(function(){n.stopListening(t.currHistoryPanel.collection)})})}}),this.render(),this.model.get("collapsible")||this.$el.append((0,p.default)("<div/>").addClass("mt-2").append(this._footer())),e.tool_errors&&this.message.update({status:"danger",message:e.tool_errors,persistent:!0}),this.show_message&&this.message.update({status:"success",message:"Now you are using '".concat(e.name,"' version ").concat(e.version,", id '").concat(e.id,"'."),persistent:!1}),this.show_message=!0},_operations:function(){var e=this,n=this.model.attributes,t=new v.default.ButtonMenu({icon:"fa-cubes",title:n.narrow?null:"Versions",tooltip:"Select another tool version"});if(!n.sustain_version&&n.versions&&1<n.versions.length)for(var o in n.versions){var i=n.versions[o];i!=n.version&&t.addMenu({title:"Switch to ".concat(i),version:i,icon:"fa-cube",onclick:function(){e.model.set("id",n.id.replace(n.version,this.version)),e.model.set("version",this.version),e._update()}})}else t.$el.hide();var a=new v.default.ButtonMenu({id:"options",icon:"fa-caret-down",title:n.narrow?null:"Options",tooltip:"View available options"});n.biostar_url&&(a.addMenu({icon:"fa-question-circle",title:"Question?",onclick:function(){window.open("".concat(n.biostar_url,"/p/new/post/"))}}),a.addMenu({icon:"fa-search",title:(0,h.default)("Search"),onclick:function(){window.open("".concat(n.biostar_url,"/local/search/page/?q=").concat(n.name))}})),a.addMenu({icon:"fa-share",title:(0,h.default)("Share"),onclick:function(){prompt("Copy to clipboard: Ctrl+C, Enter","".concat(window.location.origin+(0,s.getAppRoot)(),"root?tool_id=").concat(n.id))}});var r=(0,l.getGalaxyInstance)();return r.user&&r.user.get("is_admin")&&a.addMenu({icon:"fa-download",title:(0,h.default)("Download"),onclick:function(){window.location.href="".concat((0,s.getAppRoot)(),"api/tools/").concat(n.id,"/download")}}),n.requirements&&0<n.requirements.length&&a.addMenu({icon:"fa-info-circle",title:(0,h.default)("Requirements"),onclick:function(){!this.requirements_visible||e.portlet.collapsed?(this.requirements_visible=!0,e.portlet.expand(),e.message.update({persistent:!0,message:e._templateRequirements(n),status:"info"})):(this.requirements_visible=!1,e.message.update({message:""}))}}),n.sharable_url&&a.addMenu({icon:"fa-external-link",title:(0,h.default)("See in Tool Shed"),onclick:function(){window.open(n.sharable_url)}}),_.default.load({type:"tool-menu",callback:function(e){e.each(function(e){var t=e.toJSON();t.activate&&t.config.function&&a.addMenu({icon:t.config.icon,title:t.config.title,onclick:function(){new Function("options",t.config.function)(n)}})})}}),{menu:a,versions:t}},_footer:function(){var e=this.model.attributes,t=(0,p.default)("<div/>").append(this._templateHelp(e));if(e.citations){var n=b.default.extend(w.default),o=document.createElement("div");t.append(o),new n({propsData:{id:e.id,source:"tools"}}).$mount(o)}return t},_templateHelp:function(e){var t=(0,p.default)("<div/>").addClass("form-help form-text mt-4").append(e.help);return t.find("a").attr("target","_blank"),t.find("img").each(function(){var e=(0,p.default)(this).attr("src");-1!==e.indexOf("admin_toolshed")&&(0,p.default)(this).attr("src",(0,s.getAppRoot)()+e)}),t},_templateRequirements:function(e){var n=e.requirements.length;if(0<n){var o="This tool requires ";f.default.each(e.requirements,function(e,t){o+=e.name+(e.version?" (Version ".concat(e.version,")"):"")+(t<n-2?", ":t==n-2?" and ":"")});var t=(0,p.default)("<a/>").attr("target","_blank").attr("href","https://galaxyproject.org/tools/requirements/").text("here");return(0,p.default)("<span/>").append("".concat(o,". Click ")).append(t).append(" for more information.")}return"No requirements found."}})});