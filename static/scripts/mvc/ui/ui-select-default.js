define(["exports","utils/utils","mvc/ui/ui-buttons"],function(e,t,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=l(t),s=l(i);function l(e){return e&&e.__esModule?e:{default:e}}var n=Backbone.View.extend({initialize:function(e){var t=this;this.data=[],this.data2=[],this.model=e&&e.model||new Backbone.Model({id:a.default.uid(),cls:"ui-select",error_text:"No options available",empty_text:"Nothing selected",visible:!0,wait:!1,multiple:!1,searchable:!0,optional:!1,disabled:!1,readonly:!1,onchange:function(){},value:null,individual:!1,pagesize:20}).set(e),this.on("change",function(){t.model.get("onchange")&&t.model.get("onchange")(t.value())}),this.listenTo(this.model,"change:data",this._changeData,this),this.listenTo(this.model,"change:disabled",this._changeDisabled,this),this.listenTo(this.model,"change:wait",this._changeWait,this),this.listenTo(this.model,"change:visible",this._changeVisible,this),this.listenTo(this.model,"change:value",this._changeValue,this),this.listenTo(this.model,"change:multiple change:searchable change:cls change:id",this.render,this),this.render()},render:function(){var e=this;this.model.get("searchable")?this._renderSearchable():this._renderClassic(),this.$el.addClass(this.model.get("cls")).attr("id",this.model.get("id")),this.$select.empty().addClass("select").attr("id","".concat(this.model.get("id"),"_select")).prop("multiple",this.model.get("multiple")).on("change",function(){e.value(e._getValue()),e.trigger("change")}),this._changeData(),this._changeWait(),this._changeVisible(),this._changeDisabled()},_renderClassic:function(){var s=this;this.$el.addClass(this.model.get("multiple")?"ui-select-multiple":"ui-select").append(this.$select=$("<select/>")).append(this.$dropdown=$("<div/>")).append(this.$resize=$("<div/>").append(this.$resize_icon=$("<i/>"))),this.model.get("multiple")?(this.$dropdown.hide(),this.$resize_icon.addClass("fa fa-angle-double-right fa-rotate-45").show(),this.$resize.removeClass().addClass("icon-resize").show().off("mousedown").on("mousedown",function(e){var t=e.pageY,i=s.$select.height();s.minHeight=s.minHeight||i,$("#dd-helper").show().on("mousemove",function(e){s.$select.height(Math.max(i+(e.pageY-t),s.minHeight))}).on("mouseup mouseleave",function(){$("#dd-helper").hide().off()})})):(this.$dropdown.show(),this.$resize.hide(),this.$resize_icon.hide())},_renderSearchable:function(){var e=this;this.$el.append(this.$select=$("<div/>")).append(this.$dropdown=$("<div/>")),this.$dropdown.hide(),this.model.get("multiple")||this.$dropdown.show().on("click",function(){e.$select.select2&&e.$select.select2("open")}),this.all_button=null,!this.model.get("multiple")||this.model.get("individual")||this.model.get("readonly")||(this.all_button=new s.default.ButtonCheck({onclick:function(){var t=[];0!==e.all_button.value()&&_.each(e.model.get("data"),function(e){t.push(e.value)}),e.value(t),e.trigger("change")}}),this.$el.prepend(this.all_button.$el))},_match:function(e,t){return!e||""===e||0<=String(t).toUpperCase().indexOf(e.toUpperCase())},_changeData:function(){var s=this;this.data=[],!this.model.get("multiple")&&this.model.get("optional")&&this.data.push({value:"__null__",label:this.model.get("empty_text")}),_.each(this.model.get("data"),function(e){s.data.push(e)}),0===this.length()&&this.data.push({value:"__null__",label:this.model.get("error_text")}),this.model.get("searchable")?(this.data2=[],this.data2index={},_.each(this.data,function(e,t){var i={order:t,id:e.value,text:e.label,tags:e.tags};s.data2.push(i),s.data2index[i.id]=i}),this.$select.data("select2")&&this.$select.select2("destroy"),this.matched_tags={},this.$select.select2({data:this.data2,closeOnSelect:!this.model.get("multiple"),multiple:this.model.get("multiple"),query:function(i){s.matched_tags={};var e=s.model.get("pagesize"),t=_.filter(s.data2,function(e){var t=!1;return _.each(e.tags,function(e){s._match(i.term,e)&&(t=s.matched_tags[e]=!0)}),t||s._match(i.term,e.text)});i.callback({results:t.slice((i.page-1)*e,i.page*e),more:t.length>=i.page*e})},formatResult:function(e){var t="",i=_.filter(e.tags,function(e){return s.matched_tags.hasOwnProperty(e)});return 5<i.length&&(t='&nbsp;<div class="label label-warning">'.concat(i.length-5," more tags</div>")),"\n                    ".concat(_.escape(e.text),"\n                    <div>\n                        ").concat(_.reduce(i.slice(0,5),function(e,t){return"".concat(e,'&nbsp;<div style="').concat(a.default.generateTagStyle(t.slice(5)),'" class="badge badge-primary badge-tags">').concat(_.escape(t),"</div>")},""),"\n                        ").concat(t,"\n                   </div>")}}),this.$(".select2-container .select2-search input").off("blur")):(this.$select.find("option").remove(),_.each(this.data,function(e){s.$select.append($("<option/>").attr("value",e.value).html(_.escape(e.label)))})),this.model.set("disabled",this.model.get("readonly")||0===this.length()),this._changeValue()},_changeDisabled:function(){this.model.get("searchable")?this.$select.select2(this.model.get("disabled")?"disable":"enable"):this.$select.prop("disabled",this.model.get("disabled"))},_changeWait:function(){this.$dropdown.removeClass().addClass("icon-dropdown fa").addClass(this.model.get("wait")?"fa-spinner fa-spin":"fa-caret-down")},_changeVisible:function(){this.$el[this.model.get("visible")?"show":"hide"](),this.$select[this.model.get("visible")?"show":"hide"]()},_changeValue:function(){if(this._setValue(this.model.get("value")),this.model.get("multiple")){if(this.all_button){var e=this._getValue();this.all_button.value($.isArray(e)?e.length:0,this.length())}}else null!==this._getValue()||this.model.get("optional")||this._setValue(this.first())},value:function(e){return void 0!==e&&this.model.set("value",e),this._getValue()},first:function(){return 0<this.data.length?this.data[0].value:null},exists:function(e){return _.findWhere(this.data,{value:e})},text:function(){var e=this._getValue(),t=this.exists($.isArray(e)?e[0]:e);return t?t.label:""},show:function(){this.model.set("visible",!0)},hide:function(){this.model.set("visible",!1)},wait:function(){this.model.set("wait",!0)},unwait:function(){this.model.set("wait",!1)},disabled:function(){return this.model.get("disabled")},enable:function(){this.model.set("disabled",!1)},disable:function(){this.model.set("disabled",!0)},add:function(t,e){_.each(this.model.get("data"),function(e){e.keep&&!_.findWhere(t,{value:e.value})&&t.push(e)}),e&&t&&t.sort(e),this.model.set("data",t)},update:function(e){this.model.set("data",e.data)},setOnChange:function(e){this.model.set("onchange",e)},length:function(){return $.isArray(this.model.get("data"))?this.model.get("data").length:0},_setValue:function(e){var i=this;if(null==e&&(e="__null__"),this.model.get("multiple")?e=$.isArray(e)?e:[e]:$.isArray(e)&&(e=0<e.length?e[0]:"__null__"),this.model.get("searchable")){if($.isArray(e)){var s=[];_.each(e,function(e){var t=i.data2index[e];t&&s.push(t)}),e=s}else e=this.data2index[e];this.$select.select2("data",e)}else this.$select.val(e)},_getValue:function(){var t=null;if(this.model.get("searchable")){var e=this.$select.select2("data");e&&($.isArray(e)?(t=[],e.sort(function(e,t){return e.order-t.order}),_.each(e,function(e){t.push(e.id)})):t=e.id)}else t=this.$select.val();return a.default.isEmpty(t)?null:t}});e.default={View:n}});