define(["exports","underscore","jquery","backbone","onload/loadConfig","app","utils/utils","mvc/upload/upload-utils"],function(t,e,s,a,i,n,l,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var d=f(e),h=f(s),c=f(a),r=f(l),p=f(o);function f(t){return t&&t.__esModule?t:{default:t}}t.default=c.default.View.extend({initialize:function(t){this.model=new c.default.Model({cls:"upload-ftp",class_add:"upload-icon-button fa fa-square-o",class_remove:"upload-icon-button fa fa-check-square-o",class_partial:"upload-icon-button fa fa-minus-square-o",help_enabled:!0,oidc_text:"<br/>If you are signed-in to Galaxy using a third-party identity and you <strong>don't have a Galaxy password</strong> please go to <a href=\"".concat((0,i.getAppRoot)(),'user/reset_password" target="_blank">this</a> page and request a password for your Galaxy account.'),help_text:"This Galaxy server allows you to upload files via FTP. To upload some files, log in to the FTP server at <strong>".concat(t.ftp_upload_site,'</strong> using your Galaxy credentials.\n            For help visit the <a href="https://ftp.usegalaxy.eu" target="_blank">documentation</a>.'),collection:null,onchange:function(){},onadd:function(){},onremove:function(){}}).set(t),this.collection=this.model.get("collection"),(0,n.getGalaxyInstance)().config.enable_oidc&&this.model.set("help_text",this.model.get("help_text")+this.model.get("oidc_text")),this.setElement(this._template()),this.$content=this.$(".upload-ftp-content"),this.$wait=this.$(".upload-ftp-wait"),this.$help=this.$(".upload-ftp-help"),this.$number=this.$(".upload-ftp-number"),this.$disk=this.$(".upload-ftp-disk"),this.$body=this.$(".upload-ftp-body"),this.$warning=this.$(".upload-ftp-warning"),this.$select=this.$(".upload-ftp-select-all"),this.render()},render:function(){var e=this;this.$wait.show(),this.$content.hide(),this.$warning.hide(),this.$help.hide(),p.default.getRemoteFiles(function(t){e.model.set("ftp_files",t),e._index(),e._renderTable()},function(){e._renderTable()})},_renderTable:function(){var e=this,t=this.model.get("ftp_files");if(this.rows=[],t&&0<t.length){this.$body.empty();var s=0;d.default.each(t,function(t){e.rows.push(e._renderRow(t)),s+=t.size}),this.$number.html("".concat(t.length," files")),this.$disk.html(r.default.bytesToString(s,!0)),this.collection&&(this.$("._has_collection").show(),this.$select.addClass(this.model.get("class_add")).off().on("click",function(){e._all()}),this._refresh()),this.$content.show()}else this.$warning.show();this.model.get("help_enabled")&&this.$help.show(),this.$wait.hide()},_renderRow:function(t){var e=this,s=this.model.attributes,a=(0,h.default)(this._templateRow(t)),i=a.find(".icon");if(this.$body.append(a),this.collection){var n=this.ftp_index[t.path];i.addClass(void 0===n?s.class_add:s.class_remove),a.on("click",function(){e._switch(i,t),e._refresh()})}else a.on("click",function(){s.onchange(t)});return i},_index:function(){var e=this;this.ftp_index={},this.collection&&this.collection.each(function(t){"ftp"==t.get("file_mode")&&(e.ftp_index[t.get("file_path")]=t.id)})},_all:function(){var t=this.model.attributes,e=this.model.get("ftp_files"),s=this.$select.hasClass(t.class_add);for(var a in e){var i=e[a],n=this.ftp_index[i.path];(void 0===n&&s||void 0!==n&&!s)&&this._switch(this.rows[a],i)}this._refresh()},_switch:function(t,e){t.removeClass();var s=this.model.attributes,a=this.ftp_index[e.path];if(void 0===a){var i=s.onadd(e);t.addClass(s.class_remove),this.ftp_index[e.path]=i}else s.onremove(a),t.addClass(s.class_add),this.ftp_index[e.path]=void 0},_refresh:function(){var t=d.default.reduce(this.ftp_index,function(t,e){return void 0!==e&&t++,t},0);this.$select.removeClass(),0==t?this.$select.addClass(this.model.get("class_add")):this.$select.addClass(t==this.rows.length?this.model.get("class_remove"):this.model.get("class_partial"))},_templateRow:function(t){return'<tr class="upload-ftp-row">\n                    <td class="_has_collection" style="display: none;">\n                        <div class="icon"/>\n                    </td>\n                    <td class="ftp-name">'.concat(d.default.escape(t.path),'</td>\n                    <td class="ftp-size">').concat(r.default.bytesToString(t.size),'</td>\n                    <td class="ftp-time">').concat(t.ctime,"</td>\n                </tr>")},_template:function(){return'<div class="'.concat(this.model.get("cls"),'">\n                    <div class="upload-ftp-wait fa fa-spinner fa-spin"/>\n                    <div class="upload-ftp-help">').concat(this.model.get("help_text"),'</div>\n                    <div class="upload-ftp-content">\n                        <span style="whitespace: nowrap; float: left;">Available files: </span>\n                        <span style="whitespace: nowrap; float: right;">\n                            <span class="upload-icon fa fa-file-text-o"/>\n                            <span class="upload-ftp-number"/>\n                            <span class="upload-icon fa fa-hdd-o"/>\n                            <span class="upload-ftp-disk"/>\n                        </span>\n                        <table class="grid" style="float: left;">\n                            <thead>\n                                <tr>\n                                    <th class="_has_collection" style="display: none;">\n                                        <div class="upload-ftp-select-all">\n                                    </th>\n                                    <th>Name</th>\n                                    <th>Size</th>\n                                    <th>Created</th>\n                                </tr>\n                            </thead>\n                            <tbody class="upload-ftp-body"/>\n                        </table>\n                    </div>\n                    <div class="upload-ftp-warning warningmessage">Your FTP directory does not contain any files.</div>\n                </div>')}})});