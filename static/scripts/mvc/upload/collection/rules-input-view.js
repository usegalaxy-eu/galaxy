define(["exports","underscore","backbone","onload/loadConfig","app","utils/localization","mvc/ui/ui-misc","mvc/ui/ui-select","mvc/upload/upload-utils","axios"],function(t,e,a,i,r,n,s,l,o,d){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var p=b(e),c=b(a),h=b(n),u=b(s),f=b(l),v=b(o),y=b(d);function b(t){return t&&t.__esModule?t:{default:t}}t.default=c.default.View.extend({initialize:function(t){var e=this;this.app=t,this.options=t.options,this.ftpFiles=[],this.ftpUploadSite=t.currentFtp(),this.setElement(this._template()),this.btnBuild=new u.default.Button({id:"btn-build",title:(0,h.default)("Build"),onclick:function(){e._eventBuild()}}),this.btnBuild.$el.addClass("btn-primary"),this.btnReset=new u.default.Button({id:"btn-reset",title:(0,h.default)("Reset"),onclick:function(){return e._eventReset()}}),this.btnClose=new u.default.Button({id:"btn-close",title:(0,h.default)("Close"),onclick:function(){return e.app.modal.hide()}}),p.default.each([this.btnReset,this.btnBuild,this.btnClose],function(t){e.$(".upload-buttons").prepend(t.$el)});this.dataType="datasets",this.dataTypeView=new f.default.View({css:"upload-footer-selection",container:this.$(".rule-data-type"),data:[{id:"datasets",text:"Datasets"},{id:"collections",text:"Collection(s)"}],value:this.dataType,onchange:function(t){e.dataType=t}});var a=[{id:"paste",text:"Pasted Table"},{id:"dataset",text:"History Dataset"}];this.ftpUploadSite&&a.push({id:"ftp",text:"FTP Directory"}),this.selectionType="paste",this.selectionTypeView=new f.default.View({css:"upload-footer-selection",container:this.$(".rule-select-type"),data:a,value:this.selectionType,onchange:function(t){e.selectionType=t,e._renderSelectedType()}}),this.selectedDatasetId=null,this.$sourceContent=this.$(".upload-rule-source-content"),this.$sourceContent.on("change keyup paste",function(){e._updateBuildState()}),this._renderSelectedType()},_renderSelectedType:function(){var e=this,t=this.selectionType,a=(0,r.getGalaxyInstance)();if("dataset"==t)if(this.datasetSelectorView)this.datasetSelectorView.value(null);else{this.selectedDatasetId=null;var i=(a&&a.currHistoryPanel&&a.currHistoryPanel.model).contents.models,n=[],s=!0,l=!1,o=void 0;try{for(var d,c=i[Symbol.iterator]();!(s=(d=c.next()).done);s=!0){var u=d.value.attributes;"dataset"===u.history_content_type&&n.push({id:u.id,text:"".concat(u.hid,": ").concat(p.default.escape(u.name))})}}catch(t){l=!0,o=t}finally{try{s||null==c.return||c.return()}finally{if(l)throw o}}this.datasetSelectorView=new f.default.View({container:this.$(".dataset-selector"),data:n,placeholder:(0,h.default)("Select a dataset"),onchange:function(t){e._onDataset(t)}})}else"ftp"==t&&v.default.getRemoteFiles(function(t){e._setPreview(t.map(function(t){return t.path}).join("\n")),e.ftpFiles=t});this._updateScreen()},_onDataset:function(t){var e=this,a=(0,r.getGalaxyInstance)();(this.selectedDatasetId=t)?y.default.get("".concat((0,i.getAppRoot)(),"api/histories/").concat(a.currHistoryPanel.model.id,"/contents/").concat(t,"/display")).then(function(t){e._setPreview(t.data)}).catch(function(t){return console.log(t)}):this._setPreview("")},_eventReset:function(){this.datasetSelectorView&&this.datasetSelectorView.value(null),this.$sourceContent.val(""),this._updateScreen()},_eventBuild:function(){var t=this.$sourceContent.val();this._buildSelection(t)},_buildSelection:function(t){var e=this.selectionType,a={},i=(0,r.getGalaxyInstance)();"dataset"==e||"paste"==e?(a.selectionType="raw",a.content=t):"ftp"==e&&(a.selectionType="ftp",a.elements=this.ftpFiles,a.ftpUploadSite=this.ftpUploadSite),a.dataType=this.dataType,i.currHistoryPanel.buildCollection("rules",a,!0),this.app.modal.hide()},_setPreview:function(t){this.$sourceContent.val(t),this._updateScreen()},_updateScreen:function(){this._updateBuildState();var t=this.selectionType;this.$("#upload-rule-dataset-option")["dataset"==t?"show":"hide"](),this.$sourceContent.attr("disabled","paste"!==t)},_updateBuildState:function(){var t=this.$sourceContent.val();this.btnBuild[t?"enable":"disable"](),this.btnBuild.$el[t?"addClass":"removeClass"]("btn-primary")},_template:function(){return'\n            <div class="upload-view-default">\n                <div class="upload-top">\n                    <h6 class="upload-top-info">\n                        Tabular source data to extract collection files and metadata from\n                    </h6>\n                </div>\n                <div class="upload-box" style="height: 335px;">\n                    <span style="width: 25%; display: inline; height: 100%" class="float-left">\n                        <div class="upload-rule-option">\n                            <div class="upload-rule-option-title">'.concat((0,h.default)("Upload data as"),':</div>\n                            <div class="rule-data-type" />\n                        </div>\n                        <div class="upload-rule-option">\n                            <div class="upload-rule-option-title">').concat((0,h.default)("Load tabular data from"),':</div>\n                            <div class="rule-select-type" />\n                        </div>\n                        <div id="upload-rule-dataset-option" class="upload-rule-option">\n                            <div class="upload-rule-option-title">').concat((0,h.default)("Select dataset to load"),':</div>\n                            <div class="dataset-selector" />\n                        </div>\n                    </span>\n                    <span style="display: inline; float: right; width: 75%; height: 300px">\n                    <textarea class="upload-rule-source-content form-control" style="height: 100%"></textarea>\n                    </span>\n                </div>\n                <div class="clear" />\n                \x3c!--\n                <div class="upload-footer">\n                </div>\n                --\x3e\n                <div class="upload-buttons"/>\n                </div>\n        ')}})});