define(["exports","jquery","backbone","underscore","utils/localization","mvc/upload/upload-model","mvc/upload/default/default-row","mvc/upload/upload-ftp","mvc/upload/upload-extension","mvc/ui/ui-popover","mvc/ui/ui-select","mvc/ui/ui-misc","mvc/lazy/lazy-limited","app","utils/uploadbox"],function(t,e,n,o,i,s,a,u,l,c,r,d,h,p){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var f=y(e),_=y(n),b=y(o),g=y(i),v=y(s),m=y(a),x=y(u),w=y(l),$=y(c),z=y(r),S=y(d),C=y(h);function y(t){return t&&t.__esModule?t:{default:t}}t.default=_.default.View.extend({upload_size:0,collection:new v.default.Collection,counter:{announce:0,success:0,error:0,running:0,reset:function(){this.announce=this.success=this.error=this.running=0}},initialize:function(t){var n=this;this.app=t,this.options=t.options,this.list_extensions=t.list_extensions,this.list_genomes=t.list_genomes,this.ui_button=t.ui_button,this.ftp_upload_site=t.currentFtp(),this.setElement(this._template()),this.$uploadbox=this.$(".upload-box"),this.$uploadtable=this.$(".upload-table"),this.btnLocal=new S.default.Button({id:"btn-local",title:(0,g.default)("Choose local file"),onclick:function(){n.uploadbox.select()},icon:"fa fa-laptop"}),this.btnFtp=new S.default.Button({id:"btn-ftp",title:(0,g.default)("Choose FTP file"),onclick:function(){n._eventFtp()},icon:"fa fa-folder-open-o"}),this.btnCreate=new S.default.Button({id:"btn-new",title:"Paste/Fetch data",onclick:function(){n._eventCreate()},icon:"fa fa-edit"}),this.btnStart=new S.default.Button({id:"btn-start",title:(0,g.default)("Start"),onclick:function(){n._eventStart()}}),this.btnStop=new S.default.Button({id:"btn-stop",title:(0,g.default)("Pause"),onclick:function(){n._eventStop()}}),this.btnReset=new S.default.Button({id:"btn-reset",title:(0,g.default)("Reset"),onclick:function(){n._eventReset()}}),this.btnClose=new S.default.Button({id:"btn-close",title:(0,g.default)("Close"),onclick:function(){n.app.modal.hide()}}),b.default.each([this.btnLocal,this.btnFtp,this.btnCreate,this.btnStop,this.btnReset,this.btnStart,this.btnClose],function(t){n.$(".upload-buttons").prepend(t.$el)}),this.uploadbox=this.$uploadbox.uploadbox({url:this.app.options.upload_path,announce:function(t,e){n._eventAnnounce(t,e)},initialize:function(t){return n.app.toData([n.collection.get(t)],n.history_id)},progress:function(t,e){n._eventProgress(t,e)},success:function(t,e){n._eventSuccess(t,e)},error:function(t,e){n._eventError(t,e)},warning:function(t,e){n._eventWarning(t,e)},complete:function(){n._eventComplete()},ondragover:function(){n.$uploadbox.addClass("highlight")},ondragleave:function(){n.$uploadbox.removeClass("highlight")}}),this.ftp=new $.default({title:(0,g.default)("FTP files"),container:this.btnFtp.$el}),this.select_extension=new z.default.View({css:"upload-footer-selection",container:this.$(".upload-footer-extension"),data:b.default.filter(this.list_extensions,function(t){return!t.composite_files}),value:this.options.default_extension,onchange:function(t){n._changeExtension(t)}}),this.$(".upload-footer-extension-info").on("click",function(t){new w.default({$el:(0,f.default)(t.target),title:n.select_extension.text(),extension:n.select_extension.value(),list:n.list_extensions,placement:"top"})}).on("mousedown",function(t){t.preventDefault()}),this.select_genome=new z.default.View({css:"upload-footer-selection",container:this.$(".upload-footer-genome"),data:this.list_genomes,value:this.options.default_genome,onchange:function(t){n._changeGenome(t)}}),this.loader=new C.default({$container:this.$uploadbox,collection:this.collection,new_content:function(t){var e=new m.default(n,{model:t});return n.$uploadtable.find("> tbody:first").append(e.$el),e.render(),e}}),this.collection.on("remove",function(t){n._eventRemove(t)}),this.render()},render:function(){var t="";t=0===this.counter.announce?this.uploadbox.compatible()?"&nbsp;":"Browser does not support Drag & Drop. Try Firefox 4+, Chrome 7+, IE 10+, Opera 12+ or Safari 6+.":0===this.counter.running?"You added ".concat(this.counter.announce," file(s) to the queue. Add more files or click 'Start' to proceed."):"Please wait...".concat(this.counter.announce," out of ").concat(this.counter.running," remaining."),this.$(".upload-top-info").html(t);var e=0===this.counter.running&&0<this.counter.announce+this.counter.success+this.counter.error,n=0===this.counter.running&&0<this.counter.announce,o=0===this.counter.running,i=0<this.counter.announce+this.counter.success+this.counter.error;this.btnReset[e?"enable":"disable"](),this.btnStart[n?"enable":"disable"](),this.btnStart.$el[n?"addClass":"removeClass"]("btn-primary"),this.btnStop[0<this.counter.running?"enable":"disable"](),this.btnLocal[o?"enable":"disable"](),this.btnFtp[o?"enable":"disable"](),this.btnCreate[o?"enable":"disable"](),this.btnFtp.$el[this.ftp_upload_site?"show":"hide"](),this.$(".upload-table")[i?"show":"hide"](),this.$(".upload-helper")[i?"hide":"show"]()},_eventAnnounce:function(t,e){this.counter.announce++;var n=new v.default.Model({id:t,file_name:e.name,file_size:e.size,file_mode:e.mode||"local",file_path:e.path,file_data:e});this.render(),this.collection.add(n)},_eventProgress:function(t,e){var n=this.collection.get(t);n.set({percentage:e,status:"running",info:""}),this.ui_button.model.set("percentage",this._uploadPercentage(e,n.get("file_size")))},_eventSuccess:function(t,e){var n=(0,p.getGalaxyInstance)(),o=this.collection.get(t);o.set({percentage:100,status:"success"}),this.ui_button.model.set("percentage",this._uploadPercentage(100,o.get("file_size"))),this.upload_completed+=100*o.get("file_size"),this.counter.announce--,this.counter.success++,this.render(),n.currHistoryPanel.refreshContents()},_eventWarning:function(t,e){this.collection.get(t).set({status:"warning",info:e})},_eventError:function(t,e){var n=this.collection.get(t);n.set({percentage:100,status:"error",info:e}),this.ui_button.model.set({percentage:this._uploadPercentage(100,n.get("file_size")),status:"danger"}),this.upload_completed+=100*n.get("file_size"),this.counter.announce--,this.counter.error++,this.render()},_eventComplete:function(){this.collection.each(function(t){"queued"==t.get("status")&&t.set("status","init")}),this.counter.running=0,this.render()},_eventRemove:function(t){var e=t.get("status");"success"==e?this.counter.success--:"error"==e?this.counter.error--:this.counter.announce--,this.uploadbox.remove(t.id),this.render()},_eventFtp:function(){var e=this;this.ftp.show(new x.default({collection:this.collection,ftp_upload_site:this.ftp_upload_site,onadd:function(t){return e.uploadbox.add([{mode:"ftp",name:t.path,size:t.size,path:t.path}])},onremove:function(t){e.collection.remove(t)}}).$el)},_eventCreate:function(){this.uploadbox.add([{name:"New File",size:0,mode:"new"}])},_eventStart:function(){if(0!==this.counter.announce&&0===this.counter.running){var e=this;this.upload_size=0,this.upload_completed=0,this.collection.each(function(t){"init"==t.get("status")&&(t.set("status","queued"),e.upload_size+=t.get("file_size"))}),this.ui_button.model.set({percentage:0,status:"success"}),this.counter.running=this.counter.announce,this.history_id=this.app.currentHistory(),this._uploadFtp();var t=(0,p.getGalaxyInstance)();this.uploadbox.start({id:t.user.id,chunk_upload_size:this.app.options.chunk_upload_size}),this.render()}},_eventStop:function(){0<this.counter.running&&(this.ui_button.model.set("status","info"),(0,f.default)(".upload-top-info").html("Queue will pause after completing the current file..."),this.uploadbox.stop())},_eventReset:function(){0===this.counter.running&&(this.collection.reset(),this.counter.reset(),this.uploadbox.reset(),this.select_extension.value(this.options.default_extension),this.select_genome.value(this.options.default_genome),this.ui_button.model.set("percentage",0),this.render())},_changeExtension:function(e,n){var o=this;this.collection.each(function(t){"init"!=t.get("status")||t.get("extension")!=o.options.default_extension&&n||t.set("extension",e)})},_changeGenome:function(e,n){var o=this;this.collection.each(function(t){"init"!=t.get("status")||t.get("genome")!=o.options.default_genome&&n||t.set("genome",e)})},_uploadFtp:function(){var n=this,o=[];this.collection.each(function(t){"queued"==t.get("status")&&"ftp"==t.get("file_mode")&&(n.uploadbox.remove(t.id),o.push(t))}),0<o.length&&f.default.uploadpost({data:this.app.toData(o),url:this.app.options.upload_path,success:function(t){b.default.each(o,function(t){n._eventSuccess(t.id)})},error:function(e){b.default.each(o,function(t){n._eventError(t.id,e)})}})},_uploadPercentage:function(t,e){return(this.upload_completed+t*e)/this.upload_size},_template:function(){return'<div class="upload-view-default">\n                    <div class="upload-top">\n                        <h6 class="upload-top-info"/>\n                    </div>\n                    <div class="upload-box">\n                        <div class="upload-helper">\n                            <i class="fa fa-files-o"/>Drop files here\n                        </div>\n                        <table class="upload-table ui-table-striped" style="display: none;">\n                            <thead>\n                                <tr>\n                                    <th>Name</th>\n                                    <th>Size</th>\n                                    <th>Type</th>\n                                    <th>Genome</th>\n                                    <th>Settings</th>\n                                    <th>Status</th>\n                                    <th/>\n                                </tr>\n                            </thead>\n                            <tbody/>\n                        </table>\n                    </div>\n                    <div class="upload-footer">\n                        <span class="upload-footer-title">Type (set all):</span>\n                        <span class="upload-footer-extension"/>\n                        <span class="upload-footer-extension-info upload-icon-button fa fa-search"/>\n                        <span class="upload-footer-title">Genome (set all):</span>\n                        <span class="upload-footer-genome"/>\n                    </div>\n                    <div class="upload-buttons"/>\n                </div>'}})});