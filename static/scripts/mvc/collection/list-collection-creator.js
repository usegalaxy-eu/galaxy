define(["exports","mvc/history/hdca-model","mvc/dataset/states","mvc/base-mvc","mvc/collection/base-creator","mvc/ui/ui-modal","utils/natural-sort","utils/localization","components/RuleCollectionBuilder.vue","vue","ui/hoverhighlight"],function(e,t,n,l,i,a,s,r,o,c){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var d=b(t),h=b(n),m=b(l),u=b(i),f=b(a),g=(b(s),b(r)),p=b(o),v=b(c);function b(e){return e&&e.__esModule?e:{default:e}}var w="collections",E=Backbone.View.extend(m.default.LoggableMixin).extend({_logNamespace:w,tagName:"li",className:"collection-element",initialize:function(e){this.element=e.element||{},this.selected=e.selected||!1},render:function(){this.dragStartHandler=_.bind(this._dragstart,this),this.dragEndHandler=_.bind(this._dragend,this);var e=this.$el.attr("data-element-id",this.element.id).attr("draggable",!0).html(this.template({element:this.element})).get(0);return e.addEventListener("dragstart",this.dragStartHandler,!1),e.addEventListener("dragend",this.dragEndHandler,!1),this.selected&&this.$el.addClass("selected"),this},template:_.template(['<a class="name" title="',(0,g.default)("Click to rename"),'" href="javascript:void(0)">',"<%- element.name %>","</a>",'<button class="discard btn btn-sm" title="',(0,g.default)("Remove this dataset from the list"),'">',(0,g.default)("Discard"),"</button>"].join("")),select:function(e){this.$el.toggleClass("selected",e),this.trigger("select",{source:this,selected:this.$el.hasClass("selected")})},discard:function(){var e=this,t=this.$el.parent().width();this.$el.animate({"margin-right":t},"fast",function(){e.trigger("discard",{source:e}),e.destroy()})},destroy:function(){this.off(),this.$el.remove()},events:{click:"_click","click .name":"_clickName","click .discard":"_clickDiscard",dragover:"_sendToParent",drop:"_sendToParent"},_click:function(e){e.stopPropagation(),this.select(e)},_clickName:function(e){e.stopPropagation(),e.preventDefault();[(0,g.default)("Enter a new name for the element"),":\n(",(0,g.default)("Note that changing the name here will not rename the dataset"),")"].join("");var t=prompt("".concat((0,g.default)("Enter a new name for the element"),":"),this.element.name);t&&(this.element.name=t,this.render())},_clickDiscard:function(e){e.stopPropagation(),this.discard()},_dragstart:function(e){e.originalEvent&&(e=e.originalEvent),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",JSON.stringify(this.element)),this.$el.addClass("dragging"),this.$el.parent().trigger("collection-element.dragstart",[this])},_dragend:function(e){this.$el.removeClass("dragging"),this.$el.parent().trigger("collection-element.dragend",[this])},_sendToParent:function(e){this.$el.parent().trigger(e)},toString:function(){return"DatasetCollectionElementView()"}}),C=Backbone.View.extend(m.default.LoggableMixin).extend(u.default.CollectionCreatorMixin).extend({_logNamespace:w,elementViewClass:E,collectionClass:d.default.HistoryDatasetCollection,className:"list-collection-creator collection-creator flex-row-container",minElements:1,defaultAttributes:{creationFn:function(){throw new TypeError("no creation fn for creator")},oncreate:function(){},oncancel:function(){},autoscrollDist:24,highlightClr:"rgba( 64, 255, 255, 1.0 )"},footerSettings:{".hide-originals":"hideOriginals"},initialize:function(n){this.metric("ListCollectionCreator.initialize",n);var l=this;_.each(this.defaultAttributes,function(e,t){e=n[t]||e,l[t]=e}),l.initialElements=n.elements||[],this._setUpCommonSettings(n),this._instanceSetUp(),this._elementsSetUp(),this._setUpBehaviors()},_instanceSetUp:function(){this.selectedIds={},this.$dragging=null,this.blocking=!1},_elementsSetUp:function(){this.invalidElements=[],this.workingElements=[],this.elementViews=[],this.workingElements=this.initialElements.slice(0),this._ensureElementIds(),this._validateElements(),this._mangleDuplicateNames(),this._sortElements()},_ensureElementIds:function(){return this.workingElements.forEach(function(e){e.hasOwnProperty("id")||(e.id=_.uniqueId())}),this.workingElements},_validateElements:function(){var n=this;return n.invalidElements=[],this.workingElements=this.workingElements.filter(function(e){var t=n._isElementInvalid(e);return t&&n.invalidElements.push({element:e,text:t}),!t}),this.workingElements},_isElementInvalid:function(e){return"dataset_collection"===e.history_content_type?(0,g.default)("is a collection, this is not allowed"):e.state===h.default.OK||_.contains(h.default.NOT_READY_STATES,e.state)?e.deleted||e.purged?(0,g.default)("has been deleted or purged"):null:(0,g.default)("has errored, is paused, or is not accessible")},_mangleDuplicateNames:function(){var n=1,l={};this.workingElements.forEach(function(e){for(var t=e.name;l.hasOwnProperty(t);)if(t="".concat(e.name," (").concat(n,")"),900<=(n+=1))throw new Error("Safety hit in while loop - thats impressive");e.name=t,l[e.name]=!0})},_sortElements:function(e){},render:function(e,t){return this.workingElements.length<this.minElements?this._renderInvalid(e,t):(this.$el.empty().html(this.templates.main()),this._renderHeader(e),this._renderMiddle(e),this._renderFooter(e),this._addPluginComponents(),this.$(".collection-name").focus(),this.trigger("rendered",this),this)},_renderInvalid:function(e,t){return this.$el.empty().html(this.templates.invalidInitial({problems:this.invalidElements,elements:this.workingElements})),"function"==typeof this.oncancel&&this.$(".cancel-create.btn").show(),this.trigger("rendered",this),this},_renderHeader:function(e,t){var n=this.$(".header").empty().html(this.templates.header()).find(".help-content").prepend($(this.templates.helpContent()));return this.invalidElements.length&&this._invalidElementsAlert(),n},_renderMiddle:function(e,t){var n=this.$(".middle").empty().html(this.templates.middle());return this._renderList(e),n},_addPluginComponents:function(){this.$(".help-content i").hoverhighlight(".collection-creator",this.highlightClr)},_invalidElementsAlert:function(){this._showAlert(this.templates.invalidElements({problems:this.invalidElements}),"alert-warning")},_disableNameAndCreate:function(e){(e=!!_.isUndefined(e)||e)&&(this.$(".collection-name").prop("disabled",!0),this.$(".create-collection").toggleClass("disabled",!0))},$list:function(){return this.$(".collection-elements")},_renderClearSelected:function(){_.size(this.selectedIds)?this.$(".collection-elements-controls > .clear-selected").show():this.$(".collection-elements-controls > .clear-selected").hide()},_renderList:function(e,t){var n=this,l=jQuery("<div/>"),i=n.$list();_.each(this.elementViews,function(e){e.destroy(),n.removeElementView(e)}),n.workingElements.forEach(function(e){var t=n._createElementView(e);l.append(t.$el)}),n._renderClearSelected(),i.empty().append(l.children()),_.invoke(n.elementViews,"render"),i.height()>i.css("max-height")?i.css("border-width","1px 0px 1px 0px"):i.css("border-width","0px")},_createElementView:function(e){var t=new this.elementViewClass({element:e,selected:_.has(this.selectedIds,e.id)});return this.elementViews.push(t),this._listenToElementView(t),t},_listenToElementView:function(e){var n=this;n.listenTo(e,{select:function(e){var t=e.source.element;e.selected?n.selectedIds[t.id]=!0:delete n.selectedIds[t.id],n.trigger("elements:select",e)},discard:function(e){n.trigger("elements:discard",e)}})},addElementView:function(e){},removeElementView:function(e){delete this.selectedIds[e.element.id],this._renderClearSelected(),this.elementViews=_.without(this.elementViews,e),this.stopListening(e)},_renderNoElementsLeft:function(){this._disableNameAndCreate(!0),this.$(".collection-elements").append(this.templates.noElementsLeft())},_elementToJSON:function(e){return e},createList:function(e){if(!this.workingElements.length){var t="".concat((0,g.default)("No valid elements for final list"),". ");return t+='<a class="cancel-create" href="javascript:void(0);">'.concat((0,g.default)("Cancel"),"</a> "),t+=(0,g.default)("or"),t+=' <a class="reset" href="javascript:void(0);">'.concat((0,g.default)("start over"),"</a>."),void this._showAlert(t)}var l=this,n=this.workingElements.map(function(e){return l._elementToJSON(e)});return l.blocking=!0,l.creationFn(n,e,l.hideOriginals).always(function(){l.blocking=!1}).fail(function(e,t,n){l.trigger("error",{xhr:e,status:t,message:(0,g.default)("An error occurred while creating this collection")})}).done(function(e,t,n){l.trigger("collection:created",e,t,n),l.metric("collection:created",e),"function"==typeof l.oncreate&&l.oncreate.call(this,e,t,n)})},_setUpBehaviors:function(){return this.on("error",this._errorHandler),this.once("rendered",function(){this.trigger("rendered:initial",this)}),this.on("elements:select",function(e){this._renderClearSelected()}),this.on("elements:discard",function(e){var t=e.source.element;this.removeElementView(e.source),this.workingElements=_.without(this.workingElements,t),this.workingElements.length||this._renderNoElementsLeft()}),this},_errorHandler:function(e){this.error(e);var t=e.message||(0,g.default)("An error occurred");if(e.xhr){var n=e.xhr,l=e.message;0===n.readyState&&0===n.status?t+=": ".concat((0,g.default)("Galaxy could not be reached and may be updating.")).concat((0,g.default)(" Try again in a few minutes.")):n.responseJSON?t+=":<br /><pre>".concat(JSON.stringify(n.responseJSON),"</pre>"):t+=": ".concat(l)}this._showAlert(t,"alert-danger")},events:{"click .more-help":"_clickMoreHelp","click .less-help":"_clickLessHelp","click .main-help":"_toggleHelp","click .header .alert button":"_hideAlert","click .reset":"reset","click .clear-selected":"clearSelectedElements","click .collection-elements":"clearSelectedElements","dragover .collection-elements":"_dragoverElements","drop .collection-elements":"_dropElements","collection-element.dragstart .collection-elements":"_elementDragstart","collection-element.dragend   .collection-elements":"_elementDragend","change .collection-name":"_changeName","keydown .collection-name":"_nameCheckForEnter","change .hide-originals":"_changeHideOriginals","click .cancel-create":"_cancelCreate","click .create-collection":"_clickCreate"},reset:function(){this._instanceSetUp(),this._elementsSetUp(),this.render()},clearSelectedElements:function(e){this.$(".collection-elements .collection-element").removeClass("selected"),this.$(".collection-elements-controls > .clear-selected").hide()},_dragoverElements:function(e){e.preventDefault();var t=this.$list();this._checkForAutoscroll(t,e.originalEvent.clientY);var n=this._getNearestElement(e.originalEvent.clientY);this.$(".element-drop-placeholder").remove();var l=$('<div class="element-drop-placeholder"></div>');n.length?n.before(l):t.append(l)},_checkForAutoscroll:function(e,t){var n=e.offset(),l=e.scrollTop(),i=t-n.top,a=n.top+e.outerHeight()-t;0<=i&&i<this.autoscrollDist?e.scrollTop(l-2):0<=a&&a<this.autoscrollDist&&e.scrollTop(l+2)},_getNearestElement:function(e){for(var t=this.$(".collection-elements li.collection-element").toArray(),n=0;n<t.length;n++){var l=$(t[n]),i=l.offset().top,a=Math.floor(l.outerHeight()/2)+4;if(e<i+a&&i-a<e)return l}return $()},_dropElements:function(e){e.originalEvent&&(e=e.originalEvent),e.preventDefault(),e.dataTransfer.dropEffect="move";var t=this._getNearestElement(e.clientY);return t.length?this.$dragging.insertBefore(t):this.$dragging.insertAfter(this.$(".collection-elements .collection-element").last()),this._syncOrderToDom(),!1},_syncOrderToDom:function(){var n=this,l=[];this.$(".collection-elements .collection-element").each(function(){var e=$(this).attr("data-element-id"),t=_.findWhere(n.workingElements,{id:e});t?l.push(t):console.error("missing element: ",e)}),this.workingElements=l,this._renderList()},_elementDragstart:function(e,t){t.select(!0),this.$dragging=this.$(".collection-elements .collection-element.selected")},_elementDragend:function(e,t){$(".element-drop-placeholder").remove(),this.$dragging=null},templates:_.extend({},u.default.CollectionCreatorMixin._creatorTemplates,{header:_.template(['<div class="main-help well clear">','<a class="more-help" href="javascript:void(0);">',(0,g.default)("More help"),"</a>",'<div class="help-content">','<a class="less-help" href="javascript:void(0);">',(0,g.default)("Less"),"</a>","</div>","</div>",'<div class="alert alert-dismissable">','<button type="button" class="close" data-dismiss="alert" ','title="',(0,g.default)("Close and show more help"),'" aria-hidden="true">&times;</button>','<span class="alert-message"></span>',"</div>"].join("")),middle:_.template(['<div class="collection-elements-controls">','<a class="reset" href="javascript:void(0);" ','title="',(0,g.default)("Undo all reordering and discards"),'">',(0,g.default)("Start over"),"</a>",'<a class="clear-selected" href="javascript:void(0);" ','title="',(0,g.default)("De-select all selected datasets"),'">',(0,g.default)("Clear selected"),"</a>","</div>",'<div class="collection-elements scroll-container flex-row">',"</div>"].join("")),footer:_.template(['<div class="attributes clear">','<div class="clear">','<label class="setting-prompt float-right">',(0,g.default)("Hide original elements"),"?",'<input class="hide-originals float-right" type="checkbox" />',"</label>","</div>",'<div class="clear">','<input class="collection-name form-control float-right" ','placeholder="',(0,g.default)("Enter a name for your new collection"),'" />','<div class="collection-name-prompt float-right">',(0,g.default)("Name"),":</div>","</div>","</div>",'<div class="actions clear vertically-spaced">','<div class="other-options float-left">','<button class="cancel-create btn" tabindex="-1">',(0,g.default)("Cancel"),"</button>",'<div class="create-other btn-group dropup">','<button class="btn btn-secondary dropdown-toggle" data-toggle="dropdown">',(0,g.default)("Create a different kind of collection"),' <span class="caret"></span>',"</button>",'<ul class="dropdown-menu" role="menu">','<li><a href="#">',(0,g.default)("Create a <i>single</i> pair"),"</a></li>",'<li><a href="#">',(0,g.default)("Create a list of <i>unpaired</i> datasets"),"</a></li>","</ul>","</div>","</div>",'<div class="main-options float-right">','<button class="create-collection btn btn-primary">',(0,g.default)("Create list"),"</button>","</div>","</div>"].join("")),helpContent:_.template(["<p>",(0,g.default)(["Collections of datasets are permanent, ordered lists of datasets that can be passed to tools and ","workflows in order to have analyses done on each member of the entire group. This interface allows ","you to create a collection and re-order the final collection."].join("")),"</p>","<ul>","<li>",(0,g.default)(["Rename elements in the list by clicking on ",'<i data-target=".collection-element .name">the existing name</i>.'].join("")),"</li>","<li>",(0,g.default)(["Discard elements from the final created list by clicking on the ",'<i data-target=".collection-element .discard">"Discard"</i> button.'].join("")),"</li>","<li>",(0,g.default)(["Reorder the list by clicking and dragging elements. Select multiple elements by clicking on ",'<i data-target=".collection-element">them</i> and you can then move those selected by dragging the ',"entire group. Deselect them by clicking them again or by clicking the ",'the <i data-target=".clear-selected">"Clear selected"</i> link.'].join("")),"</li>","<li>",(0,g.default)(['Click the <i data-target=".reset">"Start over"</i> link to begin again as if you had just opened ',"the interface."].join("")),"</li>","<li>",(0,g.default)(['Click the <i data-target=".cancel-create">"Cancel"</i> button to exit the interface.'].join("")),"</li>","</ul><br />","<p>",(0,g.default)(['Once your collection is complete, enter a <i data-target=".collection-name">name</i> and ','click <i data-target=".create-collection">"Create list"</i>.'].join("")),"</p>"].join("")),invalidElements:_.template([(0,g.default)("The following selections could not be included due to problems:"),"<ul><% _.each( problems, function( problem ){ %>","<li><b><%- problem.element.name %></b>: <%- problem.text %></li>","<% }); %></ul>"].join("")),noElementsLeft:_.template(['<li class="no-elements-left-message">',(0,g.default)("No elements left! "),(0,g.default)("Would you like to "),'<a class="reset" href="javascript:void(0)">',(0,g.default)("start over"),"</a>?","</li>"].join("")),invalidInitial:_.template(['<div class="header flex-row no-flex">','<div class="alert alert-warning" style="display: block">','<span class="alert-message">',"<% if( _.size( problems ) ){ %>",(0,g.default)("The following selections could not be included due to problems"),":","<ul><% _.each( problems, function( problem ){ %>","<li><b><%- problem.element.name %></b>: <%- problem.text %></li>","<% }); %></ul>","<% } else if( _.size( elements ) < 1 ){ %>",(0,g.default)("No datasets were selected"),".","<% } %>","<br />",(0,g.default)("At least one element is needed for the collection"),". ",(0,g.default)("You may need to "),'<a class="cancel-create" href="javascript:void(0)">',(0,g.default)("cancel"),"</a> ",(0,g.default)("and reselect new elements"),".","</span>","</div>","</div>",'<div class="footer flex-row no-flex">','<div class="actions clear vertically-spaced">','<div class="other-options float-left">','<button class="cancel-create btn" tabindex="-1">',(0,g.default)("Cancel"),"</button>","</div>","</div>","</div>"].join(""))}),toString:function(){return"ListCollectionCreator"}}),y=function(t){var n=jQuery.Deferred(),l=Galaxy.modal||new f.default.View,e=_.defaults(t||{},{oncancel:function(){l.hide(),n.reject("cancelled")},oncreate:function(e,t){l.hide(),n.resolve(t)}});return{deferred:n,creatorOptions:e,showEl:function(e){l.show({title:t.title||(0,g.default)("Create a collection"),body:e,width:"85%",height:"100%",xlarge:!0,closing_events:!0})}}},k=function(e,t,n){t=_.defaults(t||{},{elements:e});var l=y(t),i=l.deferred,a=l.creatorOptions,s=l.showEl,r=new n(a);return s(r.$el),r.render(),i},x=function(e,t,n,l){var i;i="datasets"==n?(0,g.default)("Build Rules for Uploading Datasets"):"collection_contents"==t?(0,g.default)("Build Rules for Applying to Existing Collection"):"datasets"==t||"library_datasets"==t?(0,g.default)("Build Rules for Creating Collection(s)"):(0,g.default)("Build Rules for Uploading Collections"),l=_.defaults(l||{},{title:i});var a=y(l),s=a.deferred,r=(a.creatorOptions,a.showEl),o=v.default.extend(p.default),c=document.createElement("div");return r(c),new o({propsData:{initialElements:e,elementsType:t,importType:n,ftpUploadSite:l.ftpUploadSite,creationFn:l.creationFn,oncancel:l.oncancel,oncreate:l.oncreate,defaultHideSourceItems:l.defaultHideSourceItems,saveRulesFn:l.saveRulesFn,initialRules:l.initialRules}}).$mount(c),s},S=function(e,t){return(t=t||{}).title=(0,g.default)("Create a collection from a list of datasets"),k(e,t,C)};e.default={DatasetCollectionElementView:E,ListCollectionCreator:C,collectionCreatorModal:k,listCollectionCreatorModal:S,createListCollection:function(l,e){var t=l.toJSON(),i=!e;return S(t,{defaultHideSourceItems:e,creationFn:function(e,t,n){return e=e.map(function(e){return{id:e.id,name:e.name,src:"dataset"===e.history_content_type?"hda":"hdca"}}),l.createHDCA(e,"list",t,n,i)}})},createCollectionViaRules:function(i,e){var t,n,l,a=i.selectionType,s=!e;if(a)if(i.elements)n=i.selectionType,l=i.dataType||"collections",t=i.elements;else{var r=RegExp(/[^\s]/),o=i.content.split(/[\n\r]/).filter(function(e){return 0<e.length&&r.exec(e)}),c=!1;0<o.length&&0<=o[0].indexOf("\t")&&(c=!0);var d=c?/\t/:/\s+/;t=o.map(function(e){return e.split(d)}),n=i.selectionType,l=i.dataType||"collections"}else t=i.toJSON(),n="datasets",l="collections";return x(t,n,l,{ftpUploadSite:i.ftpUploadSite,defaultHideSourceItems:e,creationFn:function(e,t,n,l){return i.createHDCA(e,t,n,l,s)}})},ruleBasedCollectionCreatorModal:x}});