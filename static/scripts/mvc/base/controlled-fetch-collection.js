define(["exports","jquery","underscore","backbone","app","mvc/base-mvc"],function(t,e,i,r,a,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var l=u(e),o=u(i),c=u(r),s=u(n);function u(t){return t&&t.__esModule?t:{default:t}}var h=c.default.Collection.extend({initialize:function(t,e){c.default.Collection.prototype.initialize.call(this,t,e),this.setOrder(e.order||this.order,{silent:!0})},_setUpListeners:function(){return this.on({"changed-order":this.sort})},fetch:function(t){return t=this._buildFetchOptions(t),(0,a.getGalaxyInstance)().debug("fetch options:",t),c.default.Collection.prototype.fetch.call(this,t)},_buildFetchOptions:function(t){var e=(0,a.getGalaxyInstance)();(t=o.default.clone(t)||{}).traditional=!0,t.data=t.data||this._buildFetchData(t),e.debug("data:",t.data);var i=this._buildFetchFilters(t);return e.debug("filters:",i),o.default.isEmpty(i)||o.default.extend(t.data,this._fetchFiltersToAjaxData(i)),e.debug("data:",t.data),t},_buildFetchData:function(t){var e={};return this.order&&(e.order=this.order),o.default.defaults(o.default.pick(t,this._fetchParams),e)},_fetchParams:["order","limit","offset","view","keys"],_buildFetchFilters:function(t){return o.default.clone(t.filters||{})},_fetchFiltersToAjaxData:function(t){var i={q:[],qv:[]};return o.default.each(t,function(t,e){void 0!==t&&""!==t&&(!0===t&&(t="True"),!1===t&&(t="False"),null===t&&(t="None"),i.q.push(e),i.qv.push(t))}),i},reset:function(t,e){return this.allFetched=!1,c.default.Collection.prototype.reset.call(this,t,e)},order:null,comparators:{update_time:s.default.buildComparator("update_time",{ascending:!1}),"update_time-asc":s.default.buildComparator("update_time",{ascending:!0}),create_time:s.default.buildComparator("create_time",{ascending:!1}),"create_time-asc":s.default.buildComparator("create_time",{ascending:!0})},setOrder:function(t,e){e=e||{};var i=this,r=i.comparators[t];if(o.default.isUndefined(r))throw new Error("unknown order: ".concat(t));if(r!==i.comparator)return i.order=t,i.comparator=r,e.silent||i.trigger("changed-order",e),i}}),f=h.extend({limitPerPage:500,initialize:function(t,e){h.prototype.initialize.call(this,t,e),this.currentPage=e.currentPage||0},getTotalItemCount:function(){return this.length},shouldPaginate:function(){return this.getTotalItemCount()>=this.limitPerPage},getLastPage:function(){return Math.floor(this.getTotalItemCount()/this.limitPerPage)},getPageCount:function(){return this.getLastPage()+1},getPageLimitOffset:function(t){return t=this.constrainPageNum(t),{limit:this.limitPerPage,offset:t*this.limitPerPage}},constrainPageNum:function(t){return Math.max(0,Math.min(t,this.getLastPage()))},fetchPage:function(t,e){var i=this;return t=i.constrainPageNum(t),i.currentPage=t,e=o.default.defaults(e||{},i.getPageLimitOffset(t)),i.trigger("fetching-more"),i.fetch(e).always(function(){i.trigger("fetching-more-done")})},fetchCurrentPage:function(t){return this.fetchPage(this.currentPage,t)},fetchPrevPage:function(t){return this.fetchPage(this.currentPage-1,t)},fetchNextPage:function(t){return this.fetchPage(this.currentPage+1,t)}}),d=h.extend({limitOnFirstFetch:null,limitPerFetch:100,initialize:function(t,e){h.prototype.initialize.call(this,t,e),this.limitOnFirstFetch=e.limitOnFirstFetch||this.limitOnFirstFetch,this.limitPerFetch=e.limitPerFetch||this.limitPerFetch,this.allFetched=!1,this.lastFetched=e.lastFetched||0},_buildFetchOptions:function(t){return t.remove=t.remove||!1,h.prototype._buildFetchOptions.call(this,t)},fetchFirst:function(t){return(0,a.getGalaxyInstance)().debug("ControlledFetchCollection.fetchFirst:",t),t=t?o.default.clone(t):{},this.allFetched=!1,this.lastFetched=0,this.fetchMore(o.default.defaults(t,{reset:!0,limit:this.limitOnFirstFetch}))},fetchMore:function(t){var i=(0,a.getGalaxyInstance)();i.debug("ControlledFetchCollection.fetchMore:",t),t=o.default.clone(t||{});var r=this;if(i.debug("fetchMore, options.reset:",t.reset),!t.reset&&r.allFetched)return l.default.when();t.reset?t.offset=0:void 0===t.offset&&(t.offset=r.lastFetched);var n=t.limit=t.limit||r.limitPerFetch||null;return i.debug("fetchMore, limit:",n,"offset:",t.offset),r.trigger("fetching-more"),r.fetch(t).always(function(){r.trigger("fetching-more-done")}).done(function(t){var e=o.default.isArray(t)?t.length:0;r.lastFetched+=e,i.debug("fetchMore, lastFetched:",r.lastFetched),(!n||e<n)&&(r.allFetched=!0,r.trigger("all-fetched",this))})},fetchAll:function(t){t=t||{};var e=this;return(t=o.default.pick(t,"silent")).filters={},e.fetch(t).done(function(){e.allFetched=!0,e.trigger("all-fetched",e)})}});t.default={ControlledFetchCollection:h,PaginatedCollection:f,InfinitelyScrollingCollection:d}});