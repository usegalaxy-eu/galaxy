define(["exports","underscore","jquery","backbone","onload/loadConfig","app","utils/localization","mvc/history/history-model","mvc/history/history-view-edit","mvc/history/job-states-model","mvc/history/copy-dialog","mvc/ui/error-modal","mvc/base-mvc","utils/ajax-queue","ui/search-input"],function(e,t,n,i,o,r,s,l,a,c,d,u,h,f){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var p=_(t),m=_(n),g=_(i),v=_(s),y=_(a),w=_(c),C=_(d),b=_(u),x=_(h),H=_(f);function _(e){return e&&e.__esModule?e:{default:e}}var D="history",$=g.default.View.extend(x.default.LoggableMixin).extend({_logNamespace:D,tagName:"div",className:"history-column flex-column flex-row-container",id:function(){return this.model?"history-column-".concat(this.model.get("id")):""},initialize:function(e){e=e||{},this.purgeAllowed=!p.default.isUndefined(e.purgeAllowed)&&e.purgeAllowed,this.panel=e.panel||this.createPanel(e),this.setUpListeners()},createPanel:function(e){return new y.default.HistoryViewEdit(p.default.defaults(e,{model:this.model,purgeAllowed:this.purgeAllowed,dragItems:!0,$scrollContainer:function(){return this.$el}}))},setUpListeners:function(){var e=this;this.once("rendered",function(){e.trigger("rendered:initial",e)}),this.setUpPanelListeners()},setUpPanelListeners:function(){var e=this;this.listenTo(this.panel,{rendered:function(){e.trigger("rendered",e)},"view:expanded view:rendered":function(e){e.$(".rerun-btn").off()}},this)},inView:function(e,t){var n=this.$el.offset().left;return!(n+this.$el.width()<e)&&!(t<n)},$panel:function(){return this.$(".history-panel")},render:function(e){e=void 0!==e?e:"fast";var t=this.model?this.model.toJSON():{};return this.$el.html(this.template(t)),this.renderPanel(e),this.panel.$el.css("display","flex"),this.setUpBehaviors(),this},setUpBehaviors:function(){},template:function(e){return e=p.default.extend(e||{},{isCurrentHistory:this.currentHistory}),(0,m.default)('\n            <div class="panel-controls mb-1">\n                <div class="flex-row flex-column-container no-gutters justify-content-between">\n                    '.concat(this.controlsLeftTemplate({history:e,view:this}),"\n                    ").concat(this.controlsRightTemplate({history:e,view:this}),'\n                </div>\n            </div>\n            <div class="inner flex-row flex-column-container">\n                <div id="history-').concat(e.id,'" class="history-column history-panel flex-column"></div>\n            </div>'))},renderPanel:function(e){return e=void 0!==e?e:"fast",this.panel.setElement(this.$panel()).render(e),this.currentHistory&&this.panel.$list().before(this.panel._renderDropTargetHelp()),this},events:{"click .switch-to.btn":function(){this.model.setAsCurrent()},"click .delete-history":function(){var t=this;this.model._delete().done(function(e){t.render()})},"click .undelete-history":function(){var t=this;this.model.undelete().done(function(e){t.render()})},"click .purge-history":function(){var t=this;window.confirm((0,v.default)("This will permanently remove the data. Are you sure?"))&&this.model.purge().done(function(e){t.render()})},"click .copy-history":"copy"},copy:function(){(0,C.default)(this.model)},controlsLeftTemplate:p.default.template('\n        <div class="text-left col-8">\n            <% if( data.history.isCurrentHistory ){ %>\n                <strong class="current-label">\n                    '.concat((0,v.default)("Current History"),'\n                </strong>\n            <% } else { %>\n                <button class="switch-to btn btn-secondary">\n                    ').concat((0,v.default)("Switch to"),"\n                </button>\n            <% } %>\n        </div>"),{variable:"data"}),controlsRightTemplate:p.default.template('<div class="text-right col-4">\n            <% if( !data.history.purged ){ %>\n                <div class="panel-menu btn-group">\n                    <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown">\n                        <span class="caret"></span>\n                    </button>\n                    <ul class="dropdown-menu" role="menu">\n                        <% if( !data.history.deleted ){ %>\n                            <li><a href="javascript:void(0);" class="copy-history">\n                                '.concat((0,v.default)("Copy"),'\n                            </a></li>\n                            <li><a href="javascript:void(0);" class="delete-history">\n                                ').concat((0,v.default)("Delete"),'\n                            </a></li>\n                        <% } else /* if is deleted */ { %>\n                            <li><a href="javascript:void(0);" class="undelete-history">\n                                ').concat((0,v.default)("Undelete"),'\n                            </a></li>\n                        <% } %>\n                        <% if( data.view.purgeAllowed ){ %>\n                            <li><a href="javascript:void(0);" class="purge-history">\n                                ').concat((0,v.default)("Purge"),"\n                            </a></li>\n                        <% } %>\n                    </ul>\n                </div>\n            <% } %>\n        </div>"),{variable:"data"}),toString:function(){return"HistoryViewColumn(".concat(this.panel?this.panel:"",")")}}),T=g.default.View.extend(x.default.LoggableMixin).extend({_logNamespace:D,className:"multi-panel-history",initialize:function(e){e=e||{},this.log("".concat(this,".init"),e),this.$el.addClass(this.className),this.options={columnWidth:312,borderWidth:1,columnGap:8,headerHeight:29,footerHeight:0,controlsHeight:20},this.perPage=e.perPage||10,this.hdaQueue=new H.default.NamedAjaxQueue([],!1),this.collection=null,this.columnMap={},this.columnOptions=e.columnOptions||{},this.historySearch=null,this.datasetSearch=null,this.setCollection(e.histories),this.setUpListeners()},setUpListeners:function(){var e=this;this.on("end-of-scroll",function(){e.collection.fetchMore()})},setCollection:function(e){return this.stopListening(this.collection),this.collection=e||new l.HistoryCollection,this.setUpCollectionListeners(),this.createColumns(),this.hdaQueue.clear(),this.trigger("new-collection",this),this},addModels:function(e,t,n){var i=this;return n=n||{},(e=p.default.isArray(e)?e:[e]).forEach(function(e){i.addColumn(e,!1)}),this},setUpCollectionListeners:function(){this.listenTo(this.collection,{error:this.errorHandler,add:this.addModels,"all-fetched":this._postFetchAll,"new-current":this.addAsCurrentColumn,"set-as-current":this.setCurrentHistory,"change:deleted change:purged":this.handleDeletedHistory,sort:function(){this.renderColumns(0)}})},_postFetchAll:function(e){if(this.$(".histories-loading-indicator").remove(),!this.historySearch){var t=this.$(".outer-middle");t.scrollLeft(t.scrollLeft()+24)}},setCurrentHistory:function(e){this.log("setCurrentHistory:",e);var t=p.default.findWhere(this.columnMap,{currentHistory:!0});t&&(t.currentHistory=!1,t.$el.height(""));var n=this.columnMap[this.collection.currentHistoryId];return n.currentHistory=!0,this.collection.sort(),this._recalcFirstColumnHeight(),n},handleDeletedHistory:function(e){if(e.get("deleted")||e.get("purged")){this.log("handleDeletedHistory",this.collection.includeDeleted,e);var t=this.columnMap[e.id];if(!t)return;t.model.id===this.collection.currentHistoryId||this.collection.includeDeleted||this.removeColumn(t)}},errorHandler:function(e,t,n){if(!t||0!==t.status||0!==t.readyState){if(this.error(e,t,n),p.default.isString(e)&&p.default.isString(t)){var i=e,o=t;return b.default.errorModal(i,o,n)}return t&&502===t.status?b.default.badGatewayErrorModal():b.default.ajaxErrorModal(e,t,n)}},_ajaxErrorHandler:function(){b.default.ajaxErrorModal.apply(null,p.default.toArray(arguments))},create:function(e){return this.collection.create({current:!0})},createColumns:function(e,n){var i=this;n=n||this.options.columnOptions,this.columnMap={},this.collection.each(function(e,t){i.columnMap[e.id]=i.createColumn(e,n)})},createColumn:function(e,t){var n=(0,r.getGalaxyInstance)();t=p.default.extend({},t,{model:e,purgeAllowed:n.config.allow_user_dataset_purge});var i=new $(t);return e.id===this.collection.currentHistoryId&&(i.currentHistory=!0),this.setUpColumnListeners(i),this.datasetSearch&&(i.panel.searchItems(this.datasetSearch),this.queueHdaFetchDetails(i)),i},addColumn:function(e,t){t=void 0===t||t;var n=this.createColumn(e);return this.columnMap[e.id]=n,t&&this.renderColumns(),n},addAsCurrentColumn:function(e,t,n){var i=this,o=this.addColumn(e,!1);return this.setCurrentHistory(e),o.once("rendered",function(){i.queueHdaFetch(o)}),o},removeColumn:function(e,t){var n=this;if(t=void 0===t||t,this.log("removeColumn",e),e){var i=this.options.columnWidth+this.options.columnGap;e.$el.fadeOut("fast",function(){t&&((0,m.default)(n).remove(),n.$(".middle").width(n.$(".middle").width()-i),n.checkColumnsInView(),n._recalcFirstColumnHeight()),n.stopListening(e.panel),n.stopListening(e),delete n.columnMap[e.model.id],e.remove()})}},setUpColumnListeners:function(e){var r=this;this.listenTo(e,{"in-view":this.queueHdaFetch}),this.listenTo(e.panel,{"view:draggable:dragstart":function(e,t,n,i){r._dropData=JSON.parse(e.dataTransfer.getData("text")),r.currentColumnDropTargetOn()},"view:draggable:dragend":function(e,t,n,i){r._dropData=null,r.currentColumnDropTargetOff()},"droptarget:drop":function(e,t,n){var i=r._dropData.filter(function(e){return n.model.contents.isCopyable(e)});r._dropData=null;var o=new H.default.NamedAjaxQueue;0!==n.model.contents.currentPage&&o.add({name:"fetch-front-page",fn:function(){return n.model.contents.fetchPage(0)}}),i.reverse().forEach(function(e){o.add({name:"copy-".concat(e.id),fn:function(){return n.model.contents.copy(e)}})}),o.start(),o.done(function(e){n.model.fetch()})}})},columnMapLength:function(){return Object.keys(this.columnMap).length},sortedFilteredColumns:function(n){return(n=n||this.filters)&&n.length?this.sortedColumns().filter(function(t,e){return t.currentHistory||p.default.every(n.map(function(e){return e.call(t)}))}):this.sortedColumns()},sortedColumns:function(){var n=this;return this.collection.map(function(e,t){return n.columnMap[e.id]})},render:function(e){return e=void 0!==e?e:this.fxSpeed,this.log("".concat(this,".render")),this.$el.html(this.mainTemplate),this.renderColumns(e),this.setUpBehaviors(),this.trigger("rendered",this),this},renderColumns:function(e){e=p.default.isNumber(e)?e:this.fxSpeed;var t=this.sortedFilteredColumns(),n=this.$(".middle").empty();return this._addColumns(t,e),this.collection.allFetched||n.append(this.loadingIndicatorTemplate),this.trigger("columns-rendered",t,this),(!this.datasetSearch||1<t.length)&&(this.checkColumnsInView(),this._recalcFirstColumnHeight()),t},_addColumns:function(e,n){n=p.default.isNumber(n)?n:this.fxSpeed;var i=this.$(".middle"),t=i.children(".history-column").length;i.width(this._calcMiddleWidth(e.length+t)),e.forEach(function(e,t){e.delegateEvents().render(n).$el.appendTo(i)})},_calcMiddleWidth:function(e){return e*(this.options.columnWidth+this.options.columnGap)+this.options.columnGap+16},queueHdaFetch:function(e){var t=e.model.contents;if(0===t.length&&e.model.contentsShown()){var n={silent:!0},i=p.default.values(t.storage.allExpanded()).join();i&&(n.details=i),this.hdaQueue.add({name:e.model.id,fn:function(){return t.fetchCurrentPage(n).done(function(){e.panel.renderItems()}).done(function(){w.default.FETCH_STATE_ON_ADD||t.jobStateSummariesCollection.fetch()})}}),this.hdaQueue.running||this.hdaQueue.start()}},queueHdaFetchDetails:function(e){var t=e.model.contents;!(0===t.length&&e.model.contentsShown())&&t.haveDetails()||(this.hdaQueue.add({name:e.model.id,fn:function(){return t.progressivelyFetchDetails().done(function(){e.panel._renderEmptyMessage()})}}),this.hdaQueue.running||this.hdaQueue.start())},renderInfo:function(e){return this.$(".header .header-info").text(e)},events:{"click .done.btn":"close","click .create-new.btn":"create","click #include-deleted":"_clickToggleDeletedHistories","click .order .set-order":"_chooseOrder","click #toggle-deleted":"_clickToggleDeletedDatasets","click #toggle-hidden":"_clickToggleHiddenDatasets"},close:function(e){window.location=(0,o.getAppRoot)()},_clickToggleDeletedHistories:function(e){this.toggleDeletedHistories((0,m.default)(e.currentTarget).is(":checked")),this.toggleOptionsPopover()},toggleDeletedHistories:function(e){window.location="".concat((0,o.getAppRoot)(),e?"history/view_multiple?include_deleted_histories=True":"history/view_multiple")},_clickToggleDeletedDatasets:function(e){this.toggleDeletedDatasets((0,m.default)(e.currentTarget).is(":checked")),this.toggleOptionsPopover()},toggleDeletedDatasets:function(n){n=void 0!==n&&n,this.sortedFilteredColumns().forEach(function(e,t){p.default.delay(function(){e.panel.toggleShowDeleted(n,!1)},200*t)})},_clickToggleHiddenDatasets:function(e){this.toggleHiddenDatasets((0,m.default)(e.currentTarget).is(":checked")),this.toggleOptionsPopover()},toggleHiddenDatasets:function(n){n=void 0!==n&&n,this.sortedFilteredColumns().forEach(function(e,t){p.default.delay(function(){e.panel.toggleShowHidden(n,!1)},200*t)})},_chooseOrder:function(e){var t=this,n=this.collection,i=(0,m.default)(e.currentTarget).data("order");this.$(".current-order").text(this.orderDescriptions[i]),this.toggleOptionsPopover(),n.setOrder(i);var o=n.slice(0,1);n.fetchFirst().done(function(){n.unshift(o,{silent:!0}),t.createColumns(),t.hdaQueue.clear(),t.render()}),this.once("columns-rendered",this._scrollLeft)},_scrollLeft:function(e){e=p.default.isNumber(e)?e:0,this.$(".outer-middle").scrollLeft(e)},setUpBehaviors:function(){var n=this;this._moreOptionsPopover(),this.$("#search-histories").searchInput({name:"search-histories",placeholder:(0,v.default)("search histories"),onfirstsearch:function(e){n.$("#search-histories").searchInput("toggle-loading"),n.renderInfo((0,v.default)("loading all histories for search")),n.collection.fetchAll().done(function(){n.$("#search-histories").searchInput("toggle-loading"),n.renderInfo("")})},onsearch:function(e){n.historySearch=e,n.filters=[function(){return n.model.matchesAll(n.historySearch)}],n.renderColumns(0)},onclear:function(e){n.historySearch=null,n.filters=[],n.renderColumns(0)}}),this.$("#search-datasets").searchInput({name:"search-datasets",placeholder:(0,v.default)("search all datasets"),onfirstsearch:function(t){n.hdaQueue.clear(),n.$("#search-datasets").searchInput("toggle-loading"),n.datasetSearch=t,n.sortedFilteredColumns().forEach(function(e){e.panel.searchItems(t),n.queueHdaFetchDetails(e)}),n.hdaQueue.progress(function(e){n.renderInfo([(0,v.default)("searching"),e.curr+1,(0,v.default)("of"),e.total].join(" "))}),n.hdaQueue.deferred.done(function(){n.renderInfo(""),n.$("#search-datasets").searchInput("toggle-loading")})},onsearch:function(t){n.datasetSearch=t,n.sortedFilteredColumns().forEach(function(e){e.panel.searchItems(t)})},onclear:function(e){n.datasetSearch=null,n.sortedFilteredColumns().forEach(function(e){e.panel.clearSearch()})}}),(0,m.default)(window).resize(function(){n._recalcFirstColumnHeight()});var e=p.default.debounce(function(){var e=n._viewport();n.checkColumnsInView(e),n.checkForEndOfScroll(e)},100);this.$(".middle").parent().scroll(e)},_moreOptionsPopover:function(){return this.$(".open-more-options.btn").popover({container:".header",placement:"bottom",html:!0,content:(0,m.default)(this.optionsPopoverTemplate(this))})},toggleOptionsPopover:function(e){this.$(".open-more-options.btn").popover("toggle")},_recalcFirstColumnHeight:function(){var e=this.$(".history-column").first(),t=this.$(".middle").height(),n=e.find(".panel-controls").height();e.height(t).find(".inner").height(t-n)},_viewport:function(){var e=this.$(".middle").parent(),t=e.offset().left;return{left:t,right:t+e.width()}},columnsInView:function(e){var t=e||this._viewport();return this.sortedFilteredColumns().filter(function(e){return e.currentHistory||e.inView(t.left,t.right)})},checkColumnsInView:function(){this.columnsInView().forEach(function(e){e.trigger("in-view",e)})},checkForEndOfScroll:function(e){e=e||this._viewport();var t=this.$(".middle");t.parent().scrollLeft()+e.right>=t.width()-16&&this.trigger("end-of-scroll")},currentColumnDropTargetOn:function(){var e=this.columnMap[this.collection.currentHistoryId];e&&(e.panel.dataDropped=function(e){},e.panel.dropTargetOn())},currentColumnDropTargetOff:function(){var e=this.columnMap[this.collection.currentHistoryId];e&&(e.panel.dataDropped=y.default.HistoryViewEdit.prototype.dataDrop,e.panel.dropTarget=!1,e.panel.$(".history-drop-target").remove())},toString:function(){return"MultiPanelColumns(".concat(this.columns?this.columns.length:0,")")},mainTemplate:'\n        <div class="header flex-column-container">\n            <div class="control-column control-column-left flex-column">\n                <div id="search-histories" class="search-control"></div>\n                <div id="search-datasets" class="search-control"></div>\n                <a class="open-more-options btn btn-secondary" tabindex="3">\n                    <span class="fa fa-ellipsis-h"></span>\n                </a>\n            </div>\n            <div class="control-column control-column-center flex-column">\n                <div class="header-info">\n                </div>\n            </div>\n            <div class="control-column control-column-right flex-column">\n                <button class="create-new btn btn-secondary" tabindex="4">\n                    '.concat((0,v.default)("Create new"),'\n                </button>\n            </div>\n        </div>\n        <div class="outer-middle flex-row flex-row-container">\n            <div class="middle flex-column-container flex-row"></div>\n        </div>\n        <div class="footer flex-column-container"></div>'),loadingIndicatorTemplate:'\n        <div class="histories-loading-indicator">\n            <span class="fa fa-spin fa-spinner"></span>\n            '.concat((0,v.default)("Loading histories")," ...\n        </div>"),orderDescriptions:{update_time:(0,v.default)("most recent first"),"update_time-asc":(0,v.default)("least recent first"),name:(0,v.default)("name, a to z"),"name-dsc":(0,v.default)("name, z to a"),size:(0,v.default)("size, large to small"),"size-asc":(0,v.default)("size, small to large")},optionsPopoverTemplate:p.default.template(['<div class="more-options d-flex flex-column">','<div class="order btn-group mb-2">','<button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown">',"".concat((0,v.default)("Order histories by")," "),'<span class="current-order"><%- view.orderDescriptions[ view.collection.order ] %></span> ','<span class="caret"></span>',"</button>",'<ul class="dropdown-menu" role="menu">',"<% _.each( view.orderDescriptions, function( text, order ){ %>",'<li class="dropdown-item"><a href="javascript:void(0);" class="set-order" data-order="<%- order %>">',"<%- text %>","</a></li>","<% }); %>","</ul>","</div>",'<div class="checkbox"><label><input id="include-deleted" type="checkbox"','<%= view.collection.includeDeleted? " checked" : "" %>>',(0,v.default)("Include deleted histories"),"</label></div>",'<div class="checkbox"><label><input id="toggle-deleted" type="checkbox">',(0,v.default)("Include deleted datasets"),"</label></div>",'<div class="checkbox"><label><input id="toggle-hidden" type="checkbox">',(0,v.default)("Include hidden datasets"),"</label></div>","</div>"].join(""),{variable:"view"})});e.default={MultiPanelColumns:T}});