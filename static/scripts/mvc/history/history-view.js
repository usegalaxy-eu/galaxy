define(["exports","underscore","jquery","onload/loadConfig","app","utils/localization","mvc/list/list-view","mvc/history/history-model","mvc/history/history-contents","mvc/history/hda-li","mvc/history/hdca-li","mvc/ui/error-modal","ui/fa-icon-button","mvc/base-mvc","mvc/history/history-view-edit","mvc/history/copy-dialog","ui/search-input","ui/mode-button"],function(e,t,s,n,o,i,l,a,r,d,c,h,u,g,f,m){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.historyEntry=T;var p=M(t),v=M(s),y=M(i),w=M(l),_=M(d),I=M(c),b=M(h),C=M(u),P=M(g),x=M(f),H=M(m);function M(e){return e&&e.__esModule?e:{default:e}}var S,$,k=w.default.ModelListPanel,D=k.extend({_logNamespace:"history",HDAViewClass:_.default.HDAListItemView,HDCAViewClass:I.default.HDCAListItemView,collectionClass:r.HistoryContents,modelCollectionKey:"contents",tagName:"div",className:"".concat(k.prototype.className," history-panel"),emptyMsg:(0,y.default)("This history is empty"),noneFoundMsg:(0,y.default)("No matching datasets found"),searchPlaceholder:(0,y.default)("search datasets"),initialize:function(e){k.prototype.initialize.call(this,e),this.linkTarget=e.linkTarget||"_blank"},_createDefaultCollection:function(){return new this.collectionClass([],{history:this.model})},freeModel:function(){return k.prototype.freeModel.call(this),this.model&&this.model.stopPolling(),this},_setUpListeners:function(){k.prototype._setUpListeners.call(this),this.on({error:function(e,t,s,i,n){this.errorHandler(e,t,s,i,n)},"views:ready view:attached view:removed":function(e){this._renderSelectButton()},"view:attached":function(e){this.scrollTo(0)}})},loadHistory:function(e,t,s){var i=this;return s=p.default.extend(s||{silent:!0}),this.info("loadHistory:",e,t,s),this.setModel(new a.History({id:e})),s.silent=!0,this.trigger("loading"),this.model.fetchWithContents(t,s).always(function(){i.render(),i.trigger("loading-done")})},refreshContents:function(e){return this.model?this.model.refresh(e):v.default.when()},_setUpCollectionListeners:function(){return k.prototype._setUpCollectionListeners.call(this),this.listenTo(this.collection,{"fetching-more":function(){this._toggleContentsLoadingIndicator(!0),this.$emptyMessage().hide()},"fetching-more-done":function(){this._toggleContentsLoadingIndicator(!1)}})},_showLoadingIndicator:function(e,t,s){var i=(0,v.default)('<div class="loading-indicator"/>');this.$el.html(i.text(e).slideDown(p.default.isUndefined(t)?this.fxSpeed:t))},_hideLoadingIndicator:function(e){this.$(".loading-indicator").slideUp(p.default.isUndefined(e)?this.fxSpeed+200:e,function(){(0,v.default)(this).remove()})},_buildNewRender:function(){var e=k.prototype._buildNewRender.call(this);return this._renderSelectButton(e),e},_renderSelectButton:function(e){if(e=e||this.$el,!this.multiselectActions().length)return null;if(!this.views.length)return this.hideSelectors(),e.find(".controls .actions .show-selectors-btn").remove(),null;var t=e.find(".controls .actions .show-selectors-btn");return t.length?t:(0,C.default)({title:(0,y.default)("Operations on multiple datasets"),classes:"show-selectors-btn",faIcon:"fa-check-square-o",tooltipConfig:{placement:"top"}}).prependTo(e.find(".controls .actions"))},_renderEmptyMessage:function(e){var t=this.$emptyMessage(e);return this.model.get("contents_active").active<=0?t.empty().append(this.emptyMsg).show():this.searchFor&&this.model.contents.haveSearchDetails()&&!this.views.length?t.empty().append(this.noneFoundMsg).show():(t.hide(),(0,v.default)())},$scrollContainer:function(e){return this.$list(e)},_toggleContentsLoadingIndicator:function(e){e?this.$list().html('<div class="contents-loading-indicator"><span class="fa fa-2x fa-spinner fa-spin"/></div>'):this.$list().find(".contents-loading-indicator").remove()},renderItems:function(e){e=e||this.$el;var t=this.$list(e);(0,v.default)(".tooltip").remove(),t.empty(),this.views=[];var s=this._filterCollection();return s.length?(this._renderPagination(e),this.views=this._renderSomeItems(s,t)):e.find("> .controls .list-pagination").empty(),this._renderEmptyMessage(e).toggle(!s.length),this.trigger("views:ready",this.views),this.views},_renderPagination:function(e){var t=e.find("> .controls .list-pagination");return this.searchFor||!this.model.contents.shouldPaginate()?t.empty():(t.html(this.templates.pagination({current:this.model.contents.currentPage+1,last:this.model.contents.getLastPage()+1},this)),t.find("select.pages").tooltip(),t)},_renderSomeItems:function(e,t){var s=this,i=[];return t.append(e.map(function(e){var t=s._createItemView(e);return i.push(t),s._renderItemView$el(t)})),i},_filterItem:function(e){var t=this.model.contents;return(t.includeHidden||!e.hidden())&&(t.includeDeleted||!e.isDeletedOrPurged())&&k.prototype._filterItem.call(this,e)},_getItemViewClass:function(e){var t=e.get("history_content_type");switch(t){case"dataset":return this.HDAViewClass;case"dataset_collection":return this.HDCAViewClass}throw new TypeError("Unknown history_content_type: ".concat(t))},_getItemViewOptions:function(e){var t=k.prototype._getItemViewOptions.call(this,e);return p.default.extend(t,{linkTarget:this.linkTarget,expanded:this.model.contents.storage.isExpanded(e.id),hasUser:this.model.ownedByCurrUser()})},_setUpItemViewListeners:function(e){var t=this;return k.prototype._setUpItemViewListeners.call(t,e),t.listenTo(e,{expanded:function(e){t.model.contents.storage.addExpanded(e.model)},collapsed:function(e){t.model.contents.storage.removeExpanded(e.model)}})},collapseAll:function(){this.model.contents.storage.clearExpanded(),k.prototype.collapseAll.call(this)},getSelectedModels:function(){var e=k.prototype.getSelectedModels.call(this);return e.historyId=this.collection.historyId,e},events:p.default.extend(p.default.clone(k.prototype.events),{"click .show-selectors-btn":"toggleSelectors","click > .controls .prev":"_clickPrevPage","click > .controls .next":"_clickNextPage","change > .controls .pages":"_changePageSelect","click .messages [class$=message]":"clearMessages"}),_clickPrevPage:function(e){this.model.stopPolling(),this.model.contents.fetchPrevPage()},_clickNextPage:function(e){this.model.stopPolling(),this.model.contents.fetchNextPage()},_changePageSelect:function(e){this.model.stopPolling();var t=(0,v.default)(e.currentTarget).val();this.model.contents.fetchPage(t)},toggleShowDeleted:function(e,t){e=void 0!==e?e:!this.model.contents.includeDeleted;var s=this.model.contents;return s.setIncludeDeleted(e,t),this.trigger("show-deleted",e),s.fetchCurrentPage({renderAll:!0}),e},toggleShowHidden:function(e,t,s){e=void 0!==e?e:!this.model.contents.includeHidden;var i=this.model.contents;return i.setIncludeHidden(e,s),this.trigger("show-hidden",e),i.fetchCurrentPage({renderAll:!0}),e},_firstSearch:function(e){var i=this,t="> .controls .search-input";this.log("onFirstSearch",e),this.model.contents.haveSearchDetails()?this.searchItems(e):(this.$(t).searchInput("toggle-loading"),this.searchFor=e,this.model.contents.progressivelyFetchDetails({silent:!0}).progress(function(e,t,s){i.renderItems(),i.trigger("search:loading-progress",t,s)}).always(function(){i.$el.find(t).searchInput("toggle-loading")}).done(function(){i.searchItems(e,"force")}))},clearSearch:function(e){var t=this;return this.searchFor&&(this.searchFor="",this.trigger("search:clear",this),this.$("> .controls .search-query").val(""),this.model.contents.fetchCurrentPage({silent:!0}).done(function(){t.renderItems()})),this},errorHandler:function(e,t,s){if(!t||0!==t.status||0!==t.readyState){if(this.error(e,t,s),p.default.isString(e)&&p.default.isString(t)){var i=e,n=t;return b.default.errorModal(i,n,s)}return t&&502===t.status?b.default.badGatewayErrorModal():b.default.ajaxErrorModal(e,t,s)}},clearMessages:function(e){return(p.default.isUndefined(e)?this.$messages().children('[class$="message"]'):(0,v.default)(e.currentTarget)).fadeOut(this.fxSpeed,function(){(0,v.default)(this).remove()}),this},scrollToHid:function(e){return this.scrollToItem(p.default.first(this.viewsWhereModel({hid:e})))},ordinalIndicator:function(e){var t="".concat(e);switch(t.charAt(t.length-1)){case"1":return"".concat(t,"st");case"2":return"".concat(t,"nd");case"3":return"".concat(t,"rd");default:return"".concat(t,"th")}},toString:function(){return"HistoryView(".concat(this.model?this.model.get("name"):"",")")}});function T(e){(0,v.default)("#toggle-deleted").modeButton({initialMode:e.initialModeDeleted,modes:[{mode:"showing_deleted",html:(0,y.default)("Exclude deleted")},{mode:"not_showing_deleted",html:(0,y.default)("Include deleted")}]}),(0,v.default)("#toggle-hidden").modeButton({initialMode:e.initialModeHidden,modes:[{mode:"showing_hidden",html:(0,y.default)("Exclude hidden")},{mode:"not_showing_hidden",html:(0,y.default)("Include hidden")}]}),(0,v.default)("#switch").click(function(){var e=(0,o.getGalaxyInstance)(),t=e.currHistoryPanel?e.currHistoryPanel:null;t?t.switchToHistory("${ history[ 'id' ] }"):window.location="${ switch_to_url }"}),e.hasMasthead&&(0,v.default)("#center").addClass("flex-vertical-container");var t=e.userIsOwner?x.default.HistoryViewEdit:D.HistoryView,s=new a.History(e.historyJSON);(0,v.default)("#import").click(function(){var e=(0,o.getGalaxyInstance)();(0,H.default)(s,{useImport:!0,allDatasets:"showing_deleted"===(0,v.default)("#toggle-deleted").modeButton("getMode").mode}).done(function(){window===window.parent?window.location=(0,n.getAppRoot)():e.currHistoryPanel&&e.currHistoryPanel.loadCurrentHistory()})});var i=new t({el:(0,v.default)("#history-"+e.historyJSON.id),className:t.prototype.className+" wide",$scrollContainer:e.hasMasthead?function(){return this.$el.parent()}:void 0,model:s,show_deleted:e.showDeletedJson,show_hidden:e.showHiddenJson,purgeAllowed:e.allow_user_dataset_purge});i.trigger("loading"),s.fetchContents({silent:!0}).fail(function(){alert("Galaxy history failed to load")}).done(function(){i.trigger("loading-done"),i.render()}),(0,v.default)("#toggle-deleted").on("click",function(){i.toggleShowDeleted()}),(0,v.default)("#toggle-hidden").on("click",function(){i.toggleShowHidden()})}D.prototype.templates=(S=P.default.wrapTemplate(['<div class="controls">','<div class="title">','<div class="name"><%- history.name %></div>',"</div>",'<div class="subtitle"></div>','<div class="history-size"><%- history.nice_size %></div>','<div class="actions"></div>','<div class="messages">',"<% if( history.deleted && history.purged ){ %>",'<div class="deleted-msg warningmessagesmall">',(0,y.default)("This history has been purged and deleted"),"</div>","<% } else if( history.deleted ){ %>",'<div class="deleted-msg warningmessagesmall">',(0,y.default)("This history has been deleted"),"</div>","<% } else if( history.purged ){ %>",'<div class="deleted-msg warningmessagesmall">',(0,y.default)("This history has been purged"),"</div>","<% } %>","<% if( history.message ){ %>",'<div class="<%= history.message.level || "info" %>messagesmall">',"<%= history.message.text %>","</div>","<% } %>","</div>",'<div class="tags-display"></div>','<div class="annotation-display"></div>','<div class="search">','<div class="search-input"></div>',"</div>",'<div class="list-actions">','<div class="btn-group">','<button class="select-all btn btn-secondary"','data-mode="select">',(0,y.default)("All"),"</button>",'<button class="deselect-all btn btn-secondary"','data-mode="select">',(0,y.default)("None"),"</button>","</div>",'<div class="list-action-menu btn-group">',"</div>","</div>",'<div class="list-pagination form-inline"></div>',"</div>"],"history"),$=P.default.wrapTemplate(['<button class="prev" <%- pages.current === 1 ? "disabled" : "" %>>previous</button>','<select class="pages form-control" ','title="',(0,y.default)("Click to open and select a page. Begin typing a page number to select it"),'">',"<% _.range( 1, pages.last + 1 ).forEach( function( i ){ %>",'<option value="<%- i - 1 %>" <%- i === pages.current ? "selected" : "" %>>',"<%- view.ordinalIndicator( i ) %> of <%- pages.last %> pages","</option>","<% }); %>","</select>",'<button class="next" <%- pages.current === pages.last ? "disabled" : "" %>>next</button>'],"pages"),p.default.extend(p.default.clone(k.prototype.templates),{el:function(){return'<div>\n            <div class="controls"></div>\n            <ul class="list-items"></ul>\n            <div class="empty-message infomessagesmall"></div>\',\n        </div>'},controls:S,pagination:$})),e.default={HistoryView:D,historyEntry:T}});