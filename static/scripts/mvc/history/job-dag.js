define(["exports","utils/graph","utils/add-logging"],function(t,o,e){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=s(o),n=s(e);function s(t){return t&&t.__esModule?t:{default:t}}var i=r.default.Graph,a=function(t){t=t||{};var o=this;o.filters=[],o._jobsData=[],o._historyContentsMap={},o._toolMap={},o._outputIdToJobMap={},o.noInputJobs=[],o.noOutputJobs=[],o.filteredSetMetadata=[],o.filteredErroredJobs=[],o.dataKeys=["jobs","historyContents","tools"],i.call(o,!0,_.pick(t,o.dataKeys),_.omit(t,o.dataKeys))};(a.prototype=new r.default.Graph).constructor=a,(0,n.default)(a),a.prototype.init=function(t){t=t||{};var o=this;return o.options=_.defaults(t,{excludeSetMetadata:!1}),o.filters=o._initFilters(),i.prototype.init.call(o,t),o},a.prototype._initFilters=function(){var o=this,t=[];return o.options.excludeSetMetadata&&(o.filteredSetMetadata=[],t.push(function(t){return"__SET_METADATA__"!==t.job.tool_id||(o.filteredSetMetadata.push(t.job.id),!1)})),o.options.excludeErroredJobs&&(o.filteredErroredJobs=[],t.push(function(t){return"error"!==t.job.state||(o.filteredErroredJobs.push(t.job.id),!1)})),_.isArray(o.options.filters)&&(t=t.concat(o.options.filters)),o.debug("filters len:",t.length),t},a.prototype.read=function(t){var o=this;return _.has(t,"historyContents")&&_.has(t,"jobs")&&_.has(t,"tools")?(o.preprocessHistoryContents(t.historyContents||[]).preprocessTools(t.tools||{}).preprocessJobs(t.jobs||[]),o.createGraph(o._filterJobs()),o):i.prototype.read.call(this,t)},a.prototype.preprocessHistoryContents=function(t){this.info("processing history");var e=this;return e._historyContentsMap={},t.forEach(function(t,o){e._historyContentsMap[t.id]=_.clone(t)}),e},a.prototype.preprocessTools=function(t){this.info("processing tools");var e=this;return e._toolMap={},_.each(t,function(t,o){e._toolMap[o]=_.clone(t)}),e},a.prototype.preprocessJobs=function(t){this.info("processing jobs");var o=this;return o._outputIdToJobMap={},o._jobsData=o.sort(t).map(function(t){return o.preprocessJob(_.clone(t))}),o},a.prototype.sort=function(t){return t.sort(function(t,o){return t.create_time>o.create_time?1:t.create_time<o.create_time?-1:0})},a.prototype.preprocessJob=function(t,o){var e=this,r={job:t};return r.inputs=e._processInputs(t),0===_.size(r.inputs)&&e.noInputJobs.push(t.id),r.outputs=e._processOutputs(t),0===_.size(r.outputs)&&e.noOutputJobs.push(t.id),r.tool=e._toolMap[t.tool_id],r},a.prototype._processInputs=function(t){var e=this,o=t.inputs,r={};return _.each(o,function(t,o){(t=_.clone(e._validateInputOutput(t))).name=o,t.content=e._historyContentsMap[t.id],r[t.id]=t}),r},a.prototype._validateInputOutput=function(t){if(!t.id)throw new Error("No id on job input/output: ",JSON.stringify(t));if(!t.src||"hda"!==t.src)throw new Error("Bad src on job input/output: ",JSON.stringify(t));return t},a.prototype._processOutputs=function(e){var r=this,t=e.outputs,n={};return _.each(t,function(t,o){(t=_.clone(r._validateInputOutput(t))).name=o,t.content=r._historyContentsMap[t.id],n[t.id]=t,r._outputIdToJobMap[t.id]=e.id}),n},a.prototype._filterJobs=function(){var e=this;return e._jobsData.filter(function(t,o){return e._filterJob(t,o)})},a.prototype._filterJob=function(t,o){for(var e=this,r=0;r<e.filters.length;r++)if(!e.filters[r].call(e,t))return e.debug("\t job",t.job.id," has been filtered out by function:\n",e.filters[r]),!1;return!0},a.prototype.createGraph=function(t){var n=this;return n.debug("connections:"),_.each(t,function(t){var o=t.job.id;n.debug("\t",o,t),n.createVertex(o,t)}),_.each(t,function(t){var r=t.job.id;_.each(t.inputs,function(t,o){var e=n._outputIdToJobMap[o];e||(e=n.createJobLessVertex(o).name);n.createEdge(e,r,n.directed,{dataset:o})})}),n.debug("final graph: ",JSON.stringify(n.toVerticesAndEdges(),null,"  ")),n},a.prototype.createJobLessVertex=function(t){var o="copy-"+t;return this.createVertex(o,this._historyContentsMap[t])},a.prototype.weakComponentGraphArray=function(){var o=this;return this.weakComponents().map(function(t){return t.vertices.sort(function(t,o){var e=t.data.job?t.data.job.create_time:t.data.create_time,r=o.data.job?o.data.job.create_time:o.data.create_time;return r<e?1:e<r?-1:0}),new Graph(o.directed,t)})},a.prototype._jobsDataMap=function(){var o={};return this._jobsData.forEach(function(t){o[t.job.id]=t}),o},t.default=a});