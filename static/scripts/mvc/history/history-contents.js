define(["exports","underscore","jquery","backbone","onload/loadConfig","mvc/base/controlled-fetch-collection","mvc/history/hda-model","mvc/history/hdca-model","mvc/history/history-preferences","mvc/history/job-states-model","mvc/base-mvc","utils/ajax-queue"],function(t,e,i,n,o,r,s,a,d,l,c,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HistoryContents=void 0;var h=D(e),f=D(i),y=D(n),m=D(r),g=D(s),p=D(a),v=D(d),_=D(l),b=D(c),S=D(u);function D(t){return t&&t.__esModule?t:{default:t}}var j=window.localStorage.getItem("historyContentsLimitPerPageDefault")||500,C=m.default.PaginatedCollection;t.HistoryContents=C.extend(b.default.LoggableMixin).extend({_logNamespace:"history",limitPerPage:j,limitPerProgressiveFetch:j,order:"hid",url:function(){return"".concat(this.urlRoot,"/").concat(this.historyId,"/contents")},initialize:function(t,e){this.on({"sync add":this.trackJobStates}),e=e||{},this.urlRoot="".concat((0,o.getAppRoot)(),"api/histories"),C.prototype.initialize.call(this,t,e),this.history=e.history||null,this.setHistoryId(e.historyId||null),this.includeDeleted=e.includeDeleted||this.includeDeleted,this.includeHidden=e.includeHidden||this.includeHidden,this.model.prototype.idAttribute="type_id"},trackJobStates:function(){var o=this;this.each(function(t){if(!t.has("job_states_summary")&&"dataset_collection"===t.attributes.history_content_type){var e=t.attributes.job_source_type,i=t.attributes.job_source_id;if(e&&o.jobStateSummariesCollection){o.jobStateSummariesCollection.add({id:i,model:e,history_id:o.history_id,collection_id:t.attributes.id});var n=o.jobStateSummariesCollection.get(i);t.jobStatesSummary=n}}})},model:function(t,e){return"dataset"===t.history_content_type?new g.default.HistoryDatasetAssociation(t,e):"dataset_collection"===t.history_content_type?new p.default.HistoryDatasetCollection(t,e):{validationError:"Unknown history_content_type: ".concat(t.history_content_type)}},stopPolling:function(){this.jobStateSummariesCollection&&(this.jobStateSummariesCollection.active=!1,this.jobStateSummariesCollection.clearUpdateTimeout())},setHistoryId:function(t){this.stopPolling(),(this.historyId=t)&&(this._setUpWebStorage(),this.jobStateSummariesCollection=new _.default.JobStatesSummaryCollection,this.jobStateSummariesCollection.historyId=t,this.jobStateSummariesCollection.monitor())},_setUpWebStorage:function(t){return this.storage=new v.default.HistoryPrefs({id:v.default.HistoryPrefs.historyStorageKey(this.historyId)}),this.trigger("new-storage",this.storage,this),this.on({"include-deleted":function(t){this.storage.includeDeleted(t)},"include-hidden":function(t){this.storage.includeHidden(t)}}),this.includeDeleted=this.storage.includeDeleted()||!1,this.includeHidden=this.storage.includeHidden()||!1,this},comparators:h.default.extend(h.default.clone(C.prototype.comparators),{name:b.default.buildComparator("name",{ascending:!0}),"name-dsc":b.default.buildComparator("name",{ascending:!1}),hid:b.default.buildComparator("hid",{ascending:!1}),"hid-asc":b.default.buildComparator("hid",{ascending:!0})}),running:function(){return this.filter(function(t){return!t.inReadyState()})},runningAndActive:function(){return this.filter(function(t){return!t.inReadyState()&&t.get("visible")&&!t.get("deleted")})},getByHid:function(t){return this.findWhere({hid:t})},haveDetails:function(){return this.all(function(t){return t.hasDetails()})},hidden:function(){return this.filter(function(t){return t.hidden()})},deleted:function(){return this.filter(function(t){return t.get("deleted")})},visibleAndUndeleted:function(){return this.filter(function(t){return t.get("visible")&&!t.get("deleted")})},setIncludeDeleted:function(t,e){if(h.default.isBoolean(t)&&t!==this.includeDeleted){if(this.includeDeleted=t,h.default.result(e,"silent"))return;this.trigger("include-deleted",t,this)}},setIncludeHidden:function(t,e){if(h.default.isBoolean(t)&&t!==this.includeHidden){if(this.includeHidden=t,e=e||{},h.default.result(e,"silent"))return;this.trigger("include-hidden",t,this)}},fetch:function(t){if(t=t||{},this.historyId&&!t.details){var e=v.default.HistoryPrefs.get(this.historyId).toJSON();h.default.isEmpty(e.expandedIds)||(t.details=h.default.values(e.expandedIds).join(","))}return C.prototype.fetch.call(this,t)},_buildFetchData:function(t){return h.default.extend(C.prototype._buildFetchData.call(this,t),{v:"dev"})},_fetchParams:C.prototype._fetchParams.concat(["v","details"]),_buildFetchFilters:function(t){var e=C.prototype._buildFetchFilters.call(this,t)||{},i={};return this.includeDeleted||(i.deleted=!1,i.purged=!1),this.includeHidden||(i.visible=!0),h.default.defaults(e,i)},getTotalItemCount:function(){return this.history.contentsShown()},fetchUpdated:function(t,e){return t&&((e=e||{filters:{}}).remove=!1,e.filters={"update_time-ge":t.toISOString(),visible:""}),this.fetch(e)},fetchDeleted:function(t){var e=this;return(t=t||{}).filters=h.default.extend(t.filters,{deleted:!0,purged:void 0}),t.remove=!1,this.trigger("fetching-deleted",this),this.fetch(t).always(function(){e.trigger("fetching-deleted-done",e)})},fetchHidden:function(t){var e=this;return(t=t||{}).filters=h.default.extend(t.filters,{visible:!1}),t.remove=!1,this.trigger("fetching-hidden",this),this.fetch(t).always(function(){e.trigger("fetching-hidden-done",e)})},fetchAllDetails:function(t){return(t=t||{}).data=h.default.extend(t.data||{},{details:"all"}),this.fetch(t)},_filterAndUpdate:function(t,e){var o=this,r=this.model.prototype.idAttribute,i=[e];return this.fetch({filters:t,remove:!1}).then(function(t){return t=t.reduce(function(t,e,i){var n=o.get(e[r]);return n?t.concat(n):t},[]),o.ajaxQueue("save",i,t)})},ajaxQueue:function(n,o,t){return t=t||this.models,new S.default.AjaxQueue(t.slice().reverse().map(function(t,e){var i=h.default.isString(n)?t[n]:n;return function(){return i.apply(t,o)}})).deferred},_recursivelyFetch:function(e,i,n,o,r){var s=this;r=r||0;var t=h.default.extend(h.default.clone(e),{view:"summary",keys:i,limit:o,offset:r,reset:0===r,remove:!1});h.default.defer(function(){s.fetch.call(s,t).fail(n.reject).done(function(t){n.notify(t,o,r),t.length!==o?(s.allFetched=!0,n.resolve(t,o,r)):s._recursivelyFetch(e,i,n,o,r+o)})})},progressivelyFetchDetails:function(t){t=t||{};var e=f.default.Deferred();return this._recursivelyFetch(t,g.default.HistoryDatasetAssociation.prototype.searchAttributes.join(","),e,t.limitPerCall||this.limitPerProgressiveFetch),e},isCopyable:function(t){return h.default.isObject(t)&&t.id&&h.default.contains(["HistoryDatasetAssociation","HistoryDatasetCollectionAssociation"],t.model_class)},copy:function(t){var n,o,r;o=h.default.isString(t)?(n=t,r="hda","dataset"):(n=t.id,"hdca"===(r={HistoryDatasetAssociation:"hda",LibraryDatasetDatasetAssociation:"ldda",HistoryDatasetCollectionAssociation:"hdca"}[t.model_class]||"hda")?"dataset_collection":"dataset");var s=this,a=f.default.ajax(this.url(),{method:"POST",contentType:"application/json",data:JSON.stringify({content:n,source:r,type:o})}).done(function(t){s.add([t],{parse:!0})}).fail(function(t,e,i){s.trigger("error",s,a,{},"Error copying contents",{type:o,id:n,source:r})});return a},createHDCA:function(t,e,i,n,o,r){return void 0===o&&(o=!0),this.model({history_content_type:"dataset_collection",collection_type:e,history_id:this.historyId,name:i,hide_source_items:n||!1,copy_elements:o,element_identifiers:t}).save(r)},haveSearchDetails:function(){return this.allFetched&&this.all(function(t){return h.default.has(t.attributes,"annotation")})},matches:function(e){return this.filter(function(t){return t.matches(e)})},clone:function(){var t=y.default.Collection.prototype.clone.call(this);return t.historyId=this.historyId,t},toString:function(){return["HistoryContents(",[this.historyId,this.length].join(),")"].join("")}})});