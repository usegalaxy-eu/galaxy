define(["exports","underscore","jquery","onload/loadConfig","app","mvc/dataset/states","mvc/dataset/dataset-li","mvc/tag","mvc/annotation","ui/fa-icon-button","mvc/base-mvc","utils/localization"],function(t,e,a,o,r,i,n,s,l,d,u,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var f=w(e),h=w(a),g=w(i),p=w(n),m=w(s),v=w(l),_=w(d),b=w(u),k=w(c);function w(t){return t&&t.__esModule?t:{default:t}}var E,y,A=p.default.DatasetListItemView,z=A.extend({initialize:function(t){A.prototype.initialize.call(this,t),this.hasUser=t.hasUser,this.purgeAllowed=t.purgeAllowed||!1,this.tagsEditorShown=t.tagsEditorShown||!1,this.annotationEditorShown=t.annotationEditorShown||!1},_renderPrimaryActions:function(){var t=A.prototype._renderPrimaryActions.call(this);return this.model.get("state")===g.default.NOT_VIEWABLE?t:A.prototype._renderPrimaryActions.call(this).concat([this._renderEditButton(),this._renderDeleteButton()])},_renderEditButton:function(){var a=this;if(this.model.get("state")===g.default.DISCARDED||!this.model.get("accessible"))return null;var t=this.model.get("purged"),e=this.model.get("deleted"),i={title:(0,k.default)("Edit attributes"),href:"".concat((0,o.getAppRoot)(),"datasets/edit?dataset_id=").concat(this.model.attributes.id),faIcon:"fa-pencil",classes:"edit-btn",onclick:function(t){var e=(0,r.getGalaxyInstance)();e.router&&(t.preventDefault(),e.router.push("datasets/edit",{dataset_id:a.model.attributes.id}))}};return e||t?(i.disabled=!0,t?i.title=(0,k.default)("Cannot edit attributes of datasets removed from disk"):e&&(i.title=(0,k.default)("Undelete dataset to edit attributes"))):[g.default.UPLOAD,g.default.NEW].includes(this.model.get("state"))&&(i.disabled=!0,i.title=(0,k.default)("This dataset is not yet editable")),(0,_.default)(i)},_renderDeleteButton:function(){if(!this.model.get("accessible"))return null;var t=this,e=this.model.isDeletedOrPurged();return(0,_.default)({title:e?(0,k.default)("Dataset is already deleted"):(0,k.default)("Delete"),disabled:e,faIcon:"fa-times",classes:"delete-btn",onclick:function(){t.$el.find(".icon-btn.delete-btn").tooltip("dispose"),t.model.delete()}})},_renderDetails:function(){var t=A.prototype._renderDetails.call(this),e=this.model.get("state");return this.model.isDeletedOrPurged()||(this._renderTags(t),this._renderAnnotation(t),[g.default.OK,g.default.FAILED_METADATA].includes(e)&&this._makeDbkeyEditLink(t)),this._setUpBehaviors(t),t},_renderToolHelpButton:function(){var a=this.model.attributes.dataset_id,t=this.model.attributes.creating_job,i=this,n=function(t){var e='<div id="thdiv-'.concat(a,'" class="toolhelp">');t.name&&t.help?(e+="<strong>Tool help for ".concat(t.name,"</strong><hr/>"),e+=t.help):e+="<strong>Tool help is unavailable for this dataset.</strong><hr/>",e+="</div>",i.$el.find(".details").append(h.default.parseHTML(e))};return null===(0,r.getGalaxyInstance)().user.id?null:(0,_.default)({title:(0,k.default)("Tool Help"),classes:"icon-btn",href:"#",faIcon:"fa-question",onclick:function(){0<i.$el.find(".toolhelp").length?i.$el.find(".toolhelp").toggle():h.default.ajax({url:"".concat((0,o.getAppRoot)(),"api/jobs/").concat(t)}).done(function(t){var e;e=t,h.default.ajax({url:"".concat((0,o.getAppRoot)(),"api/tools/").concat(e.tool_id,"/build")}).done(function(t){n(t)}).fail(function(){n({})})}).fail(function(){console.log('Failed at recovering job information from the  Galaxy API for job id "'.concat(t,'".'))})}})},_renderSecondaryActions:function(){var t=A.prototype._renderSecondaryActions.call(this);switch(this.model.get("state")){case g.default.UPLOAD:case g.default.NOT_VIEWABLE:return t;case g.default.ERROR:return t.unshift(this._renderErrButton()),t.concat([this._renderRerunButton(),this._renderToolHelpButton()]);case g.default.OK:case g.default.FAILED_METADATA:return t.concat([this._renderRerunButton(),this._renderVisualizationsButton(),this._renderToolHelpButton()])}return t.concat([this._renderRerunButton(),this._renderToolHelpButton()])},_renderErrButton:function(){var a=this;return(0,_.default)({title:(0,k.default)("View or report this error"),href:"".concat((0,o.getAppRoot)(),"datasets/error?dataset_id=").concat(this.model.attributes.id),classes:"report-error-btn",faIcon:"fa-bug",onclick:function(t){var e=(0,r.getGalaxyInstance)();e.router&&(t.preventDefault(),e.router.push("datasets/error",{dataset_id:a.model.attributes.id}))}})},_renderRerunButton:function(){var a=this.model.get("creating_job");if(this.model.get("rerunnable"))return(0,_.default)({title:(0,k.default)("Run this job again"),href:this.model.urls.rerun,classes:"rerun-btn",target:this.linkTarget,faIcon:"fa-refresh",onclick:function(t){var e=(0,r.getGalaxyInstance)();e.router&&(t.preventDefault(),e.router.push("/",{job_id:a}))}})},_renderVisualizationsButton:function(){var t=this.model.get("visualizations");if(this.model.isDeletedOrPurged()||!this.hasUser||!this.model.hasData()||f.default.isEmpty(t))return null;if(!f.default.isObject(t[0]))return this.warn("Visualizations have been switched off"),null;if(1<=t.length){var a=this.model.get("id"),i=(0,o.getAppRoot)()+"visualizations?dataset_id="+a;return(0,_.default)({title:(0,k.default)("Visualize this data"),href:i,classes:"visualization-link",faIcon:"fa-bar-chart-o",onclick:function(t){var e=(0,r.getGalaxyInstance)();e.frame&&e.frame.active?(t.preventDefault(),e.frame.add({url:i,title:"Visualization"})):e.router&&(t.preventDefault(),e.router.push("visualizations",{dataset_id:a}),e.trigger("activate-hda",a))}})}},_renderTags:function(t){if(this.hasUser){var e=this;this.tagsEditor=new m.default.TagsEditor({model:this.model,el:t.find(".tags-display"),onshowFirstTime:function(){this.render()},onshow:function(){e.tagsEditorShown=!0},onhide:function(){e.tagsEditorShown=!1},$activator:(0,_.default)({title:(0,k.default)("Edit dataset tags"),classes:"tag-btn",faIcon:"fa-tags"}).appendTo(t.find(".actions .right"))}),this.tagsEditorShown&&this.tagsEditor.toggle(!0)}},_renderAnnotation:function(t){if(this.hasUser){var e=this;this.annotationEditor=new v.default.AnnotationEditor({model:this.model,el:t.find(".annotation-display"),onshowFirstTime:function(){this.render()},onshow:function(){e.annotationEditorShown=!0},onhide:function(){e.annotationEditorShown=!1},$activator:(0,_.default)({title:(0,k.default)("Edit dataset annotation"),classes:"annotate-btn",faIcon:"fa-comment"}).appendTo(t.find(".actions .right"))}),this.annotationEditorShown&&this.annotationEditor.toggle(!0)}},_makeDbkeyEditLink:function(t){if("?"===this.model.get("metadata_dbkey")&&!this.model.isDeletedOrPurged()){var e=(0,h.default)('<a class="value">?</a>').attr("href",this.model.urls.edit).attr("target","_top");t.find(".dbkey .value").replaceWith(e)}},events:f.default.extend(f.default.clone(A.prototype.events),{"click .undelete-link":"_clickUndeleteLink","click .purge-link":"_clickPurgeLink","click .edit-btn":function(t){this.trigger("edit",this,t)},"click .delete-btn":function(t){this.trigger("delete",this,t)},"click .rerun-btn":function(t){this.trigger("rerun",this,t)},"click .report-err-btn":function(t){this.trigger("report-err",this,t)},"click .visualization-btn":function(t){this.trigger("visualize",this,t)},"click .dbkey a":function(t){this.trigger("edit",this,t)}}),_clickUndeleteLink:function(t){return this.model.undelete(),!1},_clickPurgeLink:function(t){return window.confirm((0,k.default)("This will permanently remove the data in your dataset. Are you sure?"))&&this.model.purge(),!1},toString:function(){var t=this.model?"".concat(this.model):"(no model)";return"HDAEditView(".concat(t,")")}});z.prototype.templates=(E=f.default.extend({},A.prototype.templates.warnings,{failed_metadata:b.default.wrapTemplate(['<% if( dataset.state === "failed_metadata" ){ %>','<div class="failed_metadata-warning warningmessagesmall">',(0,k.default)("An error occurred setting the metadata for this dataset"),'<br /><a href="<%- dataset.urls.edit %>" target="_top">',(0,k.default)("Set it manually or retry auto-detection"),"</a>","</div>","<% } %>"],"dataset"),deleted:b.default.wrapTemplate(["<% if( dataset.deleted && !dataset.purged ){ %>",'<div class="deleted-msg warningmessagesmall">',(0,k.default)("This dataset has been deleted"),'<br /><a class="undelete-link" href="javascript:void(0);">',(0,k.default)("Undelete it"),"</a>","<% if( view.purgeAllowed ){ %>",'<br /><a class="purge-link" href="javascript:void(0);">',(0,k.default)("Permanently remove it from disk"),"</a>","<% } %>","</div>","<% } %>"],"dataset")}),y=b.default.wrapTemplate(["<% if( visualizations.length === 1 ){ %>",'<a class="visualization-link icon-btn" href="<%- visualizations[0].href %>"',' target="<%- visualizations[0].target %>" title="',(0,k.default)("Visualize in"),' <%- visualizations[0].html %>">','<span class="fa fa-bar-chart-o"></span>',"</a>","<% } else { %>",'<div class="visualizations-dropdown dropdown icon-btn">','<a data-toggle="dropdown" title="',(0,k.default)("Visualize"),'">','<span class="fa fa-bar-chart-o"></span>',"</a>",'<ul class="dropdown-menu" role="menu">',"<% _.each( visualizations, function( visualization ){ %>",'<li><a class="visualization-link" href="<%- visualization.href %>"',' target="<%- visualization.target %>">',"<%- visualization.html %>","</a></li>","<% }); %>","</ul>","</div>","<% } %>"],"visualizations"),f.default.extend({},A.prototype.templates,{warnings:E,visualizations:y})),t.default={DatasetListItemEdit:z}});