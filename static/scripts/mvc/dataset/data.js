define(["exports","underscore","jquery","backbone","onload/loadConfig","utils/localization","mvc/ui/icon-button","app"],function(t,e,i,a,n,l,o,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createTabularDatasetChunkedView=t.DatasetCollection=t.TabularDataset=t.Dataset=void 0;var d=f(e),u=f(i),r=f(a),h=f(l),c=f(o);function f(t){return t&&t.__esModule?t:{default:t}}var _=r.default.Model.extend({}),m=t.Dataset=r.default.Model.extend({defaults:{id:"",type:"",name:"",hda_ldda:"hda",metadata:null},initialize:function(){this.get("metadata")||this._set_metadata(),this.on("change",this._set_metadata,this)},_set_metadata:function(){var i=new _;d.default.each(d.default.keys(this.attributes),function(t){if(0===t.indexOf("metadata_")){var e=t.split("metadata_")[1];i.set(e,this.attributes[t]),delete this.attributes[t]}},this),this.set("metadata",i,{silent:!0})},get_metadata:function(t){return this.attributes.metadata.get(t)},urlRoot:"".concat((0,n.getAppRoot)(),"api/datasets")}),p=t.TabularDataset=m.extend({defaults:d.default.extend({},m.prototype.defaults,{chunk_url:null,first_data_chunk:null,offset:0,at_eof:!1}),initialize:function(t){m.prototype.initialize.call(this),this.attributes.first_data_chunk&&(this.attributes.offset=this.attributes.first_data_chunk.offset),this.attributes.chunk_url="".concat((0,n.getAppRoot)(),"dataset/display?dataset_id=").concat(this.id),this.attributes.url_viz="".concat((0,n.getAppRoot)(),"visualization")},get_next_chunk:function(){if(this.attributes.at_eof)return null;var i=this,a=u.default.Deferred();return u.default.getJSON(this.attributes.chunk_url,{offset:i.attributes.offset}).success(function(t){var e;""!==t.ck_data?(e=t,i.attributes.offset=t.offset):(i.attributes.at_eof=!0,e=null),a.resolve(e)}),a}}),g=(t.DatasetCollection=r.default.Collection.extend({model:m}),r.default.View.extend({initialize:function(t){this.row_count=0,this.loading_chunk=!1,new k({model:t.model,$el:this.$el})},expand_to_container:function(){this.$el.height()<this.scroll_elt.height()&&this.attempt_to_fetch()},attempt_to_fetch:function(t){var e=this;!this.loading_chunk&&this.scrolled_to_bottom()&&(this.loading_chunk=!0,this.loading_indicator.show(),u.default.when(e.model.get_next_chunk()).then(function(t){t&&(e._renderChunk(t),e.loading_chunk=!1),e.loading_indicator.hide(),e.expand_to_container()}))},render:function(){this.loading_indicator=(0,u.default)("<div/>").attr("id","loading_indicator"),this.$el.append(this.loading_indicator);var t=(0,u.default)("<table/>").attr({id:"content_table",cellpadding:0});this.$el.append(t);var e=this.model.get_metadata("column_names"),i=(0,u.default)("<thead/>").appendTo(t),a=(0,u.default)("<tr/>").appendTo(i);if(e)a.append("<th>".concat(e.join("</th><th>"),"</th>"));else for(var n=1;n<=this.model.get_metadata("columns");n++)a.append("<th>".concat(n,"</th>"));var l=this,o=this.model.get("first_data_chunk");o?this._renderChunk(o):u.default.when(l.model.get_next_chunk()).then(function(t){l._renderChunk(t)}),this.scroll_elt.scroll(function(){l.attempt_to_fetch()})},scrolled_to_bottom:function(){return!1},_renderCell:function(t,e,i){var a=(0,u.default)("<td>").text(t),n=this.model.get_metadata("column_types");return void 0!==i?a.attr("colspan",i).addClass("stringalign"):n&&e<n.length&&("str"!==n[e]&&"list"!==n[e]||a.addClass("stringalign")),a},_renderRow:function(t){var e=t.split("\t"),i=(0,u.default)("<tr>"),a=this.model.get_metadata("columns");return this.row_count%2!=0&&i.addClass("dark_row"),e.length===a?d.default.each(e,function(t,e){i.append(this._renderCell(t,e))},this):e.length>a?(d.default.each(e.slice(0,a-1),function(t,e){i.append(this._renderCell(t,e))},this),i.append(this._renderCell(e.slice(a-1).join("\t"),a-1))):1===e.length?i.append(this._renderCell(t,0,a)):(d.default.each(e,function(t,e){i.append(this._renderCell(t,e))},this),d.default.each(d.default.range(a-e.length),function(){i.append((0,u.default)("<td>"))})),this.row_count++,i},_renderChunk:function(t){var i=this.$el.find("table");d.default.each(t.ck_data.split("\n"),function(t,e){""!==t&&i.append(this._renderRow(t))},this)}})),v=g.extend({initialize:function(t){g.prototype.initialize.call(this,t);var e=d.default.find(this.$el.parents(),function(t){return"auto"===(0,u.default)(t).css("overflow")});e||(e=window),this.scroll_elt=(0,u.default)(e)},scrolled_to_bottom:function(){return this.$el.height()-this.scroll_elt.scrollTop()-this.scroll_elt.height()<=0}}),b=g.extend({initialize:function(t){g.prototype.initialize.call(this,t),this.scroll_elt=this.$el.css({position:"relative",overflow:"scroll",height:t.height||"500px"})},scrolled_to_bottom:function(){return this.$el.scrollTop()+this.$el.innerHeight()>=this.el.scrollHeight}}),k=r.default.View.extend({col:{chrom:null,start:null,end:null},url_viz:null,dataset_id:null,genome_build:null,file_ext:null,initialize:function(t){var e=(0,s.getGalaxyInstance)();if(e&&e.modal&&(this.modal=e.modal),e&&e.frame&&(this.frame=e.frame),this.modal&&this.frame){var i=t.model,a=i.get("metadata");if(i.get("file_ext")){if(this.file_ext=i.get("file_ext"),"bed"==this.file_ext){if(!(a.get("chromCol")&&a.get("startCol")&&a.get("endCol")))return void console.log("TabularButtonTrackster : Bed-file metadata incomplete.");this.col.chrom=a.get("chromCol")-1,this.col.start=a.get("startCol")-1,this.col.end=a.get("endCol")-1}if("vcf"==this.file_ext){var n=function(t,e){for(var i=0;i<e.length;i++)if(e[i].match(t))return i;return-1};if(this.col.chrom=n("Chrom",a.get("column_names")),this.col.start=n("Pos",a.get("column_names")),this.col.end=null,-1==this.col.chrom||-1==this.col.start)return void console.log("TabularButtonTrackster : VCF-file metadata incomplete.")}if(void 0!==this.col.chrom)if(i.id)if(this.dataset_id=i.id,i.get("url_viz")){this.url_viz=i.get("url_viz"),i.get("genome_build")&&(this.genome_build=i.get("genome_build"));var l=new c.default.IconButtonView({model:new c.default.IconButton({title:(0,h.default)("Visualize"),icon_class:"chart_curve",id:"btn_viz"})});this.setElement(t.$el),this.$el.append(l.render().$el),this.hide()}else console.log("TabularButtonTrackster : Url for visualization controller is missing.");else console.log("TabularButtonTrackster : Dataset identification is missing.")}}},events:{"mouseover tr":"show",mouseleave:"hide"},show:function(t){var e=this;if(null!==this.col.chrom){var i,a=(0,u.default)(t.target).parent(),n=a.children().eq(this.col.chrom).html(),l=a.children().eq(this.col.start).html(),o=this.col.end?a.children().eq(this.col.end).html():l;if(n.match("^#")||""===n||(i=l,isNaN(parseFloat(i))||!isFinite(i)))(0,u.default)("#btn_viz").hide();else{var s={dataset_id:this.dataset_id,gene_region:"".concat(n,":").concat(l,"-").concat(o)},d=a.offset(),r=d.left-10,c=d.top-(0,u.default)(window).scrollTop()+3;(0,u.default)("#btn_viz").css({position:"fixed",top:"".concat(c,"px"),left:"".concat(r,"px")}),(0,u.default)("#btn_viz").off("click"),(0,u.default)("#btn_viz").click(function(){e.frame.add({title:(0,h.default)("Trackster"),url:"".concat(e.url_viz,"/trackster?").concat(u.default.param(s))})}),(0,u.default)("#btn_viz").show()}}},hide:function(){this.$("#btn_viz").hide()}});t.createTabularDatasetChunkedView=function(t){t.model||(t.model=new p(t.dataset_config));var e=t.parent_elt,i=t.embedded;delete t.embedded,delete t.parent_elt,delete t.dataset_config;var a=i?new b(t):new v(t);return a.render(),e&&(e.append(a.$el),a.expand_to_container()),a}});