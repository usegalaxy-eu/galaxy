define(["exports","underscore","jquery","backbone","onload/loadConfig","mvc/dataset/states","mvc/base-mvc","utils/localization"],function(t,e,a,n,i,s,r,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var u=g(e),l=g(a),d=g(n),c=g(s),f=g(r),h=g(o);function g(t){return t&&t.__esModule?t:{default:t}}var _="dataset",p=f.default.SearchableModelMixin,m=d.default.Model.extend(f.default.LoggableMixin).extend(f.default.mixin(p,{_logNamespace:_,defaults:{state:c.default.NEW,deleted:!1,purged:!1,name:"(unnamed dataset)",accessible:!0,data_type:"",file_ext:"",file_size:0,meta_files:[],misc_blurb:"",misc_info:"",tags:[]},initialize:function(t,e){this.debug("".concat(this,"(Dataset).initialize"),t,e),this.get("accessible")||this.set("state",c.default.NOT_VIEWABLE),this.urls=this._generateUrls(),this._setUpListeners()},_getDatasetId:function(){return this.get("id")},_generateUrls:function(){var t=this._getDatasetId();if(!t)return{};var a={purge:"datasets/".concat(t,"/purge_async"),display:"datasets/".concat(t,"/display/?preview=True"),edit:"datasets/edit?dataset_id=".concat(t),download:"datasets/".concat(t,"/display").concat(this._downloadQueryParameters()),report_error:"dataset/errors?id=".concat(t),rerun:"tool_runner/rerun?id=".concat(t),show_params:"datasets/".concat(t,"/show_params"),visualization:"visualization",meta_download:"dataset/get_metadata_file?hda_id=".concat(t,"&metadata_name=")};return u.default.each(a,function(t,e){a[e]=(0,i.getAppRoot)()+t}),this.urls=a},_downloadQueryParameters:function(){return"?to_ext=".concat(this.get("file_ext"))},_setUpListeners:function(){this.on("change:state",function(t,e){this.log("".concat(this," has changed state:"),t,e),this.inReadyState()&&this.trigger("state:ready",t,e,this.previous("state"))}),this.on("change:id change:file_ext",function(t){this._generateUrls()})},toJSON:function(){var t=d.default.Model.prototype.toJSON.call(this);return u.default.extend(t,{urls:this.urls})},isDeletedOrPurged:function(){return this.get("deleted")||this.get("purged")},inReadyState:function(){var t=u.default.contains(c.default.READY_STATES,this.get("state"));return this.isDeletedOrPurged()||t},hasDetails:function(){return!this.get("accessible")||this.has("annotation")},hasData:function(){return 0<this.get("file_size")},fetch:function(t){var e=this;return d.default.Model.prototype.fetch.call(this,t).always(function(){e._generateUrls()})},parse:function(t,e){var a=d.default.Model.prototype.parse.call(this,t,e);return a.create_time&&(a.create_time=new Date(a.create_time)),a.update_time&&(a.update_time=new Date(a.update_time)),a},save:function(t,e){return(e=e||{}).wait=!!u.default.isUndefined(e.wait)||e.wait,d.default.Model.prototype.save.call(this,t,e)},delete:function(t){return this.get("deleted")?l.default.when():this.save({deleted:!0},t)},undelete:function(t){return!this.get("deleted")||this.get("purged")?l.default.when():this.save({deleted:!1},t)},purge:function(s){if(this.get("purged"))return l.default.when();(s=s||{}).url=this.urls.purge;var r=this,t=l.default.ajax(s);return t.done(function(t,e,a){r.set({deleted:!0,purged:!0})}),t.fail(function(t,e,a){var n=(0,h.default)("Unable to purge dataset"),i="Removal of datasets by users is not allowed in this Galaxy instance";t.responseJSON&&t.responseJSON.error?n=t.responseJSON.error:-1!==t.responseText.indexOf(i)&&(n=i),t.responseText=n,r.trigger("error",r,t,s,(0,h.default)(n),{error:n})}),t},searchAttributes:["name","file_ext","genome_build","misc_blurb","misc_info","annotation","tags"],searchAliases:{title:"name",format:"file_ext",database:"genome_build",blurb:"misc_blurb",description:"misc_blurb",info:"misc_info",tag:"tags"},toString:function(){var t=this.get("id")||"";return this.get("name")&&(t='"'.concat(this.get("name"),'",').concat(t)),"Dataset(".concat(t,")")}})),v=d.default.Collection.extend(f.default.LoggableMixin).extend({_logNamespace:_,model:m,urlRoot:"".concat((0,i.getAppRoot)(),"api/datasets"),url:function(){return this.urlRoot},ids:function(){return this.map(function(t){return t.get("id")})},notReady:function(){return this.filter(function(t){return!t.inReadyState()})},haveDetails:function(){return this.all(function(t){return t.hasDetails()})},ajaxQueue:function(n,i){var s=l.default.Deferred(),r=this.length,o=[];if(!r)return s.resolve([]),s;var u=this.chain().reverse().map(function(e,a){return function(){var t=n.call(e,i);t.done(function(t){s.notify({curr:a,total:r,response:t,model:e})}),t.always(function(t){o.push(t),u.length?u.shift()():s.resolve(o)})}}).value();return u.shift()(),s},matches:function(e){return this.filter(function(t){return t.matches(e)})},toString:function(){return["DatasetAssociationCollection(",this.length,")"].join("")}});t.default={DatasetAssociation:m,DatasetAssociationCollection:v}});