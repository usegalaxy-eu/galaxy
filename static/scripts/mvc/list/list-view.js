define(["exports","jquery","backbone","underscore","mvc/list/list-item","ui/loading-indicator","mvc/base-mvc","utils/localization","ui/search-input"],function(e,t,i,s,n,l,r,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var c=g(t),a=g(i),d=g(s),h=g(n),u=g(l),f=g(r),v=g(o);function g(e){return e&&e.__esModule?e:{default:e}}var m=a.default.View.extend(f.default.LoggableMixin).extend({_logNamespace:"list",viewClass:h.default.ListItemView,collectionClass:a.default.Collection,tagName:"div",className:"list-panel",fxSpeed:"fast",emptyMsg:(0,v.default)("This list is empty"),noneFoundMsg:(0,v.default)("No matching items found"),searchPlaceholder:(0,v.default)("search"),initialize:function(e,t){(e=e||{}).logger&&(this.logger=e.logger),this.log("".concat(this,".initialize:"),e),this.fxSpeed=d.default.has(e,"fxSpeed")?e.fxSpeed:this.fxSpeed,this.filters=[],this.searchFor=e.searchFor||"",this.selecting=void 0===e.selecting||e.selecting,this.selected=e.selected||[],this.lastSelected=null,this.dragItems=e.dragItems||!1,this.viewClass=e.viewClass||this.viewClass,this.views=[],this.collection=e.collection||this._createDefaultCollection(),this.filters=e.filters||[],this.$scrollContainer=e.$scrollContainer||this.$scrollContainer,this.title=e.title||"",this.subtitle=e.subtitle||"",this._setUpListeners()},_setUpListeners:function(){return this.off(),this.on({error:function(e,t,i,s,n){console.error(e,t,i,s,n)},loading:function(){this._showLoadingIndicator("loading...",40)},"loading-done":function(){this._hideLoadingIndicator(40)}}),this.once("rendered",function(){this.trigger("rendered:initial",this)}),this._setUpCollectionListeners(),this._setUpViewListeners(),this},_createDefaultCollection:function(){return new this.collectionClass([])},_setUpCollectionListeners:function(){return this.log("".concat(this,"._setUpCollectionListeners"),this.collection),this.stopListening(this.collection),this.listenTo(this.collection,{error:function(e,t,i,s,n){this.trigger("error",e,t,i,s,n)},update:function(e,t){var i=t.changes;return t.renderAll||1<i.added.length+i.removed.length?this.renderItems():1===i.added.length?this.addItemView(d.default.first(i.added),e,t):1===i.removed.length?this.removeItemView(d.default.first(i.removed),e,t):void 0}}),this},_setUpViewListeners:function(){this.log("".concat(this,"._setUpViewListeners")),this.on({"view:selected":function(e,t){if(t&&t.shiftKey&&this.lastSelected){var i=this.viewFromModelId(this.lastSelected);i&&this.selectRange(e,i)}else t&&t.altKey&&!this.selecting&&this.showSelectors();this.selected.push(e.model.id),this.lastSelected=e.model.id},"view:de-selected":function(e,t){this.selected=d.default.without(this.selected,e.model.id)}})},render:function(e){this.log("".concat(this,".render"),e);var t=this._buildNewRender();return this._setUpBehaviors(t),this._queueNewRender(t,e),this},_buildNewRender:function(){this.debug("".concat(this,"(ListPanel)._buildNewRender"));var e=(0,c.default)(this.templates.el({},this));return this._renderControls(e),this._renderTitle(e),this._renderSubtitle(e),this._renderSearch(e),this.renderItems(e),e},_renderControls:function(e){this.debug("".concat(this,"(ListPanel)._renderControls"));var t=(0,c.default)(this.templates.controls({},this));return e.find(".controls").replaceWith(t),t},_renderTitle:function(e){},_renderSubtitle:function(e){},_queueNewRender:function(t,i){i=void 0===i?this.fxSpeed:i;var s=this;s.log("_queueNewRender:",t,i),(0,c.default)(s).queue("fx",[function(e){s.$el.fadeOut(i,e)},function(e){s._swapNewRender(t),e()},function(e){s.$el.fadeIn(i,e)},function(e){s.trigger("rendered",s),e()}])},_swapNewRender:function(e){return this.$el.empty().attr("class",this.className).append(e.children()),this.selecting&&this.showSelectors(0),this},_setUpBehaviors:function(e){return e=e||this.$el,this.$controls(e).find("[title]").tooltip(),this._renderMultiselectActionMenu(e),this},_renderMultiselectActionMenu:function(e){var t=(e=e||this.$el).find(".list-action-menu"),i=this.multiselectActions();if(!i.length)return t.empty();var s=(0,c.default)(['<div class="list-action-menu btn-group">','<button class="list-action-menu-btn btn btn-secondary dropdown-toggle" data-toggle="dropdown">',(0,v.default)("For all selected"),"...","</button>",'<ul class="dropdown-menu float-right" role="menu">',"</ul>","</div>"].join("")),n=i.map(function(t){var e=['<li><a href="javascript:void(0);">',t.html,"</a></li>"].join("");return(0,c.default)(e).click(function(e){return e.preventDefault(),t.func(e)})});return s.find("ul").append(n),t.replaceWith(s),s},multiselectActions:function(){return[]},$scrollContainer:function(e){return(e||this.$el).parent().parent()},$controls:function(e){return(e||this.$el).find("> .controls")},$list:function(e){return(e||this.$el).find("> .list-items")},$messages:function(e){return(e||this.$el).find("> .controls .messages")},$emptyMessage:function(e){return(e||this.$el).find("> .empty-message")},renderItems:function(e){e=e||this.$el;var t=this;t.log("".concat(this,".renderItems"),e);var i=t.$list(e);t.freeViews();var s=t._filterCollection();return t.views=s.map(function(e){return t._createItemView(e)}),i.empty(),t.views.length&&t._attachItems(e),t._renderEmptyMessage(e).toggle(!t.views.length),t.trigger("views:ready",t.views),t.views},_filterCollection:function(){return this.collection.filter(d.default.bind(this._filterItem,this))},_filterItem:function(t){return d.default.every(this.filters.map(function(e){return e.call(t)}))&&(!this.searchFor||t.matchesAll(this.searchFor))},_createItemView:function(e){var t=new(this._getItemViewClass(e))(d.default.extend(this._getItemViewOptions(e),{model:e}));return this._setUpItemViewListeners(t),t},_destroyItemView:function(e){this.stopListening(e),this.views=d.default.without(this.views,e)},_destroyItemViews:function(e){var t=this;return t.views.forEach(function(e){t.stopListening(e)}),t.views=[],t},freeViews:function(){return this._destroyItemViews()},_getItemViewClass:function(e){return this.viewClass},_getItemViewOptions:function(e){return{fxSpeed:this.fxSpeed,expanded:!1,selectable:this.selecting,selected:d.default.contains(this.selected,e.id),draggable:this.dragItems}},_setUpItemViewListeners:function(e){var t=this;return this.listenTo(e,"all",function(){var e=Array.prototype.slice.call(arguments,0);e[0]="view:".concat(e[0]),t.trigger.apply(t,e)}),this.listenTo(e,"draggable:dragstart",function(e,t){var i={},s=this.getSelectedModels();i=s.length?s.toJSON():[t.model.toJSON()],e.dataTransfer.setData("text",JSON.stringify(i))},this),t},_attachItems:function(e){var t=this;return this.$list(e).append(this.views.map(function(e){return t._renderItemView$el(e)})),this},_renderItemView$el:function(e){return e.render(0).$el},_renderEmptyMessage:function(e){this.debug("_renderEmptyMessage",e,this.searchFor);var t=this.searchFor?this.noneFoundMsg:this.emptyMsg;return this.$emptyMessage(e).text(t)},expandAll:function(){d.default.each(this.views,function(e){e.expand()})},collapseAll:function(){d.default.each(this.views,function(e){e.collapse()})},addItemView:function(e,t,i){var s=this,n=s._filterCollection().indexOf(e);if(-1!==n){var l=s._createItemView(e);return(0,c.default)(l).queue("fx",[function(e){s.$emptyMessage().is(":visible")?s.$emptyMessage().fadeOut(s.fxSpeed,e):e()},function(e){s._attachView(l,n),e()}]),l}},_attachView:function(e,t,i){i=!!d.default.isUndefined(i)||i,t=t||0;var s=this;return s.views.splice(t,0,e),s._insertIntoListAt(t,s._renderItemView$el(e).hide()),s.trigger("view:attached",e),i?e.$el.slideDown(s.fxSpeed,function(){s.trigger("view:attached:rendered")}):(e.$el.show(),s.trigger("view:attached:rendered")),e},_insertIntoListAt:function(e,t){var i=this.$list();return 0===e?i.prepend(t):i.children().eq(e-1).after(t),t},removeItemView:function(t,e,i){var s=this,n=d.default.find(s.views,function(e){return e.model===t});if(n)return s.views=d.default.without(s.views,n),s.trigger("view:removed",n),(0,c.default)({}).queue("fx",[function(e){n.$el.fadeOut(s.fxSpeed,e)},function(e){n.remove(),s.trigger("view:removed:rendered"),s.views.length?e():s._renderEmptyMessage().fadeIn(s.fxSpeed,e)}]),n},viewFromModelId:function(t){return d.default.find(this.views,function(e){return e.model.id===t})},viewFromModel:function(e){return e?this.viewFromModelId(e.id):void 0},viewsWhereModel:function(t){return this.views.filter(function(e){return d.default.isMatch(e.model.attributes,t)})},viewRange:function(e,t){if(e===t)return e?[e]:[];var i=this.views.indexOf(e),s=this.views.indexOf(t);return-1===i||-1===s?i===s?[]:-1===i?[t]:[e]:i<s?this.views.slice(i,s+1):this.views.slice(s,i+1)},_renderSearch:function(e){return e.find(".controls .search-input").searchInput({placeholder:this.searchPlaceholder,initialVal:this.searchFor,onfirstsearch:d.default.bind(this._firstSearch,this),onsearch:d.default.bind(this.searchItems,this),onclear:d.default.bind(this.clearSearch,this)}),e},_firstSearch:function(e){return this.log("onFirstSearch",e),this.searchItems(e)},searchItems:function(e,t){if(this.log("searchItems",e,this.searchFor,t),!t&&this.searchFor===e)return this;this.searchFor=e,this.renderItems(),this.trigger("search:searching",e,this);var i=this.$("> .controls .search-query");return i.val()!==e&&i.val(e),this},clearSearch:function(e){return this.searchFor="",this.trigger("search:clear",this),this.$("> .controls .search-query").val(""),this.renderItems(),this},THROTTLE_SELECTOR_FX_AT:20,showSelectors:function(t){t=void 0!==t?t:this.fxSpeed,this.selecting=!0,this.$(".list-actions").slideDown(t),t=this.views.length>=this.THROTTLE_SELECTOR_FX_AT?0:t,d.default.each(this.views,function(e){e.showSelector(t)})},hideSelectors:function(t){t=void 0!==t?t:this.fxSpeed,this.selecting=!1,this.$(".list-actions").slideUp(t),t=this.views.length>=this.THROTTLE_SELECTOR_FX_AT?0:t,d.default.each(this.views,function(e){e.hideSelector(t)}),this.selected=[],this.lastSelected=null},toggleSelectors:function(){this.selecting?this.hideSelectors():this.showSelectors()},selectAll:function(t){d.default.each(this.views,function(e){e.select(t)})},deselectAll:function(t){this.lastSelected=null,d.default.each(this.views,function(e){e.deselect(t)})},selectRange:function(e,t){var i=this.viewRange(e,t);return d.default.each(i,function(e){e.select()}),i},getSelectedViews:function(){return d.default.filter(this.views,function(e){return e.selected})},getSelectedModels:function(){return new this.collection.constructor(d.default.map(this.getSelectedViews(),function(e){return e.model}))},_showLoadingIndicator:function(e,t,i){this.debug("_showLoadingIndicator",this.indicator,e,t,i),t=void 0!==t?t:this.fxSpeed,this.indicator||(this.indicator=new u.default.LoadingIndicator(this.$el),this.debug("\t created",this.indicator)),this.$el.is(":visible")?(this.$el.fadeOut(t),this.indicator.show(e,t,i)):this.indicator.show(0,i)},_hideLoadingIndicator:function(e,t){this.debug("_hideLoadingIndicator",this.indicator,e,t),e=void 0!==e?e:this.fxSpeed,this.indicator&&this.indicator.hide(e,t)},scrollPosition:function(){return this.$scrollContainer().scrollTop()},scrollTo:function(e,t){return t=t||0,this.$scrollContainer().animate({scrollTop:e},t),this},scrollToTop:function(e){return this.scrollTo(0,e)},scrollToItem:function(e,t){return this},scrollToId:function(e,t){return this.scrollToItem(this.viewFromModelId(e),t)},events:{"click .select-all":"selectAll","click .deselect-all":"deselectAll"},toString:function(){return"ListPanel(".concat(this.collection,")")}});m.prototype.templates={el:f.default.wrapTemplate(["<div>",'<div class="controls"></div>','<div class="list-items"></div>','<div class="empty-message infomessagesmall"></div>',"</div>"]),controls:f.default.wrapTemplate(['<div class="controls">','<div class="title">','<div class="name"><%- view.title %></div>',"</div>",'<div class="subtitle"><%- view.subtitle %></div>','<div class="actions"></div>','<div class="messages"></div>','<div class="search">','<div class="search-input"></div>',"</div>",'<div class="list-actions">','<div class="btn-group">','<button class="select-all btn btn-secondary"','data-mode="select">',(0,v.default)("All"),"</button>",'<button class="deselect-all btn btn-secondary"','data-mode="select">',(0,v.default)("None"),"</button>","</div>",'<div class="list-action-menu btn-group">',"</div>","</div>","</div>"])};var p,w=m.extend({modelCollectionKey:"contents",initialize:function(e){m.prototype.initialize.call(this,e),this.selecting=void 0!==e.selecting&&e.selecting,this.setModel(this.model,e)},setModel:function(e,t){if(t=t||{},this.debug("".concat(this,".setModel:"),e,t),this.freeModel(),this.freeViews(),e){var i=this.model?this.model.get("id"):null;this.model=e,this.logger&&(this.model.logger=this.logger),this._setUpModelListeners(),this.stopListening(this.collection),this.collection=this.model[this.modelCollectionKey]||t.collection||this._createDefaultCollection(),this._setUpCollectionListeners(),i&&e.get("id")!==i&&this.trigger("new-model",this)}return this},freeModel:function(){return this.model&&this.stopListening(this.model),this},_setUpModelListeners:function(){return this.log("".concat(this,"._setUpModelListeners"),this.model),this.listenTo(this.model,"error",function(){var e=Array.prototype.slice.call(arguments,0);e.unshift("error"),this.trigger.apply(this,e)},this),this.logger&&this.listenTo(this.model,"all",function(e){this.info("".concat(this,"(model)"),e,arguments)}),this},_renderControls:function(e){this.debug("".concat(this,"(ModelListPanel)._renderControls"));var t=this.model?this.model.toJSON():{},i=(0,c.default)(this.templates.controls(t,this));return e.find(".controls").replaceWith(i),i},toString:function(){return"ModelListPanel(".concat(this.model,")")}});w.prototype.templates=(p=f.default.wrapTemplate(['<div class="controls">','<div class="title">','<div class="name"><%- model.name %></div>',"</div>",'<div class="subtitle"><%- view.subtitle %></div>','<div class="actions"></div>','<div class="messages"></div>','<div class="search">','<div class="search-input"></div>',"</div>",'<div class="list-actions">','<div class="btn-group">','<button class="select-all btn btn-secondary"','data-mode="select">',(0,v.default)("All"),"</button>",'<button class="deselect-all btn btn-secondary"','data-mode="select">',(0,v.default)("None"),"</button>","</div>",'<div class="list-action-menu btn-group">',"</div>","</div>","</div>"]),d.default.extend(d.default.clone(m.prototype.templates),{controls:p})),e.default={ListPanel:m,ModelListPanel:w}});