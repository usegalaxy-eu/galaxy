define(["exports","underscore","jquery","backbone","onload/loadConfig","libs/jquery/jstree","mvc/toolshed/toolshed-model","utils/utils","mvc/ui/ui-modal","mvc/form/form-view","mvc/toolshed/util"],function(e,t,o,l,r,n,i,a,s,d,c){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var p=g(t),_=g(o),u=g(l),h=(g(n),g(i)),f=g(a),m=g(s),y=g(d),v=g(c);function g(e){return e&&e.__esModule?e:{default:e}}var b=u.default.View.extend({el:"#center",initialize:function(e){this.options=p.default.defaults(this.options||{},this.defaults),this.model=new h.default.RepositoryCollection,this.listenTo(this.model,"sync",this.render);var t=e.tool_shed.replace(/\//g,"%2f");this.model.url+="?tool_shed_url=".concat(t,"&repository_id=").concat(e.repository_id),this.model.tool_shed_url=e.tool_shed.replace(/%2f/g,"/"),this.model.tool_shed=t,this.model.category=e.repository_id,this.model.fetch()},render:function(e){var t=this.templateRepoDetails,o=this.model.models[0];this.options={repository:o.get("repository"),tool_shed:this.model.tool_shed,queue:v.default.queueLength()};var l=Object.keys(this.options.repository.metadata).sort(function(e,t){return parseInt(e.split(":")[0]-t.split(":")[0])}),n={},i=this.options.repository.metadata;l.forEach(function(e){n[e]=i[e]}),this.options.repository.metadata=n,this.options.current_changeset=this.options.current_changeset||l[l.length-1],this.options.current_metadata=this.options.repository.metadata[this.options.current_changeset],this.options.current_metadata.tool_shed_url=this.model.tool_shed_url,this.options.tools=this.options.current_metadata.tools,this.options.repository_dependencies_template=this.templateRepoDependencies,this.options.repository_dependency_template=this.templateRepoDependency,this.options.tps_template_global_select=this.templateGlobalSectionSelect,this.options.tps_template_global_create=this.templateGlobalSectionCreate,this.options.tps_template_tool_select=this.templateToolSectionSelect,this.options.tps_template_tool_create=this.templateToolSectionCreate,this.options.panel_section_options=this.templatePanelSelectOptions,this.options.tool_dependencies=o.get("tool_dependencies"),this.options.shed_tool_conf=this.templateShedToolConf({shed_tool_confs:o.get("shed_conf")}),this.options.panel_section_dict=o.get("panel_section_dict"),this.options.api_url="".concat((0,r.getAppRoot)(),"api/tool_shed_repositories/install?async=True"),this.options=p.default.extend(this.options,e),this.$el.html(t(this.options)),this.checkInstalled(this.options.current_metadata),this.bindEvents(),(0,_.default)("#center").css("overflow","auto")},bindEvents:function(){var c=this;(0,_.default)("#changeset").on("change",function(){c.options.current_changeset=(0,_.default)("#changeset").find("option:selected").text(),c.options.current_metadata=c.options.repository.metadata[c.options.current_changeset],c.checkInstalled(c.options.current_metadata),c.reDraw(c.options)}),(0,_.default)("#tool_panel_section_select").on("change",function(){c.tpsSelection()}),(0,_.default)("#install_repository").on("click",function(e){e.preventDefault();var t={};t.repositories=JSON.stringify([[(0,_.default)("#install_repository").attr("data-tsrid"),(0,_.default)("#changeset").find("option:selected").val()]]),t.tool_shed_repository_ids=JSON.stringify([(0,_.default)("#install_repository").attr("data-tsrid")]),t.tool_shed_url=c.model.tool_shed_url,t.install_tool_dependencies=(0,_.default)("#install_tool_dependencies").val(),t.install_repository_dependencies=(0,_.default)("#install_repository_dependencies").val(),t.install_resolver_dependencies=(0,_.default)("#install_resolver_dependencies").val(),t.tool_panel_section=JSON.stringify(c.panelSelect(t)),t.shed_tool_conf=(0,_.default)("select[name='shed_tool_conf']").find("option:selected").val(),t.changeset=(0,_.default)("#changeset").find("option:selected").val();var o=(0,_.default)("#repository_installation").attr("action");c.prepareInstall(t,o)}),(0,_.default)("#queue_install").on("click",function(e){c.options.current_changeset=(0,_.default)("#changeset").find("option:selected").text(),c.options.current_metadata=c.options.repository.metadata[c.options.current_changeset];var t={};p.default.each(Object.keys(c.options.current_metadata),function(e){t[e]||(t[e]=c.options.current_metadata[e])}),t.install_tool_dependencies=(0,_.default)("#install_tool_dependencies").val(),t.install_repository_dependencies=(0,_.default)("#install_repository_dependencies").val(),t.install_resolver_dependencies=(0,_.default)("#install_resolver_dependencies").val(),t.tool_panel_section=JSON.stringify(c.panelSelect({})),t.shed_tool_conf=(0,_.default)("select[name='shed_tool_conf']").find("option:selected").val(),t.tool_shed_url=c.model.tool_shed_url,"/"==t.tool_shed_url.substr(-1)&&(t.tool_shed_url=t.tool_shed_url.substr(0,t.tool_shed_url.length-1)),v.default.addToQueue(t),c.checkInstalled(t)}),this.toolTPSSelectionEvents(),(0,_.default)(function(){(0,_.default)("#repository_dependencies").jstree()}),(0,_.default)(".tool_form").on("click",function(e){var t=(0,_.default)(e.target).attr("data-guid"),n=(0,_.default)(e.target).attr("data-name"),i=(0,_.default)(e.target).attr("data-desc"),o=c.model.tool_shed_url,l=(0,_.default)("#repository_details").attr("data-tsrid"),a=(0,_.default)("#changeset").find("option:selected").val(),s="".concat((0,r.getAppRoot)(),"api/tool_shed/tool_json"),d={guid:t,tool_shed_url:o,tsr_id:l,changeset:a};_.default.get(s,d,function(e){var t=new y.default(e);f.default.deepeach(e.inputs,function(e){e.type&&-1!=["data","data_collection"].indexOf(e.type)&&(e.type="hidden",e.info="Data input '".concat(e.name,"' (").concat(f.default.textify(e.extensions),")"))});var o=new m.default.View,l="<u>".concat(n,"</u> ").concat(i);o.show({closing_events:!0,title:l,body:t.$el,buttons:{Close:function(){o.hide()}}})})}),(0,_.default)(".select-tps-button").on("click",function(e){var t=c.selectedChangeset(),o=e.target.attributes.getNamedItem("data-toolguid");c.showToolTPSSelect(o,t)}),(0,_.default)(".create-tps-button").on("click",function(e){var t=c.selectedChangeset(),o=e.target.attributes.getNamedItem("data-toolguid");c.showToolTPSCreate(o,t)}),(0,_.default)(".global-select-tps-button").on("click",function(){(0,_.default)("#tool_panel_section").replaceWith(c.options.tps_template_global_select(c.options)),c.propagateTPS(),c.bindEvents()}),(0,_.default)(".global-create-tps-button").on("click",function(){(0,_.default)("#tool_panel_section").replaceWith(c.options.tps_template_global_create()),c.bindEvents()})},checkInstalled:function(i){var a=this,e={name:i.name,owner:i.owner},s=!1;_.default.get("".concat((0,r.getAppRoot)(),"api/tool_shed_repositories"),e,function(e){for(var t=0;t<e.length;t++){var o=e[t],l=!o.deleted&&!o.uninstalled,n=o.changeset_revision==i.changeset_revision||o.installed_changeset_revision==i.changeset_revision;o.name==i.repository.name&&o.owner==i.repository.owner&&l&&n&&(s=!0),s?((0,_.default)("#install_repository").prop("disabled",!0),(0,_.default)("#install_repository").val("This revision is already installed")):((0,_.default)("#install_repository").prop("disabled",!1),(0,_.default)("#install_repository").val("Install this revision"))}a.repoQueued(i)||s?((0,_.default)("#queue_install").hide(),(0,_.default)("#queue_install").val("This revision is already in the queue")):((0,_.default)("#queue_install").show(),(0,_.default)("#queue_install").val("Install this revision later"))})},panelSelect:function(e){var o={};return(0,_.default)("#tool_panel_section_select").length?e.tool_panel_section_id=(0,_.default)("#tool_panel_section_select").find("option:selected").val():e.new_tool_panel_section=(0,_.default)("#new_tool_panel_section").val(),(0,_.default)(".tool_panel_section_picker").each(function(){var e=(0,_.default)(this).attr("name"),t=(0,_.default)(this).attr("data-toolguid");o[t]="tool_panel_section_id"===e?{tool_panel_section:(0,_.default)(this).find("option:selected").val(),action:"append"}:{tool_panel_section:(0,_.default)(this).val(),action:"create"}}),o},reDraw:function(e){this.$el.empty(),this.render(e)},repoQueued:function(e){if(window.localStorage.repositories){var t,o=this.queueKey(e);return window.localStorage.repositories&&(t=JSON.parse(window.localStorage.repositories)),!(!t||!t.hasOwnProperty(o))}},queueKey:function(e){var t=this.model.tool_shed_url;return"/"==t.substr(-1)&&(t=t.substr(0,t.length-1)),"".concat(t,"|").concat(e.repository_id,"|").concat(e.changeset_revision)},tpsSelection:function(){var e=(0,_.default)("#tool_panel_section_select").find("option:selected").val();(0,_.default)('.tool_panel_section_picker[default="active"]').each(function(){(0,_.default)(this).val(e)})},prepareInstall:function(e,t){var o=this;_.default.post(t,e,function(e){var t=JSON.parse(e);o.doInstall(t)})},doInstall:function(e){var t="".concat((0,r.getAppRoot)(),"admin_toolshed/install_repositories"),o=e.repositories,l="status/r/".concat(o.join("|"));_.default.post(t,e,function(e){console.log("Initializing repository installation succeeded")}),u.default.history.navigate(l,{trigger:!0,replace:!0})},selectedChangeset:function(){return(0,_.default)("#changeset").find("option:selected").val()},showToolTPSCreate:function(e,t){var l=this,o=this.options.current_metadata.tools,n=v.default.toolByGuid(e,t,o),i="#tool_tps_"+n.clean;(0,_.default)(i).empty(),(0,_.default)(i).append(this.options.tps_template_tool_create({tool:n})),(0,_.default)(".select-tps-button").click(function(e){var t=l.selectedChangeset(),o=e.target.attributes.getNamedItem("data-toolguid");l.showToolTPSSelect(o,t)}),this.bindEvents()},showToolTPSSelect:function(e,t){var l=this,o=this.options.current_metadata.tools,n=v.default.toolByGuid(e,t,o),i="#tool_tps_"+n.clean;(0,_.default)(i).empty(),(0,_.default)(i).append(this.options.tps_template_tool_select({tool:n,panel_section_dict:this.options.panel_section_dict,panel_section_options:this.options.panel_section_options})),(0,_.default)(".create-tps-button").click(function(e){var t=l.selectedChangeset(),o=e.target.attributes.getNamedItem("data-toolguid");l.showToolTPSCreate(o,t)}),this.bindEvents()},propagateTPS:function(){(0,_.default)("#tool_panel_section_select").change(function(){var t=(0,_.default)("#tool_panel_section_select").find("option:selected").val();(0,_.default)('.tool_panel_section_picker[default="active"]').each(function(e){e.val(t)})}),this.toolTPSSelectionEvents()},toolTPSSelectionEvents:function(){(0,_.default)(".tool_panel_section_picker").on("change",function(e){var t=(0,_.default)(e.target);t.find("option:selected").val()==(0,_.default)("#tool_panel_section_select").find("option:selected").val()?t.attr("default","active"):t.removeAttr("default")})},templateRepoDetails:p.default.template(['<div class="unified-panel-header" id="panel_header" unselectable="on">','<div class="unified-panel-header-inner">Repository information for&nbsp;<strong><%= repository.name %></strong>&nbsp;from&nbsp;<strong><%= repository.owner %></strong><a class="ml-auto" href="#/queue">Repository Queue (<%= queue %>)</a></div>',"</div>",'<div class="unified-panel-body" id="repository_details" data-tsrid="<%= repository.id %>">','<form id="repository_installation" name="install_repository" method="post" action="<%= api_url %>">','<input type="hidden" id="repositories" name="<%= repository.id %>" value="ID" />','<input type="hidden" id="tool_shed_url" name="tool_shed_url" value="<%= tool_shed %>" />','<div class="toolForm">','<div class="toolFormTitle">Changeset</div>','<div class="toolFormBody changeset">','<select id="changeset" name="changeset" style="margin: 5px;">',"<% _.each(Object.keys(repository.metadata), function(changeset) { %>",'<% if (changeset == current_changeset) { var selected = "selected "; } else { var selected = ""; } %>','<option <%= selected %>value="<%= changeset.split(":")[1] %>"><%= changeset %></option>',"<% }); %>","</select>",'<input class="btn btn-primary preview-button" data-tsrid="<%= current_metadata.repository.id %>" type="submit" id="install_repository" name="install_repository" value="Install this revision now" />','<input class="btn btn-primary preview-button" type="button" id="queue_install" name="queue_install" value="Install this revision later" />','<div class="toolParamHelp" style="clear: both;">Please select a revision and review the settings below before installing.</div>',"</div>","</div>","<%= shed_tool_conf %>","<% if (current_metadata.has_repository_dependencies) { %>",'<div class="toolFormTitle">Repository dependencies for <strong id="current_changeset"><%= current_changeset %></strong></div>','<div class="toolFormBody">','<p id="install_repository_dependencies_checkbox">','<input type="checkbox" checked id="install_repository_dependencies" />','<label for="install_repository_dependencies">Install repository dependencies</label>',"</p>","<% current_metadata.repository_dependency_template = repository_dependency_template; %>",'<div class="tables container-table" id="repository_dependencies">','<div class="expandLink">','<a class="toggle_folder" data_target="repository_dependencies_table">',"Repository dependencies &ndash; <em>installation of these additional repositories is required</em>","</a>","</div>","<%= repository_dependencies_template(current_metadata) %>","</div>","</div>","<% } %>","<% if (current_metadata.includes_tool_dependencies) { %>",'<div class="toolFormTitle">Tool dependencies</div>','<div class="toolFormBody">','<p id="install_resolver_dependencies_checkbox">','<input type="checkbox" checked id="install_resolver_dependencies" />','<label for="install_resolver_dependencies">Install resolver dependencies</label>',"</p>",'<p id="install_tool_dependencies_checkbox">','<input type="checkbox" checked id="install_tool_dependencies" />','<label for="install_tool_dependencies">Install tool dependencies</label>',"</p>",'<div class="tables container-table" id="tool_dependencies">','<div class="expandLink">','<a class="toggle_folder" data_target="tool_dependencies_table">',"Tool dependencies &ndash; <em>repository tools require handling of these dependencies</em>","</a>","</div>",'<table class="tables container-table" id="tool_dependencies_table" border="0" cellpadding="2" cellspacing="2" width="100%">',"<thead>",'<tr style="display: table-row;" class="datasetRow" parent="0" id="libraryItem-rt-f9cad7b01a472135">','<th style="padding-left: 40px;">Name</th>',"<th>Version</th>","<th>Type</th>","</tr>","</thead>",'<tbody id="tool_deps">',"<% _.each(tool_dependencies[current_changeset], function(dependency) { %>",'<tr class="datasetRow tool_dependency_row" style="display: table-row;">','<td style="padding-left: 40px;">',"<%= dependency.name %></td>","<td><%= dependency.version %></td>","<td><%= dependency.type %></td>","</tr>","<% }); %>","</tbody>","</table>","</div>","</div>","<% } %>","<% if (current_metadata.includes_tools_for_display_in_tool_panel) { %>",'<div class="toolFormTitle">Tools &ndash; <em>click the name to preview the tool and use the pop-up menu to inspect all metadata</em></div>','<div class="toolFormBody">','<div class="tables container-table" id="tools_toggle">','<table class="tables container-table" id="valid_tools" border="0" cellpadding="2" cellspacing="2" width="100%">',"<thead>",'<tr style="display: table-row;" class="datasetRow" parent="0" id="libraryItem-rt-f9cad7b01a472135">','<th style="padding-left: 40px;">Name</th>',"<th>Description</th>","<th>Version</th>","<th><%= tps_template_global_select({panel_section_dict: panel_section_dict, panel_section_options: panel_section_options}) %></tr>","</thead>",'<tbody id="tools_in_repo">',"<% _.each(current_metadata.tools, function(tool) { %>",'<tr id="libraryItem-<%= tool.clean %>" class="tool_row" style="display: table-row;" style="width: 15%">','<td style="padding-left: 40px;">','<div id="tool-<%= tool.clean %>" class="menubutton split popup" style="float: left;">','<a class="tool_form view-info" data-toggle="modal" data-target="toolform_<%= tool.clean %>" data-clean="<%= tool.clean %>" data-guid="<%= tool.guid %>" data-name="<%= tool.name %>" data-desc="<%= tool.description %>"><%= tool["name"] %></a>',"</div>","</td>","<td><%= tool.description %></td>",'<td style="width: 15%"><%= tool.version %></td>','<td style="width: 35%" id="tool_tps_<%= tool.clean %>">',"<%= tps_template_tool_select({tool: tool, panel_section_dict: panel_section_dict, panel_section_options: panel_section_options}) %>","</td>","</tr>","<% }); %>","</tbody>","</table>","</div>","</div>","<% } %>","</form>","</div>"].join("")),templateRepoDependencies:p.default.template(['<div class="toolFormTitle">Repository Dependencies</div>','<div class="toolFormBody tables container-table" id="repository_dependencies">',"<ul>","<li>Repository installation requires the following","<% if (has_repository_dependencies) { %>","<% _.each(repository_dependencies, function(dependency) { %>","<% dependency.repository_dependency_template = repository_dependency_template; %>","<%= repository_dependency_template(dependency) %>","<% }); %>","<% } %>","</li>","</ul>","</div>"].join("")),templateRepoDependency:p.default.template(['<li id="metadata_<%= id %>" class="datasetRow repository_dependency_row">',"Repository <b><%= repository.name %></b> revision <b><%= changeset_revision %></b> owned by <b><%= repository.owner %></b>","<% if (has_repository_dependencies) { %>",'<ul class="child_dependencies">',"<% _.each(repository_dependencies, function(dependency) { %>","<% dependency.repository_dependency_template = repository_dependency_template; %>","<%= repository_dependency_template(dependency) %>","<% }); %>","</ul>","<% } %>","</li>"].join("")),templateShedToolConf:p.default.template(['<div class="toolFormTitle">Shed tool configuration file:</div>','<div class="toolFormBody">','<div class="form-row">','<select name="shed_tool_conf">',"<% _.each(shed_tool_confs.options, function(conf) { %>",'<option value="<%= conf.value %>"><%= conf.label %></option>',"<% }); %>","</select>",'<div class="toolParamHelp" style="clear: both;">Select the file whose <b>tool_path</b> setting you want used for installing repositories.</div>',"</div>","</div>"].join("")),templateToolDependency:p.default.template(["<% if (has_repository_dependencies) { %>","<% _.each(repository_dependencies, function(dependency) { %>","<% if (dependency.includes_tool_dependencies) { %>","<% dependency.tool_dependency_template = tool_dependency_template %>","<%= tool_dependency_template(dependency) %>","<% } %>","<% }); %>","<% } %>"].join("")),templateGlobalSectionCreate:p.default.template(['<div id="tool_panel_section">','<div class="form-row" id="new_tps">','<input id="new_tool_panel_section" name="new_tool_panel_section" type="textfield" value="" size="40"/>','<input class="btn btn-primary global-select-tps-button" type="button" id="select_existing" value="Select existing" />','<div class="toolParamHelp" style="clear: both;">',"Add a new tool panel section to contain the installed tools (optional).","</div>","</div>","</div>"].join("")),templateGlobalSectionSelect:p.default.template(['<div id="tool_panel_section">','<div class="toolFormTitle">Tool Panel Section</div>','<div class="toolFormBody">','<div class="tab-pane" id="select_tps">','<select name="<%= name %>" id="<%= panel_section_dict.id %>">',"<%= panel_section_options({sections: panel_section_dict.sections}) %>","</select>",'<input class="btn btn-primary global-create-tps-button" type="button" id="create_new" value="Create new" />','<div class="toolParamHelp" style="clear: both;">',"Select an existing tool panel section to contain the installed tools (optional).","</div>","</div>","</div>","</div>"].join("")),templateToolSectionCreate:p.default.template(['<div id="new_tps_<%= tool.clean %>" data-clean="<%= tool.clean %>" class="form-row">','<input data-toolguid="<%= tool.guid %>" class="tool_panel_section_picker" size="40" name="new_tool_panel_section" id="new_tool_panel_section_<%= tool.clean %>" type="text">','<input id="per_tool_select_<%= tool.clean %>" class="btn btn-primary select-tps-button" data-toolguid="<%= tool.guid %>" value="Select existing" id="select_existing_<%= tool.clean %>" type="button">',"</div>"].join("")),templateToolSectionSelect:p.default.template(['<div id="select_tps_<%= tool.clean %>" data-clean="<%= tool.clean %>" class="tps_creator">','<select default="active" style="width: 30em;" data-toolguid="<%= tool.guid %>" class="tool_panel_section_picker" name="tool_panel_section_id" id="tool_panel_section_select_<%= tool.clean %>">',"<%= panel_section_options({sections: panel_section_dict.sections}) %>","</select>",'<input id="per_tool_create_<%= tool.clean %>" data-clean="<%= tool.clean %>" class="btn btn-primary create-tps-button" data-toolguid="<%= tool.guid %>" value="Create new" id="create_new_<%= tool.clean %>" type="button">','<div style="clear: both;" class="toolParamHelp"></div>',"</div>"].join("")),templatePanelSelectOptions:p.default.template(["<% _.each(sections, function(section) { %>",'<option value="<%= section.id %>"><%= section.name %></option>',"<% }); %>"].join(""))});e.default={RepoDetails:b}});