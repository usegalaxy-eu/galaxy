define(["exports","utils/utils","legacy/grid/grid-model","legacy/grid/grid-template","mvc/ui/popup-menu"],function(t,i,e,n,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=d(i),s=d(e),o=d(n),c=d(r);function d(t){return t&&t.__esModule?t:{default:t}}jQuery.ajaxSettings.traditional=!0,t.default=Backbone.View.extend({grid:null,initialize:function(i){this.grid=new s.default,this.dict_format=i.dict_format,this.title=i.title,this.title_id=i.title_id;var n=this;if(window.add_tag_to_grid_filter=function(t,i){var e=t+(void 0!==i&&""!==i?":".concat(i):"");$("#advanced-search").is(":visible")||($("#standard-search").slideToggle("fast"),$("#advanced-search").slideToggle("fast")),n.add_filter_condition("tags",e)},this.dict_format)if(this.setElement("<div/>"),i.url_base&&!i.items){var e=i.url_data||{};_.each(i.filters,function(t,i){e["f-".concat(i)]=t}),$.ajax({url:"".concat(i.url_base,"?").concat($.param(e)),success:function(t){t.embedded=i.embedded,t.filters=i.filters||{},n.init_grid(t)}})}else this.init_grid(i);else this.setElement("#grid-container"),this.init_grid(i);i.use_panels&&$("#center").css({padding:"10px",overflow:"auto"})},handle_refresh:function(t){t&&-1<$.inArray("history",t)&&window.top.Galaxy&&window.top.Galaxy.currHistoryPanel&&window.top.Galaxy.currHistoryPanel.loadCurrentHistory()},init_grid:function(t){this.grid.set(t);var i=this.grid.attributes;this.allow_title_display&&i.title&&a.default.setWindowTitle(i.title),this.handle_refresh(i.refresh_frames);var e=this.grid.get("url_base");if(e=e.replace(/^.*\/\/[^\/]+/,""),this.grid.set("url_base",e),this.$el.html(o.default.grid(i)),this.$el.find("#grid-table-header").html(o.default.header(i)),this.$el.find("#grid-table-body").html(o.default.body(i)),this.$el.find("#grid-table-footer").html(o.default.footer(i)),i.message){this.$el.find("#grid-message").html(o.default.message(i));var n=this;i.use_hide_message&&setTimeout(function(){n.$el.find("#grid-message").html("")},5e3)}this.init_grid_elements(),this.init_grid_controls(),window.init_refresh_on_change&&window.init_refresh_on_change()},init_grid_controls:function(){var n=this;this.$el.find(".operation-button").each(function(){$(this).off(),$(this).click(function(){return n.submit_operation(this),!1})}),this.$el.find("input[type=text]").each(function(){$(this).off(),$(this).click(function(){$(this).select()}).keyup(function(){$(this).css("font-style","normal")})}),this.$el.find(".sort-link").each(function(){$(this).off(),$(this).click(function(){return n.set_sort_condition($(this).attr("sort_key")),!1})}),this.$el.find(".text-filter-form").each(function(){$(this).off(),$(this).submit(function(){var t=$(this).attr("column_key"),i=$("#input-".concat(t,"-filter")),e=i.val();return i.val(""),n.add_filter_condition(t,e),!1})}),this.$el.find(".text-filter-val > a").each(function(){$(this).off(),$(this).click(function(){return $(this).parent().remove(),n.remove_filter_condition($(this).attr("filter_key"),$(this).attr("filter_val")),!1})}),this.$el.find(".categorical-filter > a").each(function(){$(this).off(),$(this).click(function(){return n.set_categorical_filter($(this).attr("filter_key"),$(this).attr("filter_val")),!1})}),this.$el.find(".advanced-search-toggle").each(function(){$(this).off(),$(this).click(function(){return n.$el.find("#standard-search").slideToggle("fast"),n.$el.find("#advanced-search").slideToggle("fast"),!1})}),this.$el.find("#check_all").off(),this.$el.find("#check_all").on("click",function(){n.check_all_items()})},init_grid_elements:function(){this.$el.find(".grid").each(function(){var t=$(this).find("input.grid-row-select-checkbox"),i=$(this).find("span.grid-selected-count"),e=function(){i.text($(t).filter(":checked").length)};$(t).each(function(){$(this).change(e)}),e()}),0!==this.$el.find(".community_rating_star").length&&this.$el.find(".community_rating_star").rating({});var r=this.grid.attributes,a=this;this.$el.find(".page-link > a").each(function(){$(this).click(function(){return a.set_page($(this).attr("page_num")),!1})}),this.$el.find(".use-target").each(function(){$(this).click(function(){return a.execute({href:$(this).attr("href"),target:$(this).attr("target")}),!1})}),0!==r.items.length&&_.each(r.items,function(i,t){var e=a.$("#grid-".concat(i.encode_id,"-popup")).off(),n=new c.default(e);_.each(r.operations,function(t){a._add_operation(n,t,i)})})},_add_operation:function(t,e,n){var r=this,i=n.operation_config[e.label];i.allowed&&e.allow_popup&&t.addItem({html:e.label,href:i.url_args,target:i.target,confirmation_text:e.confirm,func:function(t){t.preventDefault();var i=$(t.target).html();e.onclick?e.onclick(n.encode_id):r.execute(this.findItemByHtml(i))}})},add_filter_condition:function(t,i){if(""===i)return!1;this.grid.add_filter(t,i,!0);var e=$(o.default.filter_element(t,i)),n=this;e.click(function(){$(this).remove(),n.remove_filter_condition(t,i)}),this.$el.find("#".concat(t,"-filtering-criteria")).append(e),this.go_page_one(),this.execute()},remove_filter_condition:function(t,i){this.grid.remove_filter(t,i),this.go_page_one(),this.execute()},set_sort_condition:function(t){var i=this.grid.get("sort_key"),e=t;-1!==i.indexOf(t)&&"-"!==i.substring(0,1)&&(e="-".concat(t)),this.$el.find(".sort-arrow").remove();var n="-"==e.substring(0,1)?"&uarr;":"&darr;",r=$("<span>".concat(n,"</span>")).addClass("sort-arrow");this.$el.find("#".concat(t,"-header")).append(r),this.grid.set("sort_key",e),this.go_page_one(),this.execute()},set_categorical_filter:function(n,r){var a=this.grid.get("categorical_filters")[n],s=this.grid.get("filters")[n],o=this;this.$el.find(".".concat(n,"-filter")).each(function(){var t=$.trim($(this).text()),i=a[t][n];if(i==r)$(this).empty(),$(this).addClass("current-filter"),$(this).append(t);else if(i==s){$(this).empty();var e=$('<a href="#">'.concat(t,"</a>"));e.click(function(){o.set_categorical_filter(n,i)}),$(this).removeClass("current-filter"),$(this).append(e)}}),this.grid.add_filter(n,r),this.go_page_one(),this.execute()},set_page:function(a){var s=this;this.$el.find(".page-link").each(function(){var t,i=$(this).attr("id"),e=parseInt(i.split("-")[2],10),n=s.grid.get("cur_page");if(e===a)t=$(this).children().text(),$(this).empty(),$(this).addClass("inactive-link"),$(this).text(t);else if(e===n){t=$(this).text(),$(this).empty(),$(this).removeClass("inactive-link");var r=$('<a href="#">'.concat(t,"</a>"));r.click(function(){s.set_page(e)}),$(this).append(r)}}),"all"===a?this.grid.set("cur_page",a):this.grid.set("cur_page",parseInt(a,10)),this.execute()},submit_operation:function(t,i){var e=$(t).val();if(this.$el.find('input[name="id"]:checked').length<1)return!1;var n=_.findWhere(this.grid.attributes.operations,{label:e});n&&!i&&(i=n.confirm||"");var r=[];this.$el.find("input[name=id]:checked").each(function(){r.push($(this).val())});var a={operation:e,id:r,confirmation_text:i};return"top"!=n.target&&"center"!=n.target||(a=_.extend(a,{href:n.href,target:n.target})),this.execute(a),!0},check_all_items:function(){var t=this.$(".grid-row-select-checkbox"),i=this.$("#check_all").prop("checked");_.each(t,function(t){$(t).prop("checked",i)}),this.init_grid_elements()},go_page_one:function(){var t=this.grid.get("cur_page");null!=t&&"all"!==t&&this.grid.set("cur_page",1)},execute:function(t){var i=null,e=null,n=null,r=null,a=null;if(t&&(e=t.href,n=t.operation,i=t.id,r=t.confirmation_text,a=t.target,void 0!==e&&-1!=e.indexOf("operation="))){var s=e.split("?");if(1<s.length)for(var o=s[1].split("&"),c=0;c<o.length;c++)-1!=o[c].indexOf("operation")?n=(n=o[c].split("=")[1]).replace(/\+/g," "):-1!=o[c].indexOf("id")&&(i=o[c].split("=")[1])}return n&&i?r&&""!==r&&"None"!=r&&"null"!=r&&!confirm(r)||(n=n.toLowerCase(),this.grid.set({operation:n,item_ids:i}),"top"==a?window.top.location="".concat(e,"?").concat($.param(this.grid.get_url_data())):"center"==a?$("#galaxy_main").attr("src","".concat(e,"?").concat($.param(this.grid.get_url_data()))):this.grid.can_async_op(n)||this.dict_format?this.update_grid():this.go_to(a,e)):e?this.go_to(a,e):this.grid.get("async")||this.dict_format?this.update_grid():this.go_to(a,e),!1},go_to:function(t,i){var e=this.grid.get("async");this.grid.set("async",!1);var n=this.$el.find("#advanced-search").is(":visible");switch(this.grid.set("advanced_search",n),i||(i="".concat(this.grid.get("url_base"),"?").concat($.param(this.grid.get_url_data()))),this.grid.set({operation:void 0,item_ids:void 0,async:e}),t){case"center":$("#galaxy_main").attr("src",i);break;case"top":window.top.location=i;break;default:window.location=i}},update_grid:function(){var t=this.grid.get("operation")?"POST":"GET";this.$el.find(".loading-elt-overlay").show();var a=this;$.ajax({type:t,url:a.grid.get("url_base"),data:a.grid.get_url_data(),error:function(){alert("Grid refresh failed")},success:function(t){var i=a.grid.get("embedded"),e=a.grid.get("insert"),n=a.$el.find("#advanced-search").is(":visible"),r=a.dict_format?t:$.parseJSON(t);r.embedded=i,r.insert=e,r.advanced_search=n,a.init_grid(r),a.$el.find(".loading-elt-overlay").hide()},complete:function(){a.grid.set({operation:void 0,item_ids:void 0})}})}})});