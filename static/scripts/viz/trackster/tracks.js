define(["exports","underscore","jquery","backbone","onload/loadConfig","app","utils/localization","viz/visualization","viz/viz_views","viz/trackster/util","viz/trackster/slotting","viz/trackster/painters","viz/trackster/filters","mvc/dataset/data","mvc/tool/tools","utils/config","viz/bbi-data-manager","ui/editable-text"],function(t,e,a,i,l,s,n,o,r,d,h,c,_,u,f,v,p){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var b=A(e),y=A(a),g=A(i),m=A(n),w=A(o),k=A(r),x=A(d),C=A(h),T=A(c),M=A(_),z=A(f),q=A(v),S=A(p);function A(t){return t&&t.__esModule?t:{default:t}}var F=void 0,D=b.default.extend,R={};function V(t,e){R[t.attr("id")]=e}function j(t,e,a,i){R[t.attr("id")]=i,t.bind("drag",{handle:".".concat(e),relative:!0},function(t,e){var a,i,n,o,s,r=(0,y.default)(this).parent(),l=r.children(".track,.group"),d=R[(0,y.default)(this).attr("id")];if(0!==(i=(0,y.default)(this).parents(".group")).length){o=(n=i.position().top)+i.outerHeight();var h=R[i.attr("id")];if(e.offsetY<n)return(0,y.default)(this).insertBefore(i),h.remove_drawable(d),void h.container.add_drawable_before(d,h);if(e.offsetY>o)return(0,y.default)(this).insertAfter(i),h.remove_drawable(d),void h.container.add_drawable(d)}for(i=null,s=0;s<l.length;s++)if(o=(n=(a=(0,y.default)(l.get(s))).position().top)+a.outerHeight(),a.is(".group")&&this!==a.get(0)&&e.offsetY>=n&&e.offsetY<=o)return e.offsetY-n<o-e.offsetY?a.find(".content-div").prepend(this):a.find(".content-div").append(this),d.container&&d.container.remove_drawable(d),void R[a.attr("id")].add_drawable(d);for(s=0;s<l.length&&(a=(0,y.default)(l.get(s)),!(e.offsetY<a.position().top)||a.hasClass("reference-track")||a.hasClass("intro"));s++);s===l.length?this!==l.get(s-1)&&(r.append(this),R[r.attr("id")].move_drawable(d,s)):this!==l.get(s)&&((0,y.default)(this).insertBefore(l.get(s)),R[r.attr("id")].move_drawable(d,0<e.deltaY?s-1:s))}).bind("dragstart",function(){(0,y.default)(this).addClass("dragging")}).bind("dragend",function(){(0,y.default)(this).removeClass("dragging")})}var N=100,X="A converter for this dataset is not installed. Please check your datatypes_conf.xml file.",H=["Histogram","Line","Filled","Intensity"];function P(t,e){e||(e=0);var a=Math.pow(10,e);return Math.round(t*a)/a}var L=function t(e,a,i){if(t.id_counter||(t.id_counter=0),this.id=t.id_counter++,this.view=e,this.container=a,this.drag_handle_class=i.drag_handle_class,this.is_overview=!1,this.action_icons={},this.config=q.default.ConfigSettingCollection.from_models_and_saved_values(this.build_config_params(),i.prefs),this.config.get_value("name")||this.config.set_value("name",i.name),this.config_onchange&&this.config.on("change",this.config_onchange,this),this.container_div=this.build_container_div(),this.header_div=null,!1!==i.header){var n=new k.default.TrackHeaderView({model:this,id:this.id});this.header_div=n.$el,this.container_div.append(this.header_div);var o=n.icons_div;this.action_icons=n.action_icons,this.container_div.hover(function(){o.show()},function(){o.hide()})}};L.prototype.action_icons_def=[{name:"toggle_icon",title:"Hide/show content",css_class:"toggle",on_click_fn:function(t){t.config.get_value("content_visible")?(t.action_icons.toggle_icon.addClass("toggle-expand").removeClass("toggle"),t.hide_contents(),t.config.set_value("content_visible",!1)):(t.action_icons.toggle_icon.addClass("toggle").removeClass("toggle-expand"),t.config.set_value("content_visible",!0),t.show_contents())}},{name:"settings_icon",title:(0,m.default)("Edit settings"),css_class:"gear",on_click_fn:function(t){new q.default.ConfigSettingCollectionView({collection:t.config}).render_in_modal("Configure Track")}},{name:"remove_icon",title:(0,m.default)("Remove"),css_class:"remove-icon",on_click_fn:function(t){(0,y.default)(".tooltip").remove(),t.remove()}}],D(L.prototype,{config_params:[{key:"name",label:"Name",type:"text",default_value:""},{key:"content_visible",type:"bool",default_value:!0,hidden:!0}],build_config_params:function(){return this.config_params},config_onchange:function(){},init:function(){},changed:function(){this.view.changed()},can_draw:function(){return!(!this.enabled||!this.config.get_value("content_visible"))},request_draw:function(){},_draw:function(t){},to_dict:function(){},set_name:function(t){this.old_name=this.config.get_value("name"),this.config.set_value("name",t)},revert_name:function(){this.old_name&&this.config.set_value("name",this.old_name)},remove:function(){this.changed(),this.container.remove_drawable(this);var t=this.view;this.container_div.hide(0,function(){(0,y.default)(this).remove(),t.update_intro_div()})},build_container_div:function(){},update_icons:function(){},hide_contents:function(){},show_contents:function(){},get_drawables:function(){}});var O=function(t,e,a){L.call(this,t,e,a),this.obj_type=a.obj_type,this.drawables=[]};D(O.prototype,L.prototype,{unpack_drawables:function(t){var e;this.drawables=[];for(var a=0;a<t.length;a++)e=lt(t[a],this.view,this),this.add_drawable(e)},init:function(){for(var t=0;t<this.drawables.length;t++)this.drawables[t].init()},_draw:function(t){for(var e=0;e<this.drawables.length;e++)this.drawables[e]._draw(t)},to_dict:function(){for(var t=[],e=0;e<this.drawables.length;e++)t.push(this.drawables[e].to_dict());return{prefs:this.config.to_key_value_dict(),obj_type:this.obj_type,drawables:t}},add_drawable:function(t){this.drawables.push(t),(t.container=this).changed()},add_drawable_before:function(t,e){this.changed();var a=this.drawables.indexOf(e);return-1!==a&&(this.drawables.splice(a,0,t),!0)},replace_drawable:function(t,e,a){var i=this.drawables.indexOf(t);return-1!==i&&(this.drawables[i]=e,a&&t.container_div.replaceWith(e.container_div),this.changed()),i},remove_drawable:function(t){var e=this.drawables.indexOf(t);return-1!==e&&(this.drawables.splice(e,1),t.container=null,this.changed(),!0)},move_drawable:function(t,e){var a=this.drawables.indexOf(t);return-1!==a&&(this.drawables.splice(a,1),this.drawables.splice(e,0,t),this.changed(),!0)},get_drawables:function(){return this.drawables},get_tracks:function(t){for(var e,a=this.drawables.slice(0),i=[];0!==a.length;)(e=a.shift())instanceof t?i.push(e):e.drawables&&(a=a.concat(e.drawables));return i}});var G=function(t,e,a){if(D(a,{obj_type:"DrawableGroup",drag_handle_class:"group-handle"}),O.call(this,t,e,a),this.content_div=(0,y.default)("<div/>").addClass("content-div").attr("id","group_".concat(this.id,"_content_div")).appendTo(this.container_div),V(this.container_div,this),V(this.content_div,this),j(this.container_div,this.drag_handle_class,0,this),this.filters_manager=new M.default.FiltersManager(this),this.header_div.after(this.filters_manager.parent_div),this.filters_manager.parent_div.after((0,y.default)("<div style='clear: both'/>")),this.saved_filters_managers=[],"drawables"in a&&this.unpack_drawables(a.drawables),"filters"in a){var i=this.filters_manager;this.filters_manager=new M.default.FiltersManager(this,a.filters),i.parent_div.replaceWith(this.filters_manager.parent_div),a.filters.visible&&this.setup_multitrack_filtering()}};D(G.prototype,L.prototype,O.prototype,{action_icons_def:[L.prototype.action_icons_def[0],L.prototype.action_icons_def[1],{name:"composite_icon",title:(0,m.default)("Show composite track"),css_class:"layers-stack",on_click_fn:function(t){(0,y.default)(".tooltip").remove(),t.show_composite_track()}},{name:"filters_icon",title:(0,m.default)("Filters"),css_class:"ui-slider-050",on_click_fn:function(t){t.filters_manager.visible()?(t.filters_manager.clear_filters(),t._restore_filter_managers()):(t.setup_multitrack_filtering(),t.request_draw({clear_tile_cache:!0})),t.filters_manager.toggle()}},L.prototype.action_icons_def[2]],build_container_div:function(){var t=(0,y.default)("<div/>").addClass("group").attr("id","group_".concat(this.id));return this.container&&this.container.content_div.append(t),t},hide_contents:function(){this.tiles_div.hide()},show_contents:function(){this.tiles_div.show(),this.request_draw()},update_icons:function(){var t=this.drawables.length;if(0===t)this.action_icons.composite_icon.hide(),this.action_icons.filters_icon.hide();else if(1===t)this.action_icons.composite_icon.toggle(this.drawables[0]instanceof tt),this.action_icons.filters_icon.hide();else{var e,a,i,n=this.drawables[0].get_type(),o=0;for(e=0;e<t&&(i=this.drawables[e]).get_type()===n;e++)i instanceof nt&&o++;if(this.drawables[0]instanceof at?this.action_icons.composite_icon.show():(this.action_icons.composite_icon.hide(),(0,y.default)(".tooltip").remove()),1<o&&o===this.drawables.length){var s,r={};for(i=this.drawables[0],a=0;a<i.filters_manager.filters.length;a++)r[(s=i.filters_manager.filters[a]).name]=[s];for(e=1;e<this.drawables.length;e++)for(i=this.drawables[e],a=0;a<i.filters_manager.filters.length;a++)(s=i.filters_manager.filters[a]).name in r&&r[s.name].push(s);for(var l in this.filters_manager.remove_all(),r){var d=r[l];if(d.length===o){var h=new M.default.NumberFilter({name:d[0].name,index:d[0].index});this.filters_manager.add_filter(h)}}this.action_icons.filters_icon.toggle(0<this.filters_manager.filters.length)}else this.action_icons.filters_icon.hide()}},_restore_filter_managers:function(){for(var t=0;t<this.drawables.length;t++)this.drawables[t].filters_manager=this.saved_filters_managers[t];this.saved_filters_managers=[]},setup_multitrack_filtering:function(){if(0<this.filters_manager.filters.length){this.saved_filters_managers=[];for(var t=0;t<this.drawables.length;t++){var e=this.drawables[t];this.saved_filters_managers.push(e.filters_manager),e.filters_manager=this.filters_manager}}this.filters_manager.init_filters()},show_composite_track:function(){var t=new tt(this.view,this.view,{name:this.config.get_value("name"),drawables:this.drawables});this.container.replace_drawable(this,t,!0),t.request_draw()},add_drawable:function(t){O.prototype.add_drawable.call(this,t),this.update_icons()},remove_drawable:function(t){O.prototype.remove_drawable.call(this,t),this.update_icons()},to_dict:function(){this.filters_manager.visible()&&this._restore_filter_managers();var t=D(O.prototype.to_dict.call(this),{filters:this.filters_manager.to_dict()});return this.filters_manager.visible()&&this.setup_multitrack_filtering(),t},request_draw:function(e){b.default.each(this.drawables,function(t){t.request_draw(e)})}});var Y=g.default.View.extend({initialize:function(t){D(t,{obj_type:"View"}),O.call(this,"View",t.container,t),this.chrom=null,this.vis_id=t.vis_id,this.dbkey=t.dbkey,this.stand_alone=void 0===t.stand_alone||t.stand_alone,this.label_tracks=[],this.tracks_to_be_redrawn=[],this.max_low=0,this.max_high=0,this.zoom_factor=3,this.min_separation=30,this.has_changes=!1,this.load_chroms_deferred=null,this.render(),this.canvas_manager=new w.default.CanvasManager(this.container.get(0).ownerDocument),this.reset(),this.config=q.default.ConfigSettingCollection.from_models_and_saved_values([{key:"name",label:"Name",type:"text",default_value:""},{key:"a_color",label:"A Color",type:"color",default_value:"#FF0000"},{key:"c_color",label:"C Color",type:"color",default_value:"#00FF00"},{key:"g_color",label:"G Color",type:"color",default_value:"#0000FF"},{key:"t_color",label:"T Color",type:"color",default_value:"#FF00FF"},{key:"n_color",label:"N Color",type:"color",default_value:"#AAAAAA"}],{name:t.name})},render:function(){this.requested_redraw=!1;var t=this.container,r=this;this.top_container=(0,y.default)("<div/>").addClass("top-container").appendTo(t),this.browser_content_div=(0,y.default)("<div/>").addClass("content").appendTo(t),this.bottom_container=(0,y.default)("<div/>").addClass("bottom-container").appendTo(t),this.top_labeltrack=(0,y.default)("<div/>").addClass("top-labeltrack").appendTo(this.top_container),this.viewport_container=(0,y.default)("<div/>").addClass("viewport-container").attr("id","viewport-container").appendTo(this.browser_content_div),this.content_div=this.viewport_container,V(this.viewport_container,r),this.intro_div=(0,y.default)("<div/>").addClass("intro").appendTo(this.viewport_container),(0,y.default)("<div/>").text("Add Datasets to Visualization").addClass("action-button").appendTo(this.intro_div).click(function(){w.default.select_datasets({dbkey:r.dbkey},function(t){b.default.each(t,function(t){r.add_drawable(lt(t,r,r))})})}),this.nav_container=(0,y.default)("<div/>").addClass("trackster-nav-container").prependTo(this.top_container),this.nav=(0,y.default)("<div/>").addClass("trackster-nav").appendTo(this.nav_container),this.stand_alone&&(this.nav_container.addClass("stand-alone"),this.nav.addClass("stand-alone")),this.overview=(0,y.default)("<div/>").addClass("overview").appendTo(this.bottom_container),this.overview_viewport=(0,y.default)("<div/>").addClass("overview-viewport").appendTo(this.overview),this.overview_close=(0,y.default)("<a/>").attr("title","Close overview").addClass("icon-button overview-close tooltip").hide().appendTo(this.overview_viewport),this.overview_highlight=(0,y.default)("<div/>").addClass("overview-highlight").hide().appendTo(this.overview_viewport),this.overview_box_background=(0,y.default)("<div/>").addClass("overview-boxback").appendTo(this.overview_viewport),this.overview_box=(0,y.default)("<div/>").addClass("overview-box").appendTo(this.overview_viewport),this.default_overview_height=this.overview_box.height(),this.nav_controls=(0,y.default)("<div/>").addClass("nav-controls").appendTo(this.nav),this.chrom_select=(0,y.default)("<select/>").attr({name:"chrom"}).addClass("chrom-nav").append("<option value=''>Loading</option>").appendTo(this.nav_controls);this.nav_input=(0,y.default)("<input/>").addClass("nav-input").hide().bind("keyup focusout",function(t){"focusout"!==t.type&&13!==(t.keyCode||t.which)&&27!==(t.keyCode||t.which)||(27!==(t.keyCode||t.which)&&r.go_to((0,y.default)(this).val()),(0,y.default)(this).hide(),(0,y.default)(this).val(""),r.location_span.show(),r.chrom_select.show()),t.stopPropagation()}).appendTo(this.nav_controls),this.location_span=(0,y.default)("<span/>").addClass("location").attr("title","Click to change location").tooltip({placement:"bottom"}).appendTo(this.nav_controls),this.location_span.click(function(){r.location_span.hide(),r.chrom_select.hide(),r.nav_input.val("".concat(r.chrom,":").concat(r.low,"-").concat(r.high)),r.nav_input.css("display","inline-block"),r.nav_input.select(),r.nav_input.focus(),r.nav_input.autocomplete({source:function(e,t){var a=[],i=y.default.map(r.get_tracks(nt),function(t){return t.data_manager.search_features(e.term).success(function(t){a=a.concat(t)})});y.default.when.apply(y.default,i).done(function(){t(y.default.map(a,function(t){return{label:t[0],value:t[1]}}))})},minLength:2})}),void 0!==this.vis_id&&(this.hidden_input=(0,y.default)("<input/>").attr("type","hidden").val(this.vis_id).appendTo(this.nav_controls)),this.zo_link=(0,y.default)("<a/>").attr("id","zoom-out").attr("title","Zoom out").tooltip({placement:"bottom"}).click(function(){r.zoom_out()}).appendTo(this.nav_controls),this.zi_link=(0,y.default)("<a/>").attr("id","zoom-in").attr("title","Zoom in").tooltip({placement:"bottom"}).click(function(){r.zoom_in()}).appendTo(this.nav_controls),this.load_chroms_deferred=this.load_chroms({low:0}),this.chrom_select.bind("change",function(){r.change_chrom(r.chrom_select.val())}),this.browser_content_div.click(function(t){(0,y.default)(this).find("input").trigger("blur")}),this.browser_content_div.bind("dblclick",function(t){r.zoom_in(t.pageX,this.viewport_container)}),this.overview_box.bind("dragstart",function(t,e){this.current_x=e.offsetX}).bind("drag",function(t,e){var a=e.offsetX-this.current_x;this.current_x=e.offsetX;var i=Math.round(a/r.viewport_container.width()*(r.max_high-r.max_low));r.move_delta(-i)}),this.overview_close.click(function(){r.reset_overview()}),this.viewport_container.bind("draginit",function(t,e){if(t.clientX>r.viewport_container.width()-16)return!1}).bind("dragstart",function(t,e){e.original_low=r.low,e.current_height=t.clientY,e.current_x=e.offsetX}).bind("drag",function(t,e){var a=(0,y.default)(this),i=e.offsetX-e.current_x,n=a.scrollTop()-(t.clientY-e.current_height);a.scrollTop(n),e.current_height=t.clientY,e.current_x=e.offsetX;var o=Math.round(i/r.viewport_container.width()*(r.high-r.low));r.move_delta(o)}),this.top_labeltrack.bind("dragstart",function(t,e){return(0,y.default)("<div/>").addClass("zoom-area").css("height",r.browser_content_div.height()+r.top_labeltrack.height()+1).appendTo((0,y.default)(this))}).bind("drag",function(t,e){(0,y.default)(e.proxy).css({left:Math.min(t.pageX,e.startX)-r.container.offset().left,width:Math.abs(t.pageX-e.startX)});var a=Math.min(t.pageX,e.startX)-r.container.offset().left,i=Math.max(t.pageX,e.startX)-r.container.offset().left,n=r.high-r.low,o=r.viewport_container.width();r.update_location(Math.round(a/o*n)+r.low,Math.round(i/o*n)+r.low)}).bind("dragend",function(t,e){var a=Math.min(t.pageX,e.startX),i=Math.max(t.pageX,e.startX),n=r.high-r.low,o=r.viewport_container.width(),s=r.low;r.low=Math.round(a/o*n)+s,r.high=Math.round(i/o*n)+s,(0,y.default)(e.proxy).remove(),r.request_redraw()}),this.add_label_track(new Q(this,{content_div:this.top_labeltrack})),(0,y.default)(window).bind("resize",function(){this.resize_timer&&window.clearTimeout(this.resize_timer),this.resize_timer=window.setTimeout(function(){r.resize_window()},500)}),(0,y.default)(document).bind("redraw",function(){r.redraw()}),this.reset(),(0,y.default)(window).trigger("resize")},get_base_color:function(t){return this.config.get_value("".concat(t.toLowerCase(),"_color"))||this.config.get_value("n_color")}});D(Y.prototype,O.prototype,{changed:function(){this.has_changes=!0},update_intro_div:function(){this.intro_div.toggle(0===this.drawables.length)},trigger_navigate:function(t,e,a,i){var n=this;this.timer&&window.clearTimeout(this.timer),i?this.timer=window.setTimeout(function(){n.trigger("navigate","".concat(t,":").concat(e,"-").concat(a))},500):this.trigger("navigate","".concat(t,":").concat(e,"-").concat(a))},update_location:function(t,e){this.location_span.text("".concat(x.default.commatize(t)," - ").concat(x.default.commatize(e))),this.nav_input.val("".concat(this.chrom,":").concat(x.default.commatize(t),"-").concat(x.default.commatize(e)));var a=this.chrom_select.val();""!==a&&this.trigger_navigate(a,this.low,this.high,!0)},load_chroms:function(t){var s=this;t.num=N;var r=y.default.Deferred();return y.default.ajax({url:"".concat((0,l.getAppRoot)(),"api/genomes/").concat(this.dbkey),data:t,dataType:"json",success:function(t){if(0!==t.chrom_info.length){if(t.reference){var e=new et(s);s.add_label_track(e),s.reference_track=e}s.chrom_data=t.chrom_info,s.chrom_select.html(""),s.chrom_select.append((0,y.default)('<option value="">Select Chrom/Contig</option>'));for(var a=0,i=s.chrom_data.length;a<i;a++){var n=s.chrom_data[a].chrom,o=(0,y.default)("<option>");o.text(n),o.val(n),s.chrom_select.append(o)}t.prev_chroms&&s.chrom_select.append((0,y.default)('<option value="previous">Previous '.concat(N,"</option>"))),t.next_chroms&&s.chrom_select.append((0,y.default)('<option value="next">Next '.concat(N,"</option>"))),s.chrom_start_index=t.start_index,r.resolve(t.chrom_info)}},error:function(){alert("Could not load chroms for this dbkey: ".concat(this.dbkey))}}),r},change_chrom:function(a,t,e){var i=this;if(i.chrom_data){if(a&&"None"!==a)if("previous"!==a)if("next"!==a){var n=y.default.grep(i.chrom_data,function(t,e){return t.chrom===a})[0];if(void 0!==n){if(a!==i.chrom){i.chrom=a,i.chrom_select.val(i.chrom),i.max_high=n.len-1,i.reset();for(var o=0,s=i.drawables.length;o<s;o++){var r=i.drawables[o];r.init&&r.init()}i.reference_track&&i.reference_track.init()}i.high=void 0===t&&void 0===e?(i.low=0,i.max_high):(i.low=void 0!==t?Math.max(t,0):0,void 0===e?(i.low=Math.max(i.low-15,0),i.low+30):Math.min(e,i.max_high)),i.request_redraw()}else i.load_chroms({chrom:a},function(){i.change_chrom(a,t,e)})}else i.load_chroms({low:this.chrom_start_index+N});else i.load_chroms({low:this.chrom_start_index-N})}else i.load_chroms_deferred.then(function(){i.change_chrom(a,t,e)})},go_to:function(t){var e=(t=(t=t.replace(/,/g,"")).replace(/:|-/g," ")).split(/\s+/),a=e[0],i=e[1]?parseInt(e[1],10):void 0,n=e[2]?parseInt(e[2],10):void 0;this.change_chrom(a,i,n)},move_fraction:function(t){var e=this.high-this.low;this.move_delta(t*e)},move_delta:function(t){var e=this,a=e.high-e.low;e.low-t<e.max_low?(e.low=e.max_low,e.high=e.max_low+a):e.high-t>e.max_high?(e.high=e.max_high,e.low=e.max_high-a):(e.high-=t,e.low-=t),e.request_redraw({data_fetch:!1}),this.redraw_on_move_fn&&window.clearTimeout(this.redraw_on_move_fn),this.redraw_on_move_fn=window.setTimeout(function(){e.request_redraw()},200);var i=e.chrom_select.val();this.trigger_navigate(i,e.low,e.high,!0)},add_drawable:function(t){O.prototype.add_drawable.call(this,t),t.init(),this.changed(),this.update_intro_div();var e=this;t.config.on("change",function(){e.changed()})},add_label_track:function(t){t.view=this,t.init(),this.label_tracks.push(t)},remove_drawable:function(t,e){if(O.prototype.remove_drawable.call(this,t),e){var a=this;t.container_div.hide(0,function(){(0,y.default)(this).remove(),a.update_intro_div()})}},reset:function(){this.low=this.max_low,this.high=this.max_high,this.viewport_container.find(".yaxislabel").remove()},request_redraw:function(a,t){var i=this,e=t?[t]:i.drawables;b.default.each(e,function(e){var t=b.default.find(i.tracks_to_be_redrawn,function(t){return t[0]===e});t?t[1]=a:i.tracks_to_be_redrawn.push([e,a])}),this.requested_redraw||(window.requestAnimationFrame(function(){i._redraw()}),this.requested_redraw=!0)},_redraw:function(){this.requested_redraw=!1;var t=this.low,e=this.high;t<this.max_low&&(t=this.max_low),e>this.max_high&&(e=this.max_high);var a=this.high-this.low;0!==this.high&&a<this.min_separation&&(e=t+this.min_separation),this.low=Math.floor(t),this.high=Math.ceil(e),this.update_location(this.low,this.high),this.resolution_px_b=this.viewport_container.width()/(this.high-this.low);var i=this.low/(this.max_high-this.max_low)*this.overview_viewport.width()||0,n=(this.high-this.low)/(this.max_high-this.max_low)*this.overview_viewport.width()||0;this.overview_box.css({left:i,width:Math.max(13,n)}).show(),n<13&&this.overview_box.css("left",i-(13-n)/2),this.overview_highlight&&this.overview_highlight.css({left:i,width:n}),b.default.each(this.tracks_to_be_redrawn,function(t){var e=t[0],a=t[1];e&&e._draw(a)}),this.tracks_to_be_redrawn=[],b.default.each(this.label_tracks,function(t){t._draw()})},zoom_in:function(t,e){if(!(0===this.max_high||this.high-this.low<=this.min_separation)){var a=this.high-this.low,i=a/2+this.low,n=a/this.zoom_factor/2;t&&(i=t/this.viewport_container.width()*(this.high-this.low)+this.low),this.low=Math.round(i-n),this.high=Math.round(i+n),this.changed(),this.request_redraw()}},zoom_out:function(){if(0!==this.max_high){var t=this.high-this.low,e=t/2+this.low,a=t*this.zoom_factor/2;this.low=Math.round(e-a),this.high=Math.round(e+a),this.changed(),this.request_redraw()}},resize_viewport:function(){this.viewport_container.height(this.container.height()-this.top_container.height()-this.bottom_container.height())},resize_window:function(){this.resize_viewport(),this.request_redraw()},set_overview:function(t){if(this.overview_drawable){if(this.overview_drawable.dataset.id===t.dataset.id)return;this.overview_viewport.find(".track").remove()}var e=t.copy({content_div:this.overview_viewport}),a=this;e.header_div.hide(),e.is_overview=!0,a.overview_drawable=e,this.overview_drawable.postdraw_actions=function(){a.overview_highlight.show().height(a.overview_drawable.content_div.height()),a.overview_viewport.height(a.overview_drawable.content_div.height()+a.overview_box.outerHeight()),a.overview_close.show(),a.resize_window()},a.overview_drawable.request_draw(),this.changed()},reset_overview:function(){(0,y.default)(".tooltip").remove(),this.overview_viewport.find(".track-tile").remove(),this.overview_viewport.height(this.default_overview_height),this.overview_box.height(this.default_overview_height),this.overview_close.hide(),this.overview_highlight.hide(),this.resize_window(),this.overview_drawable=null}});var I=z.default.Tool.extend({defaults:{track:null},initialize:function(t){z.default.Tool.prototype.initialize.call(this,t);var e=!0;void 0!==t.tool_state&&void 0!==t.tool_state.hidden&&(e=t.tool_state.hidden),this.set("hidden",e),this.remove_inputs(["data","hidden_data","conditional"])},state_dict:function(t){return b.default.extend(this.get_inputs_dict(),{hidden:!this.is_visible()})}}),J=g.default.View.extend({events:{"change :input":"update_value"},render:function(){var t=this.$el.addClass("param-row"),e=this.model;(0,y.default)("<div>").addClass("param-label").text(e.get("label")).appendTo(t),(0,y.default)("<div/>").addClass("param-input").html(e.get("html")).appendTo(t).find(":input").val(e.get("value")),(0,y.default)("<div style='clear: both;'/>").appendTo(t)},update_value:function(t){this.model.set_value((0,y.default)(t.target).val())}}),$=g.default.View.extend({initialize:function(t){this.model.on("change:hidden",this.set_visible,this)},render:function(){var t=this,e=this.model,a=this.$el.addClass("dynamic-tool").hide();a.bind("drag",function(t){t.stopPropagation()}).click(function(t){t.stopPropagation()}).bind("dblclick",function(t){t.stopPropagation()}).keydown(function(t){t.stopPropagation()}),(0,y.default)("<div class='tool-name'>").appendTo(a).text(e.get("name")),e.get("inputs").each(function(t){var e=new J({model:t});e.render(),a.append(e.$el)}),a.find("input").click(function(){(0,y.default)(this).select()});var i=(0,y.default)("<div>").addClass("param-row").appendTo(a),n=(0,y.default)("<input type='submit'>").attr("value","Run on complete dataset").appendTo(i);(0,y.default)("<input type='submit'>").attr("value","Run on visible region").appendTo(i).click(function(){t.run_on_region()}),n.click(function(){t.run_on_dataset()}),e.is_visible()&&this.$el.show()},set_visible:function(){this.$el.toggle(this.model.is_visible())},update_params:function(){for(var t=0;t<this.params.length;t++)this.params[t].update_value()},run_on_dataset:function(){var e=this.model,a=(0,s.getGalaxyInstance)();this.run({target_dataset_id:this.model.get("track").dataset.id,action:"rerun",tool_id:e.id},null,function(t){a.modal.show({title:"".concat(e.get("name")," is Running"),body:"".concat(e.get("name")," is running on the complete dataset. Tool outputs are in dataset's history."),buttons:{Close:function(){a.modal.hide()}}})})},run_on_region:function(){var t,e=this.model.get("track"),a=this.model,i=new w.default.GenomeRegion({chrom:e.view.chrom,start:e.view.low,end:e.view.high}),n={target_dataset_id:e.dataset.id,action:"rerun",tool_id:a.id,regions:[i.toJSON()]},o=a.get("name")+e.tool_region_and_parameters_str(i);if(e.container===e.view){var s=new G(e.view,e.view,{name:e.config.get_value("name")}),r=e.container.replace_drawable(e,s,!1);s.container_div.insertBefore(e.view.content_div.children()[r]),s.add_drawable(e),e.container_div.appendTo(s.content_div),t=s}else t=e.container;var l=new e.constructor(e.view,t,{name:o,hda_ldda:"hda"});l.init_for_tool_data(),l.change_mode(e.mode),l.set_filters_manager(e.filters_manager.copy(l)),l.update_icons(),t.add_drawable(l),l.tiles_div.text("Starting job."),this.run(n,l,function(t){l.set_dataset(new u.Dataset(t)),l.tiles_div.text("Running job."),l.init()})},run:function(t,e,a){t.inputs=this.model.get_inputs_dict();var i=new x.default.ServerStateDeferred({ajax_settings:{url:"".concat((0,l.getAppRoot)(),"api/tools"),data:JSON.stringify(t),dataType:"json",contentType:"application/json",type:"POST"},interval:2e3,success_fn:function(t){return"pending"!==t}});y.default.when(i.go()).then(function(t){"no converter"===t?(e.container_div.addClass("error"),e.content_div.text(X)):t.error?(e.container_div.addClass("error"),e.content_div.text("Tool cannot be rerun: "+t.message)):a(t)})}}),B=function(t,e){T.default.Scaler.call(this,e),this.filter=t};B.prototype.gen_val=function(t){return this.filter.high===Number.MAX_VALUE||this.filter.low===-Number.MAX_VALUE||this.filter.low===this.filter.high?this.default_val:(parseFloat(t[this.filter.index])-this.filter.low)/(this.filter.high-this.filter.low)};var E=function(t,e,a,i,n){this.track=t,this.region=e,this.low=e.get("start"),this.high=e.get("end"),this.w_scale=a,this.canvas=i,this.html_elt=(0,y.default)("<div class='track-tile'/>").append(i),this.data=n,this.stale=!1};E.prototype.predisplay_actions=function(){};var W=function(t,e,a,i,n){E.call(this,t,e,a,i,n)};W.prototype.predisplay_actions=function(){};var U=function(t,e,a,i,n,o,s,r,l,d,h){E.call(this,t,e,a,i,n),this.mode=o,this.all_slotted=r,this.feature_mapper=l,this.has_icons=!1,this.incomplete_features=d,this.other_tiles_features_drawn={},this.seq_data=h};D(U.prototype,E.prototype),U.prototype.predisplay_actions=function(){};var Z=function(t,e,a){D(a,{drag_handle_class:"draghandle"}),L.call(this,t,e,a),this.dataset=null,a.dataset&&(this.dataset=a.dataset instanceof g.default.Model?a.dataset:new u.Dataset(a.dataset)),this.dataset_check_type="converted_datasets_state",this.data_url_extra_params={},this.data_query_wait="data_query_wait"in a?a.data_query_wait:5e3,this.data_manager="data_manager"in a?a.data_manager:new w.default.GenomeDataManager({dataset:this.dataset,genome:new w.default.Genome({key:t.dbkey,chroms_info:{chrom_info:t.chrom_data}}),data_mode_compatible:this.data_and_mode_compatible,can_subset:this.can_subset}),this.min_height_px=16,this.max_height_px=800,this.visible_height_px=this.config.get_value("height"),this.content_div=(0,y.default)("<div class='track-content'>").appendTo(this.container_div),this.container&&(this.container.content_div.append(this.container_div),"resize"in a&&!a.resize||this.add_resize_handle())};D(Z.prototype,L.prototype,{action_icons_def:[{name:"mode_icon",title:(0,m.default)("Set display mode"),css_class:"chevron-expand",on_click_fn:function(){}},L.prototype.action_icons_def[0],{name:"overview_icon",title:(0,m.default)("Set as overview"),css_class:"application-dock-270",on_click_fn:function(t){t.view.set_overview(t)}},L.prototype.action_icons_def[1],{name:"filters_icon",title:(0,m.default)("Filters"),css_class:"ui-slider-050",on_click_fn:function(t){t.filters_manager.visible()?t.filters_manager.clear_filters():t.filters_manager.init_filters(),t.filters_manager.toggle()}},{name:"tools_icon",title:(0,m.default)("Tool"),css_class:"hammer",on_click_fn:function(t){t.tool.toggle(),t.tool.is_visible()?t.set_name(t.config.get_value("name")+t.tool_region_and_parameters_str()):t.revert_name(),(0,y.default)(".tooltip").remove()}},{name:"param_space_viz_icon",title:(0,m.default)("Tool parameter space visualization"),css_class:"arrow-split",on_click_fn:function(n){var o=(0,s.getGalaxyInstance)(),t="\n                    <strong>Tool</strong>:".concat(n.tool.get("name"),"<br/>\n                    <strong>Dataset</strong>:").concat(n.config.get_value("name"),'<br/>\n                    <strong>Region(s)</strong>:\n                        <select name="regions">\n                            <option value="cur">current viewing area</option>\n                            <option value="bookmarks">bookmarks</option>\n                            <option value="both">current viewing area and bookmarks</option>\n                        </select>\n                    ');o.modal.show({title:"Visualize tool parameter space and output from different parameter settings?",body:t,buttons:{No:function(){o.modal.hide(),(0,y.default)(window).unbind("keypress.check_enter_esc")},Yes:function(){var t,e=(0,y.default)('select[name="regions"] option:selected').val(),a=new w.default.GenomeRegion({chrom:F.view.chrom,start:F.view.low,end:F.view.high}),i=b.default.map((0,y.default)(".bookmark"),function(t){return new w.default.GenomeRegion({from_str:(0,y.default)(t).children(".position").text()})});t="cur"===e?[a]:"bookmarks"===e?i:[a].concat(i),o.modal.hide(),window.top.location.href="".concat((0,l.getAppRoot)(),"visualization/sweepster?").concat(y.default.param({dataset_id:n.dataset.id,hda_ldda:n.dataset.get("hda_ldda"),regions:JSON.stringify(new g.default.Collection(t).toJSON())}))}}})}},L.prototype.action_icons_def[2]],can_draw:function(){return this.dataset&&L.prototype.can_draw.call(this)},build_container_div:function(){return(0,y.default)("<div/>").addClass("track").attr("id","track_".concat(this.id))},set_dataset:function(t){this.dataset=t,this.data_manager.set("dataset",t)},on_resize:function(){this.request_draw({clear_tile_cache:!0})},add_resize_handle:function(){var i=this,a=!1,n=!1,o=(0,y.default)("<div class='track-resize'>");(0,y.default)(i.container_div).hover(function(){i.config.get_value("content_visible")&&(a=!0,o.show())},function(){a=!1,n||o.hide()}),o.hide().bind("dragstart",function(t,e){n=!0,e.original_height=(0,y.default)(i.content_div).height()}).bind("drag",function(t,e){var a=Math.min(Math.max(e.original_height+e.deltaY,i.min_height_px),i.max_height_px);(0,y.default)(i.tiles_div).css("height",a),i.visible_height_px=i.max_height_px===a?0:a,i.on_resize()}).bind("dragend",function(t,e){i.tile_cache.clear(),n=!1,a||o.hide(),i.config.set_value("height",i.visible_height_px),i.changed()}).appendTo(i.container_div)},hide_contents:function(){this.tiles_div.hide(),this.container_div.find(".yaxislabel, .track-resize").hide()},show_contents:function(){this.tiles_div.show(),this.container_div.find(".yaxislabel, .track-resize").show(),this.request_draw()},get_type:function(){return this instanceof Q?"LabelTrack":this instanceof et?"ReferenceTrack":this instanceof at?"LineTrack":this instanceof st?"ReadTrack":this instanceof ot?"VariantTrack":this instanceof tt?"CompositeTrack":this instanceof nt?"FeatureTrack":""},show_message:function(t){return this.tiles_div.remove(),(0,y.default)("<span/>").addClass("message").html(t).appendTo(this.content_div)},init:function(t){var a=this;if(a.enabled=!1,a.tile_cache.clear(),a.data_manager.clear(),a.content_div.children().remove(),a.container_div.removeClass("nodata error pending"),a.tiles_div=(0,y.default)("<div/>").addClass("tiles").appendTo(a.content_div),a.dataset.id){var i=y.default.Deferred(),e={hda_ldda:a.dataset.get("hda_ldda"),data_type:this.dataset_check_type,chrom:a.view.chrom,retry:t};return y.default.getJSON(this.dataset.url(),e,function(e){if(e&&"error"!==e&&"error"!==e.kind)"no converter"===e?(a.container_div.addClass("error"),a.show_message(X)):"no data"===e||void 0!==e.data&&(null===e.data||0===e.data.length)?(a.container_div.addClass("nodata"),a.show_message("No data for this chrom/contig.")):"pending"===e?(a.container_div.addClass("pending"),a.show_message("Preparing data. This can take a while for a large dataset. If the visualization is saved and closed, preparation will continue in the background."),window.setTimeout(function(){a.init()},a.data_query_wait)):"data"!==e&&"data"!==e.status||(e.valid_chroms&&(a.valid_chroms=e.valid_chroms,a.update_icons()),a.tiles_div.text("Ready for display"),a.view.chrom?(a.tiles_div.text(""),a.tiles_div.css("height","".concat(a.visible_height_px,"px")),a.enabled=!0,y.default.when.apply(y.default,a.predraw_init()).done(function(){i.resolve(),a.container_div.removeClass("nodata error pending"),a.request_draw()})):i.resolve());else{a.container_div.addClass("error");var t=a.show_message("Cannot display dataset due to an error. ");e.message&&(t.append((0,y.default)("<a href='javascript:void(0);'></a>").text("View error").click(function(){var t=(0,s.getGalaxyInstance)();t.modal.show({title:(0,m.default)("Trackster Error"),body:"<pre>".concat(e.message,"</pre>"),buttons:{Close:function(){t.modal.hide()}}})})),t.append((0,y.default)("<span/>").text(" ")),t.append((0,y.default)("<a href='javascript:void(0);'></a>").text("Try again").click(function(){a.init(!0)})))}}),this.update_icons(),i}},predraw_init:function(){var n=this;return y.default.getJSON(n.dataset.url(),{data_type:"data",stats:!0,chrom:n.view.chrom,low:0,high:n.view.max_high,hda_ldda:n.dataset.get("hda_ldda")},function(t){var e=t.data;if(e&&void 0!==e.min&&void 0!==e.max){var a=e.min,i=e.max;a=Math.floor(Math.min(0,Math.max(a,e.mean-2*e.sd))),i=Math.ceil(Math.max(0,Math.min(i,e.mean+2*e.sd))),n.config.set_default_value("min_value",a),n.config.set_default_value("max_value",i),n.config.set_value("min_value",a),n.config.set_value("max_value",i)}})},get_drawables:function(){return this}});var K=function(t,e,a){Z.call(this,t,e,a);if(j(this.container_div,this.drag_handle_class,0,this),this.filters_manager=new M.default.FiltersManager(this,"filters"in a?a.filters:null),this.data_manager.set("filters_manager",this.filters_manager),this.filters_available=!1,this.tool=a.tool?new I(b.default.extend(a.tool,{track:this,tool_state:a.tool_state})):null,this.tile_cache=new w.default.Cache(10),this.left_offset=0,this.header_div&&(this.set_filters_manager(this.filters_manager),this.tool)){var i=new $({model:this.tool});i.render(),this.dynamic_tool_div=i.$el,this.header_div.after(this.dynamic_tool_div)}this.tiles_div=(0,y.default)("<div/>").addClass("tiles").appendTo(this.content_div),this.config.get_value("content_visible")||this.tiles_div.hide(),this.overlay_div=(0,y.default)("<div/>").addClass("overlay").appendTo(this.content_div),a.mode&&this.change_mode(a.mode)};D(K.prototype,L.prototype,Z.prototype,{action_icons_def:Z.prototype.action_icons_def.concat([{name:"show_more_rows_icon",title:"To minimize track height, not all feature rows are displayed. Click to display more rows.",css_class:"exclamation",on_click_fn:function(t){(0,y.default)(".tooltip").remove(),t.slotters[t.view.resolution_px_b].max_rows*=2,t.request_draw({clear_tile_cache:!0})},hide:!0}]),copy:function(t){var e=this.to_dict();D(e,{data_manager:this.data_manager});var a=new this.constructor(this.view,t,e);return a.change_mode(this.mode),a.enabled=this.enabled,a},set_filters_manager:function(t){this.filters_manager=t,this.header_div.after(this.filters_manager.parent_div)},to_dict:function(){return{track_type:this.get_type(),dataset:{id:this.dataset.id,hda_ldda:this.dataset.get("hda_ldda")},prefs:this.config.to_key_value_dict(),mode:this.mode,filters:this.filters_manager.to_dict(),tool_state:this.tool?this.tool.state_dict():{}}},set_min_max:function(){var n=this;return y.default.getJSON(n.dataset.url(),{data_type:"data",stats:!0,chrom:n.view.chrom,low:0,high:n.view.max_high,hda_ldda:n.dataset.get("hda_ldda")},function(t){var e=t.data;if(isNaN(parseFloat(n.config.get_value("min_value")))||isNaN(parseFloat(n.config.get_value("max_value")))){var a=e.min,i=e.max;a=Math.floor(Math.min(0,Math.max(a,e.mean-2*e.sd))),i=Math.ceil(Math.max(0,Math.min(i,e.mean+2*e.sd))),n.config.set_value("min_value",a),n.config.set_value("max_value",i)}})},change_mode:function(t){var e=this;return e.mode=t,e.config.set_value("mode",t),"Auto"===t&&this.data_manager.clear(),e.request_draw({clear_tile_cache:!0}),this.action_icons.mode_icon.attr("title","Set display mode (now: ".concat(e.mode,")")),e},update_icons:function(){var t=this;t.action_icons.filters_icon.toggle(t.filters_available),t.action_icons.tools_icon.toggle(null!==t.tool),t.action_icons.param_space_viz_icon.toggle(null!==t.tool)},_gen_tile_cache_key:function(t,e){return"".concat(t,"_").concat(e)},request_draw:function(t){t&&t.clear_tile_cache&&this.tile_cache.clear(),this.view.request_redraw(t,this)},before_draw:function(){this.max_height_px=0},_draw:function(t){var e=this;if(this.can_draw()){var a=t&&t.clear_after,i=this.view.low,n=this.view.high,o=this.view.container.width(),s=this.view.resolution_px_b,r=1/s;this.is_overview&&(i=this.view.max_low,n=this.view.max_high,r=1/(s=o/(this.view.max_high-this.view.max_low))),this.before_draw(),this.tiles_div.children().addClass("remove");for(var l,d,h=Math.floor(400*r),c=Math.floor(i/h),_=[],u=[];c*h<n;)l=new w.default.GenomeRegion({chrom:this.view.chrom,start:c*h,end:Math.min((c+1)*h,this.view.max_high)}),d=this.draw_helper(l,s,t),_.push(d),y.default.when(d).then(function(t){u.push(t)}),c+=1;a||this.tiles_div.children(".remove").removeClass("remove").remove(),y.default.when.apply(y.default,_).then(function(){e.tiles_div.children(".remove").remove(),0!==(u=b.default.filter(u,function(t){return null!==t})).length&&e.postdraw_actions(u,o,s,a)})}},_add_yaxis_label:function(t,e){var a=this,i="max"===t?"top":"bottom",n="max"===t?"max":"min",o="max"===t?"max_value":"min_value",s=this.container_div.find(".yaxislabel.".concat(i)),r=P(this.config.get_value(o),1);e=e||function(){a.request_draw({clear_tile_cache:!0})},0!==s.length?s.text(r):(s=(0,y.default)("<div/>").text(r).make_text_editable({num_cols:12,on_finish:function(t){(0,y.default)(".tooltip").remove(),this.config.set_value(o,P(t,1)),e()},help_text:"Set ".concat(n," value")}).addClass("yaxislabel ".concat(i)).css("color",this.config.get_value("label_color")),this.container_div.prepend(s))},postdraw_actions:function(t,e,a,i){var n=this;0<b.default.filter(t,function(t){return t instanceof W}).length?(this.max_height_px=0,b.default.each(t,function(t){t instanceof W||(t.html_elt.remove(),n.draw_helper(t.region,a,{force:!0,mode:"Coverage"}))}),this._add_yaxis_label("max")):(this.container_div.find(".yaxislabel").remove(),b.default.find(t,function(t){return t.has_icons})&&b.default.each(t,function(t){t.has_icons||t.html_elt.css("padding-top",20)}))},get_mode:function(t){return this.mode},update_auto_mode:function(t){},_get_drawables:function(){return[this]},draw_helper:function(_,u,f){var v=this;f||(f={});var t,e=f.force,a=f.mode||this.mode,i=1/u,p=this._get_drawables(),g=this._gen_tile_cache_key(u,_),n=e?void 0:this.tile_cache.get_elt(g);if(n)return(t=n)&&"track"in t&&this.show_tile(n,u),n;if(!1===f.data_fetch)return null;var m=function(){var e=b.default.find(H,function(t){return t===a})?"Coverage":a,t=b.default.map(p,function(t){return t.data_manager.get_data(_,e,i,v.data_url_extra_params)});return v.view.reference_track&&t.push(v.view.reference_track.data_manager.get_data(_,a,i,v.view.reference_track.data_url_extra_params)),t},w=y.default.Deferred();return this.tile_cache.set_elt(g,w),y.default.when.apply(y.default,m()).then(function(){var a,t=m(),i=t;if(b.default.find(t,function(t){return x.default.is_deferred(t)}))return v.tile_cache.set_elt(g,void 0),void y.default.when(v.draw_helper(_,u,f)).then(function(t){w.resolve(t)});v.view.reference_track&&(a=v.view.reference_track.data_manager.subset_entry(t.pop(),_));var n=[],o=[];b.default.each(p,function(t,e){var a=i[e];"Auto"===t.mode&&(t.mode=t.get_mode(a),t.update_auto_mode(t.mode)),n.push(t.mode),o.push(t.get_canvas_height(a,t.mode,u,d))});var s,e=v.view.canvas_manager.new_canvas(),r=_.get("start"),l=_.get("end"),d=Math.ceil((l-r)*u)+v.left_offset,h=b.default.max(o);e.width=d,e.height=f.height||h;var c=e.getContext("2d");c.translate(v.left_offset,0),1<p.length&&(c.globalAlpha=.5,c.globalCompositeOperation="source-over"),b.default.each(p,function(t,e){s=t.draw_tile(i[e],c,n[e],_,u,a)}),void 0!==s&&(v.tile_cache.set_elt(g,s),v.show_tile(s,u)),w.resolve(s)}),w},get_canvas_height:function(t,e,a,i){return this.visible_height_px},_draw_line_track_tile:function(t,e,a,i,n){-1!==[void 0,null].indexOf(this.config.get_value("min_value"))&&this.config.set_value("min_value",0),-1!==[void 0,null,0].indexOf(this.config.get_value("max_value"))&&this.config.set_value("max_value",b.default.max(b.default.map(t.data,function(t){return t[1]}))||0);var o=e.canvas;return new T.default.LinePainter(t.data,i.get("start"),i.get("end"),this.config.to_key_value_dict(),a).draw(e,o.width,o.height,n),new W(this,i,n,o,t.data)},draw_tile:function(t,e,a,i,n,o){},show_tile:function(t,e){var a=t.html_elt;t.predisplay_actions();var i=Math.round((t.low-(this.is_overview?this.view.max_low:this.view.low))*e);this.left_offset&&(i-=this.left_offset),a.css("left",i),a.hasClass("remove")?a.removeClass("remove"):this.tiles_div.append(a),a.css("height","auto"),this.max_height_px=Math.max(this.max_height_px,a.height()-2),a.parent().children().css("height","".concat(this.max_height_px,"px"));var n=this.max_height_px;0!==this.visible_height_px&&(n=Math.min(this.max_height_px,this.visible_height_px)),this.tiles_div.css("height","".concat(n,"px"))},tool_region_and_parameters_str:function(t){var e=void 0!==t?t.toString():"all",a=b.default.values(this.tool.get_inputs_dict()).join(", ");return" - region=[".concat(e,"], parameters=[").concat(a,"]")},data_and_mode_compatible:function(t,e){return"Auto"===e||("Coverage"===e?"bigwig"===t.dataset_type:"bigwig"!==t.dataset_type&&"no_detail"!==t.extra_info)},can_subset:function(t){return!t.message&&"no_detail"!==t.extra_info&&("bigwig"!==t.dataset_type||t.data[1][0]-t.data[0][0]==1)},init_for_tool_data:function(){this.data_manager.set("data_type","raw_data"),this.data_query_wait=1e3,this.dataset_check_type="state"}});var Q=function(t,e){Z.call(this,t,e,{resize:!1,header:!1}),this.container_div.addClass("label-track")};D(Q.prototype,Z.prototype,{init:function(){this.enabled=!0},predraw_init:function(){},_draw:function(t){for(var e=this.view,a=e.high-e.low,i=Math.floor(Math.pow(10,Math.floor(Math.log(a)/Math.log(10)))),n=Math.floor(e.low/i)*i,o=this.view.container.width(),s=(0,y.default)("<div/>").addClass("label-container");n<e.high;){var r=Math.floor((n-e.low)/a*o);s.append((0,y.default)("<div/>").addClass("pos-label").text(x.default.commatize(n)).css({left:r})),n+=i}this.content_div.children(":first").remove(),this.content_div.append(s)}});var tt=function(t,e,a){if(K.call(this,t,e,a),this.drawables=[],"drawables"in a){for(var i,n=0;n<a.drawables.length;n++)i=a.drawables[n],this.drawables[n]=lt(i,t,null),i.left_offset>this.left_offset&&(this.left_offset=i.left_offset);this.enabled=!0}b.default.each(this.drawables,function(t){(t instanceof nt||t instanceof st)&&t.change_mode("Coverage")}),this.update_icons(),this.obj_type="CompositeTrack"};D(tt.prototype,K.prototype,{display_modes:H,build_config_params:function(){return b.default.union(L.prototype.config_params,[{key:"min_value",label:"Min Value",type:"float",default_value:void 0},{key:"max_value",label:"Max Value",type:"float",default_value:void 0},{key:"mode",type:"string",default_value:this.mode,hidden:!0},{key:"height",type:"int",default_value:30,hidden:!0}])},action_icons_def:[{name:"composite_icon",title:(0,m.default)("Show individual tracks"),css_class:"layers-stack",on_click_fn:function(t){(0,y.default)(".tooltip").remove(),t.show_group()}}].concat(K.prototype.action_icons_def),to_dict:O.prototype.to_dict,add_drawable:O.prototype.add_drawable,unpack_drawables:O.prototype.unpack_drawables,config_onchange:function(){this.set_name(this.config.get_value("name")),this.request_draw({clear_tile_cache:!0})},on_resize:function(){var e=this.visible_height_px;b.default.each(this.drawables,function(t){t.visible_height_px=e}),Z.prototype.on_resize.call(this)},change_mode:function(t){K.prototype.change_mode.call(this,t);for(var e=0;e<this.drawables.length;e++)this.drawables[e].change_mode(t)},init:function(){for(var t=[],e=0;e<this.drawables.length;e++)t.push(this.drawables[e].init());var a=this;y.default.when.apply(y.default,t).then(function(){a.enabled=!0,a.request_draw()})},update_icons:function(){this.action_icons.filters_icon.hide(),this.action_icons.tools_icon.hide(),this.action_icons.param_space_viz_icon.hide()},can_draw:L.prototype.can_draw,_get_drawables:function(){return this.drawables},show_group:function(){for(var t,e=new G(this.view,this.container,{name:this.config.get_value("name")}),a=0;a<this.drawables.length;a++)(t=this.drawables[a]).update_icons(),e.add_drawable(t),(t.container=e).content_div.append(t.container_div);this.container.replace_drawable(this,e,!0),e.request_draw({clear_tile_cache:!0})},before_draw:function(){var e=b.default.min(b.default.map(this.drawables,function(t){return t.config.get_value("min_value")})),a=b.default.max(b.default.map(this.drawables,function(t){return t.config.get_value("max_value")}));this.config.set_value("min_value",e),this.config.set_value("max_value",a),b.default.each(this.drawables,function(t){t.config.set_value("min_value",e),t.config.set_value("max_value",a)})},update_all_min_max:function(){var e=this.config.get_value("min_value"),a=this.config.get_value("max_value");b.default.each(this.drawables,function(t){t.config.set_value("min_value",e),t.config.set_value("max_value",a)}),this.request_draw({clear_tile_cache:!0})},postdraw_actions:function(t,e,a,i){var n,o=-1;for(n=0;n<t.length;n++){var s=t[n].html_elt.find("canvas").height();o<s&&(o=s)}for(n=0;n<t.length;n++){var r=t[n];r.html_elt.find("canvas").height()!==o&&(this.draw_helper(r.region,a,{force:!0,height:o}),r.html_elt.remove())}var l=this,d=function(){l.update_all_min_max()};this._add_yaxis_label("min",d),this._add_yaxis_label("max",d)}});var et=function(t){K.call(this,t,{content_div:t.top_labeltrack},{resize:!1,header:!1}),this.left_offset=t.canvas_manager.char_width_px,this.container_div.addClass("reference-track"),this.data_url="".concat((0,l.getAppRoot)(),"api/genomes/").concat(this.view.dbkey),this.data_url_extra_params={reference:!0},this.data_manager=new w.default.GenomeReferenceDataManager({data_url:this.data_url,can_subset:this.can_subset}),this.hide_contents()};D(et.prototype,L.prototype,K.prototype,{build_config_params:function(){return b.default.union(L.prototype.config_params,[{key:"height",type:"int",default_value:13,hidden:!0}])},init:function(){this.data_manager.clear(),this.enabled=!0},predraw_init:function(){},can_draw:L.prototype.can_draw,draw_helper:function(t,e,a){var i,n=this.tiles_div.is(":visible"),o=null;return e>this.view.canvas_manager.char_width_px?(this.tiles_div.show(),i=!0,o=K.prototype.draw_helper.call(this,t,e,a)):(i=!1,this.tiles_div.hide()),n!==i&&this.view.resize_viewport(),o},can_subset:function(t){return!0},draw_tile:function(t,e,a,i,n){var o=this.data_manager.subset_entry(t,i),s=o.data,r=e.canvas;e.font=e.canvas.manager.default_font,e.textAlign="center";for(var l=0,d=s.length;l<d;l++)e.fillStyle=this.view.get_base_color(s[l]),e.fillText(s[l],Math.floor(l*n),10);return new E(this,i,n,r,o)}});var at=function(t,e,a){this.mode="Histogram",K.call(this,t,e,a),this.left_offset=30;var i,n,o=this;y.default.when((i="".concat((0,l.getAppRoot)(),"datasets/").concat(this.dataset.id,"/display"),n=y.default.Deferred(),y.default.ajax({type:"HEAD",url:i,beforeSend:function(t){t.setRequestHeader("Range","bytes=0-10")},success:function(t,e,a){n.resolve(206===a.status)}}),n)).then(function(t){t&&(o.data_manager=new S.default.BBIDataManager({dataset:o.dataset}))})};D(at.prototype,L.prototype,K.prototype,{display_modes:H,build_config_params:function(){return b.default.union(L.prototype.config_params,[{key:"color",label:"Color",type:"color"},{key:"min_value",label:"Min Value",type:"float",default_value:void 0},{key:"max_value",label:"Max Value",type:"float",default_value:void 0},{key:"mode",type:"string",default_value:this.mode,hidden:!0},{key:"height",type:"int",default_value:30,hidden:!0}])},config_onchange:function(){this.set_name(this.config.get_value("name")),this.request_draw({clear_tile_cache:!0})},before_draw:function(){},draw_tile:function(t,e,a,i,n){return this._draw_line_track_tile(t,e,a,i,n)},can_subset:function(t){return t.data[1][0]-t.data[0][0]==1},postdraw_actions:function(t,e,a,i){this._add_yaxis_label("max"),this._add_yaxis_label("min")}});var it=function(t,e,a){this.mode="Heatmap",K.call(this,t,e,a)};D(it.prototype,L.prototype,K.prototype,{display_modes:["Heatmap"],build_config_params:function(){return b.default.union(L.prototype.config_params,[{key:"pos_color",label:"Positive Color",type:"color",default_value:"#FF8C00"},{key:"neg_color",label:"Negative Color",type:"color",default_value:"#4169E1"},{key:"min_value",label:"Min Value",type:"int",default_value:void 0},{key:"max_value",label:"Max Value",type:"int",default_value:void 0},{key:"mode",type:"string",default_value:this.mode,hidden:!0},{key:"height",type:"int",default_value:500,hidden:!0}])},config_onchange:function(){this.set_name(this.config.get_value("name")),this.request_draw({clear_tile_cache:!0})},predraw_init:function(){return y.default.getJSON(this.dataset.url(),{data_type:"data",stats:!0,chrom:this.view.chrom,low:0,high:this.view.max_high,hda_ldda:this.dataset.get("hda_ldda")},function(t){})},draw_tile:function(t,e,a,i,n){var o=e.canvas;return new T.default.DiagonalHeatmapPainter(t.data,i.get("start"),i.get("end"),this.config.to_key_value_dict(),a).draw(e,o.width,o.height,n),new E(this,i,n,o,t.data)}});var nt=function(t,e,a){K.call(this,t,e,a),this.container_div.addClass("feature-track"),this.summary_draw_height=30,this.slotters={},this.start_end_dct={},this.left_offset=200,this.set_painter_from_config()};D(nt.prototype,L.prototype,K.prototype,{display_modes:["Auto","Coverage","Dense","Squish","Pack"],build_config_params:function(){return b.default.union(L.prototype.config_params,[{key:"block_color",label:"Block color",type:"color"},{key:"reverse_strand_color",label:"Antisense strand color",type:"color"},{key:"label_color",label:"Label color",type:"color",default_value:"black"},{key:"show_counts",label:"Show summary counts",type:"bool",default_value:!0,help:"Show the number of items in each bin when drawing summary histogram"},{key:"min_value",label:"Histogram minimum",type:"float",default_value:void 0,help:"clear value to set automatically"},{key:"max_value",label:"Histogram maximum",type:"float",default_value:void 0,help:"clear value to set automatically"},{key:"connector_style",label:"Connector style",type:"select",default_value:"fishbones",options:[{label:"Line with arrows",value:"fishbone"},{label:"Arcs",value:"arcs"}]},{key:"mode",type:"string",default_value:this.mode,hidden:!0},{key:"height",type:"int",default_value:0,hidden:!0}])},config_onchange:function(){this.set_name(this.config.get_value("name")),this.set_painter_from_config(),this.request_draw({clear_tile_cache:!0})},set_painter_from_config:function(){"arcs"===this.config.get_value("connector_style")?this.painter=T.default.ArcLinkedFeaturePainter:this.painter=T.default.LinkedFeaturePainter},postdraw_actions:function(t,e,a,i){var s=this;if(K.prototype.postdraw_actions.call(this,t,e,a,i),0===b.default.filter(t,function(t){return t instanceof W}).length){var r={};b.default.each(b.default.pluck(t,"incomplete_features"),function(t){b.default.each(t,function(t){r[t[0]]=t})}),b.default.each(t,function(t){var e=b.default.omit(r,b.default.map(t.incomplete_features,function(t){return t[0]}));if(e=b.default.omit(e,b.default.keys(t.other_tiles_features_drawn)),0!==b.default.size(e)){var a={data:b.default.values(e)},i=s.view.canvas_manager.new_canvas(),n=i.getContext("2d");i.height=Math.max(t.canvas.height,s.get_canvas_height(a,t.mode,t.w_scale,100)),i.width=t.canvas.width,n.drawImage(t.canvas,0,0),n.translate(s.left_offset,0);var o=s.draw_tile(a,n,t.mode,t.region,t.w_scale,t.seq_data);(0,y.default)(t.canvas).replaceWith((0,y.default)(o.canvas)),t.canvas=i,b.default.extend(t.other_tiles_features_drawn,r)}})}if(this.filters_manager){var n,o=this.filters_manager.filters;for(n=0;n<o.length;n++)o[n].update_ui_elt();for(var l,d,h=!1,c=0;c<t.length;c++)if(t[c].data.length)for(l=t[c].data[0],n=0;n<o.length;n++)if((d=o[n]).applies_to(l)&&d.min!==d.max){h=!0;break}this.filters_available!==h&&(this.filters_available=h,this.filters_available||this.filters_manager.hide(),this.update_icons())}if(t[0]instanceof U){for(var _=!0,u=0;u<t.length;u++)if(!t[u].all_slotted){_=!1;break}this.action_icons.show_more_rows_icon.toggle(!_)}else this.action_icons.show_more_rows_icon.hide()},update_auto_mode:function(t){"Auto"===this.mode&&("no_detail"===t&&(t="feature spans"),this.action_icons.mode_icon.attr("title","Set display mode (now: Auto/".concat(t,")")))},incremental_slots:function(t,e,a){var i=this.view.canvas_manager.dummy_context,n=this.slotters[t];return n&&n.mode===a||(n=new C.default.FeatureSlotter(t,a,100,function(t){return i.measureText(t)}),this.slotters[t]=n),n.slot_features(e)},get_mode:function(t){return"no_detail"===t.extra_info||this.is_overview?"no_detail":12e3<this.view.high-this.view.low?"Squish":"Pack"},get_canvas_height:function(t,e,a,i){if("Coverage"===e||"bigwig"===t.dataset_type)return this.summary_draw_height;var n=this.incremental_slots(a,t.data,e),o=new this.painter(null,null,null,this.config.to_key_value_dict(),e);return Math.max(this.min_height_px,o.get_required_height(n,i))},draw_tile:function(t,e,a,i,n,o,s){var r=this,l=e.canvas,d=i.get("start"),h=i.get("end"),c=this.left_offset;if("bigwig"===t.dataset_type)return this._draw_line_track_tile(t,e,a,i,n);var _=[],u=this.slotters[n].slots,f=!0;if(t.data)for(var v=this.filters_manager.filters,p=0,g=t.data.length;p<g;p++){for(var m,w=t.data[p],b=!1,y=0,k=v.length;y<k;y++)if((m=v[y]).update_attrs(w),!m.keep(w)){b=!0;break}b||(_.push(w),w[0]in u||(f=!1))}var x=this.filters_manager.alpha_filter?new B(this.filters_manager.alpha_filter):null,C=this.filters_manager.height_filter?new B(this.filters_manager.height_filter):null,T=new this.painter(_,d,h,this.config.to_key_value_dict(),a,x,C,o,function(t){return r.view.get_base_color(t)}),M=null,z=null;if(e.fillStyle=this.config.get_value("block_color"),e.font=e.canvas.manager.default_font,e.textAlign="right",t.data){var q=T.draw(e,l.width,l.height,n,u);M=q.feature_mapper,z=q.incomplete_features,M.translation=-c}return s?void 0:new U(r,i,n,l,t.data,a,t.message,f,M,z,o)}});var ot=function(t,e,a){K.call(this,t,e,a),this.painter=T.default.VariantPainter,this.summary_draw_height=30,this.left_offset=30};D(ot.prototype,L.prototype,K.prototype,{display_modes:["Auto","Coverage","Dense","Squish","Pack"],build_config_params:function(){return b.default.union(L.prototype.config_params,[{key:"color",label:"Histogram color",type:"color"},{key:"show_sample_data",label:"Show sample data",type:"bool",default_value:!0},{key:"show_labels",label:"Show summary and sample labels",type:"bool",default_value:!0},{key:"summary_height",label:"Locus summary height",type:"float",default_value:20},{key:"mode",type:"string",default_value:this.mode,hidden:!0},{key:"height",type:"int",default_value:0,hidden:!0}])},config_onchange:function(){this.set_name(this.config.get_value("name")),this.request_draw({clear_tile_cache:!0})},draw_tile:function(t,e,a,i,n){if("bigwig"===t.dataset_type)return this._draw_line_track_tile(t,e,"Histogram",i,n);var o=this.view;return new this.painter(t.data,i.get("start"),i.get("end"),this.config.to_key_value_dict(),a,function(t){return o.get_base_color(t)}).draw(e,e.canvas.width,e.canvas.height,n),new E(this,i,n,e.canvas,t.data)},get_canvas_height:function(t,e,a,i){if("bigwig"===t.dataset_type)return this.summary_draw_height;var n=this.dataset.get_metadata("sample_names")?this.dataset.get_metadata("sample_names").length:0;return 0===n&&0!==t.data.length&&(n=null===(n=t.data[0][7].match(/,/g))?1:n.length+1),new this.painter(null,null,null,this.config.to_key_value_dict(),e).get_required_height(n)},predraw_init:function(){var t=[Z.prototype.predraw_init.call(this)];return this.dataset.get_metadata("sample_names")||t.push(this.dataset.fetch()),t},postdraw_actions:function(t,e,a,i){K.prototype.postdraw_actions.call(this,t,e,a,i);var n=b.default.filter(t,function(t){return t instanceof W}),o=this.dataset.get_metadata("sample_names");if(0===n.length&&this.config.get_value("show_labels")&&o&&1<o.length){var s;if(0===this.container_div.find(".yaxislabel.variant").length&&(s=this.config.get_value("summary_height")/2,this.tiles_div.prepend((0,y.default)("<div/>").text("Summary").addClass("yaxislabel variant top").css({"font-size":"".concat(s,"px"),top:"".concat((this.config.get_value("summary_height")-s)/2,"px")})),this.config.get_value("show_sample_data"))){var r=o.join("<br/>");this.tiles_div.prepend((0,y.default)("<div/>").html(r).addClass("yaxislabel variant top sample").css({top:this.config.get_value("summary_height")}))}s="".concat("Squish"===this.mode?5:10,"px"),(0,y.default)(this.tiles_div).find(".sample").css({"font-size":s,"line-height":s}),(0,y.default)(this.tiles_div).find(".yaxislabel").css("color",this.config.get_value("label_color"))}else this.container_div.find(".yaxislabel.variant").remove()}});var st=function(t,e,a){nt.call(this,t,e,a),this.painter=T.default.ReadPainter,this.update_icons()};D(st.prototype,L.prototype,K.prototype,nt.prototype,{build_config_params:function(){return b.default.union(L.prototype.config_params,[{key:"block_color",label:"Histogram color",type:"color"},{key:"detail_block_color",label:"Sense strand block color",type:"color",default_value:"#AAAAAA"},{key:"reverse_strand_color",label:"Antisense strand block color",type:"color",default_value:"#DDDDDD"},{key:"label_color",label:"Label color",type:"color",default_value:"black"},{key:"show_insertions",label:"Show insertions",type:"bool",default_value:!1},{key:"show_differences",label:"Show differences only",type:"bool",default_value:!0},{key:"show_counts",label:"Show summary counts",type:"bool",default_value:!0},{key:"mode",type:"string",default_value:this.mode,hidden:!0},{key:"min_value",label:"Histogram minimum",type:"float",default_value:void 0,help:"clear value to set automatically"},{key:"max_value",label:"Histogram maximum",type:"float",default_value:void 0,help:"clear value to set automatically"},{key:"height",type:"int",default_value:0,hidden:!0}])},config_onchange:function(){this.set_name(this.config.get_value("name")),this.request_draw({clear_tile_cache:!0})}});var rt={CompositeTrack:tt,DrawableGroup:G,DiagonalHeatmapTrack:it,FeatureTrack:nt,LineTrack:at,ReadTrack:st,VariantTrack:ot,VcfTrack:ot},lt=function(t,e,a){if("copy"in t)return t.copy(a);var i=t.obj_type;return i||(i=t.track_type),new rt[i](e,a,t)};t.default={TracksterView:Y,DrawableGroup:G,LineTrack:at,FeatureTrack:nt,DiagonalHeatmapTrack:it,ReadTrack:st,VariantTrack:ot,CompositeTrack:tt,object_from_template:lt}});