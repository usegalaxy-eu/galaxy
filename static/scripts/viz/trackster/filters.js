define(["exports","utils/localization","libs/underscore"],function(t,i,e){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,l=(n=i)&&n.__esModule?n:{default:n};var a=function(t){{if(t&&t.__esModule)return t;var i={};if(null!=t)for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(t,e):{};n.get||n.set?Object.defineProperty(i,e,n):i[e]=t[e]}return i.default=t,i}}(e).extend,d=function(t){this.manager=null,this.name=t.name,this.index=t.index,this.tool_id=t.tool_id,this.tool_exp_name=t.tool_exp_name};a(d.prototype,{to_dict:function(){return{name:this.name,index:this.index,tool_id:this.tool_id,tool_exp_name:this.tool_exp_name}}});var p=function(t,i,e){return $("<a/>").attr("href","javascript:void(0);").attr("title",t).addClass("icon-button").addClass(i).tooltip().click(e)},c=function(t){d.call(this,t),this.low="low"in t?t.low:-Number.MAX_VALUE,this.high="high"in t?t.high:Number.MAX_VALUE,this.min="min"in t?t.min:Number.MAX_VALUE,this.max="max"in t?t.max:-Number.MAX_VALUE,this.container=null,this.slider=null,this.slider_label=null;var e=this;e.parent_div=$("<div/>").addClass("filter-row slider-row");var i=$("<div/>").addClass("elt-label").appendTo(e.parent_div);$("<span/>").addClass("slider-name").text("".concat(e.name,"  ")).appendTo(i);var n=$("<span/>").text("".concat(this.low,"-").concat(this.high)),a=$("<span/>").addClass("slider-value").appendTo(i).append("[").append(n).append("]");e.values_span=n;var r,l,o,s=$("<div/>").addClass("slider").appendTo(e.parent_div);e.control_element=$("<div/>").attr("id","".concat(e.name,"-filter-control")).appendTo(s),e.control_element.slider({range:!0,min:this.min,max:this.max,step:this.get_slider_step(this.min,this.max),values:[this.low,this.high],slide:function(t,i){e.slide(t,i)},change:function(t,i){e.control_element.slider("option","slide").call(e.control_element,t,i)}}),e.slider=e.control_element,e.slider_label=n,r=a,l=n,o=e.control_element,r.click(function(){var t=l.text(),i=parseFloat(o.slider("option","max")),e=i<=1?4:i<=1e6?i.toString().length:6,r=!1,s=$(this).parents(".slider-row");s.addClass("input"),o.slider("option","values")&&(e=2*e+1,r=!0),l.text(""),$("<input type='text'/>").attr("size",e).attr("maxlength",e).attr("value",t).appendTo(l).focus().select().click(function(t){t.stopPropagation()}).blur(function(){$(this).remove(),l.text(t),s.removeClass("input")}).keyup(function(t){if(27===t.keyCode)$(this).trigger("blur");else if(13===t.keyCode){var i=o.slider("option","min"),e=o.slider("option","max"),n=function(t){return isNaN(t)||e<t||t<i},a=$(this).val();if(r){if(a=a.split("-"),n((a=[parseFloat(a[0]),parseFloat(a[1])])[0])||n(a[1]))return alert("Parameter value must be in the range [".concat(i,"-").concat(e,"]")),$(this)}else if(n(a=parseFloat(a)))return alert("Parameter value must be in the range [".concat(i,"-").concat(e,"]")),$(this);o.slider(r?"values":"value",a),s.removeClass("input")}})});var h=$("<div/>").addClass("display-controls").appendTo(e.parent_div);this.transparency_icon=p("Use filter for data transparency","layer-transparent",function(){e.manager.alpha_filter!==e?((e.manager.alpha_filter=e).manager.parent_div.find(".layer-transparent").removeClass("active").hide(),e.transparency_icon.addClass("active").show()):(e.manager.alpha_filter=null,e.transparency_icon.removeClass("active")),e.manager.track.request_draw({force:!0,clear_after:!0})}).appendTo(h).hide(),this.height_icon=p("Use filter for data height","arrow-resize-090",function(){e.manager.height_filter!==e?((e.manager.height_filter=e).manager.parent_div.find(".arrow-resize-090").removeClass("active").hide(),e.height_icon.addClass("active").show()):(e.manager.height_filter=null,e.height_icon.removeClass("active")),e.manager.track.request_draw({force:!0,clear_after:!0})}).appendTo(h).hide(),e.parent_div.hover(function(){e.transparency_icon.show(),e.height_icon.show()},function(){e.manager.alpha_filter!==e&&e.transparency_icon.hide(),e.manager.height_filter!==e&&e.height_icon.hide()}),$("<div style='clear: both;'/>").appendTo(e.parent_div)};a(c.prototype,{to_dict:function(){var t=d.prototype.to_dict.call(this);return a(t,{type:"number",min:this.min,max:this.max,low:this.low,high:this.high})},copy:function(){return new c({name:this.name,index:this.index,tool_id:this.tool_id,tool_exp_name:this.tool_exp_name})},get_slider_step:function(t,i){return i-t<=2?.01:1},slide:function(t,i){var e=i.values;this.values_span.text("".concat(e[0],"-").concat(e[1])),this.low=e[0],this.high=e[1];var n=this;setTimeout(function(){e[0]===n.low&&e[1]===n.high&&n.manager.track.request_draw({force:!0,clear_after:!0})},25)},applies_to:function(t){return t.length>this.index},_keep_val:function(t){return isNaN(t)||t>=this.low&&t<=this.high},keep:function(t){if(!this.applies_to(t))return!0;var i=t[this.index];if(i instanceof Array){for(var e=!0,n=0;n<i.length;n++)if(!this._keep_val(i[n])){e=!1;break}return e}return this._keep_val(t[this.index])},update_attrs:function(t){var i=!1;if(!this.applies_to(t))return i;var e=t[this.index];e instanceof Array||(e=[e]);for(var n=0;n<e.length;n++){var a=e[n];a<this.min&&(this.min=Math.floor(a),i=!0),a>this.max&&(this.max=Math.ceil(a),i=!0)}return i},update_ui_elt:function(){this.min<this.max?this.parent_div.show():this.parent_div.hide();var t=this.slider.slider("option","min"),i=this.slider.slider("option","max");(this.min<t||this.max>i)&&(this.slider.slider("option","min",this.min),this.slider.slider("option","max",this.max),this.slider.slider("option","step",this.get_slider_step(this.min,this.max)),this.slider.slider("option","values",[this.min,this.max]))}});var r=function(t,i){if(this.track=t,this.alpha_filter=null,this.height_filter=null,this.filters=[],this.parent_div=$("<div/>").addClass("filters").hide(),this.parent_div.bind("drag",function(t){t.stopPropagation()}).click(function(t){t.stopPropagation()}).bind("dblclick",function(t){t.stopPropagation()}).bind("keydown",function(t){t.stopPropagation()}),i&&"filters"in i){for(var e,n=("alpha_filter"in i?i.alpha_filter:null),a=("height_filter"in i?i.height_filter:null),r=i.filters,s=0;s<r.length;s++)"number"===r[s].type?(e=new c(r[s]),this.add_filter(e),e.name===n&&(this.alpha_filter=e).transparency_icon.addClass("active").show(),e.name===a&&(this.height_filter=e).height_icon.addClass("active").show()):console.log("ERROR: unsupported filter: ",r[s]);"visible"in i&&i.visible&&this.parent_div.show()}if(0!==this.filters.length){var l=$("<div/>").addClass("param-row").appendTo(this.parent_div),o=$("<input type='submit'/>").attr("value","Run on complete dataset").appendTo(l),h=this;o.click(function(){h.run_on_dataset()})}};a(r.prototype,{show:function(){this.parent_div.show()},hide:function(){this.parent_div.hide()},toggle:function(){this.parent_div.toggle()},visible:function(){return this.parent_div.is(":visible")},to_dict:function(){for(var t,i={},e=[],n=0;n<this.filters.length;n++)t=this.filters[n],e.push(t.to_dict());return i.filters=e,i.alpha_filter=this.alpha_filter?this.alpha_filter.name:null,i.height_filter=this.height_filter?this.height_filter.name:null,i.visible=this.parent_div.is(":visible"),i},copy:function(t){for(var i=new r(t),e=0;e<this.filters.length;e++)i.add_filter(this.filters[e].copy());return i},add_filter:function(t){(t.manager=this).parent_div.append(t.parent_div),this.filters.push(t)},remove_all:function(){this.filters=[],this.parent_div.children().remove()},init_filters:function(){for(var t=0;t<this.filters.length;t++){this.filters[t].update_ui_elt()}},clear_filters:function(){for(var t=0;t<this.filters.length;t++){var i=this.filters[t];i.slider.slider("option","values",[i.min,i.max])}this.alpha_filter=null,this.height_filter=null,this.parent_div.find(".icon-button").hide()},run_on_dataset:function(){for(var t,i,e=function(t,i,e){return i in t||(t[i]=e),t[i]},n={},a=0;a<this.filters.length;a++)(t=this.filters[a]).tool_id&&(t.min!==t.low&&((i=e(n,t.tool_id,[]))[i.length]="".concat(t.tool_exp_name," >= ").concat(t.low)),t.max!==t.high&&((i=e(n,t.tool_id,[]))[i.length]="".concat(t.tool_exp_name," <= ").concat(t.high)));var r=[];for(var s in n)r[r.length]=[s,n[s]];!function i(t,e){var n=e[0],a=n[0],r=n[1],s={cond:"(".concat(r.join(") and ("),")"),input:t,target_dataset_id:t,tool_id:a};e=e.slice(1),$.getJSON(run_tool_url,s,function(t){t.error?Galaxy.modal.show({title:(0,l.default)("Filter Dataset"),body:"Error running tool ".concat(a),buttons:{Close:Galaxy.modal.hide()}}):0===e.length?Galaxy.modal.show({title:(0,l.default)("Filtering Dataset"),body:"Filter(s) are running on the complete dataset. Outputs are in dataset's history.",buttons:{Close:Galaxy.modal.hide()}}):i(t.dataset_id,e)})}(this.track.dataset_id,r)}}),t.default={FiltersManager:r,NumberFilter:c}});