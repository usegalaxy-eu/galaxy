define(["exports","underscore","jquery","backbone","onload/loadConfig","app","utils/localization","viz/trackster/tracks","viz/visualization","mvc/ui/icon-button","utils/query-string-parsing","mvc/grid/grid-view","libs/jquery/jquery.event.drag","libs/jquery/jquery.event.hover","jquery-mousewheel","libs/jquery/jquery-ui","libs/jquery/select2","libs/farbtastic","libs/jquery/jquery.form","libs/jquery/jquery.rating","ui/editable-text"],function(e,t,i,a,n,r,o,l,u,s,c,d){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TracksterUIView=e.TracksterUI=void 0;var w=k(t),h=k(i),f=k(a),v=k(o),p=k(l),_=k(u),b=k(s),y=k(c),g=k(d);function k(e){return e&&e.__esModule?e:{default:e}}function m(e){return(m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function x(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function z(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function j(e,t,i){return t&&z(e.prototype,t),i&&z(e,i),e}function T(e,t){return!t||"object"!==m(t)&&"function"!=typeof t?function(e){if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(e):t}function C(e){return(C=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function A(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&R(e,t)}function R(e,t){return(R=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var S=e.TracksterUI=function(e){function t(e){return x(this,t),T(this,C(t).call(this,e))}return A(t,f.default.Model),j(t,[{key:"initialize",value:function(e){this.baseURL=e}},{key:"save_viz",value:function(){var t=this,i=(0,r.getGalaxyInstance)();i.modal.show({title:"Saving...",body:"progress"});var e=[];(0,h.default)(".bookmark").each(function(){e.push({position:(0,h.default)(t).children(".position").text(),annotation:(0,h.default)(t).children(".annotation").text()})});var a=this.view.overview_drawable?this.view.overview_drawable.config.get_value("name"):null,o={view:this.view.to_dict(),viewport:{chrom:this.view.chrom,start:this.view.low,end:this.view.high,overview:a},bookmarks:e};return h.default.ajax({url:"".concat((0,n.getAppRoot)(),"visualization/save"),type:"POST",dataType:"json",data:{id:this.view.vis_id,title:this.view.config.get_value("name"),dbkey:this.view.dbkey,type:"trackster",vis_json:JSON.stringify(o)}}).success(function(e){i.modal.hide(),t.view.vis_id=e.vis_id,t.view.has_changes=!1,window.history.pushState({},"",e.url+window.top.location.hash)}).error(function(){i.modal.show({title:(0,v.default)("Could Not Save"),body:"Could not save visualization. Please try again later.",buttons:{Cancel:function(){i.modal.hide()}}})})}},{key:"createButtonMenu",value:function(){var t=this,e=b.default.create_icon_buttons_menu([{icon_class:"plus-button",title:(0,v.default)("Add tracks"),on_click:function(){_.default.select_datasets({dbkey:t.view.dbkey},function(e){w.default.each(e,function(e){t.view.add_drawable(p.default.object_from_template(e,t.view,t.view))})})}},{icon_class:"block--plus",title:(0,v.default)("Add group"),on_click:function(){t.view.add_drawable(new p.default.DrawableGroup(t.view,t.view,{name:"New Group"}))}},{icon_class:"bookmarks",title:(0,v.default)("Bookmarks"),on_click:function(){window.force_right_panel("0px"==(0,h.default)("div#right").css("right")?"hide":"show")}},{icon_class:"globe",title:(0,v.default)("Circster"),on_click:function(){window.top.location="".concat(t.baseURL,"visualization/circster?id=").concat(t.view.vis_id)}},{icon_class:"disk--arrow",title:(0,v.default)("Save"),on_click:function(){t.save_viz()}},{icon_class:"cross-circle",title:(0,v.default)("Close"),on_click:function(){t.handle_unsaved_changes(t.view)}}],{tooltip_config:{placement:"bottom"}});return this.buttonMenu=e}},{key:"add_bookmark",value:function(e,t,i){var a=this,o=(0,h.default)("#right .unified-panel-body"),n=(0,h.default)("<div/>").addClass("bookmark").appendTo(o),r=(0,h.default)("<div/>").addClass("position").appendTo(n);(0,h.default)("<a href=''/>").text(e).appendTo(r).click(function(){return a.view.go_to(e),!1});var l=(0,h.default)("<div/>").text(t).appendTo(n);if(i){var u=(0,h.default)("<div/>").addClass("delete-icon-container").prependTo(n).click(function(){return n.slideUp("fast"),n.remove(),!(a.view.has_changes=!0)});(0,h.default)("<a href=''/>").addClass("icon-button delete").appendTo(u),l.make_text_editable({num_rows:3,use_textarea:!0,help_text:"Edit bookmark note"}).addClass("annotation")}return this.view.has_changes=!0,n}},{key:"create_visualization",value:function(e,s,c,d,f){var v=this;return this.view=new p.default.TracksterView(w.default.extend(e,{header:!1})),this.view.editor=!0,h.default.when(this.view.load_chroms_deferred).then(function(e){var t=null;if(s){var i=s.chrom,a=s.start,o=s.end;t=s.overview,i&&void 0!==a&&o?v.view.change_chrom(i,a,o):v.view.change_chrom(e[0].chrom)}else v.view.change_chrom(e[0].chrom);if(c)for(var n=0;n<c.length;n++)v.view.add_drawable(p.default.object_from_template(c[n],v.view,v.view));for(var r=0;r<v.view.drawables.length;r++)if(v.view.drawables[r].config.get_value("name")===t){v.view.set_overview(v.view.drawables[r]);break}if(d)for(var l,u=0;u<d.length;u++)l=d[u],v.add_bookmark(l.position,l.annotation,f);v.view.has_changes=!1}),this.set_up_router({view:this.view}),this.view}},{key:"set_up_router",value:function(e){new _.default.TrackBrowserRouter(e),f.default.history.start()}},{key:"init_keyboard_nav",value:function(t){(0,h.default)(document).keyup(function(e){if(!(0,h.default)(e.srcElement).is(":input"))switch(e.which){case 37:t.move_fraction(.25);break;case 38:t.viewport_container.scrollTop(t.viewport_container.scrollTop()-20);break;case 39:t.move_fraction(-.25);break;case 40:t.viewport_container.scrollTop(t.viewport_container.scrollTop()+20)}})}},{key:"handle_unsaved_changes",value:function(e){var t=this,i=(0,r.getGalaxyInstance)();e.has_changes?i.modal.show({title:(0,v.default)("Close visualization"),body:"There are unsaved changes to your visualization which will be lost if you do not save them.",buttons:{Cancel:function(){i.modal.hide()},"Leave without Saving":function(){(0,h.default)(window).off("beforeunload"),window.top.location="".concat((0,n.getAppRoot)(),"visualizations/list")},Save:function(){h.default.when(t.save_viz()).then(function(){window.top.location="".concat((0,n.getAppRoot)(),"visualizations/list")})}}}):window.top.location="".concat((0,n.getAppRoot)(),"visualizations/list")}}]),t}();e.TracksterUIView=function(e){function t(e){return x(this,t),T(this,C(t).call(this,e))}return A(t,f.default.View),j(t,[{key:"initialize",value:function(){var e=this;this.ui=new S((0,n.getAppRoot)()),this.ui.createButtonMenu(),this.ui.buttonMenu.$el.attr("style","float: right"),(0,h.default)("#center .unified-panel-header-inner").append(this.ui.buttonMenu.$el),(0,h.default)("#right .unified-panel-title").append("Bookmarks"),(0,h.default)("#right .unified-panel-icons").append("<a id='add-bookmark-button' class='icon-button menu-button plus-button' href='javascript:void(0);' title='Add bookmark'></a>"),(0,h.default)("#right-border").click(function(){e.ui.view.resize_window()}),window.force_right_panel("hide"),window.galaxy_config.app.id?this.view_existing():y.default.get("dataset_id")?this.choose_existing_or_new():this.view_new()}},{key:"choose_existing_or_new",value:function(){var e=this,t=(0,r.getGalaxyInstance)(),i=y.default.get("dbkey"),a={dbkey:i,dataset_id:y.default.get("dataset_id"),hda_ldda:y.default.get("hda_ldda"),gene_region:y.default.get("gene_region")};t.modal.show({title:"View Data in a New or Saved Visualization?",body:"<p><ul style='list-style: disc inside none'>You can add this dataset as:<li>a new track to one of your existing, saved Trackster sessions if they share the genome build: <b>".concat(i||"Not available.","</b></li><li>or create a new session with this dataset as the only track</li></ul></p>"),buttons:{Cancel:function(){window.top.location="".concat((0,n.getAppRoot)(),"visualizations/list")},"View in saved visualization":function(){e.view_in_saved(a)},"View in new visualization":function(){e.view_new()}}})}},{key:"view_in_saved",value:function(e){var t=this,i=(0,r.getGalaxyInstance)(),a=new g.default({url_base:"".concat((0,n.getAppRoot)(),"visualization/list_tracks"),embedded:!0});i.modal.show({title:(0,v.default)("Add Data to Saved Visualization"),body:a.$el,buttons:{Cancel:function(){window.top.location="".concat((0,n.getAppRoot)(),"visualizations/list")},"Add to visualization":function(){(0,h.default)(window.parent.document).find("input[name=id]:checked").each(function(){e.id=(0,h.default)(t).val(),window.top.location="".concat((0,n.getAppRoot)(),"visualization/trackster?").concat(h.default.param(e))})}}})}},{key:"view_existing",value:function(){var e=window.galaxy_config.app.viz_config;this.ui.create_visualization({container:(0,h.default)("#center .unified-panel-body"),name:e.title,vis_id:e.vis_id,dbkey:e.dbkey},e.viewport,e.tracks,e.bookmarks,!0),this.init_editor()}},{key:"view_new",value:function(){var i=this,a=(0,r.getGalaxyInstance)();h.default.ajax({url:"".concat((0,n.getAppRoot)(),"api/genomes?chrom_info=True"),data:{},error:function(){alert("Couldn't create new browser.")},success:function(e){a.modal.show({title:(0,v.default)("New Visualization"),body:i.template_view_new(e),buttons:{Cancel:function(){window.top.location="".concat((0,n.getAppRoot)(),"visualizations/list")},Create:function(){i.create_browser((0,h.default)("#new-title").val(),(0,h.default)("#new-dbkey").val()),a.modal.hide()}}});var t=e.map(function(e){return e[1]});window.galaxy_config.app.default_dbkey&&w.default.contains(t,window.galaxy_config.app.default_dbkey)&&(0,h.default)("#new-dbkey").val(window.galaxy_config.app.default_dbkey),(0,h.default)("#new-title").focus(),(0,h.default)("select[name='dbkey']").select2(),(0,h.default)("#overlay").css("overflow","auto")}})}},{key:"template_view_new",value:function(e){for(var t='<form id="new-browser-form" action="javascript:void(0);" method="post" onsubmit="return false;"><div class="form-row"><label for="new-title">Browser name:</label><div class="form-row-input"><input type="text" name="title" id="new-title" value="Unnamed"></input></div><div style="clear: both;"></div></div><div class="form-row"><label for="new-dbkey">Reference genome build (dbkey): </label><div class="form-row-input"><select name="dbkey" id="new-dbkey">',i=0;i<e.length;i++)t+='<option value="'.concat(e[i][1],'">').concat(e[i][0],"</option>");return t+='</select></div><div style="clear: both;"></div></div><div class="form-row">Is the build not listed here? <a href="'.concat((0,n.getAppRoot)(),'custom_builds" target="_top">Add a Custom Build</a></div></form>')}},{key:"init_editor",value:function(){var t=this;(0,h.default)("#center .unified-panel-title").text("".concat(this.ui.view.config.get_value("name")," (").concat(this.ui.view.dbkey,")")),window.galaxy_config.app.add_dataset&&h.default.ajax({url:"".concat((0,n.getAppRoot)(),"api/datasets/").concat(window.galaxy_config.app.add_dataset),data:{hda_ldda:"hda",data_type:"track_config"},dataType:"json",success:function(e){t.ui.view.add_drawable(p.default.object_from_template(e,t.ui.view,t.ui.view))}}),(0,h.default)("#add-bookmark-button").click(function(){var e="".concat(t.ui.view.chrom,":").concat(t.ui.view.low,"-").concat(t.ui.view.high);return t.ui.add_bookmark(e,"Bookmark description",!0)}),this.ui.init_keyboard_nav(this.ui.view),(0,h.default)(window).on("beforeunload",function(){if(t.ui.view.has_changes)return"There are unsaved changes to your visualization that will be lost if you leave this page."})}},{key:"create_browser",value:function(e,t){(0,h.default)(document).trigger("convert_to_values"),this.ui.create_visualization({container:(0,h.default)("#center .unified-panel-body"),name:e,dbkey:t},window.galaxy_config.app.gene_region),this.init_editor(),this.ui.view.editor=!0}}]),t}()});