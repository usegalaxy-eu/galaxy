define(["exports","utils/localization","libs/d3","viz/visualization","mvc/dataset/data","mvc/ui/icon-button"],function(e,t,n,o,i,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PhylovizView=void 0;var l=s(t),g=function(e){{if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var o=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,n):{};o.get||o.set?Object.defineProperty(t,n,o):t[n]=e[n]}return t.default=e,t}}(n),r=s(o),c=s(a);function s(e){return e&&e.__esModule?e:{default:e}}var d=Backbone.View.extend({className:"UserMenuBase",isAcceptableValue:function(e,t,n){var o,i=e.val(),a=e.attr("displayLabel")||e.attr("id").replace("phyloViz","");return o=i,isNaN(parseFloat(o))||!isFinite(o)?(alert("".concat(a," is not a number!")),!1):n<i?(alert("".concat(a," is too large.")),!1):!(i<t)||(alert("".concat(a," is too small.")),!1)},hasIllegalJsonCharacters:function(e){return-1!==e.val().search(/"|'|\\/)&&(alert("Named fields cannot contain these illegal characters: double quote(\"), single guote('), or back slash(\\). "),!0)}});function h(){var l=this,r=g.layout.hierarchy().sort(null).value(null),c=360,s="Linear",d=18,h=200,u=0,f=.5,p=50;return l.leafHeight=function(e){return void 0===e?d:(d=e,l)},l.layoutMode=function(e){return void 0===e?s:(s=e,l)},l.layoutAngle=function(e){return void 0===e?c:(isNaN(e)||e<0||360<e||(c=e),l)},l.separation=function(e){return void 0===e?h:(h=e,l)},l.links=function(e){return g.layout.tree().links(e)},l.nodes=function(e,t){"[object Array]"===toString.call(e)&&(e=e[0]);var n=r.call(l,e,t),o=[],i=0,a=0;return window._d=e,(window._nodes=n).forEach(function(e){i=e.depth>i?e.depth:i,o.push(e)}),o.forEach(function(e){e.children||(a+=1,e.depth=i)}),d="Circular"===s?c/a:d,function t(n,o,i,e){var a=n.children;var l=0;var r=n.dist||f;r=1<r?1:r;n.dist=r;n.y0=null!==e?e.y0+r*h:p;a?(a.forEach(function(e){e.parent=n,l+=t(e,o,i,n)}),n.x0=l/a.length):(n.x0=u*i,u+=1);n.x=n.x0;n.y=n.y0;return n.x0}(o[u=0],i,d,null),o},l}var u=r.default.Visualization.extend({defaults:{layout:"Linear",separation:250,leafHeight:18,type:"phyloviz",title:(0,l.default)("Title"),scaleFactor:1,translate:[0,0],fontSize:12,selectedNode:null,nodeAttrChangedTime:0},initialize:function(e){this.set("dataset",new i.Dataset({id:e.dataset_id}))},root:{},toggle:function(e){void 0!==e&&(e.children?(e._children=e.children,e.children=null):(e.children=e._children,e._children=null))},toggleAll:function(e){e.children&&0!==e.children.length&&(e.children.forEach(this.toggleAll),toggle(e))},getData:function(){return this.root},save:function(){!function e(t){delete t.parent;t._selected&&delete t._selected;t.children&&t.children.forEach(e);t._children&&t._children.forEach(e)}(this.root);var e=$.extend(!0,{},this.attributes);return e.selectedNode=null,show_message("Saving to Galaxy","progress"),$.ajax({url:this.url(),type:"POST",dataType:"json",data:{config:JSON.stringify(e),type:"phyloviz"},success:function(e){hide_modal()}})}}),f=Backbone.View.extend({defaults:{nodeRadius:4.5},stdInit:function(e){var t=this;t.model.on("change:separation change:leafHeight change:fontSize change:nodeAttrChangedTime",t.updateAndRender,t),t.vis=e.vis,t.i=0,t.maxDepth=-1,t.width=e.width,t.height=e.height},updateAndRender:function(e){g.select(".vis");e=e||this.model.root,this.renderNodes(e),this.renderLinks(e),this.addTooltips()},renderLinks:function(e){var t=this,n=(t.diagonal,t.duration,t.layoutMode,t.vis.selectAll("g.completeLink").data(t.tree.links(t.nodes),function(e){return e.target.id})),o=function(e){e.pos0="".concat(e.source.y0," ").concat(e.source.x0),e.pos1="".concat(e.source.y0," ").concat(e.target.x0),e.pos2="".concat(e.target.y0," ").concat(e.target.x0)};n.enter().insert("svg:g","g.node").attr("class","completeLink").append("svg:path").attr("class","link").attr("d",function(e){return o(e),"M ".concat(e.pos0," L ").concat(e.pos1)}),n.transition().duration(500).select("path.link").attr("d",function(e){return o(e),"M ".concat(e.pos0," L ").concat(e.pos1," L ").concat(e.pos2)});n.exit().remove()},selectNode:function(t){g.selectAll("g.node").classed("selectedHighlight",function(e){return t.id===e.id&&(t._selected?(delete t._selected,!1):t._selected=!0)}),this.model.set("selectedNode",t),$("#phyloVizSelectedNodeName").val(t.name),$("#phyloVizSelectedNodeDist").val(t.dist),$("#phyloVizSelectedNodeAnnotation").val(t.annotation||"")},addTooltips:function(){$(".tooltip").remove(),$(".node").attr("data-original-title",function(){var e=this.__data__,t=e.annotation||"None";return e?"".concat(e.name?"".concat(e.name,"<br/>"):"","Dist: ").concat(e.dist," <br/>Annotation1: ").concat(t).concat(e.bootstrap?"<br/>Confidence level: ".concat(Math.round(100*e.bootstrap)):""):""}).tooltip({placement:"top",trigger:"hover"})}}).extend({initialize:function(e){var t=this;t.margins=e.margins,t.layoutMode="Linear",t.stdInit(e),t.layout(),t.updateAndRender(t.model.root)},layout:function(){this.tree=(new h).layoutMode("Linear"),this.diagonal=g.svg.diagonal().projection(function(e){return[e.y,e.x]})},renderNodes:function(t){var n=this,e="".concat(n.model.get("fontSize"),"px");n.tree.separation(n.model.get("separation")).leafHeight(n.model.get("leafHeight"));var o=n.tree.separation(n.model.get("separation")).nodes(n.model.root),i=n.vis.selectAll("g.node").data(o,function(e){return e.name+e.id||(e.id=++n.i)});n.nodes=o,n.duration=500;var a=i.enter().append("svg:g").attr("class","node").on("dblclick",function(){g.event.stopPropagation()}).on("click",function(e){if(g.event.altKey)n.selectNode(e);else{if(e.children&&0===e.children.length)return;n.model.toggle(e),n.updateAndRender(e)}});"[object Array]"===toString.call(t)&&(t=t[0]),a.attr("transform",function(e){return"translate(".concat(t.y0,",").concat(t.x0,")")}),a.append("svg:circle").attr("r",1e-6).style("fill",function(e){return e._children?"lightsteelblue":"#fff"}),a.append("svg:text").attr("class","nodeLabel").attr("x",function(e){return e.children||e._children?-10:10}).attr("dy",".35em").attr("text-anchor",function(e){return e.children||e._children?"end":"start"}).style("fill-opacity",1e-6);var l=i.transition().duration(500);l.attr("transform",function(e){return"translate(".concat(e.y,",").concat(e.x,")")}),l.select("circle").attr("r",n.defaults.nodeRadius).style("fill",function(e){return e._children?"lightsteelblue":"#fff"}),l.select("text").style("fill-opacity",1).style("font-size",e).text(function(e){return e.name&&""!==e.name?e.name:e.bootstrap?Math.round(100*e.bootstrap):""});var r=i.exit().transition().duration(500).remove();r.select("circle").attr("r",1e-6),r.select("text").style("fill-opacity",1e-6),o.forEach(function(e){e.x0=e.x,e.y0=e.y})}}),p=(e.PhylovizView=Backbone.View.extend({className:"phyloviz",initialize:function(e){var t=this;t.MIN_SCALE=.05,t.MAX_SCALE=5,t.MAX_DISPLACEMENT=500,t.margins=[10,60,10,80],t.width=$("#PhyloViz").width(),t.height=$("#PhyloViz").height(),t.radius=t.width,t.data=e.data,$(window).resize(function(){t.width=$("#PhyloViz").width(),t.height=$("#PhyloViz").height(),t.render()}),t.phyloTree=new u(e.config),t.phyloTree.root=t.data,t.zoomFunc=g.behavior.zoom().scaleExtent([t.MIN_SCALE,t.MAX_SCALE]),t.zoomFunc.translate(t.phyloTree.get("translate")),t.zoomFunc.scale(t.phyloTree.get("scaleFactor")),t.navMenu=new p(t),t.settingsMenu=new v({phyloTree:t.phyloTree}),t.nodeSelectionView=new y({phyloTree:t.phyloTree}),t.search=new m,setTimeout(function(){t.zoomAndPan()},1e3)},render:function(){var e=this;$("#PhyloViz").empty(),e.mainSVG=g.select("#PhyloViz").append("svg:svg").attr("width",e.width).attr("height",e.height).attr("pointer-events","all").call(e.zoomFunc.on("zoom",function(){e.zoomAndPan()})),e.boundingRect=e.mainSVG.append("svg:rect").attr("class","boundingRect").attr("width",e.width).attr("height",e.height).attr("stroke","black").attr("fill","white"),e.vis=e.mainSVG.append("svg:g").attr("class","vis"),e.layoutOptions={model:e.phyloTree,width:e.width,height:e.height,vis:e.vis,margins:e.margins},$("#title").text("Phylogenetic Tree from ".concat(e.phyloTree.get("title"),":"));new f(e.layoutOptions)},zoomAndPan:function(e){var t,n;void 0!==e&&(t=e.zoom,n=e.translate);var o,i=this,a=i.zoomFunc.scale(),l=i.zoomFunc.translate(),r="";switch(t){case"reset":a=1,l=[0,0];break;case"+":a*=1.1;break;case"-":a*=.9;break;default:"number"==typeof t?a=t:null!==g.event&&(a=g.event.scale)}if(!(a<i.MIN_SCALE||a>i.MAX_SCALE)){if(i.zoomFunc.scale(a),o="translate(".concat(i.margins[3],",").concat(i.margins[0],") scale(").concat(a,")"),null!==g.event)r="translate(".concat(g.event.translate,")");else{if(void 0!==n){var c=n.split(",")[0],s=n.split(",")[1];isNaN(c)||isNaN(s)||(l=[l[0]+parseFloat(c),l[1]+parseFloat(s)])}i.zoomFunc.translate(l),r="translate(".concat(l,")")}i.phyloTree.set("scaleFactor",a),i.phyloTree.set("translate",l),i.vis.attr("transform",r+o)}},reloadViz:function(){var t=this,e=$("#phylovizNexSelector :selected").val();$.getJSON(t.phyloTree.get("dataset").url(),{tree_index:e,data_type:"raw_data"},function(e){t.data=e.data,t.config=e,t.render()})}}),Backbone.View.extend({initialize:function(e){var t=this;t.phylovizView=e,$("#panelHeaderRightBtns").empty(),$("#phyloVizNavBtns").empty(),$("#phylovizNexSelector").off(),t.initNavBtns(),t.initRightHeaderBtns(),$("#phylovizNexSelector").off().on("change",function(){t.phylovizView.reloadViz()})},initRightHeaderBtns:function(){var t=this,e=c.default.create_icon_buttons_menu([{icon_class:"gear",title:(0,l.default)("PhyloViz Settings"),on_click:function(){$("#SettingsMenu").show(),t.settingsMenu.updateUI()}},{icon_class:"disk",title:(0,l.default)("Save visualization"),on_click:function(){var e=$("#phylovizNexSelector option:selected").text();e&&t.phylovizView.phyloTree.set("title",e),t.phylovizView.phyloTree.save()}},{icon_class:"chevron-expand",title:"Search / Edit Nodes",on_click:function(){$("#nodeSelectionView").show()}},{icon_class:"information",title:(0,l.default)("Phyloviz Help"),on_click:function(){window.open("https://galaxyproject.org/learn/visualization/phylogenetic-tree/")}}],{tooltip_config:{placement:"bottom"}});$("#panelHeaderRightBtns").append(e.$el)},initNavBtns:function(){var e=this,t=c.default.create_icon_buttons_menu([{icon_class:"zoom-in",title:(0,l.default)("Zoom in"),on_click:function(){e.phylovizView.zoomAndPan({zoom:"+"})}},{icon_class:"zoom-out",title:(0,l.default)("Zoom out"),on_click:function(){e.phylovizView.zoomAndPan({zoom:"-"})}},{icon_class:"arrow-circle",title:"Reset Zoom/Pan",on_click:function(){e.phylovizView.zoomAndPan({zoom:"reset"})}}],{tooltip_config:{placement:"bottom"}});$("#phyloVizNavBtns").append(t.$el)}})),v=d.extend({className:"Settings",initialize:function(e){var t=this;t.phyloTree=e.phyloTree,t.el=$("#SettingsMenu"),t.inputs={separation:$("#phyloVizTreeSeparation"),leafHeight:$("#phyloVizTreeLeafHeight"),fontSize:$("#phyloVizTreeFontSize")},$("#settingsCloseBtn").off().on("click",function(){t.el.hide()}),$("#phylovizResetSettingsBtn").off().on("click",function(){t.resetToDefaults()}),$("#phylovizApplySettingsBtn").off().on("click",function(){t.apply()})},apply:function(){var n=this;n.isAcceptableValue(n.inputs.separation,50,2500)&&n.isAcceptableValue(n.inputs.leafHeight,5,30)&&n.isAcceptableValue(n.inputs.fontSize,5,20)&&$.each(n.inputs,function(e,t){n.phyloTree.set(e,t.val())})},updateUI:function(){var n=this;$.each(n.inputs,function(e,t){t.val(n.phyloTree.get(e))})},resetToDefaults:function(){$(".tooltip").remove();var n=this;$.each(n.phyloTree.defaults,function(e,t){n.phyloTree.set(e,t)}),n.updateUI()},render:function(){}}),y=d.extend({className:"Settings",initialize:function(e){var t,n=this;n.el=$("#nodeSelectionView"),n.phyloTree=e.phyloTree,n.UI={enableEdit:$("#phylovizEditNodesCheck"),saveChanges:$("#phylovizNodeSaveChanges"),cancelChanges:$("#phylovizNodeCancelChanges"),name:$("#phyloVizSelectedNodeName"),dist:$("#phyloVizSelectedNodeDist"),annotation:$("#phyloVizSelectedNodeAnnotation")},n.valuesOfConcern={name:null,dist:null,annotation:null},$("#nodeSelCloseBtn").off().on("click",function(){n.el.hide()}),n.UI.saveChanges.off().on("click",function(){n.updateNodes()}),n.UI.cancelChanges.off().on("click",function(){n.cancelChanges()}),(t=$).fn.enable=function(e){return t(this).each(function(){e?t(this).removeAttr("disabled"):t(this).attr("disabled","disabled")})},n.UI.enableEdit.off().on("click",function(){n.toggleUI()})},toggleUI:function(){var n=this,o=n.UI.enableEdit.is(":checked");o||n.cancelChanges(),$.each(n.valuesOfConcern,function(e,t){n.UI[e].enable(o)}),o?(n.UI.saveChanges.show(),n.UI.cancelChanges.show()):(n.UI.saveChanges.hide(),n.UI.cancelChanges.hide())},cancelChanges:function(){var n=this,o=n.phyloTree.get("selectedNode");o&&$.each(n.valuesOfConcern,function(e,t){n.UI[e].val(o[e])})},updateNodes:function(){var n=this,o=n.phyloTree.get("selectedNode");if(o){if(!n.isAcceptableValue(n.UI.dist,0,1)||n.hasIllegalJsonCharacters(n.UI.name)||n.hasIllegalJsonCharacters(n.UI.annotation))return;$.each(n.valuesOfConcern,function(e,t){o[e]=n.UI[e].val()}),n.phyloTree.set("nodeAttrChangedTime",new Date)}else alert("No node selected")}}),m=d.extend({initialize:function(){var i=this;$("#phyloVizSearchBtn").on("click",function(){var e=$("#phyloVizSearchTerm"),t=$("#phyloVizSearchCondition").val().split("-"),n=t[0],o=t[1];i.hasIllegalJsonCharacters(e),"dist"===n&&i.isAcceptableValue(e,0,1),i.searchTree(n,o,e.val())})},searchTree:function(n,o,i){g.selectAll("g.node").classed("searchHighlight",function(e){var t=e[n];if(null!=t)if("dist"===n)switch(o){case"greaterEqual":return+i<=t;case"lesserEqual":return t<=+i;default:return}else if("name"===n||"annotation"===n)return-1!==t.toLowerCase().indexOf(i.toLowerCase())})}})});