define(["exports","underscore","jquery","backbone","onload/loadConfig","utils/localization","mvc/dataset/data","viz/trackster/util","utils/config","mvc/grid/grid-view","mvc/ui/ui-tabs"],function(t,e,a,n,s,i,r,o,d,l,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var _=y(e),c=y(a),h=y(n),f=y(i),g=y(o),m=y(d),p=y(l),v=y(u);function y(t){return t&&t.__esModule?t:{default:t}}var b={toJSON:function(){var a=this,n={};return _.default.each(a.constructor.to_json_keys,function(t){var e=a.get(t);t in a.constructor.to_json_mappers&&(e=a.constructor.to_json_mappers[t](e,a)),n[t]=e}),n}},w=function(t){this.default_font=void 0!==t?t:"9px Monaco, Lucida Console, monospace",this.dummy_canvas=this.new_canvas(),this.dummy_context=this.dummy_canvas.getContext("2d"),this.dummy_context.font=this.default_font,this.char_width_px=this.dummy_context.measureText("A").width,this.patterns={},this.load_pattern("right_strand","/visualization/strand_right.png"),this.load_pattern("left_strand","/visualization/strand_left.png"),this.load_pattern("right_strand_inv","/visualization/strand_right_inv.png"),this.load_pattern("left_strand_inv","/visualization/strand_left_inv.png")};_.default.extend(w.prototype,{load_pattern:function(t,e){var a=this.patterns,n=this.dummy_context,i=new Image;i.src="".concat((0,s.getAppRoot)(),"static/images").concat(e),i.onload=function(){a[t]=n.createPattern(i,"repeat")}},get_pattern:function(t){return this.patterns[t]},new_canvas:function(){var t=(0,c.default)("<canvas/>")[0];return t.manager=this,t}});var k=h.default.Model.extend({defaults:{num_elements:20,obj_cache:null,key_ary:null},initialize:function(t){this.clear()},get_elt:function(t){var e=this.attributes.obj_cache,a=this.attributes.key_ary,n=t.toString(),i=_.default.indexOf(a,function(t){return t.toString()===n});return-1!==i&&(e[n].stale?(a.splice(i,1),delete e[n]):this.move_key_to_end(t,i)),e[n]},set_elt:function(t,e){var a=this.attributes.obj_cache,n=this.attributes.key_ary,i=t.toString(),s=this.attributes.num_elements;if(!a[i]){if(n.length>=s)delete a[n.shift().toString()];n.push(t)}return a[i]=e},move_key_to_end:function(t,e){this.attributes.key_ary.splice(e,1),this.attributes.key_ary.push(t)},clear:function(){this.attributes.obj_cache={},this.attributes.key_ary=[]},size:function(){return this.attributes.key_ary.length},most_recently_added:function(){return 0===this.size()?null:this.attributes.key_ary[this.attributes.key_ary.length-1]}}),x=k.extend({defaults:_.default.extend({},k.prototype.defaults,{dataset:null,genome:null,init_data:null,min_region_size:200,filters_manager:null,data_type:"data",data_mode_compatible:function(t,e){return!0},can_subset:function(t){return!1}}),initialize:function(t){k.prototype.initialize.call(this);var e=this.get("init_data");e&&this.add_data(e)},add_data:function(t){this.get("num_elements")<t.length&&this.set("num_elements",t.length);var e=this;_.default.each(t,function(t){e.set_data(t.region,t)})},data_is_ready:function(){var t=this.get("dataset"),e=c.default.Deferred(),a="raw_data"===this.get("data_type")?"state":"data"===this.get("data_type")?"converted_datasets_state":"error",n=new g.default.ServerStateDeferred({ajax_settings:{url:this.get("dataset").url(),data:{hda_ldda:t.get("hda_ldda"),data_type:a},dataType:"json"},interval:5e3,success_fn:function(t){return"pending"!==t}});return c.default.when(n.go()).then(function(t){e.resolve("ok"===t||"data"===t)}),e},search_features:function(t){var e=this.get("dataset"),a={query:t,hda_ldda:e.get("hda_ldda"),data_type:"features"};return c.default.getJSON(e.url(),a)},load_data:function(e,t,a,n){var i=this.get("dataset"),s={data_type:this.get("data_type"),chrom:e.get("chrom"),low:e.get("start"),high:e.get("end"),mode:t,resolution:a,hda_ldda:i.get("hda_ldda")};c.default.extend(s,n);var r=this.get("filters_manager");if(r){for(var o=[],d=r.filters,l=0;l<d.length;l++)o.push(d[l].name);s.filter_cols=JSON.stringify(o)}var u=this,_=c.default.getJSON(i.url(),s,function(t){t.region=e,u.set_data(e,t)});return this.set_data(e,_),_},get_data:function(t,e,a,n){var i=this.get_elt(t);if(i&&(g.default.is_deferred(i)||this.get("data_mode_compatible")(i,e)))return i;for(var s,r,o=this.get("key_ary"),d=this.get("obj_cache"),l=0;l<o.length;l++)if((s=o[l]).contains(t)&&(r=!0,i=d[s.toString()],g.default.is_deferred(i)||this.get("data_mode_compatible")(i,e)&&this.get("can_subset")(i))){if(this.move_key_to_end(s,l),!g.default.is_deferred(i)){var u=this.subset_entry(i,t);this.set_data(t,u),i=u}return i}if(!r&&t.length()<this.attributes.min_region_size){t=t.copy();var _=this.most_recently_added();!_||t.get("start")>_.get("start")?t.set("end",t.get("start")+this.attributes.min_region_size):t.set("start",t.get("end")-this.attributes.min_region_size),t.set("genome",this.attributes.genome),t.trim()}return this.load_data(t,e,a,n)},set_data:function(t,e){this.set_elt(t,e)},DEEP_DATA_REQ:"deep",BROAD_DATA_REQ:"breadth",get_more_data:function(e,t,a,n,i){var s=this._mark_stale(e);if(s&&this.get("data_mode_compatible")(s,t)){var r=e.get("start");i===this.DEEP_DATA_REQ?c.default.extend(n,{start_val:s.data.length+1}):i===this.BROAD_DATA_REQ&&(r=(s.max_high?s.max_high:s.data[s.data.length-1][2])+1);var o=e.copy().set("start",r),d=this,l=this.load_data(o,t,a,n),u=c.default.Deferred();return this.set_data(e,u),c.default.when(l).then(function(t){t.data&&(t.data=s.data.concat(t.data),t.max_low&&(t.max_low=s.max_low),t.message&&(t.message=t.message.replace(/[0-9]+/,t.data.length))),d.set_data(e,t),u.resolve(t)}),u}console.log("ERROR: problem with getting more data: current data is not compatible")},can_get_more_detailed_data:function(t){var e=this.get_elt(t);return"bigwig"===e.dataset_type&&e.data.length<8e3},get_more_detailed_data:function(t,e,a,n,i){var s=this._mark_stale(t);if(s)return i||(i={}),"bigwig"===s.dataset_type&&(i.num_samples=1e3*n),this.load_data(t,e,a,i);console.log("ERROR getting more detailed data: no current data")},_mark_stale:function(t){var e=this.get_elt(t);return e||console.log("ERROR: no data to mark as stale: ",this.get("dataset"),t.toString()),e.stale=!0,e},get_genome_wide_data:function(t){var a=this,n=!0,e=_.default.map(t.get("chroms_info").chrom_info,function(t){var e=a.get_elt(new O({chrom:t.chrom,start:0,end:t.len}));return e||(n=!1),e});if(n)return e;var i=c.default.Deferred();return c.default.getJSON(this.get("dataset").url(),{data_type:"genome_data"},function(t){a.add_data(t.data),i.resolve(t.data)}),i},subset_entry:function(n,t){var e={bigwig:function(t,e){return _.default.filter(t,function(t){return t[0]>=e.get("start")&&t[0]<=e.get("end")})},refseq:function(t,e){var a=e.get("start")-n.region.get("start");return n.data.slice(a,a+e.length())}},a=n.data;return!n.region.same(t)&&n.dataset_type in e&&(a=e[n.dataset_type](n.data,t)),{region:t,data:a,dataset_type:n.dataset_type}}}),R=x.extend({initialize:function(t){var e=new h.default.Model;e.urlRoot=t.data_url,this.set("dataset",e)},load_data:function(t,e,a,n){return t.length()<=1e5?x.prototype.load_data.call(this,t,e,a,n):{data:null,region:t}}}),A=h.default.Model.extend({defaults:{name:null,key:null,chroms_info:null},initialize:function(t){this.id=t.dbkey},get_chroms_info:function(){return this.attributes.chroms_info.chrom_info},get_chrom_region:function(e){var t=_.default.find(this.get_chroms_info(),function(t){return t.chrom===e});return new O({chrom:t.chrom,end:t.len})},get_chrom_len:function(e){return _.default.find(this.get_chroms_info(),function(t){return t.chrom===e}).len}}),O=h.default.Model.extend({defaults:{chrom:null,start:0,end:0,str_val:null,genome:null},same:function(t){return this.attributes.chrom===t.get("chrom")&&this.attributes.start===t.get("start")&&this.attributes.end===t.get("end")},initialize:function(t){if(t.from_str){var e=t.from_str.split(":"),a=e[0],n=e[1].split("-");this.set({chrom:a,start:parseInt(n[0],10),end:parseInt(n[1],10)})}this.attributes.str_val="".concat(this.get("chrom"),":").concat(this.get("start"),"-").concat(this.get("end")),this.on("change",function(){this.attributes.str_val="".concat(this.get("chrom"),":").concat(this.get("start"),"-").concat(this.get("end"))},this)},copy:function(){return new O({chrom:this.get("chrom"),start:this.get("start"),end:this.get("end")})},length:function(){return this.get("end")-this.get("start")},toString:function(){return this.attributes.str_val},toJSON:function(){return{chrom:this.get("chrom"),start:this.get("start"),end:this.get("end")}},compute_overlap:function(t){var e=this.get("chrom"),a=t.get("chrom"),n=this.get("start"),i=t.get("start"),s=this.get("end"),r=t.get("end");return e&&a&&e!==a?O.overlap_results.DIF_CHROMS:n<i?s<i?O.overlap_results.BEFORE:s<r?O.overlap_results.OVERLAP_START:O.overlap_results.CONTAINS:i<n?r<n?O.overlap_results.AFTER:s<=r?O.overlap_results.CONTAINED_BY:O.overlap_results.OVERLAP_END:r<=s?O.overlap_results.CONTAINS:O.overlap_results.CONTAINED_BY},trim:function(t){if(this.attributes.start<0&&(this.attributes.start=0),this.attributes.genome){var e=this.attributes.genome.get_chrom_len(this.attributes.chrom);this.attributes.end>e&&(this.attributes.end=e-1)}return this},contains:function(t){return this.compute_overlap(t)===O.overlap_results.CONTAINS},overlaps:function(t){return 0===_.default.intersection([this.compute_overlap(t)],[O.overlap_results.DIF_CHROMS,O.overlap_results.BEFORE,O.overlap_results.AFTER]).length}},{overlap_results:{DIF_CHROMS:1e3,BEFORE:1001,CONTAINS:1002,OVERLAP_START:1003,OVERLAP_END:1004,CONTAINED_BY:1005,AFTER:1006}}),E=h.default.Collection.extend({model:O}),S=h.default.Model.extend({defaults:{region:null,note:""},initialize:function(t){this.set("region",new O(t.region))}}),z=h.default.Collection.extend({model:S}),C=h.default.Model.extend(b).extend({defaults:{mode:"Auto"},initialize:function(t){this.set("dataset",new r.Dataset(t.dataset));var e=[{key:"name",default_value:this.get("dataset").get("name")},{key:"color"},{key:"min_value",label:"Min Value",type:"float",default_value:0},{key:"max_value",label:"Max Value",type:"float",default_value:1}];this.set("config",m.default.ConfigSettingCollection.from_models_and_saved_values(e,t.prefs));var a=this.get("preloaded_data");a=a?a.data:[],this.set("data_manager",new x({dataset:this.get("dataset"),init_data:a}))}},{to_json_keys:["track_type","dataset","prefs","mode","filters","tool_state"],to_json_mappers:{prefs:function(t,e){return 0===_.default.size(t)&&(t={name:e.get("config").get("name").get("value"),color:e.get("config").get("color").get("value")}),t},dataset:function(t){return{id:t.id,hda_ldda:t.get("hda_ldda")}}}}),T=h.default.Collection.extend({model:C}),D=h.default.Model.extend({defaults:{title:"",type:""},urlRoot:"".concat((0,s.getAppRoot)(),"api/visualizations"),save:function(){return c.default.ajax({url:this.url(),type:"POST",dataType:"json",data:{vis_json:JSON.stringify(this)}})}}),N=D.extend(b).extend({defaults:_.default.extend({},D.prototype.defaults,{dbkey:"",drawables:null,bookmarks:null,viewport:null}),initialize:function(t){this.set("drawables",new T(t.tracks));this.set("config",m.default.ConfigSettingCollection.from_models_and_saved_values([],t.prefs)),this.unset("tracks"),this.get("drawables").each(function(t){t.unset("preloaded_data")})},add_tracks:function(t){this.get("drawables").add(t)}},{to_json_keys:["view","viewport","bookmarks"],to_json_mappers:{view:function(t,e){return{obj_type:"View",prefs:{name:e.get("title"),content_visible:!0},drawables:e.get("drawables")}}}}),j=h.default.Router.extend({initialize:function(t){var e=this;this.view=t.view,this.route(/([\w]+)$/,"change_location"),this.route(/([\w+]+:[\d,]+-[\d,]+)$/,"change_location"),this.view.on("navigate",function(t){e.navigate(t)})},change_location:function(t){this.view.go_to(t)}});t.default={BackboneTrack:C,BrowserBookmark:S,BrowserBookmarkCollection:z,Cache:k,CanvasManager:w,Genome:A,GenomeDataManager:x,GenomeRegion:O,GenomeRegionCollection:E,GenomeVisualization:N,GenomeReferenceDataManager:R,TrackBrowserRouter:j,Visualization:D,select_datasets:function(t,e){var a=new p.default({url_base:"".concat((0,s.getAppRoot)(),"visualization/list_history_datasets"),filters:t,embedded:!0}),n=new p.default({url_base:"".concat((0,s.getAppRoot)(),"visualization/list_library_datasets"),embedded:!0}),i=new v.default.View;i.add({id:"histories",title:(0,f.default)("Histories"),$el:(0,c.default)("<div/>").append(a.$el)}),i.add({id:"libraries",title:(0,f.default)("Libraries"),$el:(0,c.default)("<div/>").append(n.$el)}),Galaxy.modal.show({title:(0,f.default)("Select datasets for new tracks"),body:i.$el,closing_events:!0,buttons:{Cancel:function(){Galaxy.modal.hide()},Add:function(){var t=[];i.$("input.grid-row-select-checkbox[name=id]:checked").each(function(){window.console.log((0,c.default)(this).val()),t[t.length]=c.default.ajax({url:"".concat((0,s.getAppRoot)(),"api/datasets/").concat((0,c.default)(this).val()),dataType:"json",data:{data_type:"track_config",hda_ldda:"histories"==i.current()?"hda":"ldda"}})}),c.default.when.apply(c.default,t).then(function(){var t=arguments[0]instanceof Array?c.default.map(arguments,function(t){return t[0]}):[arguments[0]];e(t)}),Galaxy.modal.hide()}}})}}});