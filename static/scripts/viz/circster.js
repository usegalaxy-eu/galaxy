define(["exports","underscore","jquery","backbone","onload/loadConfig","app","utils/localization","d3","viz/visualization","utils/utils","utils/config","mvc/ui/icon-button","libs/farbtastic"],function(t,e,a,n,i,r,l,d,o,s,u,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var _=w(e),g=w(a),h=w(n),f=w(l),p=function(t){{if(t&&t.__esModule)return t;var e={};if(null!=t)for(var a in t)if(Object.prototype.hasOwnProperty.call(t,a)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(t,a):{};n.get||n.set?Object.defineProperty(e,a,n):e[a]=t[a]}return e.default=t,e}}(d),m=w(o),v=w(s),b=w(u),k=w(c);function w(t){return t&&t.__esModule?t:{default:t}}var y=h.default.Model.extend({is_visible:function(t,e){var a=t.getBoundingClientRect(),n=(0,g.default)("svg")[0].getBoundingClientRect();return!(a.right<0||a.left>n.right||a.bottom<0||a.top>n.bottom)}}),x={drawTicks:function(t,e,a,n,i){var r=t.append("g").selectAll("g").data(e).enter().append("g").selectAll("g").data(a).enter().append("g").attr("class","tick").attr("transform",function(t){return"rotate(".concat(180*t.angle/Math.PI-90,")translate(").concat(t.radius,",0)")}),l=[],o=[],s=function(t){return t.angle>Math.PI?"end":null};return i?(l=[0,0,0,-4],o=[4,0,"",".35em"],s=null):(l=[1,0,4,0],o=[0,4,".35em",""]),r.append("line").attr("x1",l[0]).attr("y1",l[1]).attr("x2",l[2]).attr("y1",l[3]).style("stroke","#000"),r.append("text").attr("x",o[0]).attr("y",o[1]).attr("dx",o[2]).attr("dy",o[3]).attr("text-anchor",s).attr("transform",n).text(function(t){return t.label})},formatNum:function(t,e){if(void 0===e&&(e=2),null===t)return null;var a=null;if(Math.abs(t)<1)a=t.toPrecision(e);else{var n=Math.round(t.toPrecision(e));(t=Math.abs(t))<1e3?a=n:t<1e6?a="".concat(Math.round((n/1e3).toPrecision(3)).toFixed(0),"K"):t<1e9&&(a="".concat(Math.round((n/1e6).toPrecision(3)).toFixed(0),"M"))}return a}},A=h.default.Model.extend({}),z=h.default.View.extend({className:"circster",initialize:function(t){this.genome=t.genome,this.label_arc_height=50,this.scale=1,this.circular_views=null,this.chords_views=null,this.model.get("drawables").on("add",this.add_track,this),this.model.get("drawables").on("remove",this.remove_track,this);var e=this.model.get("config");e.get("arc_dataset_height").on("change:value",this.update_track_bounds,this),e.get("track_gap").on("change:value",this.update_track_bounds,this)},get_circular_tracks:function(){return this.model.get("drawables").filter(function(t){return"DiagonalHeatmapTrack"!==t.get("track_type")})},get_chord_tracks:function(){return this.model.get("drawables").filter(function(t){return"DiagonalHeatmapTrack"===t.get("track_type")})},get_tracks_bounds:function(){var t=this.get_circular_tracks(),e=this.model.get("config").get_value("arc_dataset_height"),a=this.model.get("config").get_value("track_gap"),n=Math.min(this.$el.width(),this.$el.height())-20,i=n/2-t.length*(e+a)+a-this.label_arc_height,r=p.range(i,n/2,e+a);return _.default.map(r,function(t){return[t,t+e]})},render:function(){var n=this,t=n.$el.width(),e=n.$el.height(),a=this.get_circular_tracks(),i=this.get_chord_tracks(),r=n.model.get("config").get_value("total_gap"),l=this.get_tracks_bounds(),o=p.select(n.$el[0]).append("svg").attr("width",t).attr("height",e).attr("pointer-events","all").append("svg:g").call(p.behavior.zoom().on("zoom",function(){var t=d.event.scale;o.attr("transform","translate(".concat(d.event.translate,") scale(").concat(t,")")),n.scale!==t&&(n.zoom_drag_timeout&&clearTimeout(n.zoom_drag_timeout),n.zoom_drag_timeout=setTimeout(function(){},400))})).attr("transform","translate(".concat(t/2,",").concat(e/2,")")).append("svg:g").attr("class","tracks");this.circular_views=a.map(function(t,e){var a=new O({el:o.append("g")[0],track:t,radius_bounds:l[e],genome:n.genome,total_gap:r});return a.render(),a}),this.chords_views=i.map(function(t){var e=new R({el:o.append("g")[0],track:t,radius_bounds:l[0],genome:n.genome,total_gap:r});return e.render(),e});var s=this.circular_views[this.circular_views.length-1].radius_bounds[1],u=[s,s+this.label_arc_height];this.label_track_view=new P({el:o.append("g")[0],track:new A,radius_bounds:u,genome:n.genome,total_gap:r}),this.label_track_view.render()},add_track:function(t){var e=this.model.get("config").get_value("total_gap");if("DiagonalHeatmapTrack"===t.get("track_type")){var a=this.circular_views[0].radius_bounds,n=new R({el:p.select("g.tracks").append("g")[0],track:t,radius_bounds:a,genome:this.genome,total_gap:e});n.render(),this.chords_views.push(n)}else{var i=this.get_tracks_bounds();_.default.each(this.circular_views,function(t,e){t.update_radius_bounds(i[e])}),_.default.each(this.chords_views,function(t){t.update_radius_bounds(i[0])});var r=this.circular_views.length,l=new O({el:p.select("g.tracks").append("g")[0],track:t,radius_bounds:i[r],genome:this.genome,total_gap:e});l.render(),this.circular_views.push(l)}},remove_track:function(t,e,a){var n=this.circular_views[a.index];this.circular_views.splice(a.index,1),n.$el.remove();var i=this.get_tracks_bounds();_.default.each(this.circular_views,function(t,e){t.update_radius_bounds(i[e])})},update_track_bounds:function(){var a=this.get_tracks_bounds();_.default.each(this.circular_views,function(t,e){t.update_radius_bounds(a[e])}),_.default.each(this.chords_views,function(t){t.update_radius_bounds(a[0])})}}),M=h.default.View.extend({tagName:"g",initialize:function(t){this.bg_stroke="#ddd",this.loading_bg_fill="#ffc",this.bg_fill="#ddd",this.total_gap=t.total_gap,this.track=t.track,this.radius_bounds=t.radius_bounds,this.genome=t.genome,this.chroms_layout=this._chroms_layout(),this.data_bounds=[],this.scale=1,this.parent_elt=p.select(this.$el[0])},get_fill_color:function(){var t=this.track.get("config").get_value("block_color");return t||(t=this.track.get("config").get_value("color")),t},render:function(){var t=this.parent_elt,e=this.chroms_layout,a=p.svg.arc().innerRadius(this.radius_bounds[0]).outerRadius(this.radius_bounds[1]),n=t.selectAll("g").data(e).enter().append("svg:g").append("path").attr("d",a).attr("class","chrom-background").style("stroke",this.bg_stroke).style("fill",this.loading_bg_fill);n.append("title").text(function(t){return t.data.chrom});var i=this,r=i.track.get("data_manager"),l=!r||r.data_is_ready();g.default.when(l).then(function(){g.default.when(i._render_data(t)).then(function(){n.style("fill",i.bg_fill),i.render_labels()})})},render_labels:function(){},update_radius_bounds:function(t){this.radius_bounds=t;var e=p.svg.arc().innerRadius(this.radius_bounds[0]).outerRadius(this.radius_bounds[1]);this.parent_elt.selectAll("g>path.chrom-background").transition().duration(1e3).attr("d",e),this._transition_chrom_data(),this._transition_labels()},update_scale:function(l){var t=this.scale;if(!((this.scale=l)<=t)){var o=this,a=new y;return this.parent_elt.selectAll("path.chrom-data").filter(function(t,e){return a.is_visible(this)}).each(function(t,e){var a,n=p.select(this),i=n.attr("chrom"),r=o.genome.get_chrom_region(i);o.track.get("data_manager").can_get_more_detailed_data(r)&&(a=o.track.get("data_manager").get_more_detailed_data(r,"Coverage",0,l),g.default.when(a).then(function(t){n.remove(),o._update_data_bounds();var e=_.default.find(o.chroms_layout,function(t){return t.data.chrom===i}),a=o.get_fill_color();o._render_chrom_data(o.parent_elt,e,t).style("stroke",a).style("fill",a)}))}),o}},_transition_chrom_data:function(){var e=this.track,i=this.chroms_layout,r=this.parent_elt.selectAll("g>path.chrom-data");if(0<r[0].length){var l=this;g.default.when(e.get("data_manager").get_genome_wide_data(this.genome)).then(function(t){var a=_.default.reject(_.default.map(t,function(t,e){var a=null,n=l._get_path_function(i[e],t);return n&&(a=n(t.data)),a}),function(t){return null===t}),n=e.get("config").get_value("color");r.each(function(t,e){p.select(this).transition().duration(1e3).style("stroke",n).style("fill",n).attr("d",a[e])})})}},_transition_labels:function(){},_update_data_bounds:function(t){this.data_bounds=t||this.get_data_bounds(this.track.get("data_manager").get_genome_wide_data(this.genome)),this._transition_chrom_data()},_render_data:function(n){var i=this,r=this.chroms_layout,l=this.track,o=g.default.Deferred();return g.default.when(l.get("data_manager").get_genome_wide_data(this.genome)).then(function(t){i.data_bounds=i.get_data_bounds(t),l.get("config").set_value("min_value",i.data_bounds[0],{silent:!0}),l.get("config").set_value("max_value",i.data_bounds[1],{silent:!0});var e=_.default.zip(r,t);_.default.each(e,function(t){var e=t[0],a=t[1];return i._render_chrom_data(n,e,a)});var a=i.get_fill_color();i.parent_elt.selectAll("path.chrom-data").style("stroke",a).style("fill",a),o.resolve(n)}),o},_render_chrom_data:function(t,e,a){},_get_path_function:function(t,e){},_chroms_layout:function(){var t=this.genome.get_chroms_info(),e=p.layout.pie().value(function(t){return t.len}).sort(null)(t),n=2*Math.PI*this.total_gap/t.length;return _.default.map(e,function(t,e){var a=t.endAngle-n;return t.endAngle=a>t.startAngle?a:t.startAngle,t})}}),P=M.extend({initialize:function(t){M.prototype.initialize.call(this,t),this.innerRadius=this.radius_bounds[0],this.radius_bounds[0]=this.radius_bounds[1],this.bg_stroke="#fff",this.bg_fill="#fff",this.min_arc_len=.05},_render_data:function(t){var i=this,e=t.selectAll("g");e.selectAll("path").attr("id",function(t){return"label-".concat(t.data.chrom)}),e.append("svg:text").filter(function(t){return t.endAngle-t.startAngle>i.min_arc_len}).attr("text-anchor","middle").append("svg:textPath").attr("class","chrom-label").attr("xlink:href",function(t){return"#label-".concat(t.data.chrom)}).attr("startOffset","25%").text(function(t){return t.data.chrom});var a=_.default.filter(this.chroms_layout,function(t){return t.endAngle-t.startAngle>i.min_arc_len});this.drawTicks(this.parent_elt,a,function(a){var n=(a.endAngle-a.startAngle)/a.value,t=p.range(0,a.value,25e6).map(function(t,e){return{radius:i.innerRadius,angle:t*n+a.startAngle,label:0===e?0:e%3?null:i.formatNum(t)}});return t.length<4&&(t[t.length-1].label=i.formatNum(Math.round((t[t.length-1].angle-a.startAngle)/n))),t},function(t){return t.angle>Math.PI?"rotate(180)translate(-16)":null})}});_.default.extend(P.prototype,x);var C=M.extend({initialize:function(t){M.prototype.initialize.call(this,t);var e=this.track.get("config");e.get("min_value").on("change:value",this._update_min_max,this),e.get("max_value").on("change:value",this._update_min_max,this),e.get("color").on("change:value",this._transition_chrom_data,this)},_update_min_max:function(){var t=this.track.get("config"),a=[t.get_value("min_value"),t.get_value("max_value")];this._update_data_bounds(a),this.parent_elt.selectAll(".min_max").text(function(t,e){return a[e]})},_quantile:function(t,e){return t.sort(p.ascending),p.quantile(t,e)},_render_chrom_data:function(t,e,a){var n=this._get_path_function(e,a);return n?t.datum(a.data).append("path").attr("class","chrom-data").attr("chrom",e.data.chrom).attr("d",n):null},_get_path_function:function(t,e){if("string"==typeof e||!e.data||0===e.data.length)return null;var a=p.scale.linear().domain(this.data_bounds).range(this.radius_bounds).clamp(!0),n=p.scale.linear().domain([0,e.data.length]).range([t.startAngle,t.endAngle]),i=p.svg.line.radial().interpolate("linear").radius(function(t){return a(t[1])}).angle(function(t,e){return n(e)});return p.svg.area.radial().interpolate(i.interpolate()).innerRadius(a(0)).outerRadius(i.radius()).angle(i.angle())},render_labels:function(){var e=this,t=this.drawTicks(this.parent_elt,[this.chroms_layout[0]],this._data_bounds_ticks_fn(),function(){return"rotate(90)"},!0).classed("min_max",!0);_.default.each(t,function(t){(0,g.default)(t).click(function(){new b.default.ConfigSettingCollectionView({collection:e.track.get("config")}).render_in_modal("Configure Track")})})},_transition_labels:function(){if(0!==this.data_bounds.length){var e=this,t=_.default.filter(this.chroms_layout,function(t){return.08<t.endAngle-t.startAngle}),a=_.default.filter(t,function(t,e){return e%3==0}),n=_.default.flatten(_.default.map(a,function(t){return e._data_bounds_ticks_fn()(t)}));this.parent_elt.selectAll("g.tick").data(n).transition().attr("transform",function(t){return"rotate(".concat(180*t.angle/Math.PI-90,")translate(").concat(t.radius,",0)")})}},_data_bounds_ticks_fn:function(){var e=this;return function(t){return[{radius:e.radius_bounds[0],angle:t.startAngle,label:e.formatNum(e.data_bounds[0])},{radius:e.radius_bounds[1],angle:t.startAngle,label:e.formatNum(e.data_bounds[1])}]}},get_data_bounds:function(t){}});_.default.extend(C.prototype,x);var O=C.extend({get_data_bounds:function(t){var e=_.default.flatten(_.default.map(t,function(t){return t?_.default.map(t.data,function(t){return parseInt(t[1],10)||0}):0}));return[_.default.min(e),this._quantile(e,.98)||_.default.max(e)]}}),R=M.extend({render:function(){var l=this;g.default.when(l.track.get("data_manager").data_is_ready()).then(function(){g.default.when(l.track.get("data_manager").get_genome_wide_data(l.genome)).then(function(t){var i=[],r=l.genome.get_chroms_info();_.default.each(t,function(t,e){var n=r[e].chrom,a=_.default.map(t.data,function(t){var e=l._get_region_angle(n,t[1]),a=l._get_region_angle(t[3],t[4]);return{source:{startAngle:e,endAngle:e+.01},target:{startAngle:a,endAngle:a+.01}}});i=i.concat(a)}),l.parent_elt.append("g").attr("class","chord").selectAll("path").data(i).enter().append("path").style("fill",l.get_fill_color()).attr("d",p.svg.chord().radius(l.radius_bounds[0])).style("opacity",1)})})},update_radius_bounds:function(t){this.radius_bounds=t,this.parent_elt.selectAll("path").transition().attr("d",p.svg.chord().radius(this.radius_bounds[0]))},_get_region_angle:function(e,t){var a=_.default.find(this.chroms_layout,function(t){return t.data.chrom===e});return a.endAngle-(a.endAngle-a.startAngle)*(a.data.len-t)/a.data.len}}),T=h.default.View.extend({initialize:function(){v.default.cssLoadFile("static/style/circster.css");var t=new m.default.Genome(window.galaxy_config.app.genome),a=new m.default.GenomeVisualization(window.galaxy_config.app.viz_config);a.get("config").add([{key:"arc_dataset_height",label:"Arc Dataset Height",type:"int",value:25,view:"circster"},{key:"track_gap",label:"Gap Between Tracks",type:"int",value:5,view:"circster"},{key:"total_gap",label:"Gap [0-1]",type:"float",value:.4,view:"circster",hidden:!0}]),new z({el:(0,g.default)("#center .unified-panel-body"),genome:t,model:a}).render(),(0,g.default)("#center .unified-panel-header-inner").append("".concat(window.galaxy_config.app.viz_config.title," ").concat(window.galaxy_config.app.viz_config.dbkey));var e=k.default.create_icon_buttons_menu([{icon_class:"plus-button",title:(0,f.default)("Add tracks"),on_click:function(){m.default.select_datasets({dbkey:a.get("dbkey")},function(t){a.add_tracks(t)})}},{icon_class:"gear",title:(0,f.default)("Settings"),on_click:function(){new b.default.ConfigSettingCollectionView({collection:a.get("config")}).render_in_modal("Configure Visualization")}},{icon_class:"disk--arrow",title:(0,f.default)("Save"),on_click:function(){var e=(0,r.getGalaxyInstance)();e.modal.show({title:(0,f.default)("Saving..."),body:"progress"}),g.default.ajax({url:"".concat((0,i.getAppRoot)(),"visualization/save"),type:"POST",dataType:"json",data:{id:a.get("vis_id"),title:a.get("title"),dbkey:a.get("dbkey"),type:"trackster",vis_json:JSON.stringify(a)}}).success(function(t){e.modal.hide(),a.set("vis_id",t.vis_id)}).error(function(){e.modal.show({title:(0,f.default)("Could Not Save"),body:"Could not save visualization. Please try again later.",buttons:{Cancel:function(){e.modal.hide()}}})})}},{icon_class:"cross-circle",title:(0,f.default)("Close"),on_click:function(){window.top.location="".concat((0,i.getAppRoot)(),"visualizations/list")}}],{tooltip_config:{placement:"bottom"}});e.$el.attr("style","float: right"),(0,g.default)("#center .unified-panel-header-inner").append(e.$el),(0,g.default)(".menu-button").tooltip({placement:"bottom"})}});t.default={GalaxyApp:T}});