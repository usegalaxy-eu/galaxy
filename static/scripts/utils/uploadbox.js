define(["underscore","jquery","onload/loadConfig"],function(e,n,g){"use strict";var o=r(e),a=r(n);function r(e){return e&&e.__esModule?e:{default:e}}!function(f){a.default.event.props.push("dataTransfer");var p=function(e){var r=f.extend({error_default:"Please make sure the file is available.",error_server:"Upload request failed.",error_login:"Uploads require you to log in.",error_retry:"Waiting for server to resume..."},e);console.debug(r);var t=new XMLHttpRequest;t.open("POST",r.url,!0),t.setRequestHeader("Cache-Control","no-cache"),t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.setRequestHeader("Accept","application/json"),t.onreadystatechange=function(){if(t.readyState==t.DONE)if(-1!==[502,0].indexOf(t.status)&&r.warning)r.warning(r.error_retry);else if(t.status<200||299<t.status){var e=t.statusText;403==t.status?e=r.error_login:0==t.status?e=r.error_server:e||(e=r.error_default),r.error("".concat(e," (").concat(t.status,")"))}else{var n=null;if(t.responseText)try{n=a.default.parseJSON(t.responseText)}catch(e){n=t.responseText}r.success(n)}},t.upload.addEventListener("progress",r.progress,!1),t.send(r.data)};f.uploadchunk=function(e){var s=f.extend({},{data:{},success:function(){},error:function(){},warning:function(){},progress:function(){},attempts:7e4,timeout:5e3,url:null,error_file:"File not provided.",error_attempt:"Maximum number of attempts reached.",error_tool:"Tool submission failed."},e),i=s.data;if(i.error_message)s.error(i.error_message);else{var n=i.files&&i.files[0];if(n){var u=n.file,l=s.attempts,c="".concat(s.session.id,"-").concat((new Date).valueOf(),"-").concat(u.size),d=s.session.chunk_upload_size;console.debug("Starting chunked uploads [size=".concat(d,"].")),function r(t){t=t||0;var e=u.mozSlice||u.webkitSlice||u.slice;if(e){var n=Math.min(t+d,u.size),o=u.size;console.debug("Submitting chunk at ".concat(t," bytes..."));var a=new FormData;a.append("session_id",c),a.append("session_start",t),a.append("session_chunk",e.bind(u)(t,n)),p({url:"".concat((0,g.getAppRoot)(),"api/uploads"),data:a,success:function(e){var n=t+d;n<o?(l=s.attempts,r(n)):(console.debug("Upload completed."),i.payload.inputs=JSON.parse(i.payload.inputs),i.payload.inputs["files_0|file_data"]={session_id:c,name:u.name},i.payload.inputs=JSON.stringify(i.payload.inputs),f.ajax({url:"".concat((0,g.getAppRoot)(),"api/tools"),method:"POST",data:i.payload,success:function(e){s.success(e)},error:function(e){var n=e&&e.responseJSON&&e.responseJSON.err_msg;s.error(n||s.error_tool)}}))},warning:function(e){0<--l?(console.debug("Retrying last chunk..."),s.warning(e),setTimeout(function(){return r(t)},s.timeout)):(console.debug(s.error_attempt),s.error(s.error_attempt))},error:function(e){console.debug(e),s.error(e)},progress:function(e){e.lengthComputable&&s.progress(Math.min(Math.round(100*(t+e.loaded)/u.size),100))}})}else s.error("Browser does not support chunked uploads.")}()}else s.error(s.error_file)}},f.uploadpost=function(e){var n=f.extend({},{data:{},success:function(){},error:function(){},progress:function(){},url:null,maxfilesize:2147483648,error_filesize:"File exceeds 2GB. Please use a FTP client."},e),r=n.data;if(r.error_message)n.error(r.error_message);else{var t=new FormData;for(var o in r.payload)t.append(o,r.payload[o]);var a=0;for(var s in r.files){var i=r.files[s];t.append(i.name,i.file,i.file.name),a+=i.file.size}a>n.maxfilesize?n.error(n.error_filesize):p({url:n.url,data:t,success:n.success,error:n.error,progress:function(e){e.lengthComputable&&n.progress(Math.round(100*e.loaded/e.total))}})}},f.fn.uploadinput=function(e){var n=f.extend({},{ondragover:function(){},ondragleave:function(){},onchange:function(){},multiple:!1},e),r=f('<input type="file" style="display: none" '.concat(n.multiple?"multiple":"","/>"));this.append(r.change(function(e){n.onchange(e.target.files),e.target.value=null}));var t=this.get(0);return t.addEventListener("drop",function(e){n.ondragleave(e),e.dataTransfer&&(n.onchange(e.dataTransfer.files),e.preventDefault())}),t.addEventListener("dragover",function(e){e.preventDefault(),n.ondragover(e)}),t.addEventListener("dragleave",function(e){e.stopPropagation(),n.ondragleave(e)}),{dialog:function(){r.trigger("click")}}},f.fn.uploadbox=function(e){var a=f.extend({},{dragover:function(){},dragleave:function(){},announce:function(e){},initialize:function(e){},progress:function(e,n){},success:function(e,n){},warning:function(e,n){},error:function(e,n){alert(n)},complete:function(){}},e),s={},i=null,r=0,u=0,l=!1,c=!1,n=f(this).uploadinput({multiple:!0,onchange:function(e){o.default.each(e,function(e){e.chunk_mode=!0}),t(e)},ondragover:e.ondragover,ondragleave:e.ondragleave});function t(e){if(e&&e.length&&!l){var n=void 0;return o.default.each(e,function(n,e){"new"!==n.mode&&o.default.filter(s,function(e){return e.name===n.name&&e.size===n.size}).length&&(n.duplicate=!0)}),o.default.each(e,function(e){e.duplicate||(n=String(r++),s[n]=e,a.announce(n,s[n]),u++)}),n}}function d(e){s[e]&&(delete s[e],u--)}return{select:function(){n.dialog()},add:t,remove:d,start:function(e){i=e,l||(l=!0,function n(){if(0==u||c)return l=c=!1,void a.complete();l=!0;var r=-1;for(var e in s){r=e;break}var t=s[r];d(r);var o=f.uploadpost;t.chunk_mode&&i&&i.id&&i.chunk_upload_size&&0<i.chunk_upload_size&&(o=f.uploadchunk),o({url:a.url,data:a.initialize(r),session:i,success:function(e){a.success(r,e),n()},warning:function(e){a.warning(r,e)},error:function(e){a.error(r,e),n()},progress:function(e){a.progress(r,e)}})}())},stop:function(){c=!0},reset:function(e){for(e in s)d(e)},configure:function(e){return a=f.extend({},a,e)},compatible:function(){return window.File&&window.FormData&&window.XMLHttpRequest&&window.FileList}}}}(a.default)});