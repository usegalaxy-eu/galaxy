!function(M){M.fn.farbtastic=function(a){return M.farbtastic(this,a),this},M.farbtastic=function(a,t){return(a=M(a)[0]).farbtastic||(a.farbtastic=new M._farbtastic(a,t))},M._farbtastic=function(e,b){var k=this;k.linkTo=function(a){return"object"==typeof k.callback&&M(k.callback).unbind("keyup",k.updateValue),k.color=null,"function"==typeof a?k.callback=a:"object"!=typeof a&&"string"!=typeof a||(k.callback=M(a),k.callback.bind("keyup",k.updateValue),k.callback[0].value&&k.setColor(k.callback[0].value)),this},k.updateValue=function(a){this.value&&this.value!=k.color&&k.setColor(this.value)},k.setColor=function(a){var t=k.unpack(a);return k.color!=a&&t&&(k.color=a,k.rgb=t,k.hsl=k.RGBToHSL(k.rgb),k.updateDisplay()),this},k.setHSL=function(a){return k.hsl=a,k.rgb=k.HSLToRGB(a),k.color=k.pack(k.rgb),k.updateDisplay(),this},k.initWidget=function(){var a={width:b.width,height:b.width};M(e).html('<div class="farbtastic" style="position: relative"><div class="farbtastic-solid"></div><canvas class="farbtastic-mask"></canvas><canvas class="farbtastic-overlay"></canvas></div>').find("*").attr(a).css(a).end().find("div>*").css("position","absolute"),M.browser.msie,k.radius=(b.width-b.wheelWidth)/2-1,k.square=Math.floor(.7*(k.radius-b.wheelWidth/2))-1,k.mid=Math.floor(b.width/2),k.markerSize=.3*b.wheelWidth,k.solidFill=M(".farbtastic-solid",e).css({width:2*k.square-1,height:2*k.square-1,left:k.mid-k.square,top:k.mid-k.square}),k.cnvMask=M(".farbtastic-mask",e),k.ctxMask=k.cnvMask[0].getContext("2d"),k.cnvOverlay=M(".farbtastic-overlay",e),k.ctxOverlay=k.cnvOverlay[0].getContext("2d"),k.ctxMask.translate(k.mid,k.mid),k.ctxOverlay.translate(k.mid,k.mid),k.drawCircle(),k.drawMask()},k.drawCircle=function(){new Date;var a,t,e=k.radius,r=b.wheelWidth,o=8/e/24*Math.PI,i=k.ctxMask,c=0;i.save(),i.lineWidth=r/e,i.scale(e,e);for(var n=0;n<=24;++n){var s=n/24,l=s*Math.PI*2,u=Math.sin(c),d=-Math.cos(c);if(x2=Math.sin(l),y2=-Math.cos(l),am=(c+l)/2,tan=1/Math.cos((l-c)/2),xm=Math.sin(am)*tan,ym=-Math.cos(am)*tan,color2=k.pack(k.HSLToRGB([s,1,.5])),0<n)if(M.browser.msie){var h=(1+Math.min(Math.abs(Math.tan(c)),Math.abs(Math.tan(Math.PI/2-c))))/24;a=k.pack(k.HSLToRGB([t-.15*h,1,.5])),color2=k.pack(k.HSLToRGB([s+.15*h,1,.5])),(m=i.createLinearGradient(u,d,x2,y2)).addColorStop(0,a),m.addColorStop(1,color2),i.fillStyle=m;var f=(e+r/2)/e,v=(e-r/2)/e;i.beginPath(),i.moveTo(u*f,d*f),i.quadraticCurveTo(xm*f,ym*f,x2*f,y2*f),i.lineTo(x2*v,y2*v),i.quadraticCurveTo(xm*v,ym*v,u*v,d*v),i.fill()}else{var m;(m=i.createLinearGradient(u,d,x2,y2)).addColorStop(0,a),m.addColorStop(1,color2),i.strokeStyle=m,i.beginPath(),i.moveTo(u,d),i.quadraticCurveTo(xm,ym,x2,y2),i.stroke()}c=l-o,a=color2,t=s}i.restore()},k.drawMask=function(){new Date;var a=2*k.square,u=k.square;function t(a,t,e){for(var r=1/a,o=1/t,i=0;i<=t;++i)for(var c=1-i*o,n=0;n<=a;++n){var s=1-n*r,l=1-2*Math.min(c*s,(1-c)*s);e(n,i,0<l?.5*(2*c-1+l)/l:0,l)}}if(k.ctxMask.getImageData){var e=Math.floor(a/2),r=document.createElement("canvas");r.width=r.height=e+1;var o=r.getContext("2d"),i=o.getImageData(0,0,e+1,e+1),c=0;t(e,e,function(a,t,e,r){i.data[c++]=i.data[c++]=i.data[c++]=255*e,i.data[c++]=255*r}),o.putImageData(i,0,0),k.ctxMask.drawImage(r,0,0,e+1,e+1,-u,-u,2*u,2*u)}else if(M.browser.msie){var d,h,f=Math.floor(a/6);t(f,6,function(a,t,e,r){if(0==a&&(d=h,h=[]),e=Math.round(255*e),r=Math.round(255*r),0<t){var o=d[a][0],i=d[a][1],c=k.packDX(o,i),n=k.packDX(e,r),s=Math.round(k.mid+(.333*(t-1)-1)*u),l=Math.round(k.mid+(.333*t-1)*u);M("<div>").css({position:"absolute",filter:"progid:DXImageTransform.Microsoft.Gradient(StartColorStr="+c+", EndColorStr="+n+", GradientType=0)",top:s,height:l-s,left:k.mid+(6*a-u-1),width:6-(a==f?Math.round(3):0)}).appendTo(k.cnvMask)}h.push([e,r])})}else{t(e=Math.floor(a/2),e,function(a,t,e,r){e=Math.round(255*e),k.ctxMask.fillStyle="rgba("+e+", "+e+", "+e+", "+r+")",k.ctxMask.fillRect(2*a-u-1,2*t-u-1,2,2)})}},k.drawMarkers=function(){var a=b.width,t=Math.ceil(k.markerSize/4),e=k.markerSize-t+1,r=6.28*k.hsl[0],o=Math.sin(r)*k.radius,i=-Math.cos(r)*k.radius,c=2*k.square*(.5-k.hsl[1]),n=2*k.square*(.5-k.hsl[2]),s=k.invert?"#fff":"#000",l=k.invert?"#000":"#fff",u=[{x:o,y:i,r:e,c:"#000",lw:t+1},{x:o,y:i,r:k.markerSize,c:"#fff",lw:t},{x:c,y:n,r:e,c:l,lw:t+1},{x:c,y:n,r:k.markerSize,c:s,lw:t}];k.ctxOverlay.clearRect(-k.mid,-k.mid,a,a);for(var d=0;d<u.length;d++){var h=u[d];k.ctxOverlay.lineWidth=h.lw,k.ctxOverlay.strokeStyle=h.c,k.ctxOverlay.beginPath(),k.ctxOverlay.arc(h.x,h.y,h.r,0,2*Math.PI,!0),k.ctxOverlay.stroke()}},k.updateDisplay=function(){k.invert=.3*k.rgb[0]+.59*k.rgb[1]+.11*k.rgb[2]<=.6,k.solidFill.css("backgroundColor",k.pack(k.HSLToRGB([k.hsl[0],1,.5]))),k.drawMarkers(),"object"==typeof k.callback?(M(k.callback).css({backgroundColor:k.color,color:k.invert?"#fff":"#000"}),M(k.callback).each(function(){"string"==typeof this.value&&this.value!=k.color&&(this.value=k.color)}).change()):"function"==typeof k.callback&&k.callback.call(k,k.color)},k.widgetCoords=function(a){return{x:a.pageX-k.offset.left-k.mid,y:a.pageY-k.offset.top-k.mid}},k.mousedown=function(a){M._farbtastic.dragging||(M(document).bind("mousemove",k.mousemove).bind("mouseup",k.mouseup),M._farbtastic.dragging=!0),k.offset=M(e).offset();var t=k.widgetCoords(a);return k.circleDrag=Math.max(Math.abs(t.x),Math.abs(t.y))>k.square+2,k.mousemove(a),!1},k.mousemove=function(a){var t=k.widgetCoords(a);if(k.circleDrag){var e=Math.atan2(t.x,-t.y)/6.28;k.setHSL([(e+1)%1,k.hsl[1],k.hsl[2]])}else{var r=Math.max(0,Math.min(1,-t.x/k.square/2+.5)),o=Math.max(0,Math.min(1,-t.y/k.square/2+.5));k.setHSL([k.hsl[0],r,o])}return!1},k.mouseup=function(){M(document).unbind("mousemove",k.mousemove),M(document).unbind("mouseup",k.mouseup),M._farbtastic.dragging=!1},k.dec2hex=function(a){return(a<16?"0":"")+a.toString(16)},k.packDX=function(a,t){return"#"+k.dec2hex(t)+k.dec2hex(a)+k.dec2hex(a)+k.dec2hex(a)},k.pack=function(a){var t=Math.round(255*a[0]),e=Math.round(255*a[1]),r=Math.round(255*a[2]);return"#"+k.dec2hex(t)+k.dec2hex(e)+k.dec2hex(r)},k.unpack=function(t){if(7==t.length){function a(a){return parseInt(t.substring(a,a+2),16)/255}return[a(1),a(3),a(5)]}if(4==t.length){function a(a){return parseInt(t.substring(a,a+1),16)/15}return[a(1),a(2),a(3)]}},k.HSLToRGB=function(a){var t,e,r=a[0],o=a[1],i=a[2];return t=2*i-(e=i<=.5?i*(o+1):i+o-i*o),[this.hueToRGB(t,e,r+.33333),this.hueToRGB(t,e,r),this.hueToRGB(t,e,r-.33333)]},k.hueToRGB=function(a,t,e){return 6*(e=(e+1)%1)<1?a+(t-a)*e*6:2*e<1?t:3*e<2?a+(t-a)*(.66666-e)*6:a},k.RGBToHSL=function(a){var t=a[0],e=a[1],r=a[2],o=Math.min(t,e,r),i=Math.max(t,e,r),c=i-o,n=0,s=0,l=(o+i)/2;return 0<l&&l<1&&(s=c/(l<.5?2*l:2-2*l)),0<c&&(i==t&&i!=e&&(n+=(e-r)/c),i==e&&i!=r&&(n+=2+(r-t)/c),i==r&&i!=t&&(n+=4+(t-e)/c),n/=6),[n,s,l]},b.callback||(b={callback:b}),b=M.extend({width:300,wheelWidth:(b.width||300)/10,callback:null},b),k.initWidget(),M("canvas.farbtastic-overlay",e).mousedown(k.mousedown),b.callback&&k.linkTo(b.callback),k.color||k.setColor("#808080")}}(jQuery);