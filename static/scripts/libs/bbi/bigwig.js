define(["libs/bbi/spans","libs/bbi/jszlib","libs/bbi/jquery-ajax-native"],function(e,r){"use strict";function a(){}function ae(e){e&&(this.id=e)}var se=e.Range,fe=e.union,he=e.intersection,c=r.inflateBuffer,l=r.arrayCopy,m=256,d=65536,v=16777216,t=4294967296,ue=new RegExp("^[0-9]+,[0-9]+,[0-9]+");function g(e,r,t){Math.pow(10,6);return $.ajax({type:"GET",dataType:"native",url:e,timeout:5e3,beforeSend:function(e){e.setRequestHeader("Range","bytes="+r+"-"+(r+(t-1)))},xhrFields:{responseType:"arraybuffer"}})}function C(e,r){return e[r]+e[r+1]*m+e[r+2]*d+e[r+3]*v+e[r+4]*t}function n(){}function i(e,r,t,n){this.bwg=e,this.cirTreeOffset=r,this.cirTreeLength=t,this.isSummary=n}function w(e,r,t,n,i){this.bbi=e,this.type=r,this.fieldCount=t,this.offset=n,this.field=i}return n.prototype.readChromTree=function(){var m=this;this.chromsToIDs={},this.idsToChroms={},this.maxID=0;var e=this.unzoomedDataOffset;return e=e+4-(e-this.chromTreeOffset&3),$.when(g(this.url,this.chromTreeOffset,e-this.chromTreeOffset)).then(function(e){var h=new Uint8Array(e),u=new Int16Array(e),r=new Int32Array(e),c=(r[0],r[1],r[2]),l=(r[3],C(h,16),function(e){var r=h[e],t=u[e/2+1];e+=4;for(var n=0;n<t;++n)if(0===r){var i=C(h,e+=c);e+=8,i-=m.chromTreeOffset,l(i)}else{for(var o="",a=0;a<c;++a){var s=h[e++];0!==s&&(o+=String.fromCharCode(s))}var f=h[e+3]<<24|h[e+2]<<16|h[e+1]<<8|h[e+0];h[e+7],h[e+6],h[e+5],h[e+4];e+=8,m.chromsToIDs[o]=f,0===o.indexOf("chr")&&(m.chromsToIDs[o.substr(3)]=f),m.idsToChroms[f]=o,m.maxID=Math.max(m.maxID,f)}});l(32)})},i.prototype.readWigData=function(e,r,t){var n=this.bwg.chromsToIDs[e];return void 0===n?[]:this.readWigDataById(n,r,t)},i.prototype.readWigDataById=function(w,y,p){var h=this,u=$.Deferred();if(!this.cirHeader)return $.when(g(h.bwg.url,this.cirTreeOffset,48)).then(function(e){h.cirHeader=e;var r=new Int32Array(h.cirHeader);h.cirBlockSize=r[1],$.when(h.readWigDataById(w,y,p)).then(function(e){u.resolve(e)})}),u;var b=[],c=0,l=(Date.now(),function(e,r,t,n){return(w<0||e==w)&&r<=p&&y<=t}),x=function(e,r){if(h.bwg.instrument&&console.log("level="+r+"; offset="+e+"; time="+(0|Date.now())),c+=e.length,1==e.length&&e[0]-h.cirTreeOffset==48&&h.cachedCirRoot)return d(h.cachedCirRoot,0,r),void(0===--c&&$.when(h.fetchFeatures(l,b)).then(function(e){u.resolve(e)}));for(var t,n=4+32*h.cirBlockSize,i=0;i<e.length;++i){var o=new se(e[i],e[i]+n);t=t?fe(t,o):o}for(var a=t.ranges(),s=0;s<a.length;++s){var f=a[s];m(e,f,r)}},m=function(t,n,i,e){n.max(),n.min();$.when(g(h.bwg.url,n.min(),n.max()-n.min())).then(function(e){for(var r=0;r<t.length;++r)n.contains(t[r])&&(d(e,t[r]-n.min(),i),t[r]-h.cirTreeOffset==48&&t[r]-n.min()==0&&(h.cachedCirRoot=e),0===--c&&$.when(h.fetchFeatures(l,b)).then(function(e){u.resolve(e)}))})},d=function(e,r,t){var n=new Uint8Array(e),i=new Int16Array(e),o=new Int32Array(e),a=n[r],s=i[r/2+1];if(r+=4,0!==a)for(var f=0;f<s;++f){var h=o[g=r/4],u=o[g+1],c=o[g+2],l=o[g+3],m=C(n,r+16),d=C(n,r+24);(w<0||h<w||h==w&&u<=p)&&(w<0||w<c||c==w&&y<=l)&&b.push({offset:m,size:d}),r+=32}else{var v=[];for(f=0;f<s;++f){var g;h=o[g=r/4],u=o[g+1],c=o[g+2],l=o[g+3],m=C(n,r+16);(w<0||h<w||h==w&&u<=p)&&(w<0||w<c||c==w&&y<=l)&&v.push(m),r+=24}0<v.length&&x(v,t+1)}};return x([h.cirTreeOffset+48],1),u},i.prototype.fetchFeatures=function(n,s){var f=this,i=$.Deferred();if(s.sort(function(e,r){return(0|e.offset)-(0|r.offset)}),0===s.length)return[];var h=[],o=function(e,r,t,n){n||(n={});var i=new a;for(var o in i._chromId=e,i.segment=f.bwg.idsToChroms[e],i.min=r,i.max=t,i.type=f.bwg.type,n)i[o]=n[o];h.push(i)},u=function(){if(0===s.length){Date.now();return i.resolve(h)}var e=s[0];if(e.data)f.parseFeatures(e.data,o,n),s.splice(0,1),u();else{for(var r=e.offset,a=e.size,t=1;t<s.length&&s[t].offset==r+a;)a+=s[t].size,++t;$.when(g(f.bwg.url,r,a)).then(function(e){for(var r=0,t=0;r<a;){var n,i=s[t];if(0<f.bwg.uncompressBufSize)n=c(e,r+2,i.size-2);else{var o=new Uint8Array(i.size);l(new Uint8Array(e,r,i.size),0,o,0,i.size),n=o.buffer}i.data=n,r+=i.size,++t}u()})}};return u(),i},i.prototype.parseFeatures=function(e,r,t){var n=new Uint8Array(e);if(this.isSummary)for(var i=new Int16Array(e),o=new Int32Array(e),a=new Float32Array(e),s=e.byteLength/32,f=0;f<s;++f){var h=o[8*f],u=o[8*f+1],c=o[8*f+2],l=o[8*f+3],m=(a[8*f+4],a[8*f+5]),d=a[8*f+6];a[8*f+7];if(t(h,u+1,c)){var v={type:"bigwig",score:d/l,maxScore:m};"bigbed"==this.bwg.type&&(v.type="density"),r(h,u+1,c,v)}}else if("bigwig"==this.bwg.type){i=new Int16Array(e),o=new Int32Array(e),a=new Float32Array(e),h=o[0];var g=o[1],w=(o[2],o[3]),y=o[4],p=n[20];s=i[11];if(3==p)for(f=0;f<s;++f){var b=a[f+6],x=g+f*w+1,I=g+f*w+y;t(h,x,I)&&r(h,x,I,{score:b})}else if(2==p)for(f=0;f<s;++f){c=(u=o[2*f+6]+1)+y-1,b=a[2*f+7];t(h,u,c)&&r(h,u,c,{score:b})}else if(1==p)for(f=0;f<s;++f){u=o[3*f+6]+1,c=o[3*f+7],b=a[3*f+8];c<u&&(u=c),t(h,u,c)&&r(h,u,c,{score:b})}else console.log("Currently not handling bwgType="+p)}else{if("bigbed"!=this.bwg.type)throw Error("Don't know what to do with "+this.bwg.type);for(var z=0,A=this.bwg.definedFieldCount,O=this.bwg.schema;z<n.length;){h=n[z+3]<<24|n[z+2]<<16|n[z+1]<<8|n[z+0],u=n[z+7]<<24|n[z+6]<<16|n[z+5]<<8|n[z+4],c=n[z+11]<<24|n[z+10]<<16|n[z+9]<<8|n[z+8];z+=12;for(var C="";;){var D=n[z++];if(0==D)break;C+=String.fromCharCode(D)}var T,F={};if(0<(T=0<C.length?C.split("\t"):[]).length&&3<A&&(F.label=T[0]),1<T.length&&4<A){b=parseInt(T[1]);isNaN(b)||(F.score=b)}if(2<T.length&&5<A&&(F.orientation=T[2]),5<T.length&&8<A){var S=T[5];ue.test(S)&&(F.itemRgb="rgb("+S+")")}if(T.length>A-3&&O)for(var L=A-3;L<T.length;++L)F[O.fields[L+3].name]=T[L];if(t(h,u+1,c,T))if(A<12)r(h,u+1,c,F);else{var B=0|T[3],U=0|T[4],R=0|T[6],V=T[7].split(","),j=T[8].split(",");if(F.exonFrames){var H=F.exonFrames.split(",");F.exonFrames=void 0}F.type="transcript";var k=new ae;for(var W in F)k[W]=F[W];if(k.id=T[0],k.segment=this.bwg.idsToChroms[h],k.min=u+1,k.max=c,k.notes=[],F.groups=[k],9<T.length){var _=F.geneName||T[9],N=_;10<T.length&&(N=T[10]),F.geneName2&&(N=F.geneName2);var Z=$.extend({},k);Z.id=_,Z.label=N,Z.type="gene",F.groups.push(Z)}for(var E=[],q=0;q<R;++q){var M=(0|j[q])+u,Q=M+(0|V[q]),G=new se(M,Q);E.push(G)}for(var J=fe(E),K=J.ranges(),P=0;P<K.length;++P){r(h,(ie=K[P]).min()+1,ie.max(),F)}if(B<U){var X="+"==F.orientation?new se(B,U+3):new se(B-3,U),Y=he(J,X);if(Y){F.type="translation";for(var ee=Y.ranges(),re=0,te=0;ee[0].min()>K[te].max();)te++;for(P=0;P<ee.length;++P){var ne=P;"-"==F.orientation&&(ne=ee.length-P-1);var ie=ee[ne];if(F.readframe=re,H){var oe=parseInt(H[ne+te]);"number"==typeof oe&&0<=oe&&oe<=2&&(F.readframe=oe,F.readframeExplicit=!0)}re=(re+(ie.max()-ie.min()))%3,r(h,ie.min()+1,ie.max(),F)}}}}}}},i.prototype.getFirstAdjacent=function(e,r,t,n){var i=this.bwg.chromsToIDs[e];if(void 0===i)return n([]);this.getFirstAdjacentById(i,r,t,n)},i.prototype.getFirstAdjacentById=function(y,p,b,h){var x=this;if(this.cirHeader){var I=null,z=-1,A=-1,u=0,O=(Date.now(),function(e,r){u+=e.length;for(var t,n=4+32*x.cirBlockSize,i=0;i<e.length;++i){var o=new se(e[i],e[i]+n);t=t?fe(t,o):o}for(var a=t.ranges(),s=0;s<a.length;++s){var f=a[s];c(e,f,r)}}),c=function(t,n,i,e){n.max(),n.min();x.bwg.data.slice(n.min(),n.max()-n.min()).fetch(function(e){for(var r=0;r<t.length;++r)if(n.contains(t[r])&&(o(e,t[r]-n.min(),i),0==--u)){if(!I)return 0<b&&(0!=y||0<p)?x.getFirstAdjacentById(0,0,b,h):b<0&&(y!=x.bwg.maxID||p<1e9)?x.getFirstAdjacentById(x.bwg.maxID,1e9,b,h):h([]);x.fetchFeatures(function(e,r,t,n){return b<0&&(e<y||t<p)||0<b&&(y<e||p<r)},[I],function(e){for(var r=null,t=-1,n=-1,i=0;i<e.length;++i){var o=e[i],a=o._chromId,s=o.min,f=o.max;(null==r||b<0&&(t<a||n<f)||0<b&&(a<t||s<n))&&(r=o,n=b<0?f:s,t=a)}return h(null!=r?[r]:[])})}})},o=function(e,r,t){var n=new Uint8Array(e),i=new Int16Array(e),o=new Int32Array(e),a=n[r],s=i[r/2+1];if(r+=4,0!=a)for(var f=0;f<s;++f){var h=o[w=r/4],u=o[w+1],c=o[w+2],l=o[w+3],m=C(n,r+16),d=C(n,r+24);(b<0&&(h<y||h==y&&u<=p)||0<b&&(y<c||c==y&&p<=l))&&(/_random/.exec(x.bwg.idsToChroms[h])||(null==I||b<0&&(z<c||c==z&&A<l)||0<b&&(h<z||h==z&&u<A))&&(I={offset:m,size:d},A=b<0?l:u,z=b<0?c:h)),r+=32}else{var v=-1,g=-1;for(f=0;f<s;++f){var w;h=o[w=r/4],u=o[w+1],c=o[w+2],l=o[w+3],m=o[w+4]<<32|o[w+5];(b<0&&(h<y||h==y&&u<=p)&&y<=c||0<b&&(y<c||c==y&&p<=l)&&h<=y)&&(v<0||g<l)&&(v=m,g=b<0?l:u,b<0?c:h),r+=24}0<=v&&O([v],t+1)}};O([x.cirTreeOffset+48],1)}else this.bwg.data.slice(this.cirTreeOffset,48).fetch(function(e){x.cirHeader=e;var r=new Int32Array(x.cirHeader);x.cirBlockSize=r[1],x.getFirstAdjacentById(y,p,b,h)})},n.prototype.readWigData=function(e,r,t){var n,i=t-r;if(i<=25e3||0===this.zoomLevels.length)n=this.getUnzoomedView();else for(var o=0;o<this.zoomLevels.length;o++)if(i/this.zoomLevels[o].reduction<25e3){n=this.getZoomedView(o);break}return n.readWigData(e,r,t)},n.prototype.getUnzoomedView=function(){if(!this.unzoomedView){var e=4e3;this.zoomLevels[0]&&(e=this.zoomLevels[0].dataOffset-this.unzoomedIndexOffset),this.unzoomedView=new i(this,this.unzoomedIndexOffset,e,!1)}return this.unzoomedView},n.prototype.getZoomedView=function(e){var r=this.zoomLevels[e];return r.view||(r.view=new i(this,r.indexOffset,4e3,!0)),r.view},n.prototype._tsFetch=function(r,t,n,i,o){var a=this;if(!(r>=this.zoomLevels.length-1))return(r<0?this.getUnzoomedView():this.getZoomedView(r)).readWigDataById(t,n,i,o);if(this.topLevelReductionCache){for(var e=[],s=this.topLevelReductionCache,f=0;f<s.length;++f)s[f]._chromId==t&&e.push(s[f]);return o(e)}this.getZoomedView(this.zoomLevels.length-1).readWigDataById(-1,0,3e8,function(e){return a.topLevelReductionCache=e,a._tsFetch(r,t,n,i,o)})},n.prototype.thresholdSearch=function(e,s,f,h,u){f=f<0?-1:1;for(var r=this,t=this.chromsToIDs[e],c=[{chrOrd:0,chr:t,zoom:r.zoomLevels.length-4,min:0,max:3e8,fromRef:!0}],n=1;n<=this.maxID+1;++n){var i=(t+f*n)%(this.maxID+1);i<0&&(i+=this.maxID+1),c.push({chrOrd:n,chr:i,zoom:r.zoomLevels.length-1,min:0,max:3e8})}!function o(){if(0==c.length)return u(null);c.sort(function(e,r){var t=e.zoom-r.zoom;return 0!=t?t:0!=(t=e.chrOrd-r.chrOrd)?t:e.min-r.min*f});var a=c.splice(0,1)[0];r._tsFetch(a.zoom,a.chr,a.min,a.max,function(e){var r=0<f?0:3e8;a.fromRef&&(r=s);for(var t=0;t<e.length;++t){var n,i=e[t];if(n=null!=i.maxScore?i.maxScore:i.score,0<f){if(h<n)if(a.zoom<0){if(i.min>r)return u(i)}else i.max>r&&c.push({chr:a.chr,chrOrd:a.chrOrd,zoom:a.zoom-2,min:i.min,max:i.max,fromRef:a.fromRef})}else if(h<n)if(a.zoom<0){if(i.max<r)return u(i)}else i.min<r&&c.push({chr:a.chr,chrOrd:a.chrOrd,zoom:a.zoom-2,min:i.min,max:i.max,fromRef:a.fromRef})}o()})}()},n.prototype.getAutoSQL=function(f){if(!this.asOffset)return f(null);$.when(g(this.url,this.asOffset,2048)).then(function(e){for(var r=new Uint8Array(e),t="",n=0;n<r.length&&0!=r[n];++n)t+=String.fromCharCode(r[n]);var i=/([\w\[\]]+)\s+(\w+)\s*;\s*("([^"]+)")?\s*/g,o=/(\w+)\s+(\w+)\s+("([^"]+)")?\s+\(\s*/.exec(t);if(o){var a={declType:o[1],name:o[2],comment:o[4],fields:[]};t=t.substring(o[0]);for(var s=i.exec(t);null!=s;s=i.exec(t))a.fields.push({type:s[1],name:s[2],comment:s[4]});return f(a)}})},n.prototype.getExtraIndices=function(c){var l=this;if(this.version<4||0==this.extHeaderOffset||"bigbed"!=this.type)return c(null);this.data.slice(this.extHeaderOffset,64).fetch(function(e){if(!e)return c(null,"Couldn't fetch extension header");var r=new Uint8Array(e),t=new Int16Array(e),u=(new Int32Array(e),t[0],t[1]),n=C(r,4);if(0==u)return c(null);l.data.slice(n,20*u).fetch(function(e){if(!e)return c(null,"Couldn't fetch index info");for(var r=new Uint8Array(e),t=new Int16Array(e),n=(new Int32Array(e),[]),i=0;i<u;++i){var o=t[10*i],a=t[10*i+1],s=C(r,20*i+4),f=t[10*i+8],h=new w(l,o,a,s,f);n.push(h)}c(n)})})},w.prototype.lookup=function(p,b){var x=this;this.bbi.data.slice(this.offset,32).fetch(function(e){var r=new Uint8Array(e),t=(new Int16Array(e),new Int32Array(e)),n=(t[0],t[1]),w=t[2],y=t[3];C(r,16);!function g(e){x.bbi.data.slice(e,4+n*(w+y)).fetch(function(e){var r,t,n=new Uint8Array(e),i=new Uint16Array(e),o=(new Uint32Array(e),n[0]),a=i[1],s=4;if(0!=o){for(c=0;c<a;++c){for(l="",m=0;m<w;++m)0!=(d=n[s++])&&(l+=String.fromCharCode(d));if(l==p){var f=C(n,s),h=(r=n)[(t=s+8)+3]<<24|r[t+2]<<16|r[t+1]<<8|r[t];return x.bbi.getUnzoomedView().fetchFeatures(function(e,r,t,n){if(n&&n.length>x.field-3)return n[x.field-3]==p},[{offset:f,size:h}],b)}s+=y}return b([])}for(var u=null,c=0;c<a;++c){for(var l="",m=0;m<w;++m){var d;0!=(d=n[s++])&&(l+=String.fromCharCode(d))}var v=C(n,s);if(s+=8,p.localeCompare(l)<0&&u)return void g(u);u=v}g(u)})}(x.offset+32)})},{makeBwg:function(e){var u=$.Deferred(),c=new n;return c.url=e,$.when(g(c.url,0,512)).then(function(e){if(!e)return u.resolve(null,"Couldn't fetch file");var r=e,t=new Uint8Array(r),n=new Int16Array(r),i=new Int32Array(r),o=t[0]+m*t[1]+d*t[2]+v*t[3];if(2291137574==o)c.type="bigwig";else{if(2273964779!=o)return 654086024==o||3958540679==o?u.resolve(null,"Currently don't support big-endian BBI files"):u.resolve(null,"Not a supported format, magic=0x"+o.toString(16));c.type="bigbed"}c.version=n[2],c.numZoomLevels=n[3],c.chromTreeOffset=C(t,8),c.unzoomedDataOffset=C(t,16),c.unzoomedIndexOffset=C(t,24),c.fieldCount=n[16],c.definedFieldCount=n[17],c.asOffset=C(t,36),c.totalSummaryOffset=C(t,44),c.uncompressBufSize=i[13],c.extHeaderOffset=C(t,56),c.zoomLevels=[];for(var a=0;a<c.numZoomLevels;++a){var s=i[6*a+16],f=C(t,24*a+72),h=C(t,24*a+80);c.zoomLevels.push({reduction:s,dataOffset:f,indexOffset:h})}$.when(c.readChromTree()).then(function(){c.getAutoSQL(function(e){return c.schema=e,u.resolve(c)})})}),u}}});