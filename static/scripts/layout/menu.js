define(["exports","underscore","jquery","backbone","onload/loadConfig","app","utils/localization","layout/communication-server-view","mvc/webhooks","utils/utils"],function(t,e,l,i,a,s,o,r,u,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var d=m(e),c=m(l),_=m(i),f=m(o),g=m(u),h=m(n);function m(t){return t&&t.__esModule?t:{default:t}}var p=_.default.Collection.extend({model:_.default.Model.extend({defaults:{visible:!0,target:"_parent"}}),fetch:function(t){t=t||{},this.reset();var e=(0,s.getGalaxyInstance)(),l=new r.CommunicationServerView;this.add(l.render()),this.add({id:"analysis",title:(0,f.default)("Analyze Data"),url:"",tooltip:(0,f.default)("Analysis home view"),target:"__use_router__"}),this.add({id:"workflow",title:(0,f.default)("Workflow"),tooltip:(0,f.default)("Chain tools into workflows"),disabled:!e.user.id,url:"workflows/list",target:"__use_router__"}),this.add({id:"visualization",title:(0,f.default)("Visualize"),tooltip:(0,f.default)("Visualize datasets"),disabled:!e.user.id,menu:[{title:(0,f.default)("Create Visualization"),url:"visualizations",target:"__use_router__"},{title:(0,f.default)("Interactive Environments"),url:"visualization/gie_list",target:"galaxy_main"}]}),this.add({id:"shared",title:(0,f.default)("Shared Data"),url:"library/index",tooltip:(0,f.default)("Access published resources"),menu:[{title:(0,f.default)("Data Libraries"),url:"library/list"},{title:(0,f.default)("Histories"),url:"histories/list_published",target:"__use_router__"},{title:(0,f.default)("Workflows"),url:"workflows/list_published",target:"__use_router__"},{title:(0,f.default)("Visualizations"),url:"visualizations/list_published",target:"__use_router__"},{title:(0,f.default)("Pages"),url:"pages/list_published",target:"__use_router__"}]}),g.default.load({type:"masthead",callback:function(t){(0,c.default)(document).ready(function(){t.each(function(t){var e=t.toJSON();if(e.activate){var l={id:e.id,icon:e.config.icon,url:e.config.url,tooltip:e.config.tooltip,onclick:e.config.function&&new Function(e.config.function)},i=(0,s.getGalaxyInstance)();i.page?i.page.masthead.collection.add(l):i.masthead&&i.masthead.collection.add(l),h.default.appendScriptStyle(e)}})})}}),e.user.get("is_admin")&&this.add({id:"admin",title:(0,f.default)("Admin"),url:"admin",tooltip:(0,f.default)("Administer this Galaxy"),cls:"admin-only"});var i={id:"help",title:(0,f.default)("Help"),tooltip:(0,f.default)("Support, contact, and community"),menu:[{title:(0,f.default)("Support"),url:t.support_url,target:"_blank"},{title:(0,f.default)("Search"),url:t.search_url,target:"_blank"},{title:(0,f.default)("Mailing Lists"),url:t.mailing_lists,target:"_blank"},{title:(0,f.default)("Videos"),url:t.screencasts_url,target:"_blank"},{title:(0,f.default)("Wiki"),url:t.wiki_url,target:"_blank"},{title:(0,f.default)("How to Cite Galaxy"),url:t.citation_url,target:"_blank"},{title:(0,f.default)("Interactive Tours"),url:"tours"}]};t.terms_url&&i.menu.push({title:(0,f.default)("Terms and Conditions"),url:t.terms_url,target:"_blank"}),t.biostar_url&&i.menu.unshift({title:(0,f.default)("Ask a question"),url:"biostar/biostar_question_redirect",target:"_blank"}),t.biostar_url&&i.menu.unshift({title:(0,f.default)("Galaxy Biostar"),url:t.biostar_url_redirect,target:"_blank"}),t.helpsite_url&&i.menu.unshift({title:(0,f.default)("Galaxy Help"),url:t.helpsite_url,target:"_blank"}),this.add(i);var a={};return a=e.user.id?{id:"user",title:(0,f.default)("User"),cls:"loggedin-only",tooltip:(0,f.default)("Account and saved data"),menu:[{title:"".concat((0,f.default)("Logged in as")," ").concat(e.user.get("email"))},{title:(0,f.default)("Preferences"),url:"user",target:"__use_router__"},{title:(0,f.default)("Custom Builds"),url:"custom_builds",target:"__use_router__"},{title:(0,f.default)("Logout"),url:"user/logout?session_csrf_token=".concat(e.session_csrf_token),target:"_top",divider:!0},{title:(0,f.default)("Saved Datasets"),url:"datasets/list",target:"__use_router__"},{title:(0,f.default)("Saved Histories"),url:"histories/list",target:"__use_router__"},{title:(0,f.default)("Saved Pages"),url:"pages/list",target:"__use_router__"},{title:(0,f.default)("Saved Visualizations"),url:"visualizations/list",target:"__use_router__"}]}:t.allow_user_creation?{id:"user",title:(0,f.default)("Login or Register"),cls:"loggedout-only",tooltip:(0,f.default)("Account registration or login"),menu:[{title:(0,f.default)("Login"),url:"user/login",target:"galaxy_main",noscratchbook:!0},{title:(0,f.default)("Register"),url:"user/create",target:"galaxy_main",noscratchbook:!0}]}:{id:"user",title:(0,f.default)("Login"),cls:"loggedout-only",tooltip:(0,f.default)("Login"),url:"user/login",target:"galaxy_main",noscratchbook:!0},this.add(a),(new c.default.Deferred).resolve().promise()}}),v=_.default.View.extend({initialize:function(t){this.model=t.model,this.setElement(this._template()),this.$link=this.$(".nav-link"),this.$note=this.$(".nav-note"),this.$menu=this.$(".dropdown-menu"),this.listenTo(this.model,"change",this.render,this)},events:{"click .nav-link":"_toggleClick"},render:function(){var e=this;return(0,c.default)(".tooltip").remove(),this.$el.removeClass().addClass(this.model.get("disabled")&&"disabled").addClass(this.model.get("active")&&"active").addClass(this.model.get("menu")&&"dropdown").attr("id",this.model.id).css({visibility:this.model.get("visible")?"visible":"hidden"}),this.model.set("url",this._formatUrl(this.model.get("url"))),this.$note.html(this.model.get("note")||"").removeClass().addClass("nav-note").addClass(this.model.get("note_cls")).css({display:this.model.get("show_note")?"block":"none"}),this.$link.html(this.model.get("title")||"").removeClass().addClass("nav-link").addClass(this.model.get("cls")).addClass(this.model.get("icon")&&"nav-icon fa ".concat(this.model.get("icon"))).addClass(this.model.get("menu")&&"dropdown-toggle").addClass(this.model.get("toggle")&&"toggle").attr("target",this.model.get("target")).attr("href",this.model.get("url")).attr("title",this.model.get("tooltip")).tooltip("dispose"),this.model.get("tooltip")&&this.$link.tooltip({placement:"bottom"}),this.model.get("menu")&&this.model.get("show_menu")?(this.$menu.show(),(0,c.default)("#dd-helper").show().off().on("click",function(){(0,c.default)("#dd-helper").hide(),e.model.set("show_menu",!1)})):(this.$menu.hide(),(0,c.default)("#dd-helper").hide()),this.$menu.empty().removeClass(),this.model.get("menu")&&(d.default.each(this.model.get("menu"),function(t){e.$menu.append(e._buildMenuItem(t)),t.divider&&e.$menu.append((0,c.default)("<div/>").addClass("dropdown-divider"))}),this.$menu.addClass("dropdown-menu"),this.$link.append((0,c.default)("<b/>").addClass("caret"))),this},_buildMenuItem:function(l){var i=this;return(l=d.default.defaults(l||{},{title:"",url:"",target:"_parent",noscratchbook:!1})).url=this._formatUrl(l.url),(0,c.default)("<a/>").addClass("dropdown-item").attr("href",l.url).attr("target",l.target).html(l.title).on("click",function(t){if(t.preventDefault(),i.model.set("show_menu",!1),l.onclick)l.onclick();else{var e=(0,s.getGalaxyInstance)();if("__use_router__"==l.target&&void 0!==e.page)e.page.router.executeUseRouter(l.url);else try{e.frame.add(l)}catch(t){console.warn("Missing frame element on galaxy instance",t)}}})},buildLink:function(t,e){return(0,c.default)("<div/>").append((0,c.default)("<a/>").attr("href",(0,a.getAppRoot)()+e).html(t)).html()},_toggleClick:function(t){var e=this,l=this.model;if(t.preventDefault(),(0,c.default)(".tooltip").hide(),l.trigger("dispatch",function(t){l.id!==t.id&&t.get("menu")&&t.set("show_menu",!1)}),l.get("disabled"))this.$link.popover&&this.$link.popover("dispose"),this.$link.popover({html:!0,placement:"bottom",content:"Please ".concat(this.buildLink("login","user/login?use_panels=True")," or ").concat(this.buildLink("register","user/create?use_panels=True")," to use this feature.")}).popover("show"),window.setTimeout(function(){e.$link.popover("dispose")},3e3);else if(l.get("menu"))l.set("show_menu",!0);else if(l.get("onclick"))l.get("onclick")();else{var i=(0,s.getGalaxyInstance)();"__use_router__"==l.attributes.target&&void 0!==i.page?i.page.router.executeUseRouter(l.attributes.url):i.frame.add(l.attributes)}},_formatUrl:function(t){return"string"==typeof t&&-1===t.indexOf("//")&&"/"!=t.charAt(0)?(0,a.getAppRoot)()+t:t},_template:function(){return'\n            <li class="nav-item">\n                <a class="nav-link"/>\n                <div class="nav-note"/>\n                <div class="dropdown-menu"/>\n            </li>'}});t.default={Collection:p,Tab:v}});