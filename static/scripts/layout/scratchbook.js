define(["exports","underscore","jquery","backbone","onload/loadConfig","app","mvc/ui/ui-frames","mvc/dataset/data","viz/visualization","viz/trackster","utils/localization"],function(e,t,a,i,r,c,n,s,o,l,d){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var u=b(t),f=b(a),h=b(i),v=b(n),g=b(o),_=b(d);function b(e){return e&&e.__esModule?e:{default:e}}e.default=h.default.View.extend({initialize:function(e){var t=this;e=e||{},this.frames=new v.default.View({visible:!1}),this.setElement(this.frames.$el),this.active=!1,this.buttonActive=e.collection.add({id:"enable-scratchbook",icon:"fa-th",tooltip:(0,_.default)("Enable/Disable Scratchbook"),onclick:function(){t.active=!t.active,t.buttonActive.set({toggle:t.active,show_note:t.active,note_cls:t.active&&"fa fa-check"}),t.active||t.frames.hide()},onbeforeunload:function(){if(0<t.frames.length())return"You opened ".concat(t.frames.length()," frame(s) which will be lost.")}}),this.buttonLoad=e.collection.add({id:"show-scratchbook",icon:"fa-eye",tooltip:(0,_.default)("Show/Hide Scratchbook"),show_note:!0,visible:!1,onclick:function(e){t.frames.visible?t.frames.hide():t.frames.show()}}),this.frames.on("add remove",function(){t.frames.visible&&0===t.frames.length()&&t.frames.hide(),t.buttonLoad.set({note:t.frames.length(),visible:0<t.frames.length()})}).on("show hide ",function(){t.buttonLoad.set({toggle:t.frames.visible,icon:t.frames.visible?"fa-eye":"fa-eye-slash"})}),this.history_cache={}},addDataset:function(e){var o=this,n=null,t=(0,c.getGalaxyInstance)();if(t&&t.currHistoryPanel){var a=t.currHistoryPanel.collection.historyId;this.history_cache[a]={name:t.currHistoryPanel.model.get("name"),dataset_ids:[]},t.currHistoryPanel.collection.each(function(e){!e.get("deleted")&&e.get("visible")&&o.history_cache[a].dataset_ids.push(e.get("id"))})}var l=function(e,t){if(e){var a=o.history_cache[e.get("history_id")];if(a&&a.dataset_ids){var i=a.dataset_ids,n=i.indexOf(e.get("id"));if(-1!==n&&0<=n+t&&n+t<i.length)return i[n+t]}}},i=function(e,t,a){var i=l(e,t);i?o._loadDataset(i,function(e,t){n=e,a.model.set(t)}):a.model.trigger("change")};this._loadDataset(e,function(e,t){n=e,o.add(u.default.extend({menu:[{icon:"fa fa-chevron-circle-left",tooltip:(0,_.default)("Previous in History"),onclick:function(e){i(n,-1,e)},disabled:function(){return!l(n,-1)}},{icon:"fa fa-chevron-circle-right",tooltip:(0,_.default)("Next in History"),onclick:function(e){i(n,1,e)},disabled:function(){return!l(n,1)}}]},t))})},_loadDataset:function(i,n){var o=this,l=new s.Dataset({id:i});f.default.when(l.fetch()).then(function(){var e=u.default.find(["tabular","interval"],function(e){return-1!==l.get("data_type").indexOf(e)}),t=l.get("name"),a=o.history_cache[l.get("history_id")];a&&(t="".concat(a.name,": ").concat(t)),n(l,e?{title:t,url:null,content:(0,s.createTabularDatasetChunkedView)({model:new s.TabularDataset(l.toJSON()),embedded:!0,height:"100%"}).$el}:{title:t,url:"".concat((0,r.getAppRoot)(),"datasets/").concat(i,"/display/?preview=True"),content:null})})},addTrackster:function(e){var t=this,o=new g.default.Visualization({id:e});f.default.when(o.fetch()).then(function(){var n=new l.TracksterUI((0,r.getAppRoot)()),e={title:o.get("name"),type:"other",content:function(e){var t={container:e,name:o.get("title"),id:o.id,dbkey:o.get("dbkey"),stand_alone:!1},a=o.get("latest_revision"),i=a.config.view.drawables;u.default.each(i,function(e){e.dataset={hda_ldda:e.hda_ldda,id:e.dataset_id}}),n.create_visualization(t,a.config.viewport,a.config.view.drawables,a.config.bookmarks,!1)}};t.add(e)})},add:function(e){if("_blank"==e.target)window.open(e.url);else if("_top"==e.target||"_parent"==e.target||"_self"==e.target)window.location=e.url;else if(!this.active||e.noscratchbook){var t=(0,f.default)(window.parent.document).find("#galaxy_main");"galaxy_main"==e.target||"center"==e.target?0===t.length?window.location=this._build_url(e.url,{use_panels:!0}):t.attr("src",e.url):window.location=e.url}else e.url=this._build_url(e.url,{hide_panels:!0,hide_masthead:!0}),this.frames.add(e)},_build_url:function(e,t){if(e)return e+=-1==e.indexOf("?")?"?":"&",e+=f.default.param(t,!0)}})});