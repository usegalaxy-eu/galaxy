define(["exports","jquery","underscore","backbone","mvc/base-mvc","mvc/user/user-model","utils/metrics-logger","utils/add-logging","utils/localization","app"],function(e,t,o,a,r,n,i,l,s,g){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.GalaxyApp=h;var c=b(t),u=b(o),p=b(a),f=b(r),d=b(n),y=b(i),v=b(l),_=b(s);function b(e){return e&&e.__esModule?e:{default:e}}function h(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};this._init(e,t)}(0,v.default)(h,"GalaxyApp");var m="galaxy:debug",x="".concat(m,":namespaces"),L="".concat(m,":flatten"),S=!1;try{S="true"==localStorage.getItem(m)}catch(e){console.log((0,_.default)("localStorage not available for debug flag retrieval"))}h.prototype._init=function(e,t){var o=this;u.default.extend(o,p.default.Events),S&&(o.logger=console,console.debug("debugging galaxy:","options:",e,"bootstrapped:",t)),o._processOptions(e),o._initConfig(e.config||{});var a=(0,g.getGalaxyInstance)();return a&&o._patchGalaxy(a),o.root=e.root||"/",o.params=e.params||{},o.session_csrf_token=e.session_csrf_token||null,o._initLogger(o.options.loggerOptions||{}),o.debug("GalaxyApp.options: ",o.options),o.debug("GalaxyApp.config: ",o.config),o.debug("GalaxyApp.logger: ",o.logger),o._initLocale(),o.debug("GalaxyApp.localize: ",o.localize),o.config=e.config||{},o.debug("GalaxyApp.config: ",o.config),o._initUser(e.user||{}),o.debug("GalaxyApp.user: ",o.user),o._initUserLocale(),o.debug("currentLocale: ",sessionStorage.getItem("currentLocale")),o._setUpListeners(),o.trigger("ready",o),o},h.prototype.defaultOptions={patchExisting:!0,root:"/",session_csrf_token:null},h.prototype._processOptions=function(e){var t=this,o=t.defaultOptions;for(var a in t.options={},o)o.hasOwnProperty(a)&&(t.options[a]=e.hasOwnProperty(a)?e[a]:o[a]);return t},h.prototype._initConfig=function(e){var t=this;return t.config=e,t.config.debug=S||t.config.debug,t},h.prototype._patchGalaxy=function(e){if(this.options.patchExisting&&e)for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},h.prototype._initLogger=function(e){var o=this;if(o.config.debug){e.consoleLogger=e.consoleLogger||console,e.consoleLevel=e.consoleLevel||y.default.MetricsLogger.ALL;try{e.consoleNamespaceWhitelist=localStorage.getItem(x).split(",")}catch(e){}try{e.consoleFlattenMessages="true"==localStorage.getItem(L)}catch(e){}console.log(e.consoleFlattenMessages)}return o.logger=new y.default.MetricsLogger(e),o.emit={},["log","debug","info","warn","error","metric"].map(function(t){o.emit[t]=function(e){o.logger.emit(t,e,Array.prototype.slice.call(arguments,1))}}),o.config.debug&&(f.default.LoggableMixin.logger=o.logger),o},h.prototype._initLocale=function(e){var t=this;return t.debug("_initLocale:",e),t.localize=_.default,window._l=t.localize,t},h.prototype._initUserLocale=function(e){var t=this,o=!!t.config.default_locale&&t.config.default_locale.toLowerCase(),a={};t.user&&t.user.attributes.preferences&&"extra_user_preferences"in t.user.attributes.preferences&&(a=JSON.parse(t.user.attributes.preferences.extra_user_preferences));var r="localization|locale"in a&&a["localization|locale"].toLowerCase();"auto"==r&&(r=!1);var n="undefined"==typeof navigator?"__root":(navigator.language||navigator.userLanguage||"__root").toLowerCase(),i=r||o||n;sessionStorage.setItem("currentLocale",i)},h.prototype._initUser=function(e){var t=this;return t.debug("_initUser:",e),t.user=new d.default.User(e),t.user.logger=t.logger,t},h.prototype._setUpListeners=function(){var r=this;return r.lastAjax={},(0,c.default)(document).bind("ajaxSend",function(e,t,o){var a=o.data;try{a=JSON.parse(a)}catch(e){}r.lastAjax={url:location.href.slice(0,-1)+o.url,data:a}}),r},h.prototype.debugging=function(e){try{if(void 0===e)return"true"===localStorage.getItem(m);if(e)return localStorage.setItem(m,!0),!0;localStorage.removeItem(m),this.debuggingNamespaces(null)}catch(e){console.log((0,_.default)("localStorage not available for debug flag retrieval"))}return!1},h.prototype.debuggingNamespaces=function(e){try{if(void 0===e){var t=localStorage.getItem(x);return"string"==typeof t?t.split(","):[]}null===e?localStorage.removeItem(x):localStorage.setItem(x,e);var o=this.debuggingNamespaces();return this.logger&&(this.logger.options.consoleNamespaceWhitelist=o),o}catch(e){console.log((0,_.default)("localStorage not available for debug namespace retrieval"))}},h.prototype.toString=function(){var e=this.user?this.user.get("email")||"(anonymous)":"uninitialized";return"GalaxyApp(".concat(e,")")},e.default={GalaxyApp:h}});