<tool id="interactive_tool_cellprofiler" tool_type="interactive" name="cellprofiler" version="@VERSION@+galaxy0" profile="23.1">
	<description>cell image analysis software</description>
    <macros>
        <token name="@VERSION@">4.2.6</token>
    </macros>
    <requirements>
	    <container type="docker">registry.git.embl.de/grp-cbbcs/abcdesktop-apps/cellprofiler_galaxy:latest</container>
    </requirements>
    <entry_points>
        <entry_point name="Cellprofiler" requires_domain="True">
            <port>5800</port>
        </entry_point>
    </entry_points>
    <command detect_errors="exit_code">
    <![CDATA[
        export HOME=\$PWD &&
		    
        mkdir -p ./output ./input &&
        chown 1000:1000 ./output/ &&
        chown 1000:1000 ./input/ &&


        #for input in $infiles:
            ln -s '$input' ./input/'$input.element_identifier'.'$input.ext' &&
	    echo '$input' >> ./list.txt &&
        #end for

              
        #if str($input_type.existing) == "existing":
            cp '$input_type.pipeline_file' ./output/'$input_type.pipeline_file.element_identifier'.cppipe &&
            echo "cellprofiler --pipeline ./output/'$input_type.pipeline_file.element_identifier'.cppipe --file-list ./list.txt " > ./cellprofiler_galaxy &&
	#else:	    
	    echo "cellprofiler --project \$HOME/output/Myproject.cpproj" > ./cellprofiler_galaxy &&
        #end if
        chmod +x ./cellprofiler_galaxy &&
	cp ./cellprofiler_galaxy '/bin' &&
	/init

    ]]>
    </command>
    <inputs>
	<param name="infiles" type="data" multiple="true" format="jpg,png,tiff,bmp,gif,pcx,ppm,psd,pbm,pgm,eps" label="Images" />

        <conditional name="input_type">
            <param name="existing" type="select" label="Do you have an existing pipeline?">
                <option value="new">Start a new pipeline</option>
                <option value="existing">Modify an existing project</option>
            </param>
            <when value="new">
            </when>
            <when value="existing">
                <param name="pipeline_file" type="data" format="txt" label="Existing CellProfiler pipeline" />
            </when>
        </conditional>
    </inputs>
    
    <outputs>
	    <data name="cp_proj" format="h5" label="CellProfiler project file" from_work_dir="output/MyProject.cpproj"/>
    </outputs>
    
    <tests>
    </tests>
    
    <help><![CDATA[
	   **What it does**

      This is the CellProfiler interactive tool.


      .. class:: infomark

      **Input**

      - Collection of images.

      - Existing CellProfiler pipeline file *(.cppipe)* or generated by linking CellProfiler tools.

      .. class:: infomark


      .. class:: warningmark

      **IMPORTANT**

      You may need to modify the matrching rules in NameAndTypes module.
]]>
    </help>
</tool>
